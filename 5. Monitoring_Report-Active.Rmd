---
title: "<span style='font-size: 18px'> <span style='text-align: center'> PRISMA & ReMAPP Monitoring Report (Issued: 2024-07-05)"
output:
  pdf_document:
    toc: no
    toc_depth: 4
    latex_engine: xelatex
    keep_tex: false
    # output_dir: "D:/Users/stacie.loisate/Box/Monitoring-Report-Active/tables/"
include-in-header:
- \usepackage{ booktabs,longtable}
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, out.width = "100%") 
knitr::opts_chunk$set(out.width = "100%", fig.align = "center")

## last updated: 16 April 2024

library(tidyverse) 
library(knitr) 
library(reshape2) 
library(lubridate) 
library(kableExtra) 
library(emo) 
library(naniar) 
library(RColorBrewer) 
library(scales) 
library(gt) 
library(webshot2) 
library(grid)
library(gridExtra)

UploadDate = "2024-06-14" 

setwd(paste0("D:/Users/stacie.loisate/Box/Monitoring-Report-Active/data/"))

## import all rda files 
rda_files = list.files(pattern="*.RData")
walk(rda_files, ~ load(.x, .GlobalEnv))

#table format
tb_theme1 <- function(matrix){
  tb <- matrix %>% 
    gt(
      rownames_to_stub = TRUE
    ) %>% 
    opt_align_table_header(align = "left") %>% 
    tab_spanner(
      label = "Sites",
      columns = c(-Total)
    ) %>% 
    opt_stylize(style = 6, color = 'blue') %>% 
    tab_style(
      style = list(
        cell_fill(color = "skyblue4"),
        cell_text(weight = "bold"),
        cell_text(v_align = "middle"),
        cell_text(color = "white", size = px(18))
      ),
      locations = list(
        cells_title()
      )
    ) %>% 
    tab_style(
      style = list(
        cell_fill(color = "cadetblue1"),
        cell_text(color = "black", size = px(18)),
        cell_text(v_align = "middle") 
      ),
      locations = list(
        cells_stubhead(),
        cells_column_spanners(),
        cells_column_labels() 
      )
    ) %>% 
    tab_style(
      style = list(
        cell_fill(color = "aliceblue"),
        cell_text(v_align = "middle", size = px(18))
      ),
      locations = list(
        cells_stub()
      ) 
    ) %>% 
    tab_style(
      style = list(
        cell_text(align = "center", size = px(18)) 
      ),
      locations = list(
        cells_column_labels(columns = everything())
      )
    ) %>% 
    tab_style(
      style = list(
        cell_text(align = "center", size = px(18)) 
      ),
      locations = list(
        cells_body(columns = everything())
      ) 
    ) %>%
    fmt_markdown(columns = everything()) %>%
    tab_options(table.width = pct(100)) %>%
    cols_width(1 ~ px(240)) ## to make rows more spread out, reduce this number 
} 


# Function to extract and format legend horizontally
g_legend <- function(p) {
  tmp <- ggplot_gtable(ggplot_build(p))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend_gtable <- tmp$grobs[[leg]]
  
  # Arrange legend components horizontally
  legend_gtable$widths <- unit(rep(1, ncol(legend_gtable)), "null")
  legend_gtable$grobs <- legend_gtable$grobs[order(legend_gtable$layout$l)]
  
  return(legend_gtable)
}


setwd(paste0("D:/Users/stacie.loisate/Box/Monitoring-Report-Active/tables/"))
```

**Abbreviations:**

**PRISMA MNH:** Pregnancy Risk, Infant Surveillance, and Measurement
Alliance (PRISMA) Maternal and Newborn Health (MNH) Study: A multi-site,
prospective, open cohort study of pregnancy and postpartum health
outcomes

**ReMAPP:** Redefining Maternal Anemia in Pregnancy and Postpartum
(ReMAPP) Study: A multisite, international, population-based cohort
study to establish global hemoglobin thresholds for maternal anemia


**Versions:**

**Date issued:** 2024-07-05

**Included data last updated in Synapse:** 2024-06-28

**Last enrollment date:**

-   Kenya: 2024-06-14
-   Pakistan: 2024-06-14
-   Ghana: 2024-06-13
-   Zambia: 2024-06-13
-   India CMC: 2024-06-13
-   India SAS: 2024-06-14

```{r, results='hide' }
#check last day of screening and enrollment
lastscreen <- MatData_Screen_Enroll %>%
  filter(PRESCREEN == 1) %>%
  select(M00_SCRN_OBSSTDAT, M02_SCRN_OBSSTDAT, SITE) %>%
  group_by(SITE) %>%
  mutate(last_screen = max((M00_SCRN_OBSSTDAT), na.rm = TRUE)) %>% 
  ungroup()

lastenroll <- MatData_Screen_Enroll %>%
  filter(M02_SCRN_OBSSTDAT <= UploadDate) %>% 
  filter(ENROLL == 1) %>% 
  select(M00_SCRN_OBSSTDAT, M02_SCRN_OBSSTDAT, SITE) %>%
  group_by(SITE) %>%
  mutate(last_enroll = max((M02_SCRN_OBSSTDAT), na.rm = TRUE)) %>% 
  ungroup()

 # table(lastscreen$last_screen, lastscreen$SITE)
 table(lastenroll$last_enroll, lastenroll$SITE)
## 
##new 
date_last_enrll_pak <- lastenroll %>% filter(SITE == "Pakistan") %>% select(last_enroll) %>%  unique() %>% mutate(last_enroll = last_enroll-7) %>% pull()
date_last_enrll_ke <- lastenroll %>% filter(SITE == "Kenya") %>% select(last_enroll) %>%  unique() %>% mutate(last_enroll = last_enroll-7) %>% pull()
date_last_enrll_ga <- lastenroll %>% filter(SITE == "Ghana") %>% select(last_enroll) %>%  unique() %>% mutate(last_enroll = last_enroll-7) %>% pull()
date_last_enrll_za <- lastenroll %>% filter(SITE == "Zambia") %>% select(last_enroll) %>%  unique() %>% mutate(last_enroll = last_enroll-7) %>% pull()
date_last_enrll_cmc <- lastenroll %>% filter(SITE == "India-CMC") %>% select(last_enroll) %>%  unique() %>% mutate(last_enroll = last_enroll-7) %>% pull()
date_last_enrll_sas <- lastenroll %>% filter(SITE == "India-SAS") %>% select(last_enroll) %>%  unique() %>% mutate(last_enroll = last_enroll-7) %>% pull()



```

```{=tex}
\setcounter{tocdepth}{6}
\tableofcontents
```
\newpage

## **1. PRISMA**


### Table 1: Most recent one week pre-screened and enrolled in PRISMA

*Value:* Provides a snapshot of weekly pre-screening and enrollment
progress.

```{r}
## Prescreening and enrollment in the most recent one week 
# denominator: a = n all pre-screened 
MatData_Screen_Enroll$date_last_enrll_pak = date_last_enrll_pak
MatData_Screen_Enroll$date_last_enrll_ke = date_last_enrll_ke
MatData_Screen_Enroll$date_last_enrll_ga = date_last_enrll_ga
MatData_Screen_Enroll$date_last_enrll_za = date_last_enrll_za
MatData_Screen_Enroll$date_last_enrll_cmc = date_last_enrll_cmc
MatData_Screen_Enroll$date_last_enrll_sas = date_last_enrll_sas


tb_prescreen_enroll <- MatData_Screen_Enroll %>% 
  filter(
    SITE == "Pakistan" & (M00_SCRN_OBSSTDAT > date_last_enrll_pak) |
    SITE == "Kenya" & (M00_SCRN_OBSSTDAT > date_last_enrll_ke) | 
    SITE == "Ghana" & (M00_SCRN_OBSSTDAT > date_last_enrll_ga) |
    SITE == "Zambia" & (M00_SCRN_OBSSTDAT > date_last_enrll_za) | 
    SITE == "India-CMC" & (M00_SCRN_OBSSTDAT > date_last_enrll_cmc) |
    SITE == "India-SAS" & (M00_SCRN_OBSSTDAT > date_last_enrll_sas) 
  ) %>% 
  group_by(SITE) %>% 
  summarise("Pre-screened, n" = sum(PRESCREEN == 1, na.rm=TRUE),
            "Eligible based on pre-screen, n(%) <sup>a</sup>" = paste0(sum(PRESCR_ELIGIBLE == 1, na.rm=TRUE), 
                                        " (", format(sum(PRESCR_ELIGIBLE == 1, na.rm=TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Screened, n" = sum(SCREEN == 1),
            "Enrolled, n(%) <sup>b</sup>" = paste0(sum(ENROLL == 1, na.rm=TRUE), 
                                        " (", format(sum(ENROLL == 1, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")")
) %>% 
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "Total" = MatData_Screen_Enroll %>% 
  filter(
    SITE == "Pakistan" & (M00_SCRN_OBSSTDAT > date_last_enrll_pak) |
    SITE == "Kenya" & (M00_SCRN_OBSSTDAT > date_last_enrll_ke) | 
    SITE == "Ghana" & (M00_SCRN_OBSSTDAT > date_last_enrll_ga) |
    SITE == "Zambia" & (M00_SCRN_OBSSTDAT > date_last_enrll_za) |
    SITE == "India-CMC" & (M00_SCRN_OBSSTDAT > date_last_enrll_cmc) |
    SITE == "India-SAS" & (M00_SCRN_OBSSTDAT > date_last_enrll_sas) 

  ) %>% 
  plyr::summarise("Pre-screened, n" = sum(PRESCREEN == 1, na.rm=TRUE),
            "Eligible based on pre-screen, n(%) <sup>a</sup>" = paste0(sum(PRESCR_ELIGIBLE == 1, na.rm=TRUE), 
                                        " (", format(sum(PRESCR_ELIGIBLE == 1, na.rm=TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Screened, n" = sum(SCREEN == 1, na.rm=TRUE),
            "Enrolled, n(%) <sup>b</sup>" = paste0(sum(ENROLL == 1, na.rm=TRUE), 
                                        " (", format(sum(ENROLL == 1, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")")

) %>% 
      t() %>% unlist()
  ) 

# 
```

```{r}
#generate table by input data.frame and customize as needed. 
#example: tb_theme1(dataframe)
prisma_tab1 <- tb_theme1(tb_prescreen_enroll) %>% 
  tab_header(
    title = md("**PRISMA Table 1**")
  ) %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> Denominator is n pre-screened (MNH00 completed).</span>")
) %>%   
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Denominator is n screened (MNH02 completed).</span>")
)
```

```{r, out.width = '100%'}
prisma_tab1 <- prisma_tab1 %>% gtsave("prisma_tab1.png", expand = 10)
knitr::include_graphics("prisma_tab1.png")
```

\newpage

### Table 2: Cumulative pre-screened for PRISMA

*Value:* Distribution of total pre-screened since the launch of the harmonized PRISMA protocol. If ineligible based on pre-screening, distributions by exclusion reason are listed.

```{r}
## Cumulative Prescreening criteria 
# denominator: a = n all pre-screened 

tb_prescreen_all <- MatData_Screen_Enroll %>% 
  filter(PRESCREEN == 1) %>% 
  group_by(SITE) %>% 
  summarise("Pre-screened, n" = sum(PRESCREEN == 1, na.rm=TRUE),
            
            "Eligible based on pre-screen, n(%)^a^" = paste0(sum(PRESCR_ELIGIBLE == 1, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_ELIGIBLE == 1, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "No clinical signs of pregnancy" = paste0(sum(PRESCR_PREGSIGN == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_PREGSIGN == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Gestational age >=25 weeks" = paste0(sum(PRESCR_GA25 == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_GA25 == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Did not meet age requirement" = paste0(sum(PRESCR_AGE == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_AGE == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),

            "Outside catchment area" = paste0(sum(PRESCR_CATCHAREA == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_CATCHAREA == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Other reason^b^" = paste0(sum(PRESCR_OTHER == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_OTHER == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Did not consent" = paste0(sum(CONSENT_PRESCREEN== 0, na.rm = TRUE), 
                                        " (", format(sum(CONSENT_PRESCREEN == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")")
) %>% 
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "Total" = MatData_Screen_Enroll %>% 
  plyr::summarise("Pre-screened, n" = sum(PRESCREEN == 1, na.rm=TRUE),
            "Eligible based on pre-screen, n(%)^a^" = paste0(sum(PRESCR_ELIGIBLE == 1, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_ELIGIBLE == 1, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1,na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "No clinical signs of pregnancy" = paste0(sum(PRESCR_PREGSIGN == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_PREGSIGN == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Gestational age >=25 weeks" = paste0(sum(PRESCR_GA25 == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_GA25 == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Did not meet age requirement" = paste0(sum(PRESCR_AGE == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_AGE == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Outside catchment area" = paste0(sum(PRESCR_CATCHAREA == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_CATCHAREA == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Other reason^b^" = paste0(sum(PRESCR_OTHER == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_OTHER == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Did not consent" = paste0(sum(CONSENT_PRESCREEN== 0, na.rm = TRUE), 
                                        " (", format(sum(CONSENT_PRESCREEN == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")")
) %>% 
      t() %>% unlist()
  ) 



```

```{r}
prisma_tab2 <- tb_theme1(tb_prescreen_all) %>% 
  tab_header(
    title = md("**PRISMA Table 2**")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Pre-screening</span>"),
    rows = 1:2
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Reason for exclusion in pre-screening, n(%) <sup>a</sup></span>"),
    rows = 3:8
  ) %>%
  row_group_order(groups = c("<span style='font-size: 18px'>Pre-screening</span>",
                  "<span style='font-size: 18px'>Reason for exclusion in pre-screening, n(%) <sup>a</sup></span>")) %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> Denominator is n pre- screened (MNH00 completed).</span>")
) %>%   
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Other reasons for exclusion include: not feasible to collect the minimal required dataset, medical contraindication, comes from outside the catchment area, refusal to be screened, not interested, deferred, needs to seek spousal consent, or does not have time to proceed with enrollment process.</span>")
)
    
```

```{r, out.width = '100%'}
prisma_tab2 <- prisma_tab2 %>% gtsave("prisma_tab2.png", expand = 10)
knitr::include_graphics("prisma_tab2.png")
```

\newpage

### Figure 1: Reasons for exclusion in pre-screening for PRISMA

*Value:* Distribution by exclusion criteria among those who are ineligible in pre-screening are listed below. Each row should sum to 100%.

```{r, echo=FALSE}
### STACKED BAR CHART
total_bysite <- MatData_Screen_Enroll %>% 
  filter(PRESCREEN == 1 & PRESCREEN_DENOM == 1 & PRESCR_ELIGIBLE==0) %>% 
  select(SITE, PRESCR_PREGSIGN, PRESCR_GA25, PRESCR_AGE, PRESCR_CATCHAREA, PRESCR_OTHER,CONSENT_PRESCREEN) %>%
  rename( "No clinical signs of pregnancy" = PRESCR_PREGSIGN,
          "Gestational age >=25 weeks" = PRESCR_GA25,
          "Did not meet age requirement" = PRESCR_AGE,
          "Outside catchment area" = PRESCR_CATCHAREA,
          "Other reason" = PRESCR_OTHER,
          "Did not consent" = CONSENT_PRESCREEN,
           ) %>% 
  pivot_longer(-SITE) %>% 
  group_by(SITE, name) %>% 
  summarise(n = sum(value==0, na.rm = TRUE),
            n_pct = as.numeric(format(n/n()*100,digits = 2, nsmall=0)))


total_allsites <- MatData_Screen_Enroll %>% 
  filter(PRESCREEN == 1 & PRESCREEN_DENOM == 1 & PRESCR_ELIGIBLE==0) %>% 
  select(SITE, PRESCR_PREGSIGN, PRESCR_GA25, PRESCR_AGE, PRESCR_CATCHAREA, PRESCR_OTHER,CONSENT_PRESCREEN) %>%
  rename( "No clinical signs of pregnancy" = PRESCR_PREGSIGN,
          "Gestational age >=25 weeks" = PRESCR_GA25,
          "Did not meet age requirement" = PRESCR_AGE,
          "Outside catchment area" = PRESCR_CATCHAREA,
          "Other reason" = PRESCR_OTHER,
          "Did not consent" = CONSENT_PRESCREEN,
           ) %>% 
    pivot_longer(-SITE) %>% 
  group_by(name) %>% 
  summarise(n = sum(value==0, na.rm = TRUE),
            n_pct = as.numeric(format(n/n()*100,digits = 2, nsmall=0))) %>% 
  mutate(SITE ="Total")


total_inelg = MatData_Screen_Enroll %>% 
  filter(PRESCR_ELIGIBLE == 0) %>% 
  select(SITE, PRESCR_ELIGIBLE) %>% 
  group_by(SITE) %>% 
  summarise(n_ineligible = sum(PRESCR_ELIGIBLE==0, na.rm = TRUE)) 

barchart_data_out <- bind_rows(total_bysite, total_allsites) %>% 
  left_join(total_inelg, by = c("SITE")) %>% 
  mutate(n_ineligible = ifelse(row_number() == 1, n_ineligible, NA)) %>%
  ungroup()


desired_order <- unique(factor(barchart_data_out$SITE,
                        levels=rev(c("Total", "Ghana", "India-CMC", "India-SAS", "Kenya", "Pakistan", "Zambia"))))

desired_order2 <- unique(factor(barchart_data_out$name,
                        levels=c("No clinical signs of pregnancy",
                                "Gestational age >=25 weeks",
                                "Did not meet age requirement",
                                "Outside catchment area",
                                "Other reason",
                                "Did not consent")))

ggplot(barchart_data_out %>% mutate(SITE = factor(SITE, levels = desired_order)), 
       aes(fill = name, y = n_pct, x = SITE)) + 
geom_bar(position="stack", stat="identity") +
geom_text(aes(label = n_ineligible, x = SITE, y = n_pct+0.25), 
            position = position_stack(vjust = 1), hjust = 0.12, color = "black", size = 2.5) +
  coord_flip() +  
  scale_fill_manual(values = c("#b40e20","#0c775e", "#e2d300", "#47acc8", "#915F6D","#e58600"), ## 915F6D
                     labels = c("No clinical signs of pregnancy", "Gestational age >=25 weeks",
                                "Did not meet age requirement", "Outside catchment area",
                                "Other reason", "Did not consent"),
                    breaks=  c("No clinical signs of pregnancy", "Gestational age >=25 weeks",
                                "Did not meet age requirement", "Outside catchment area",
                                "Other reason", "Did not consent"),
                    name = NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0, vjust = 1),
        legend.position = "bottom",
        legend.direction	= "horizontal",
        panel.grid.minor = element_blank()) +
  xlab("") +
  ylab("Percentage") +
  ggtitle("") 



```

\newpage

### Table 3: Cumulative enrolled in PRISMA

*Value:* Distribution of cumulative enrollment and study progress distributions since the start of relaunch. If ineligible, distributions by exclusion criteria are listed below. Each column should sum to 100%.

```{r}

tb_enroll <- MatData_Screen_Enroll %>%
  group_by(SITE) %>%
  summarise("Screened, n" = sum(SCREEN == 1, na.rm=TRUE),
            "Missed screening, n^a^" = sum(PRESCR_ELIGIBLE ==1 & SCREEN == 0, na.rm = TRUE),
            "Enrolled, n(%)^b^" = paste0(sum(ENROLL == 1, na.rm=TRUE),
                                        " (", format(sum(ENROLL == 1, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            
              "Gestational age at enrollment, mean (SD)" = paste0(format(round(mean(US_GA_WKS_ENROLL, na.rm = TRUE),2), 
                                                        nsmall=0, digits = 2), " (",format(round(sd(US_GA_WKS_ENROLL, 
                                                            na.rm = TRUE),2), nsmall=0, digits = 2), ")"), 
              "Enrolled in 1st trimester, n(%)^c^" = paste0(sum(US_GA_WKS_ENROLL < 14, na.rm = TRUE)," (",
                          format(round(sum(US_GA_WKS_ENROLL < 14, na.rm = TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
    ")"),
          "Did not return for screening^d^" = paste0(sum(SCRN_RETURN == 0, na.rm=TRUE),
                             " (", format(sum(SCRN_RETURN == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            
          "Did not meet age requirement" = paste0(sum(AGE == 0, na.rm=TRUE),
                             " (", format(sum(AGE == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
          "Non-viable intrauterine pregnancy >=20 weeks gestation (confirmed via ultrasound)" = paste0(sum(GA20 == 0, na.rm=TRUE),
                                " (", format(sum(GA20 == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
          "Outside catchment area" = paste0(sum(CATCHAREA == 0, na.rm=TRUE),
                                   " (", format(sum(CATCHAREA == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
          "Doesn't plan to remain in catchment area" = paste0(sum(CATCHREMAIN == 0, na.rm=TRUE),
                                   " (", format(sum(CATCHREMAIN == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
          "Did not consent" = paste0(sum(CONSENT == 0, na.rm=TRUE),
                                  " (", format(sum(CONSENT == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")")
  ) %>%
    t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .before = 1,
    "Total" = MatData_Screen_Enroll %>%
  plyr::summarise("Screened for PRISMA (MNH02), n" = sum(SCREEN == 1, na.rm = TRUE),
            "Missed screening, n^a^" = sum(PRESCR_ELIGIBLE ==1 & SCREEN == 0, na.rm = TRUE),
            "Enrolled, n(%)^b^" = paste0(sum(ENROLL == 1, na.rm=TRUE),
                                        " (", format(sum(ENROLL == 1, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            
              "Gestational age at enrollment, mean (SD)" = paste0(format(round(mean(US_GA_WKS_ENROLL, na.rm = TRUE),2), 
                                                        nsmall=0, digits = 2), " (",format(round(sd(US_GA_WKS_ENROLL, 
                                                            na.rm = TRUE),2), nsmall=0, digits = 2), ")"), 
              "Enrolled in 1st trimester, n(%)^c^" = paste0(sum(US_GA_WKS_ENROLL < 14, na.rm = TRUE)," (",
                          format(round(sum(US_GA_WKS_ENROLL < 14, na.rm = TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
    ")"),
          "Did not return for screening^d^" = paste0(sum(SCRN_RETURN == 0, na.rm=TRUE),
                             " (", format(sum(SCRN_RETURN == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            
          "Did not meet age requirement" = paste0(sum(AGE == 0, na.rm=TRUE),
                             " (", format(sum(AGE == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
          "Non-viable intrauterine pregnancy >=20 weeks gestation (confirmed via ultrasound)" = paste0(sum(GA20 == 0, na.rm=TRUE),
                                " (", format(sum(GA20 == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
          "Outside catchment area" = paste0(sum(CATCHAREA == 0, na.rm=TRUE),
                                   " (", format(sum(CATCHAREA == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
          "Doesn't plan to remain in catchment area" = paste0(sum(CATCHREMAIN == 0, na.rm=TRUE),
                                   " (", format(sum(CATCHREMAIN == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),

          "Did not consent" = paste0(sum(CONSENT == 0, na.rm=TRUE),
                                  " (", format(sum(CONSENT == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")")
      ) %>%
      t() %>% unlist()
  )


## remove any NAs that may break the table codes: 
tb_enroll <- tb_enroll %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0")))
             

```

```{r}

prisma_tab3 <- tb_theme1(tb_enroll) %>% 
  tab_header(
    title = md("**PRISMA Table 3**")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Enrollment</span>"),
    rows = 1:5
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Reason not enrolled, n(%) <sup>b</sup></span>"),
    rows = 6:11
  ) %>%
  row_group_order(groups = c("<span style='font-size: 18px'>Enrollment</span>",
                  "<span style='font-size: 18px'>Reason not enrolled, n(%) <sup>b</sup></span>")) %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> n is number participants who met the eligibility criteria in MNH00 but do not have a screening form (MNH02).</span>")
) %>%   
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> denominator is n screened (MNH02 completed).</span>")
) %>% 
    tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> denominator is n enrolled.</span>")
) %>% 
    tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>d</sup> n is number of participants who responded 'No' to `SCRN_RETURN` in MNH02.</span>")
)
    
```

```{r, out.width = '100%'}
prisma_tab3 <- prisma_tab3 %>% gtsave("prisma_tab3.png", expand = 10)
knitr::include_graphics("prisma_tab3.png")

```

\newpage

### Figure 2: Reasons for exclusion in screening for PRISMA

*Value:* Distribution by exclusion criteria among those who are ineligible in screening are listed below. Each row should sum to 100%.

```{r, echo=FALSE}

### STACKED BAR CHART
total_bysite <- MatData_Screen_Enroll %>% 
  filter(SCREEN == 1 & SCREEN_DENOM == 1 & is.na(ENROLL)) %>% 
  select(SITE,SCRN_RETURN, AGE, GA20, CATCHAREA, CATCHREMAIN, CONSENT) %>%
  rename( "Did not return for screening" = SCRN_RETURN,
          "Did not meet age requirement" = AGE,
          "Non-viable intrauterine pregnancy >=20 weeks gestation (confirmed via ultrasound)" = GA20,
          "Outside catchment area" = CATCHAREA,
          "Doesn't plan to remain in catchment area" = CATCHREMAIN,
          "Did not consent" = CONSENT
           ) %>% 
  pivot_longer(-SITE) %>% 
  group_by(SITE, name) %>% 
  summarise(n = sum(value==0, na.rm = TRUE),
            n_pct = as.numeric(format(n/n()*100,digits = 2, nsmall=0))) 
 

total_allsites <- MatData_Screen_Enroll %>% 
  filter(SCREEN == 1 & SCREEN_DENOM == 1 & is.na(ENROLL)) %>% 
  select(SITE,SCRN_RETURN, AGE, GA20, CATCHAREA, CATCHREMAIN, CONSENT) %>%
  rename( "Did not return for screening" = SCRN_RETURN,
          "Did not meet age requirement" = AGE,
          "Non-viable intrauterine pregnancy >=20 weeks gestation (confirmed via ultrasound)" = GA20,
          "Outside catchment area" = CATCHAREA,
          "Doesn't plan to remain in catchment area" = CATCHREMAIN,
          "Did not consent" = CONSENT
           ) %>% 
  pivot_longer(-SITE) %>% 
  group_by(name) %>% 
  summarise(n = sum(value==0, na.rm = TRUE),
            n_pct = as.numeric(format(n/n()*100,digits = 2, nsmall=0))) %>% 
  mutate(SITE ="Total")


total_inelg = MatData_Screen_Enroll %>% 
  filter(is.na(ENROLL) & SCREEN_DENOM ==1) %>% 
  select(SITE, ENROLL) %>% 
  group_by(SITE) %>% 
  summarise(n_ineligible = sum(is.na(ENROLL))) 

barchart_data_out <- bind_rows(total_bysite, total_allsites) %>% 
  left_join(total_inelg, by = c("SITE")) %>% 
  mutate(n_ineligible = ifelse(row_number() == 1, n_ineligible, NA)) %>%
  ungroup()


desired_order <- unique(factor(barchart_data_out$SITE,
                        levels=rev(c("Total", "Ghana", "India-CMC", "India-SAS", "Kenya", "Pakistan", "Zambia"))))

desired_order2 <- unique(factor(barchart_data_out$name,
                          levels = c("Non-viable intrauterine pregnancy >=20 weeks gestation (confirmed via ultrasound)",
                                     "Did not return for screening",
                                     "Did not meet age requirement",
                                     "Outside catchment area",
                                     "Doesn't plan to remain in catchment area",
                                     "Did not consent")))

ggplot(barchart_data_out %>% mutate(SITE = factor(SITE, levels = desired_order)), 
       aes(fill = name, y = n_pct, x = SITE)) + 
  geom_bar(position="stack", stat="identity") +
  geom_text(aes(label = n_ineligible, x = SITE, y = n_pct+0.25), 
              position = position_stack(vjust = 1), hjust = 0.12, color = "black", size = 3) +
    coord_flip() +  
    scale_fill_manual(values = c("#b40e20", "#0c775e","#e2d300", "#47acc8","#915F6D", "#e58600"), #
                       labels = str_wrap(c("Non-viable intrauterine pregnancy >=20 weeks gestation (confirmed via ultrasound)",
                                           "Did not return for screening",
                                           "Did not meet age requirement", 
                                           "Outside catchment area",
                                           "Doesn't plan to remain in catchment area",
                                           "Did not consent"), width = 40), # Adjust the width as needed
                        breaks =  c("Non-viable intrauterine pregnancy >=20 weeks gestation (confirmed via ultrasound)",
                                           "Did not return for screening",
                                           "Did not meet age requirement", 
                                           "Outside catchment area",
                                           "Doesn't plan to remain in catchment area",
                                           "Did not consent"),
                        name = NULL,
                        guide = guide_legend(nrow = 3)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 0, vjust = 1),
          legend.position = "bottom",
          legend.direction	= "horizontal",
          panel.grid.minor = element_blank()) +
    xlab("") +
    ylab("Percentage") +
    ggtitle("") 

```

\newpage

### Figure 3a: Cumulative enrollment in PRISMA by site

*Value:* Track total enrollment by site each week since study launch.

```{r, echo=FALSE}

enroll_cum <- MatData_Screen_Enroll %>% 
  arrange("", by_group=START_DATE_MOM_WK) %>% 
  filter(ENROLL == 1 & !is.na(START_DATE_MOM_WK), 
         START_DATE_MOM_WK > dmy("21/09/2022"),
         START_DATE_MOM_WK <= UploadDate) %>% 
  group_by(SITE, START_DATE_MOM_WK) %>% 
  summarise(n = n()) %>% 
  mutate(cum_n = cumsum(n)) %>% 
  ungroup() 


# # New row with a new date
# new_row <- data.frame(
#   SITE = "ZZ",  # Adjust site name as needed
#   START_DATE_MOM_WK = as.Date(UploadDate) + days(14),  # Adjust the new date
#   n = 0,
#   cum_n = 0
# )

# make sure date in date class
enroll_cum$START_DATE_MOM_WK <- as.Date(as.POSIXct(enroll_cum$START_DATE_MOM_WK))
# confirm order of sites to coordinate with colors
enroll_cum$SITE <- factor(enroll_cum$SITE,
                          levels=c("Ghana", "India-CMC", "Kenya", "Pakistan", "Zambia","India-SAS")) #

ggplot() +
  geom_point(data = enroll_cum, aes(x = START_DATE_MOM_WK, y = cum_n, color = SITE), shape = 15) +
  geom_line(data = enroll_cum, aes(x = START_DATE_MOM_WK, y = cum_n, color = SITE)) +
  scale_x_date(date_breaks = "month", date_labels = ("%b"), 
               expand = c(0, 0)) +
  scale_color_manual(values = c("#F8766D", "#A3A500", "#00BF7D", "#00B0F6", "#E76BF3","orange"), #
                     labels = c("Ghana", "India-CMC", "Kenya", "Pakistan", "Zambia","India-SAS")) + #
  facet_grid(~year(START_DATE_MOM_WK), space = "free_x", scales = "free_x", switch= "x") + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0, vjust = 1),
        legend.position = "bottom",
        legend.direction	= "horizontal",
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),  # Remove primary x-axis label
        axis.text.y = element_text(size = 10), 
        strip.placement = "outside", 
        strip.background = element_rect(fill = NA, color = "grey"),
        panel.spacing = unit(0,"cm")) +
  xlab("Week") +
  ylab("Number of participants enrolled") +
  ggtitle("") 


# p <- ggplot() +
#   geom_point(data = enroll_cum, aes(x = START_DATE_MOM_WK, y = cum_n, color = SITE), shape = 15) +
#   geom_line(data = enroll_cum, aes(x = START_DATE_MOM_WK, y = cum_n, color = SITE)) +
#   scale_x_date(date_breaks = "month", date_labels = ("%b"), 
#                expand = c(0, 0)) +
#   scale_color_manual(values = c("#F8766D", "#A3A500", "#00BF7D", "#00B0F6", "#E76BF3", "white"),
#                      labels = c("Ghana", "India-CMC", "Kenya", "Pakistan", "Zambia", "")) +
#   facet_grid(~year(START_DATE_MOM_WK), space = "free_x", scales = "free_x", switch= "x") + 
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 0, vjust = 1),
#         legend.position = "bottom",
#         legend.direction	= "horizontal",
#         panel.grid.minor = element_blank(),
#         axis.title.x = element_blank(),  # Remove primary x-axis label
#         axis.text.y = element_text(size = 10), 
#         strip.placement = "outside", 
#         strip.background = element_rect(fill = NA, color = "grey"),
#         panel.spacing = unit(0,"cm")) +
#   xlab("Week") +
#   ylab("Number of participants enrolled") +
#   ggtitle("") 
# 
# 
# ggplot_build(p)$data
# # #F8766D (Ghana), #00BF7D (Kenya), #00B0F6 (Pakistan), #A3A500 (CMC), #E76BF3	(Zambia)
# 
```

\newpage

### Figure 3b: Cumulative actual versus expected enrollment in PRISMA by site

*Value:* Compare expected and actual enrollment for each site over time. Calculated by dividing the total target enrollment by 36 months to get the average enrollment per month over the course of three years (one year for India-SAS). We can further divide to get average enrollment per week.

```{r, echo=FALSE,out.width="49%",out.height="49%",fig.show='hold', fig.align='left'}

#****************
# Pakistan
#****************

enroll_cum_PA <- MatData_Screen_Enroll %>% 
  arrange("", by_group=START_DATE_MOM_WK) %>% 
  filter(SCREEN == 1 & SITE == "Pakistan" & !is.na(START_DATE_MOM_WK), 
         START_DATE_MOM_WK > dmy("21/09/2022")) %>% 
  group_by(START_DATE_MOM_WK) %>% 
  summarise(enroll_n=sum(ENROLL==1),
            expect_n=mean(EXPECT)) %>% 
  mutate(
  gap = as.numeric(ymd(START_DATE_MOM_WK)-lag(ymd(START_DATE_MOM_WK))),
  expect_n = case_when(
    gap <= 1 ~ expect_n,
    gap > 1 ~ expect_n*gap,
    is.na(gap) ~ expect_n
  )) %>% 
  mutate(expect_cum=cumsum(expect_n),
         enroll_cum=cumsum(enroll_n))%>% 
  ungroup() 

enroll_cum_PA$START_DATE_MOM_WK <- as.Date(as.POSIXct(enroll_cum_PA$START_DATE_MOM_WK))
# max_y will help us plot the year annotations on the figures
# max_y <- max(enroll_cum_PA$expect_cum) * 1.05
# 
# # midpoint will help us plot the year annotations on the figures
# midpoint <- enroll_cum_PA %>% 
#   mutate(year = year(START_DATE_MOM_WK)) %>% 
#   group_by(year) %>%
#   mutate(midpoint = min(START_DATE_MOM_WK) + as.numeric(difftime(max(START_DATE_MOM_WK), min(START_DATE_MOM_WK), units = "days"))/2,
#          midpoint_2023 = case_when(midpoint <= ymd("2023-12-31") ~ as.Date(midpoint),
#                                    TRUE ~NA),
#          midpoint_2024 = case_when(midpoint >= ymd("2024-01-01") ~ as.Date(midpoint),
#                                    TRUE ~NA))

enroll_cum_PA %>% 
  ggplot(aes(x = START_DATE_MOM_WK)) +
  geom_point(aes(y = expect_cum, color = "Expected"), shape = 15) +
  geom_point(aes(y = enroll_cum, color = "Enrolled"), shape = 15) +
  geom_line(aes(y = expect_cum, color = "Expected")) +
  geom_line(aes(y = enroll_cum, color = "Enrolled")) +
  geom_vline(xintercept = ymd("2024-01-01")) +
  geom_vline(xintercept = ymd("2023-01-01")) +
  scale_x_date(date_breaks = "month", date_labels = ("%b"), 
               expand = c(0, 0)) +
  scale_color_manual("",
                     breaks=c("Expected","Enrolled"),
                     values = c("orange", "royalblue1")) +
  # facet_grid(~year(START_DATE_MOM_WK), space = "free_x", scales = "free_x", switch= "x") + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0),
        legend.position="bottom",
        panel.grid.minor = element_blank(),
        strip.placement = "outside", 
        strip.background = element_rect(fill = NA, color = "grey"),
        panel.spacing = unit(0,"cm")) +
  xlab("Month") +
  ylab("Number of participants enrolled") +
  ggtitle("Pakistan") 

#****************
# Kenya
#****************

enroll_cum_KE <- MatData_Screen_Enroll %>% 
  arrange("", by_group=START_DATE_MOM_WK) %>% 
  filter(SCREEN == 1 & SITE == "Kenya" & !is.na(START_DATE_MOM_WK), 
         START_DATE_MOM_WK > dmy("20/11/2022")) %>% 
  group_by(START_DATE_MOM_WK) %>% 
  summarise(enroll_n=sum(ENROLL==1),
            expect_n=mean(EXPECT)) %>% 
  mutate(
  gap = as.numeric(ymd(START_DATE_MOM_WK)-lag(ymd(START_DATE_MOM_WK))),
  expect_n = case_when(
    gap <= 1 ~ expect_n,
    gap > 1 ~ expect_n*gap,
    is.na(gap) ~ expect_n
  )) %>% 
  mutate(expect_cum=cumsum(expect_n),
         enroll_cum=cumsum(enroll_n))%>% 
  ungroup() 

enroll_cum_KE$START_DATE_MOM_WK <- as.Date(as.POSIXct(enroll_cum_KE$START_DATE_MOM_WK))
# max_y will help us plot the year annotations on the figures
# max_y <- max(enroll_cum_KE$expect_cum) * 1.05
# 
# # midpoint will help us plot the year annotations on the figures
# midpoint <- enroll_cum_KE %>% 
#   mutate(year = year(START_DATE_MOM_WK)) %>% 
#   group_by(year) %>%
#   mutate(midpoint = min(START_DATE_MOM_WK) + as.numeric(difftime(max(START_DATE_MOM_WK), min(START_DATE_MOM_WK), units = "days"))/2,
#          midpoint_2023 = case_when(midpoint <= ymd("2023-12-31") ~ as.Date(midpoint),
#                                    TRUE ~NA),
#          midpoint_2024 = case_when(midpoint >= ymd("2024-01-01") ~ as.Date(midpoint),
#                                    TRUE ~NA))

enroll_cum_KE %>% 
  ggplot(aes(x = START_DATE_MOM_WK)) +
  geom_point(aes(y = expect_cum, color = "Expected"), shape = 15) +
  geom_point(aes(y = enroll_cum, color = "Enrolled"), shape = 15) +
  geom_line(aes(y = expect_cum, color = "Expected")) +
  geom_line(aes(y = enroll_cum, color = "Enrolled")) +
  geom_vline(xintercept = ymd("2024-01-01")) +
  geom_vline(xintercept = ymd("2023-01-01")) +
  scale_x_date(date_breaks = "month", date_labels = ("%b"), 
               expand = c(0, 0)) +
  scale_color_manual("",
                     breaks=c("Expected","Enrolled"),
                     values = c("orange", "royalblue1")) +
  # facet_grid(~year(START_DATE_MOM_WK), space = "free_x", scales = "free_x", switch= "x") + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0),
        legend.position="bottom",
        panel.grid.minor = element_blank(),
        strip.placement = "outside", 
        strip.background = element_rect(fill = NA, color = "grey"),
        panel.spacing = unit(0,"cm")) +
  xlab("Month") +
  ylab("Number of participants enrolled") +
  ggtitle("Kenya") 

#****************
# Ghana
#****************

enroll_cum_GA <- MatData_Screen_Enroll %>%
  arrange("", by_group=START_DATE_MOM_WK) %>%
  filter(SCREEN == 1 & SITE == "Ghana" & !is.na(START_DATE_MOM_WK),
         START_DATE_MOM_WK > dmy("01/01/2023")) %>%
  group_by(START_DATE_MOM_WK) %>%
  summarise(enroll_n=sum(ENROLL==1),
            expect_n=mean(EXPECT)) %>%
  mutate(
  gap = as.numeric(ymd(START_DATE_MOM_WK)-lag(ymd(START_DATE_MOM_WK))),
  expect_n = case_when(
    gap <= 1 ~ expect_n,
    gap > 1 ~ expect_n*gap,
    is.na(gap) ~ expect_n
  )) %>%
  mutate(expect_cum=cumsum(expect_n),
         enroll_cum=cumsum(enroll_n)) %>%
  ungroup()

enroll_cum_GA$START_DATE_MOM_WK <- as.Date(as.POSIXct(enroll_cum_GA$START_DATE_MOM_WK))
# # max_y will help us plot the year annotations on the figures
# max_y <- max(enroll_cum_GA$expect_cum) * 1.05
# 
# # midpoint will help us plot the year annotations on the figures
# midpoint <- enroll_cum_GA %>% 
#   mutate(year = year(START_DATE_MOM_WK)) %>% 
#   group_by(year) %>%
#   mutate(midpoint = min(START_DATE_MOM_WK) + as.numeric(difftime(max(START_DATE_MOM_WK), min(START_DATE_MOM_WK), units = "days"))/2,
#          midpoint_2023 = case_when(midpoint <= ymd("2023-12-31") ~ as.Date(midpoint),
#                                    TRUE ~NA),
#          midpoint_2024 = case_when(midpoint >= ymd("2024-01-01") ~ as.Date(midpoint),
#                                    TRUE ~NA))
enroll_cum_GA %>%
  ggplot(aes(x = START_DATE_MOM_WK)) +
  geom_point(aes(y = expect_cum, color = "Expected"), shape = 15) +
  geom_point(aes(y = enroll_cum, color = "Enrolled"), shape = 15) +
  geom_line(aes(y = expect_cum, color = "Expected")) +
  geom_line(aes(y = enroll_cum, color = "Enrolled")) +  
  geom_vline(xintercept = ymd("2024-01-01")) +
  scale_x_date(date_breaks = "month", date_labels = ("%b"), 
               expand = c(0, 0)) +
  scale_color_manual("",
                     breaks=c("Expected","Enrolled"),
                     values = c("orange", "royalblue1")) +
  # facet_grid(~year(START_DATE_MOM_WK), space = "free_x", scales = "free_x", switch= "x") + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0),
        legend.position="bottom",
        panel.grid.minor = element_blank(),
        strip.placement = "outside", 
        strip.background = element_rect(fill = NA, color = "grey"),
        panel.spacing = unit(0,"cm")) +
  xlab("Month") +
  ylab("Number of participants enrolled") +
  ggtitle("Ghana")

#****************
# Zambia
#****************

enroll_cum_ZA <- MatData_Screen_Enroll %>% 
  arrange("", by_group=START_DATE_MOM_WK) %>% 
  filter(SCREEN == 1 & SITE == "Zambia" & !is.na(START_DATE_MOM_WK), 
         START_DATE_MOM_WK > dmy("15/12/2022"), 
         START_DATE_MOM_WK <= UploadDate) %>% 
  group_by(START_DATE_MOM_WK) %>% 
  summarise(enroll_n=sum(ENROLL==1),
            expect_n=mean(EXPECT)) %>% 
  mutate(
  gap = as.numeric(ymd(START_DATE_MOM_WK)-lag(ymd(START_DATE_MOM_WK))),
  expect_n = case_when(
    gap <= 1 ~ expect_n,
    gap > 1 ~ expect_n*gap,
    is.na(gap) ~ expect_n
  )) %>% 
  mutate(expect_cum=cumsum(expect_n),
         enroll_cum=cumsum(enroll_n))%>% 
  ungroup() 

enroll_cum_ZA$START_DATE_MOM_WK <- as.Date(as.POSIXct(enroll_cum_ZA$START_DATE_MOM_WK))
# # max_y will help us plot the year annotations on the figures
# max_y <- max(enroll_cum_ZA$expect_cum) * 1.05
# 
# # midpoint will help us plot the year annotations on the figures
# midpoint <- enroll_cum_ZA %>% 
#   mutate(year = year(START_DATE_MOM_WK)) %>% 
#   group_by(year) %>%
#   mutate(midpoint = min(START_DATE_MOM_WK) + as.numeric(difftime(max(START_DATE_MOM_WK), min(START_DATE_MOM_WK), units = "days"))/2,
#          midpoint_2023 = case_when(midpoint <= ymd("2023-12-31") ~ as.Date(midpoint),
#                                    TRUE ~NA),
#          midpoint_2024 = case_when(midpoint >= ymd("2024-01-01") ~ as.Date(midpoint),
                                   # TRUE ~NA))

enroll_cum_ZA %>% 
  ggplot(aes(x = START_DATE_MOM_WK)) +
  geom_point(aes(y = expect_cum, color = "Expected"), shape = 15) +
  geom_point(aes(y = enroll_cum, color = "Enrolled"), shape = 15) +
  geom_line(aes(y = expect_cum, color = "Expected")) +
  geom_line(aes(y = enroll_cum, color = "Enrolled")) +
  geom_vline(xintercept = ymd("2024-01-01")) +
  geom_vline(xintercept = ymd("2023-01-01")) +
  scale_x_date(date_breaks = "month", date_labels = ("%b"), 
               expand = c(0, 0)) +
  scale_color_manual("",
                     breaks=c("Expected","Enrolled"),
                     values = c("orange", "royalblue1")) +
  # facet_grid(~year(START_DATE_MOM_WK), space = "free_x", scales = "free_x", switch= "x") + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0),
        legend.position="bottom",
        panel.grid.minor = element_blank(),
        strip.placement = "outside", 
        strip.background = element_rect(fill = NA, color = "grey"),
        panel.spacing = unit(0,"cm")) +
  xlab("Month") +
  ylab("Number of participants enrolled") +
  ggtitle("Zambia") 

#****************
# India CMC
#****************

enroll_cum_CMC <- MatData_Screen_Enroll %>% 
  arrange("", by_group=START_DATE_MOM_WK) %>% 
  filter(SCREEN == 1 & SITE == "India-CMC" & !is.na(START_DATE_MOM_WK), 
         START_DATE_MOM_WK > dmy("18/07/2023")) %>% 
  group_by(START_DATE_MOM_WK) %>% 
  summarise(enroll_n=sum(ENROLL==1),
            expect_n=mean(EXPECT)) %>% 
  mutate(
  gap = as.numeric(ymd(START_DATE_MOM_WK)-lag(ymd(START_DATE_MOM_WK))),
  expect_n = case_when(
    gap <= 1 ~ expect_n,
    gap > 1 ~ expect_n*gap,
    is.na(gap) ~ expect_n
  )) %>% 
  mutate(expect_cum=cumsum(expect_n),
         enroll_cum=cumsum(enroll_n))%>% 
  ungroup() 

enroll_cum_CMC$START_DATE_MOM_WK <- as.Date(as.POSIXct(enroll_cum_CMC$START_DATE_MOM_WK))
# max_y will help us plot the year annotations on the figures
# max_y <- max(enroll_cum_CMC$expect_cum) * 1.05
# 
# # midpoint will help us plot the year annotations on the figures
# midpoint <- enroll_cum_CMC %>% 
#   mutate(year = year(START_DATE_MOM_WK)) %>% 
#   group_by(year) %>%
#   mutate(midpoint = min(START_DATE_MOM_WK) + as.numeric(difftime(max(START_DATE_MOM_WK), min(START_DATE_MOM_WK), units = "days"))/2,
#          midpoint_2023 = case_when(midpoint <= ymd("2023-12-31") ~ as.Date(midpoint),
#                                    TRUE ~NA),
#          midpoint_2024 = case_when(midpoint >= ymd("2024-01-01") ~ as.Date(midpoint),
#                                    TRUE ~NA))

enroll_cum_CMC %>% 
  ggplot(aes(x = START_DATE_MOM_WK)) +
  geom_point(aes(y = expect_cum, color = "Expected"), shape = 15) +
  geom_point(aes(y = enroll_cum, color = "Enrolled"), shape = 15) +
  geom_line(aes(y = expect_cum, color = "Expected")) +
  geom_line(aes(y = enroll_cum, color = "Enrolled")) +
  geom_vline(xintercept = ymd("2024-01-01")) + 
  scale_x_date(date_breaks = "month", date_labels = ("%b"), 
               expand = c(0, 0)) +
  scale_color_manual("",
                     breaks=c("Expected","Enrolled"),
                     values = c("orange", "royalblue1")) +
  # facet_grid(~year(START_DATE_MOM_WK), space = "free_x", scales = "free_x", switch= "x") + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0),
        legend.position="bottom",
        panel.grid.minor = element_blank(),
        strip.placement = "outside", 
        strip.background = element_rect(fill = NA, color = "grey"),
        panel.spacing = unit(0,"cm")) +
  xlab("Month") +
  ylab("Number of participants enrolled") +
  ggtitle("India-CMC")  

#****************
# India SAS 
#****************

enroll_cum_SAS <- MatData_Screen_Enroll %>% 
  arrange("", by_group=START_DATE_MOM_WK) %>% 
  filter(SCREEN == 1 & SITE == "India-SAS" & !is.na(START_DATE_MOM_WK), 
         START_DATE_MOM_WK > dmy("01/12/2023")) %>% 
  group_by(START_DATE_MOM_WK) %>% 
  summarise(enroll_n=sum(ENROLL==1),
            expect_n=mean(EXPECT)) %>% 
  mutate(
  gap = as.numeric(ymd(START_DATE_MOM_WK)-lag(ymd(START_DATE_MOM_WK))),
  expect_n = case_when(
    gap <= 1 ~ expect_n,
    gap > 1 ~ expect_n*gap,
    is.na(gap) ~ expect_n
  )) %>% 
  mutate(expect_cum=cumsum(expect_n),
         enroll_cum=cumsum(enroll_n))%>% 
  ungroup() 

enroll_cum_SAS$START_DATE_MOM_WK <- as.Date(as.POSIXct(enroll_cum_SAS$START_DATE_MOM_WK))

# # max_y will help us plot the year annotations on the figures
# max_y <- max(enroll_cum_SAS$expect_cum) * 1.05
# 
# # midpoint will help us plot the year annotations on the figures
# midpoint <- enroll_cum_SAS %>% 
#   mutate(year = year(START_DATE_MOM_WK)) %>% 
#   group_by(year) %>%
#   mutate(midpoint = min(START_DATE_MOM_WK) + as.numeric(difftime(max(START_DATE_MOM_WK), min(START_DATE_MOM_WK), units = "days"))/2,
#          midpoint_2023 = case_when(midpoint <= ymd("2023-12-31") ~ as.Date(midpoint),
#                                    TRUE ~NA),
#          midpoint_2024 = case_when(midpoint >= ymd("2024-01-01") ~ as.Date(midpoint),
#                                    TRUE ~NA))

enroll_cum_SAS %>%
  ggplot(aes(x = START_DATE_MOM_WK)) +
  geom_point(aes(y = expect_cum, color = "Expected"), shape = 15) +
  geom_point(aes(y = enroll_cum, color = "Enrolled"), shape = 15) +
  geom_line(aes(y = expect_cum, color = "Expected")) +
  geom_line(aes(y = enroll_cum, color = "Enrolled")) +
  scale_x_date(date_breaks = "month", date_labels = ("%b"),
               expand = c(0, 0)) +
  scale_color_manual("",
                     breaks=c("Expected","Enrolled"),
                     values = c("orange", "royalblue1")) +
  # facet_grid(~year(START_DATE_MOM_WK), space = "free_x", scales = "free", switch= "x") +
  geom_vline(xintercept = ymd("2024-01-01")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0),
        legend.position="bottom",
        panel.grid.minor = element_blank(),
        strip.placement = "outside",
        strip.background = element_rect(fill = NA, color = "grey"),
        panel.spacing = unit(0,"cm")) +
  xlab("Month") +
  ylab("Number of participants enrolled") +
  ggtitle("India-SAS") 
  # geom_rect(aes(xmin = midpoint$midpoint_2023 - days(2), xmax = midpoint$midpoint_2023 + days(5), ymin = max_y - (max_y * 0.1) - 0.1, ymax = max_y), fill = "grey", color = NA, alpha = 0.5) +
  # annotate("text", x = midpoint$midpoint_2023, y = max_y-(max_y*.075), label = "2023", vjust = 0, hjust = 0) +
  # # annotate("text", x = midpoint$midpoint_2024-3, y = max_y-(max_y*.075), label = "2024", vjust = 0, hjust = 0) 
  # geom_rect(aes(xmin = midpoint$midpoint_2024 - days(5), xmax = midpoint$midpoint_2024 + days(2), ymin = max_y - (max_y * 0.1) - 0.1, ymax = max_y), fill = "grey", color = NA, alpha = 0.5) +
  # # annotate("text", x = midpoint$midpoint_2024-3, y = max_y-(max_y*.075), label = "2024", vjust = 0, hjust = 0) 
  # geom_text(aes(x = midpoint$midpoint_2024 - days(3), y = max_y - (max_y * 0.075), label = "2024"), vjust = 0, hjust = 0, color = "black", size = 4)


```

\newpage

### Table 4: Overview of PRISMA participant study status

*Value:* Distribution of current status among enrolled women. Each column should sum to 100%.

```{r}

tb_status <- MatData_Screen_Enroll %>% 
  filter(ENROLL == 1) %>% 
  group_by(SITE) %>% 
  summarise(
    "N" = paste0("(n=", sum(ENROLL==1, na.rm = TRUE), ")"),
    "Enrolled and ongoing" = paste0(sum(is.na(M23_CLOSE_DSDECOD)), 
                                        " (", format(sum(is.na(M23_CLOSE_DSDECOD))/sum(ENROLL_DENOM==1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Completed 1-year follow-up after live birth or stillbirth" = paste0(sum(M23_CLOSE_DSDECOD == 1, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 1, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Completed 42-day follow-up after spontaneous abortion (miscarriage) or induced abortion" = paste0(sum(M23_CLOSE_DSDECOD == 2, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 2, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Died before completion" = paste0(sum(M23_CLOSE_DSDECOD == 3, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 3, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Withdrew from study" = paste0(sum(M23_CLOSE_DSDECOD == 4, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 4, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Terminated from study" = paste0(sum(M23_CLOSE_DSDECOD == 5, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 5, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Lost to follow-up" = paste0(sum(M23_CLOSE_DSDECOD == 6, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 6, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")")
  ) %>% 
    t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "Total" = MatData_Screen_Enroll %>% 
      filter(ENROLL == 1) %>% 
  plyr::summarise(
    "N" = paste0("(n=", sum(ENROLL == 1, na.rm = TRUE), ")"),
    "Enrolled and ongoing" = paste0(sum(is.na(M23_CLOSE_DSDECOD)), 
                                        " (", format(sum(is.na(M23_CLOSE_DSDECOD))/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    
    "Completed 1-year follow-up after live birth or stillbirth" = paste0(sum(M23_CLOSE_DSDECOD == 1, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 1, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Completed 42-day follow-up after spontaneous abortion (miscarriage) or induced abortion" = paste0(sum(M23_CLOSE_DSDECOD == 2, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 2, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Died before completion" = paste0(sum(M23_CLOSE_DSDECOD == 3, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 3, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Withdrew from study" = paste0(sum(M23_CLOSE_DSDECOD == 4, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 4, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Terminated from study" = paste0(sum(M23_CLOSE_DSDECOD == 5, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 5, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Lost to follow-up" = paste0(sum(M23_CLOSE_DSDECOD == 6, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 6, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")")
      ) %>% 
      t() %>% unlist()
  ) 

```

```{r}

prisma_tab4 <- tb_theme1(tb_status) %>% 
  tab_header(
    title = md("**PRISMA Table 4**")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Participant study status, n(%)<sup>a</sup></span>"),
    rows = 2:8
  ) %>%
    row_group_order(groups = c(NA,
                  "<span style='font-size: 18px'>Participant study status, n(%)<sup>a</sup></span>")) %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> denominator is n enrolled.</span>")
) 
    
```

```{r}
prisma_tab4 <- prisma_tab4 %>% gtsave("prisma_tab4.png", expand = 10)
knitr::include_graphics("prisma_tab4.png")
```

\newpage

### Table 5: ANC and PNC visit completion for PRISMA

*Value:* Are forms completed for each visit? A visit is considered complete if the data reports the visit was conducted in person or by phone (variable name: MAT_VISIT_MNHXX ). If there is no late window for a visit, the on-time window is used.

*Goal:* 100% completion for enrollment; 90% completion for all other visits

*Numerator:* Any form with visit type = i (variable name: `TYPE_VISIT`) AND have a complete visit status (where variable name: `MAT_VISIT_MNHXX`=1 or 2) AND passed late window for visit type = i

*Denominator:* Passed late window for visit type = i AND (has not delivered OR delivered with gestational age \> late visit window) AND (has not closed out OR closed out with closeout date \> visit window)

```{r}
#* Num: Any form with visit type = i AND visit status = 1 or 2 & Passed window for visit type = i
#* Denom: Passed window for visit type = i

VISIT_COMPLETE_ANC <- Visit_Complete_Anc %>%
          rowwise() %>%
          group_by(SITE) %>%
          summarise(

      "Enrollment" = paste0(
        format(sum(VC_ENROLL_NUM_LATE == 1 & VC_ENROLL_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ENROLL_NUM_LATE == 1 & VC_ENROLL_DENOM_LATE==1, na.rm = TRUE)/sum(VC_ENROLL_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n" = paste0(
        format(sum(VC_ENROLL_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 20" = paste0(
        format(sum(VC_ANC20_NUM_LATE == 1 & VC_ANC20_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC20_NUM_LATE == 1  & VC_ANC20_DENOM_LATE==1, na.rm = TRUE)/sum(VC_ANC20_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n " = paste0(
        format(sum(VC_ANC20_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 28" = paste0(
        format(sum(VC_ANC28_NUM_LATE == 1 & VC_ANC28_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC28_NUM_LATE == 1 & VC_ANC28_DENOM_LATE==1, na.rm = TRUE)/sum(VC_ANC28_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n  " = paste0(
        format(sum(VC_ANC28_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 32" = paste0(
        format(sum(VC_ANC32_NUM_LATE == 1 & VC_ANC32_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC32_NUM_LATE == 1 & VC_ANC32_DENOM_LATE==1, na.rm = TRUE)/sum(VC_ANC32_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n   " = paste0(
        format(sum(VC_ANC32_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 36" = paste0(
        format(sum(VC_ANC36_NUM_LATE == 1 & VC_ANC36_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC36_NUM_LATE == 1 & VC_ANC36_DENOM_LATE==1, na.rm = TRUE)/sum(VC_ANC36_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n    " = paste0(
        format(sum(VC_ANC36_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        )
      ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Visit_Complete_Anc %>%
        plyr::summarise(

      "Enrollment" = paste0(
        format(sum(VC_ENROLL_NUM_LATE == 1 & VC_ENROLL_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ENROLL_NUM_LATE == 1 & VC_ENROLL_DENOM_LATE==1, na.rm = TRUE)/sum(VC_ENROLL_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n" = paste0(
        format(sum(VC_ENROLL_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 20" = paste0(
        format(sum(VC_ANC20_NUM_LATE == 1 & VC_ANC20_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC20_NUM_LATE == 1  & VC_ANC20_DENOM_LATE==1, na.rm = TRUE)/sum(VC_ANC20_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n " = paste0(
        format(sum(VC_ANC20_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 28" = paste0(
        format(sum(VC_ANC28_NUM_LATE == 1 & VC_ANC28_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC28_NUM_LATE == 1 & VC_ANC28_DENOM_LATE==1, na.rm = TRUE)/sum(VC_ANC28_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n  " = paste0(
        format(sum(VC_ANC28_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 32" = paste0(
        format(sum(VC_ANC32_NUM_LATE == 1 & VC_ANC32_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC32_NUM_LATE == 1 & VC_ANC32_DENOM_LATE==1, na.rm = TRUE)/sum(VC_ANC32_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n   " = paste0(
        format(sum(VC_ANC32_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 36" = paste0(
        format(sum(VC_ANC36_NUM_LATE == 1 & VC_ANC36_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC36_NUM_LATE == 1 & VC_ANC36_DENOM_LATE==1, na.rm = TRUE)/sum(VC_ANC36_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n    " = paste0(
        format(sum(VC_ANC36_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        )
        
      ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)


## PNC
VISIT_COMPLETE_PNC <- Visit_Complete_Pnc %>%
          rowwise() %>%
          group_by(SITE) %>%
          summarise(

      "PNC = 0" = paste0(
        format(sum(VC_PNC0_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC0_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC0_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n" = paste0(
        format(sum(VC_PNC0_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 1" = paste0(
        format(sum(VC_PNC1_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC1_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC1_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n " = paste0(
        format(sum(VC_PNC1_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 4" = paste0(
        format(sum(VC_PNC4_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC4_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC4_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n  " = paste0(
        format(sum(VC_PNC4_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 6" = paste0(
        format(sum(VC_PNC6_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC6_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC6_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n   " = paste0(
        format(sum(VC_PNC6_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 26" = paste0(
        format(sum(VC_PNC26_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC26_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC26_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n    " = paste0(
        format(sum(VC_PNC26_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 52" = paste0(
        format(sum(VC_PNC52_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC52_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC52_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n     " = paste0(
        format(sum(VC_PNC52_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        )
      ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Visit_Complete_Pnc %>%
        plyr::summarise(

      "PNC = 0" = paste0(
        format(sum(VC_PNC0_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC0_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC0_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n" = paste0(
        format(sum(VC_PNC0_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 1" = paste0(
        format(sum(VC_PNC1_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC1_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC1_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n " = paste0(
        format(sum(VC_PNC1_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 4" = paste0(
        format(sum(VC_PNC4_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC4_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC4_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n  " = paste0(
        format(sum(VC_PNC4_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 6" = paste0(
        format(sum(VC_PNC6_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC6_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC6_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n   " = paste0(
        format(sum(VC_PNC6_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 26" = paste0(
        format(sum(VC_PNC26_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC26_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC26_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n    " = paste0(
        format(sum(VC_PNC26_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 52" = paste0(
        format(sum(VC_PNC52_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC52_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC52_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n     " = paste0(
        format(sum(VC_PNC52_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        )
      ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

```

```{r}

table5 <- bind_rows(VISIT_COMPLETE_ANC,
          VISIT_COMPLETE_PNC) %>% 
    `rownames<-` (c(## anc (1-10)
                 "Enrollment (<20 wks)", ## NONE - SKIP WINDOW
                 "Denominator, n",
                 "ANC-20 (18 to 25 wks)",
                 "Denominator, n ",
                 "ANC-28 (26 to 30 wks)", ## NONE - SKIP WINDOW
                 "Denominator, n  ",
                 "ANC-32 (31 to 33 wks)", ## use on time windows
                 "Denominator, n   ",
                 "ANC-36 (34 wks to delivery)", ## use on time windows
                 "Denominator, n    ",
                 ## pnc (11-22)
                 "PNC-0 (3 to 5 days)", ## NONE - SKIP WINDOW
                 "Denominator, n     ",
                 "PNC-1 (7 to 14 days)", ## NONE - SKIP WINDOW
                 "Denominator, n      ",
                 "PNC-4 (28 to 35 days)", ## NONE - SKIP WINDOW
                 "Denominator, n       ",
                 "PNC-6 (8 to 12 wks)",
                 "Denominator, n        ",
                 "PNC-26 (29 to 39 wks)",
                 "Denominator, n^a^         ",
                 "PNC-52 (55 to 64 wks)",
                 "Denominator, n^a^          "
                 )
                ) %>% 
    mutate_all(funs(str_replace(., "NaN", "0"))) %>%
    mutate_all(funs(str_replace(., "NA", "0"))) %>% 
    mutate_at(vars(everything()), ~ifelse(is.na(.), "0 (0)", .))


table5_anc <- table5[c(1:10),]
table5_pnc <- table5[c(11:22),]

prisma_tab5_1 <- tb_theme1(table5_anc) %>% 
  tab_header(
    title = md("**PRISMA Table 5**"), 
    subtitle = md("*Continued on next page*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>ANC visits (late visit window)</span>"),
    rows = 1:10
  ) %>%
    row_group_order(groups = c("<span style='font-size: 18px'>ANC visits (late visit window)</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(indent = px(0))
        ),
      locations = cells_stub(rows = c('Enrollment (<20 wks)',
                 "ANC-20 (18 to 25 wks)",
                 "ANC-28 (26 to 30 wks)", ## NONE - SKIP WINDOW
                 "ANC-32 (31 to 33 wks)", ## use on time windows
                 "ANC-36 (34 wks to delivery)")) ## use on time windows
) %>% 
  tab_style(
      style = list(
        cell_text(indent = px(40))
        ),
      locations = cells_stub(rows = c('Denominator, n',
                 "Denominator, n ",
                 "Denominator, n  ",
                 "Denominator, n   ",
                 "Denominator, n    "))
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note</sup> passed late window denominators for all visits are calculated by EDD reported in MNH01 (US_EDD_BRTHDAT). If an EDD is missing, the participant is removed from this table.</span>")
) 

 
prisma_tab5_2 <- tb_theme1(table5_pnc) %>% 
  tab_header(
    title = md("**PRISMA Table 5**"),
    subtitle = md("*Continued*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC visits (late visit window)</span>"),
    rows = 1:12
  ) %>%
    row_group_order(groups = c("<span style='font-size: 18px'>PNC visits (late visit window)</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(indent = px(0))
        ),
      locations = cells_stub(rows = c(
                 "PNC-0 (3 to 5 days)", ## NONE - SKIP WINDOW
                 "PNC-1 (7 to 14 days)", ## NONE - SKIP WINDOW
                 "PNC-4 (28 to 35 days)", ## NONE - SKIP WINDOW
                 "PNC-6 (8 to 12 wks)",
                 "PNC-26 (29 to 39 wks)",
                 "PNC-52 (55 to 64 wks)"))
) %>% 
  tab_style(
      style = list(
        cell_text(indent = px(40))
        ),
      locations = cells_stub(rows = c(
                 "Denominator, n     ",
                 "Denominator, n      ",
                 "Denominator, n       ",
                 "Denominator, n        ",
                 "Denominator, n^a^         ",
                 "Denominator, n^a^          "))
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> excludes participants with a reported miscarriage `(FETAL_LOSS_DSDECOD==1 [MNH04])` who are only expected to have PNC0-6.</span>")
) 


```

```{r}
prisma_tab5_1 <- prisma_tab5_1 %>% gtsave("prisma_tab5_1.png")
knitr::include_graphics("prisma_tab5_1.png")

```

```{r}
prisma_tab5_2 <- prisma_tab5_2 %>% gtsave("prisma_tab5_2.png")
knitr::include_graphics("prisma_tab5_2.png")

```

\newpage

### Table 6: ANC protocol compliance for PRISMA

*Value:* Among women successfully contacted during the ANC period, percent who had all expected visit forms completed. A visit is considered `complete` if the data reports the visit was conducted in person or by phone (variable name: `MAT_VISIT_MNHXX`).

*Goal:* 100% completion for all forms, except MNH08 where lab results are expected to lag.

*Numerator:* By form: visit type = i (variable name: `TYPE_VISIT`) AND have a complete visit status (where variable name: `MAT_VISIT_MNHXX`=1 or 2) AND passed late window for visit type = i

*Denominator:* Any form with visit type = i (variable name: `TYPE_VISIT`) AND have a complete visit status (where variable name: `MAT_VISIT_MNHXX`=1 or 2) AND passed late window for visit type = i

```{r}
ga_tb <- MatData_Anc_Visits %>% 
  group_by(SITE) %>% 
  summarise(
  "total enrolled" = paste0(
    "(n=",sum(ENROLL_DENOM==1, na.rm = TRUE), ")"
  )
  ) %>% ungroup() %>% 
  t() %>% 
  as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "Total" = MatData_Anc_Visits %>%
 plyr::summarise(
     "total enrolled" = paste0(
    "(n=",sum(ENROLL_DENOM==1, na.rm = TRUE),")"
  )
  ) %>% 
      t() %>% as.data.frame() %>% unlist()
  ) 


ENROLLMENT <- Prot_Compliance_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
      "Denominator" = paste0(
        format(sum(PC_ENROLL_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
      
      "MNH01 Ultrasound" = paste0(
        format(sum(M01_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M01_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH02 Enrollment Status" = paste0(
        format(sum(ENROLL == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(ENROLL == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      "MNH03 Sociodemographic" = paste0(
        format(sum(M03_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M03_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Anc %>% 
        plyr::summarise(
          
      "Denominator" = paste0(
        format(sum(PC_ENROLL_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH01 Ultrasound" = paste0(
        format(sum(M01_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M01_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH02 Enrollment Status" = paste0(
        format(sum(ENROLL == 1& ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(ENROLL == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH03 Sociodemographic" = paste0(
        format(sum(M03_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M03_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>% 
        t() %>% 
        as.data.frame() %>% 
      `colnames<-`(c(.[1,])) %>% unlist() 
)

ANC20 <- Prot_Compliance_Anc %>% 
    filter(US_GA_WKS_ENROLL <= 17) %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(

    "Denominator" = paste0(
        format(sum(PC_ANC20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
        
    # "MNH01 Ultrasound (optional)" = paste0(
    #     format(sum(M01_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
    #     " (",
    #     format(round(sum(M01_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
    #     ")"),
    
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
       "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
    ) %>%
    t() %>% 
    as.data.frame() %>%    
        `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
    add_column(
      .before = 1,
      "Total" = Prot_Compliance_Anc %>%
      filter(US_GA_WKS_ENROLL <= 17) %>% 
        plyr::summarise(
          
      "Denominator" = paste0(
        format(sum(PC_ANC20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
          
      # "MNH01 Ultrasound (optional)" = paste0(
      #   format(sum(M01_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(M01_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")"),
    
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
      ) %>%
        
        t() %>% as.data.frame() %>% unlist() 
)

ANC28 <- Prot_Compliance_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
      
      "Denominator" = paste0(
        format(sum(PC_ANC28_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
        
       # "MNH01 Ultrasound (optional)" = paste0(
       #  format(sum(M01_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(M01_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% `colnames<-`(c(.[1,]))  %>% as.data.frame() %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Anc %>% 
        plyr::summarise(
          
      "Denominator" = paste0(
        format(sum(PC_ANC28_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

       # "MNH01 Ultrasound (optional)" = paste0(
       #  format(sum(M01_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(M01_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>% 
        t() %>% `colnames<-`(c(.[1,])) %>% 
        as.data.frame() %>% unlist() 
)

ANC32 <- Prot_Compliance_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
    
  "Denominator" = paste0(
        format(sum(PC_ANC32_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
        
   "MNH01 Ultrasound" = paste0(
        format(sum(M01_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M01_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
  ) %>%

  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,]))  %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Anc %>% 
        plyr::summarise(
          
  "Denominator" = paste0(
        format(sum(PC_ANC32_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
        
    "MNH01 Ultrasound" = paste0(
        format(sum(M01_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M01_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
  
  ) %>%

        t() %>% 
        as.data.frame() %>% 
      `colnames<-`(c(.[1,])) %>%  unlist() 
)

ANC36 <- Prot_Compliance_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
                
       "Denominator" = paste0(
        format(sum(PC_ANC36_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
  
       # "MNH01 Ultrasound (optional)" = paste0(
       #  format(sum(M01_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(M01_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")"),


      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% `colnames<-`(c(.[1,]))  %>% as.data.frame() %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Anc %>% 
        plyr::summarise(
          
       "Denominator" = paste0(
        format(sum(PC_ANC36_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
          
       # "MNH01 Ultrasound (optional)" = paste0(
       #  format(sum(M01_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(M01_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
        t() %>% `colnames<-`(c(.[1,])) %>% 
        as.data.frame() %>% unlist() 
)

```

```{r}

prot_compliance_anc <- bind_rows(ga_tb, 
          ENROLLMENT, 
          ANC20,
          ANC28, 
          ANC32, 
          ANC36
          ) %>% 
  `rownames<-`(c("N",
                 ## ANCLESS20 (2-10) 2-10
                 "Denominator, n^a^",
                 "MNH01 Ultrasound", 
                 "MNH02 Enrollment Status", 
                 "MNH03 Sociodemographic", 
                 "MNH04 ANC Clinical Status",
                 "MNH05 Maternal Anthro",
                 "MNH06 Maternal POC",
                 "MNH07 Maternal Specimen",
                 "MNH08 Maternal Lab",
                 ## ANC20 (11-16) 11-17
                 "Denominator, n^b^ ",                 
                # "MNH01 Ultrasound (optional) ",
                 "MNH04 ANC Clinical Status ",
                 "MNH05 Maternal Anthro ",
                 "MNH06 Maternal POC ",
                 "MNH07 Maternal Specimen ",
                 "MNH08 Maternal Lab ",
                 ## ANC28 (17-22) 18-24
                 "Denominator, n^c^  ",                 
                # "MNH01 Ultrasound (optional)  ",
                 "MNH04 ANC Clinical Status  ",
                 "MNH05 Maternal Anthro  ",
                 "MNH06 Maternal POC  ",
                 "MNH07 Maternal Specimen  ",
                 "MNH08 Maternal Lab  ",
                 ## ANC32 (23-29) 25-31
                 "Denominator, n^d^   ",                 
                 "MNH01 Ultrasound   ",
                 "MNH04 ANC Clinical Status   ",
                 "MNH05 Maternal Anthro   ",
                 "MNH06 Maternal POC   ",
                 "MNH07 Maternal Specimen   ",
                 "MNH08 Maternal Lab   ",
                 ##ANC36 (30-35) 32-38
                 "Denominator, n^e^    ",                 
               #  "MNH01 Ultrasound (optional)    ",
                 "MNH04 ANC Clinical Status    ",
                 "MNH05 Maternal Anthro    ",
                 "MNH06 Maternal POC    ",
                 "MNH07 Maternal Specimen    ",
                 "MNH08 Maternal Lab    "
                 )
               )  %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0"))) 


table6_1 <- prot_compliance_anc[c(1:16),]
table6_2 <- prot_compliance_anc[c(1,17:35),]

## PART 1
prisma_tab6_1 <- tb_theme1(table6_1) %>% 
  tab_header(
    title = md("**PRISMA Table 6** *(continued on next page)*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Enrollment visit, n(%)<sup>a</sup> [Target window: <20wks]</span>"),
    rows = 2:10
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>ANC-20 visit, n(%)<sup>b</sup> [Target window: 18 to 25wks]</span>"),
    rows = 11:16
  ) %>%
    row_group_order(groups = c(NA,
                               "<span style='font-size: 18px'>Enrollment visit, n(%)<sup>a</sup> [Target window: <20wks]</span>",
                               "<span style='font-size: 18px'>ANC-20 visit, n(%)<sup>b</sup> [Target window: 18 to 25wks]</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c("Denominator, n^a^",
                                      "Denominator, n^b^ "))
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> denominator is n completed any form with visit status=complete AND visit type=Enrollment AND passed late window with >=19 weeks gestation.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> denominator is n completed any form with visit status=complete AND visit type=ANC-20 AND passed late window with >25 weeks gestation.</span>")
) 

## PART 2
prisma_tab6_2 <- tb_theme1(table6_2) %>% 
  tab_header(
    title = md("**PRISMA Table 6** *(continued)*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>ANC-28 visit, n(%)<sup>c</sup> [Target window: 26 to 30wks]</span>"),
    rows = 2:7
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>ANC-32 visit, n(%)<sup>d</sup> [Target window: 31 to 33wks]</span>"),
    rows = 8:14
  ) %>%
 tab_row_group(
    label = html("<span style='font-size: 18px'>ANC-36 visit, n(%)<sup>e</sup> [Target window: 34 to 38wks]</span>"),
    rows = 15:20
  ) %>%
    row_group_order(groups = c(NA,
                               "<span style='font-size: 18px'>ANC-28 visit, n(%)<sup>c</sup> [Target window: 26 to 30wks]</span>",
                               "<span style='font-size: 18px'>ANC-32 visit, n(%)<sup>d</sup> [Target window: 31 to 33wks]</span>", 
                               "<span style='font-size: 18px'>ANC-36 visit, n(%)<sup>e</sup> [Target window: 34 to 38wks]</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c("Denominator, n^c^  ",
                                      "Denominator, n^d^   ",
                                      "Denominator, n^e^    "))
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> denominator is n completed any form with visit status=complete ANDvisit type=ANC-28  AND passed late window with >30 weeks gestation.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>d</sup> denominator is n completed any form with visit status=complete AND visit type=ANC-32  AND passed late window with>33 weeks gestation.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>e</sup> denominator is n completed any form with visit status=complete AND visit type=ANC-36  AND passed late window with >38 weeks gestation.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note:</sup> Passed window denominators for all visits are calculated by EDD reported in MNH01 (US_EDD_BRTHDAT). If an EDD is missing, the participant is removed from this table.</span>")
) 

```

```{r}
prisma_tab6_1 <- prisma_tab6_1 %>% gtsave("prisma_tab6_1.png")
knitr::include_graphics("prisma_tab6_1.png")
```

```{r}
prisma_tab6_2 <- prisma_tab6_2 %>% gtsave("prisma_tab6_2.png")
knitr::include_graphics("prisma_tab6_2.png")
```

\newpage

### Table 7: ANC form completion for PRISMA

*Value:* Among women who have passed the late ANC window period, percent with forms completed regardless of visit status. A form is considered complete when a form has been submitted for a participant.

*Goal:* 100% completion for all forms, except MNH08 where lab results are expected to lag.

*Numerator:* By form: visit type = i (variable name: `TYPE_VISIT`) AND have any visit status (variable name: `MAT_VISIT_MNHXX`) AND passed late window for visit type = i

*Denominator:* Any form with visit type = i (variable name: `TYPE_VISIT`) AND have any visit status (variable name: `MAT_VISIT_MNHXX`) AND passed late window for visit type = i

```{r}
# Participants are included in the numerator of this table if, for each form, they have visit type = i AND have any visit status AND passed window for visit type = 1. Participants  are included Visit status is defined by MAT_VISIT_MNHxx variables in each form.*
ga_tb <- MatData_Anc_Visits %>% 
  group_by(SITE) %>% 
  summarise(
  "total enrolled" = paste0(
    "(n=",sum(ENROLL==1, na.rm=TRUE), ")"
  )
  ) %>% ungroup() %>% 
  t() %>% 
  as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "Total" = MatData_Anc_Visits %>%
 plyr::summarise(
     "total enrolled" = paste0(
    "(n=",sum(ENROLL==1, na.rm=TRUE),")"
  )) %>% 
      t() %>% as.data.frame() %>% unlist()
  ) 



## ENROLLMENT
ENROLLMENT <- Form_Completion_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
      "Denominator" = paste0(
        format(sum(FC_ENROLL_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH01 Ultrasound" = paste0(
        format(sum(!is.na(M01_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M01_VISIT_COMPLETE_1)& ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH02 Enrollment Status" = paste0(
        format(sum(ENROLL == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(ENROLL == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      "MNH03 Sociodemographic" = paste0(
        format(sum(!is.na(M03_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M03_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "Total" = Form_Completion_Anc %>% 
        plyr::summarise(
        
      "Denominator" = paste0(
        format(sum(FC_ENROLL_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),  
      
      "MNH01 Ultrasound" = paste0(
        format(sum(!is.na(M01_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M01_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH02 Enrollment Status" = paste0(
        format(sum(ENROLL == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(ENROLL == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH03 Sociodemographic" = paste0(
        format(sum(!is.na(M03_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M03_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>% 
        t() %>% 
        as.data.frame() %>% 
      `colnames<-`(c(.[1,])) %>% unlist() 
)

## ANC20
ANC20 <- Form_Completion_Anc %>% 
    filter(US_GA_WKS_ENROLL <= 17) %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
      
    "Denominator" = paste0(
        format(sum(FC_ANC20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 
      
    # "MNH01 Ultrasound (optional)" = paste0(
    #     format(sum(!is.na(M01_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
    #     " (",
    #     format(round(sum(!is.na(M01_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
    #     ")"),
    
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
       "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")

      # "MNH25 Maternal Depression" = paste0(
      #   format(sum(!is.na(M25_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(!is.na(M25_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")")

       # "MNH26 Maternal Fatigue" = paste0(
       #  format(sum(!is.na(M26_VISIT_COMPLETE_2)  & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(!is.na(M26_VISIT_COMPLETE_2)  & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")")
    
    ) %>%
    t() %>% 
    as.data.frame() %>%    
        `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
    add_column(
      .before = 1,
      "Total" = Form_Completion_Anc %>% 
      filter(US_GA_WKS_ENROLL <= 17) %>% 
        plyr::summarise(
                
    "Denominator" = paste0(
        format(sum(FC_ANC20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 
    
      # "MNH01 Ultrasound (optional)" = paste0(
      #   format(sum(!is.na(M01_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(!is.na(M01_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")"),
    
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")

      # "MNH25 Maternal Depression" = paste0(
      #   format(sum(!is.na(M25_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(!is.na(M25_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")")

       # "MNH26 Maternal Fatigue" = paste0(
       #  format(sum(!is.na(M26_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(!is.na(M26_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")")
    ) %>%
        
        t() %>% as.data.frame() %>% unlist() 
)

## ANC28
ANC28 <- Form_Completion_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
            
    "Denominator" = paste0(
        format(sum(FC_ANC28_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 
    
       # "MNH01 Ultrasound (optional)" = paste0(
       #  format(sum(!is.na(M01_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(!is.na(M01_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% `colnames<-`(c(.[1,]))  %>% as.data.frame() %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "Total" = Form_Completion_Anc %>% 
        plyr::summarise(
                      
    "Denominator" = paste0(
        format(sum(FC_ANC28_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 

       # "MNH01 Ultrasound (optional)" = paste0(
       #  format(sum(!is.na(M01_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(!is.na(M01_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>% 
        t() %>% `colnames<-`(c(.[1,])) %>% 
        as.data.frame() %>% unlist() 
)

## ANC32
ANC32 <- Form_Completion_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
                  
    "Denominator" = paste0(
        format(sum(FC_ANC32_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 
      
   "MNH01 Ultrasound" = paste0(
        format(sum(!is.na(M01_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M01_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
      
      # "MNH25 Maternal Lab" = paste0(
      #   format(sum(!is.na(M25_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(!is.na(M25_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")")
      
      # "MNH26 Maternal Fatigue" = paste0(
      #   format(sum(!is.na(M26_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(!is.na(M26_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")")
   ) %>%

  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,]))  %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "Total" = Form_Completion_Anc %>% 
        plyr::summarise(
                            
    "Denominator" = paste0(
        format(sum(FC_ANC32_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 

    "MNH01 Ultrasound" = paste0(
        format(sum(!is.na(M01_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M01_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
      # "MNH25 Maternal Lab" = paste0(
      #   format(sum(!is.na(M25_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(!is.na(M25_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")")
      
      # "MNH26 Maternal Fatigue" = paste0(
      #   format(sum(!is.na(M26_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(!is.na(M26_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")")
    ) %>%

        t() %>% 
        as.data.frame() %>% 
      `colnames<-`(c(.[1,])) %>%  unlist() 
)

## ANC36
ANC36 <- Form_Completion_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
                        
    "Denominator" = paste0(
        format(sum(FC_ANC36_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 
      
       # "MNH01 Ultrasound (optional)" = paste0(
       #  format(sum(!is.na(M01_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(!is.na(M01_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")"),


      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% `colnames<-`(c(.[1,]))  %>% as.data.frame() %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "Total" = Form_Completion_Anc %>% 
        plyr::summarise(
                            
    "Denominator" = paste0(
        format(sum(FC_ANC36_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 
          
       # "MNH01 Ultrasound (optional)" = paste0(
       #  format(sum(!is.na(M01_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(!is.na(M01_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")"),
       # 
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
     
       "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
        t() %>% `colnames<-`(c(.[1,])) %>% 
        as.data.frame() %>% unlist() 
)


```

```{r}

form_completion_anc <- bind_rows(ga_tb, 
          ENROLLMENT, 
          ANC20,
          ANC28, 
          ANC32, 
          ANC36
          ) %>% 
  `rownames<-`(c("N",
                 ## ANCLESS20 (2-10)
                 "Denominator, n",
                 "MNH01 Ultrasound", 
                 "MNH02 Enrollment Status", 
                 "MNH03 Sociodemographic", 
                 "MNH04 ANC Clinical Status",
                 "MNH05 Maternal Anthro",
                 "MNH06 Maternal POC",
                 "MNH07 Maternal Specimen",
                 "MNH08 Maternal Lab",
                 ## ANC20 (11-16)
                 "Denominator, n ",
                # "MNH01 Ultrasound (optional) ",
                 "MNH04 ANC Clinical Status ",
                 "MNH05 Maternal Anthro ",
                 "MNH06 Maternal POC ",
                 "MNH07 Maternal Specimen ",
                 "MNH08 Maternal Lab ",
                 # "MNH25 Maternal Depression ",
                 #"MNH26 Maternal Fatigue^1^ ",
                 ## ANC28 (17-22)
                 "Denominator, n  ",
                # "MNH01 Ultrasound (optional)  ",
                 "MNH04 ANC Clinical Status  ",
                 "MNH05 Maternal Anthro  ",
                 "MNH06 Maternal POC  ",
                 "MNH07 Maternal Specimen  ",
                 "MNH08 Maternal Lab  ",
                 ## ANC32 (23-29)
                 "Denominator, n   ",
                 "MNH01 Ultrasound   ",
                 "MNH04 ANC Clinical Status   ",
                 "MNH05 Maternal Anthro   ",
                 "MNH06 Maternal POC   ",
                 "MNH07 Maternal Specimen   ",
                 "MNH08 Maternal Lab   ",
                 # "MNH25 Maternal Depression   ",
                 #"MNH26 Maternal Fatigue^1^   ",
                 ##ANC36 (30-35)
                 "Denominator, n    ",
                # "MNH01 Ultrasound (optional)    ",
                 "MNH04 ANC Clinical Status    ",
                 "MNH05 Maternal Anthro    ",
                 "MNH06 Maternal POC    ",
                 "MNH07 Maternal Specimen    ",
                 "MNH08 Maternal Lab    "
                 )
               )  %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0"))) 


table7_1 <- form_completion_anc[c(1:16),]
table7_2 <- form_completion_anc[c(1,17:35),]

## PART 1
prisma_tab7_1 <- tb_theme1(table7_1) %>% 
  tab_header(
    title = md("**PRISMA Table 7** *(continued on next page)*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Enrollment visit, n(%)<sup>a</sup> [Target window: <20wks]</span>"),
    rows = 2:10
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>ANC-20 visit, n(%)<sup>b</sup> [Target window: 18 to 25wks]</span>"),
    rows = 11:16
  ) %>%
    row_group_order(groups = c(NA,
                               "<span style='font-size: 18px'>Enrollment visit, n(%)<sup>a</sup> [Target window: <20wks]</span>",
                               "<span style='font-size: 18px'>ANC-20 visit, n(%)<sup>b</sup> [Target window: 18 to 25wks]</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c("Denominator, n",
                                      "Denominator, n "))
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> denominator is n completed any form with any visit status AND visit type=Enrollment AND passed late window with >=19 weeks gestation.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> denominator is n completed any form with any visit status AND visit type=ANC-20 AND passed late window with >=22 weeks gestation.</span>")
) 

## PART 2
prisma_tab7_2 <- tb_theme1(table7_2) %>% 
  tab_header(
    title = md("**PRISMA Table 7** *(continued)*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>ANC-28 visit, n(%)<sup>c</sup> [Target window: 26 to 30wks]</span>"),
    rows = 2:7
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>ANC-32 visit, n(%)<sup>d</sup> [Target window: 31 to 33wks]</span>"),
    rows = 8:14
  ) %>%
 tab_row_group(
    label = html("<span style='font-size: 18px'>ANC-36 visit, n(%)<sup>e</sup> [Target window: 34 to 38wks]</span>"),
    rows = 15:20
  ) %>%
    row_group_order(groups = c(NA,
                               "<span style='font-size: 18px'>ANC-28 visit, n(%)<sup>c</sup> [Target window: 26 to 30wks]</span>",
                               "<span style='font-size: 18px'>ANC-32 visit, n(%)<sup>d</sup> [Target window: 31 to 33wks]</span>", 
                               "<span style='font-size: 18px'>ANC-36 visit, n(%)<sup>e</sup> [Target window: 34 to 38wks]</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c("Denominator, n  ",
                                      "Denominator, n   ",
                                      "Denominator, n    "))
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> denominator is n completed any form with any visit status AND visit type=ANC-28 AND passed late window with >30 weeks gestation.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>d</sup> denominator is n completed any form with any visit status AND visit type=ANC-32 AND passed late window with>33 weeks gestation.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>e</sup> denominator is n completed any form with any visit status AND visit type=ANC-36 AND passed late window with >38 weeks gestation.</span>")
) 

```

```{r}
prisma_tab7_1 <- prisma_tab7_1 %>% gtsave("prisma_tab7_1.png")
knitr::include_graphics("prisma_tab7_1.png")

```

```{r}
prisma_tab7_2 <- prisma_tab7_2 %>% gtsave("prisma_tab7_2.png")
knitr::include_graphics("prisma_tab7_2.png")

```

\newpage

### Table 8: IPC visit completion and PRISMA protocol compliance for IPC

*Value:* Among women successfully contacted during the IPC period, percent who have expected visit forms completed. A visit is considered `complete` if the data reports the visit was conducted in person or by phone (variable name: `MAT_VISIT_MNHXX`).

```{r}

# row 1: among people with a passed window how many have an mnh09 OR mnh10 OR mnh11
# row 2: among people WITH either an 09/10/11 how many have mnh09 complete 
# row 3: among people WITH either an 09/10/11 how many have mnh10 complete 
# row 4: among people WITH either an 09/10/11 how many have mnh11 complete 

IPC_Total <- MatData_Ipc_Visits_Mat %>%
  group_by(SITE) %>%
  summarise(
    
  ## VISIT COMPLETION: 
      # NUM: have MNH09 or MNH10 or MNH11 with a complete visit status (variable name: `MAT_VISIT_MNHXX`).   
      # DENOM: denominator is n completed MNH09 or MNH10 or MNH11 with a complete visit status (variable name: `MAT_VISIT_MNHXX`) OR passed on-time window with >42 weeks gestation OR closed out (lost to followup, withdrew, investigator terminated participation).

    "IPC" = paste0(
      format(sum(ANY_TYPE_VISIT_COMPLETE_6 == 1 & IPC_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANY_TYPE_VISIT_COMPLETE_6 == 1 & IPC_DENOM==1, na.rm = TRUE)/sum(IPC_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "total passed ipc period" = paste0(
      format(sum(IPC_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2))
    
    
  ) %>%
  
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>% 
      add_column(
      .before = 1,
      "Total" = MatData_Ipc_Visits_Mat %>%
        plyr::summarise(
          
  ## VISIT COMPLETION: 
      # NUM: have MNH09 or MNH10 or MNH11 with a complete visit status (variable name: `MAT_VISIT_MNHXX`).   
      # DENOM: denominator is n completed MNH09 or MNH10 or MNH11 with a complete visit status (variable name: `MAT_VISIT_MNHXX`) OR passed on-time window with >42 weeks gestation.

    "IPC" = paste0(
      format(sum(ANY_TYPE_VISIT_COMPLETE_6 == 1 & IPC_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANY_TYPE_VISIT_COMPLETE_6 == 1 & IPC_DENOM==1, na.rm = TRUE)/sum(IPC_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "total passed ipc period" = paste0(
      format(sum(IPC_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2))
  ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

IPC_Prot_Comp_Mat <- MatData_Ipc_Visits_Compliance_Mat %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(
    
  ## PROTOCOL COMPLIANCE: 
    # NUM: have a complete visit status (variable name: `MAT_VISIT_MNHXX`).
    # DENOM: n completed MNH09 or MNH10 or MNH11 with visit status=complete.
    
    "MNH09" = paste0(
      format(sum(M09_VISIT_COMPLETE_6==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(M09_VISIT_COMPLETE_6==1, na.rm = TRUE)/sum(ANY_TYPE_VISIT_COMPLETE_6==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "MNH10" = paste0(
      format(sum(M10_VISIT_COMPLETE_6==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(M10_VISIT_COMPLETE_6==1, na.rm = TRUE)/sum(ANY_TYPE_VISIT_COMPLETE_6==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")
  ) %>%
  
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>% 
      add_column(
      .before = 1,
      "Total" = MatData_Ipc_Visits_Compliance_Mat %>%
        plyr::summarise(

  ## PROTOCOL COMPLIANCE: 
    # NUM: have a complete visit status (variable name: `MAT_VISIT_MNHXX`).
    # DENOM: n completed MNH09 or MNH10 or MNH11 with visit status=complete.
    
    "MNH09" = paste0(
      format(sum(M09_VISIT_COMPLETE_6==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(M09_VISIT_COMPLETE_6==1, na.rm = TRUE)/sum(ANY_TYPE_VISIT_COMPLETE_6==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "MNH10" = paste0(
      format(sum(M10_VISIT_COMPLETE_6==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(M10_VISIT_COMPLETE_6==1, na.rm = TRUE)/sum(ANY_TYPE_VISIT_COMPLETE_6==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")
  ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

IPC_Prot_Comp_Inf <- MatData_Ipc_Visits_Compliance_Inf %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(
    
  ## PROTOCOL COMPLIANCE: 
    # NUM: have a complete visit status (variable name: `MAT_VISIT_MNHXX`).
    # DENOM: n completed MNH09 or MNH10 or MNH11 with visit status=complete.

    "MNH11" = paste0(
      format(sum(M11_VISIT_COMPLETE_6==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(M11_VISIT_COMPLETE_6==1, na.rm = TRUE)/sum(ANY_TYPE_VISIT_COMPLETE_6==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")
  ) %>%
  
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>% 
      add_column(
      .before = 1,
      "Total" = MatData_Ipc_Visits_Compliance_Inf %>%
        plyr::summarise(

  ## PROTOCOL COMPLIANCE: 
    # NUM: have a complete visit status (variable name: `MAT_VISIT_MNHXX`).
    # DENOM: n completed MNH09 or MNH10 or MNH11 with visit status=complete.
    
    "MNH11" = paste0(
      format(sum(M11_VISIT_COMPLETE_6==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(M11_VISIT_COMPLETE_6==1, na.rm = TRUE)/sum(ANY_TYPE_VISIT_COMPLETE_6==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")
  ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)



```

```{r}

table8 <- bind_rows(IPC_Total, 
                    IPC_Prot_Comp_Mat,
                    IPC_Prot_Comp_Inf) %>% 
  `rownames<-`(c("IPC (Target window: Delivery to 72 hours)",
                 "Denominator, n",
                 "MNH09 Labor & Delivery", 
                 "MNH10 Post-Delivery Outcome", 
                 "MNH11 Newborn Birth Outcome")
               )  %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0"))) %>%   
  mutate_at(vars(everything()), ~ifelse(is.na(.), "0 (0)", .))




## table 8
prisma_tab8 <- tb_theme1(table8) %>% 
  tab_header(
    title = md("**PRISMA Table 8**")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>IPC Visit Completion<sup>a,b</sup></span>"),
    rows = 1:2
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Maternal IPC Protocol Compliance<sup>c,d</sup></span>"),
    rows = 3:4
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Infant IPC Protocol Compliance<sup>e,f</sup></span>"),
    rows = 5:5
  ) %>%
    row_group_order(groups = c("<span style='font-size: 18px'>IPC Visit Completion<sup>a,b</sup></span>",
                               "<span style='font-size: 18px'>Maternal IPC Protocol Compliance<sup>c,d</sup></span>",
                               "<span style='font-size: 18px'>Infant IPC Protocol Compliance<sup>e,f</sup></span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> numerator: n mom with MNH09 or MNH10 or MNH11 with a complete visit status (variable name: `MAT_VISIT_MNHXX`).</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> denominator: n mom completed MNH09 or MNH10 or MNH11 with a complete visit status (variable name: `MAT_VISIT_MNHXX`) OR passed late window with >42 weeks gestation AND (has not closed out OR closed out with closeout date >42wks).</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> numerator: n mom with a complete visit status (variable name: `MAT_VISIT_MNHXX`).</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>d</sup> denominator: n mom completed MNH09 or MNH10 or MNH11 with visit status=complete.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>e</sup> numerator: n infant with a complete visit status (variable name: `MAT_VISIT_MNHXX`).</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>f</sup> denominator: n mom-infant pair completed MNH09 or MNH10 or MNH11 with visit status=complete.</span>")
) 

```

```{r}
prisma_tab8 <- prisma_tab8 %>% gtsave("prisma_tab8.png")
knitr::include_graphics("prisma_tab8.png")
```

\newpage

### Figure 4: Distribution of gestational ages of participants who passed the IPC window and do not yet have a pregnancy outcome reported

*Value:* Gestational age of participants who have passed the target IPC window and do not have any IPC forms.

```{r, echo=FALSE}

figure2 <- MatData_Ipc_Visits_Mat %>%
  # only include participants who are enrolled and who do not have a pregnancy end (ENDPREG_DAYS == NA)
  filter(GA42_MISSING_IPC==1, CLOSED_OUT != 1) %>%
  select(SITE, MOMID, PREGID,DOB, EST_CONCEP_DATE, CLOSED_OUT, M23_CLOSE_DSSTDAT) %>%
  # generate variable for upload date
  mutate(UPLOADDATE = ymd(UploadDate)) %>% 
  # calculate the age of particpant TODAY (at date of upload)
  mutate(AGE_AT_UPLOAD_DAYS = as.numeric(UPLOADDATE - EST_CONCEP_DATE))

out <- figure2 %>% filter(AGE_AT_UPLOAD_DAYS > 336)

# min(figure2$AGE_AT_UPLOAD_DAYS)
# max(figure2$AGE_AT_UPLOAD_DAYS)
## work on automating min and max labels and breaks
ggplot(data = figure2, aes(x = AGE_AT_UPLOAD_DAYS)) +
  geom_histogram(binwidth = 7, fill = "skyblue4", color  ="black") +
  facet_grid(rows = vars(SITE), scales = "free") +
  theme_bw() +
  theme(axis.text.x = element_text(vjust = 1, hjust=1),
        legend.position="bottom",
        legend.title = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_x_continuous(breaks = seq(294, 560, by = 14),
                     label = as.character(seq(42, 80, by = 2)),
                     limits = c(294,560)) +
  scale_y_continuous(labels = scales::number_format(scale = 1, accuracy = 1)) +
  xlab("Estimated Gestational Age") +
  ylab("Number of participants")

# pak_subset <-figure2 %>% filter(SITE == "Pakistan") %>% 
#   mutate(AGE_AT_UPLOAD_WKS = AGE_AT_UPLOAD_DAYS %/% 7) 
# 
# data_dictionary <- data.frame("varname" = names(pak_subset),
#                               "definition" = c("site", 
#                                                "momid",
#                                                "pregnancy id",
#                                                "date of birth; if this is NA then no DOB has been reported for this participant.",
#                                                "estimated date of conception. calculated using teh date of enrollment ultrasound and gestational age at enrollment (est_concep_date = ultrasound date - GA at ultrasound).",
#                                                "binary variable for close out. if a particpant has a closeout form, this will be a 1; if no closeout form, this will be a 0.",
#                                                "date of closeout from closeout form.",
#                                                "date of most recent upload.",
#                                                "estimated age in days at time of recent upload. calculated by taking upload date - estimated conception date.",
#                                                "estimated age in weeks at time of recent upload. calculated by taking upload date - estimated conception date."))
# path = paste0("D:/Users/stacie.loisate/Documents/Analysis/pak_momids_over42wks.xlsx")
# # path = paste("output/",UploadDate, "_intergrowth_bw_ga_outrange_report", ".xlsx", sep = "")
# header_st <- createStyle(textDecoration = "Bold")
# 
# list_of_datasets <- list("Dictionary" = data_dictionary, "Report" = pak_subset)
# 
# write.xlsx(list_of_datasets, file = path,
#            headerStyle = createStyle(textDecoration = "Bold"))
# 


# min(figure2$AGE_AT_UPLOAD_DAYS)
```

\newpage

### Table 9: PNC protocol compliance for PRISMA maternal forms

*Value:* Among women with PNC visits marked as complete, percent that have all expected visit forms completed. A visit is considered `complete` if the data reports the visit was conducted in person or by phone (variable name: `MAT_VISIT_MNHXX`).

*Goal:* 100% completion for all forms, except MNH08 where lab results are expected to lag.

*Numerator:* By form: visit type = i (variable name: `TYPE_VISIT`) AND have a complete visit status (variable name: ``MAT_VISIT_MNHXX`=1 or 2) AND passed late window for visit type = i

*Denominator:* Any form with visit type = i (variable name: `TYPE_VISIT`) AND have a complete visit status (variable name: `MAT_VISIT_MNHXX`=1 or 2) AND passed late window for visit type = i. *For PNC52 visits denominator is passed late window for visit type = i AND has not closed out OR closed out with reason for closeout=1-year followup completed).*

```{r}

# Participants are included in the numerator of this table if, for each form, they have visit type = i AND have any visit status AND passed window for visit type = 1. Participants are included Visit status is defined by MAT_VISIT_MNHxx variables in each form.*
birthoutcome <- MatData_Pnc_Visits %>%
  group_by(SITE) %>%
  summarise(
  "total birth outcomes" = paste0(
    "(n=",sum(BIRTH_OUTCOME_YN==1, na.rm = TRUE), ")"
  )
  ) %>% ungroup() %>%
  t() %>%
  as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .before = 1,
    "Total" = MatData_Pnc_Visits %>%
 plyr::summarise(
     "total birth outcomes" = paste0(
    "(n=",sum(BIRTH_OUTCOME_YN==1, na.rm = TRUE),")"
  )) %>%
      t() %>% as.data.frame() %>% unlist()
  )

## PNC0
PNC0 <- Prot_Compliance_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(PC_PNC0_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_7 == 1 & PC_PNC0_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_7 == 1 & PC_PNC0_DENOM == 1, na.rm = TRUE)/sum(PC_PNC0_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_7==1 & PC_PNC0_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_7==1 & PC_PNC0_DENOM == 1, na.rm = TRUE)/sum(PC_PNC0_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%

  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(PC_PNC0_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_7==1 & PC_PNC0_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_7==1& PC_PNC0_DENOM == 1, na.rm = TRUE)/sum(PC_PNC0_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_7==1 & PC_PNC0_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_7==1 & PC_PNC0_DENOM == 1, na.rm = TRUE)/sum(PC_PNC0_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)



## PNC1
PNC1 <- Prot_Compliance_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(PC_PNC1_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_8 == 1 & PC_PNC1_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_8 == 1& PC_PNC1_DENOM == 1, na.rm = TRUE)/sum(PC_PNC1_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_8 == 1 & PC_PNC1_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_8 == 1 & PC_PNC1_DENOM == 1, na.rm = TRUE)/sum(PC_PNC1_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(PC_PNC1_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_8 == 1 & PC_PNC1_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_8 == 1& PC_PNC1_DENOM == 1, na.rm = TRUE)/sum(PC_PNC1_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_8 == 1 & PC_PNC1_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_8 == 1 & PC_PNC1_DENOM == 1, na.rm = TRUE)/sum(PC_PNC1_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"))
  %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

## PNC4
PNC4 <- Prot_Compliance_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(PC_PNC4_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_9 == 1 & PC_PNC4_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_9 == 1& PC_PNC4_DENOM == 1, na.rm = TRUE)/sum(PC_PNC4_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_9 == 1 & PC_PNC4_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_9 == 1 & PC_PNC4_DENOM == 1, na.rm = TRUE)/sum(PC_PNC4_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%

  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(PC_PNC4_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_9 == 1 & PC_PNC4_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_9 == 1& PC_PNC4_DENOM == 1, na.rm = TRUE)/sum(PC_PNC4_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_9 == 1 & PC_PNC4_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_9 == 1 & PC_PNC4_DENOM == 1, na.rm = TRUE)/sum(PC_PNC4_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")

      )
  %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

## PNC6
PNC6 <- Prot_Compliance_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(PC_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH05 Maternal Anthropometrics" = paste0(
        format(sum(M05_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_10 == 1& PC_PNC6_DENOM == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_10 == 1& PC_PNC6_DENOM == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH07 Maternal Specimen Collection" = paste0(
        format(sum(M07_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_10 == 1& PC_PNC6_DENOM == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_10 == 1& PC_PNC6_DENOM == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      "MNH25 Maternal Depression" = paste0(
        format(sum(M25_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M25_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(PC_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH05 Maternal Anthropometrics" = paste0(
        format(sum(M05_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_10 == 1& PC_PNC6_DENOM == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_10 == 1& PC_PNC6_DENOM == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH07 Maternal Specimen Collection" = paste0(
        format(sum(M07_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_10 == 1& PC_PNC6_DENOM == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_10 == 1& PC_PNC6_DENOM == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

    "MNH25 Maternal Depression" = paste0(
        format(sum(M25_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M25_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"))
  %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

## PNC26
PNC26 <- Prot_Compliance_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(PC_PNC26_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH05 Maternal Anthropometrics" = paste0(
        format(sum(M05_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_11 == 1& PC_PNC26_DENOM == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_11 == 1& PC_PNC26_DENOM == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      # "MNH07 Maternal Specimen Collection" = paste0(
      #   format(sum(M07_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(M07_VISIT_COMPLETE_11 == 1& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")"),
      # 
      # "MNH08 Maternal Lab" = paste0(
      #   format(sum(M08_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(M08_VISIT_COMPLETE_11 == 1& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(PC_PNC26_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH05 Maternal Anthropometrics" = paste0(
        format(sum(M05_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_11 == 1& PC_PNC26_DENOM == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_11 == 1& PC_PNC26_DENOM == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      # "MNH07 Maternal Specimen Collection" = paste0(
      #   format(sum(M07_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(M07_VISIT_COMPLETE_11 == 1& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")"),
      # 
      # "MNH08 Maternal Lab" = paste0(
      #   format(sum(M08_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(M08_VISIT_COMPLETE_11 == 1& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)


## PNC52
PNC52 <- Prot_Compliance_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(PC_PNC52_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

     "MNH05 Anthropometrics" = paste0(
        format(sum(M05_VISIT_COMPLETE_12 == 1 & PC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_12 == 1& PC_PNC52_DENOM == 1, na.rm = TRUE)/sum(PC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),


      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_12 == 1 & PC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_12 == 1& PC_PNC52_DENOM == 1, na.rm = TRUE)/sum(PC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_12 == 1 & PC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_12 == 1 & PC_PNC52_DENOM == 1, na.rm = TRUE)/sum(PC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(PC_PNC52_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

    "MNH05 Anthropometrics" = paste0(
        format(sum(M05_VISIT_COMPLETE_12 == 1 & PC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_12 == 1& PC_PNC52_DENOM == 1, na.rm = TRUE)/sum(PC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_12 == 1 & PC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_12 == 1& PC_PNC52_DENOM == 1, na.rm = TRUE)/sum(PC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_12 == 1 & PC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_12 == 1 & PC_PNC52_DENOM == 1, na.rm = TRUE)/sum(PC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
            )
  %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)


```

```{r}

prot_compliance_pnc <- bind_rows(birthoutcome,
                                 PNC0,
                                 PNC1, 
                                 PNC4, 
                                 PNC6, 
                                 PNC26, 
                                 PNC52
          ) %>%
    `rownames<-`(c("Participants with a birth outcome, n^a^",
                 ## PNC0 (2-4)
                  "Denominator, n",
                  "MNH06 Maternal POC ",
                  "MNH12 Mat Clinical Status",
                 ## PNC1 (5-7)
                 "Denominator, n ",
                 "MNH06 Maternal POC  ",
                 "MNH12 Mat Clinical Status ",
                 ## PNC4 (8-10)
                 "Denominator, n  ",
                 "MNH06 Maternal POC   ",
                 "MNH12 Mat Clinical Status  ",
                 ## PNC6 (11-17)
                 "Denominator, n   ",
                 "MNH05 Maternal Anthro    ",
                 "MNH06 Maternal POC    ",
                 "MNH07 Maternal Specimen    ",
                 "MNH08 Maternal Lab    ",
                 "MNH12 Mat Clinical  Status  ",
                 "MNH25 Maternal Depression    ",
                 ## PNC26 (18-21)
                 "Denominator, n    ",
                 "MNH05 Maternal Anthro     ",
                 "MNH06 Maternal POC     ",
                 # "MNH07 Maternal Specimen     ",
                 # "MNH08 Maternal Lab     ",
                 "MNH12 Mat Clinical  Status   ",
                 ##PNC52 22-25)
                 "Denominator, n     ",
                 "MNH05 Maternal Anthro      ",
                 "MNH06 Maternal POC      ",
                 "MNH12 Mat Clinical  Status    "
                 )
               )  %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0"))) %>% 
  mutate_at(vars(everything()), ~ifelse(is.na(.), "0 (0)", .))


table9_1 <- prot_compliance_pnc[c(1:10),]
table9_2 <- prot_compliance_pnc[c(1,11:25),]


## PART 1
prisma_tab9_1 <- tb_theme1(table9_1) %>% 
  tab_header(
    title = md("**PRISMA Table 9** *(continued on next page)*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC-0 visit, n(%)<sup>b</sup> [Target window: 3 to 5 days]</span>"),
    rows = 2:4
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC-1 visit, n(%)<sup>c</sup> [Target window: 7 to 14 days]</span>"),
    rows = 5:7
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC-4 visit, n(%)<sup>d</sup> [Target window: 28 to 35 days]</span>"),
    rows = 8:10
  ) %>%

    row_group_order(groups = c(NA,
                               "<span style='font-size: 18px'>PNC-0 visit, n(%)<sup>b</sup> [Target window: 3 to 5 days]</span>",
                               "<span style='font-size: 18px'>PNC-1 visit, n(%)<sup>c</sup> [Target window: 7 to 14 days]</span>",
                               "<span style='font-size: 18px'>PNC-4 visit, n(%)<sup>d</sup> [Target window: 28 to 35 days]</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c("Denominator, n",
                                      "Denominator, n ", 
                                      "Denominator, n  "))
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> n is any participant with any birth outcome defined by `BIRTH_DSTERM_INFX` in MNH09.</span>")  
) %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> denominator is n completed any form with visit status=complete AND visit type=PNC-0 AND passed late window with >5 days postpartum.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> denominator is n completed any form with visit status=complete AND visit type=PNC-1 AND passed late window with 14 days postpartum.</span>")  
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>d</sup> denominator is n completed any form with visit status=complete AND visit type=PNC-4 AND passed late window with >35 days postpartum.</span>")  
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note</sup> passed window denominators for all visits are calculated by date and time of birth reported in MNH09. If an date of birth is missing, the particpant is removed from this table.</span>")  
)   



## PART 2
prisma_tab9_2 <- tb_theme1(table9_2) %>% 
  tab_header(
    title = md("**PRISMA Table 9** *(continued)*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC-6 visit, n(%)<sup>e</sup> [Target window: 6 to 12 wks]</span>"),
    rows = 2:8
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC-26 visit, n(%)<sup>f</sup> [Target window: 26 to 39 wks]</span>"),
    rows = 9:12
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC-52 visit, n(%)<sup>g</sup> [Target window: 52 to 64 wks]</span>"),
    rows = 13:16
  ) %>%

    row_group_order(groups = c(NA,
                               "<span style='font-size: 18px'>PNC-6 visit, n(%)<sup>e</sup> [Target window: 6 to 12 wks]</span>",
                               "<span style='font-size: 18px'>PNC-26 visit, n(%)<sup>f</sup> [Target window: 26 to 39 wks]</span>",
                               "<span style='font-size: 18px'>PNC-52 visit, n(%)<sup>g</sup> [Target window: 52 to 64 wks]</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c("Denominator, n   ",
                                      "Denominator, n    " , 
                                      "Denominator, n     "))
) %>% 
    tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> n is any participant with any birth outcome defined by `BIRTH_DSTERM_INFX` in MNH09.</span>")  
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>e</sup> denominator is n completed any form with visit status=complete AND visit type=PNC-6 AND passed late window with >12 wks postpartum.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>f</sup> denominator is n completed any form with visit status=complete AND visit type=PNC-26 AND passed late window with >39 wks postpartum.</span>")  
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>g</sup> denominator is n completed any form wit visit status=complete AND visit type=PNC-52 AND passed late window with >64 wks postpartum.</span>")  
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note</sup> passed window denominators for all visits are calculated by date and time of birth reported in MNH09. If a date of birth is missing, the particpant is removed from this table.</span>")  
)  




```

```{r}
prisma_tab9_1 <- prisma_tab9_1 %>% gtsave("prisma_tab9_1.png")
knitr::include_graphics("prisma_tab9_1.png")

```

```{r}
prisma_tab9_2 <- prisma_tab9_2 %>% gtsave("prisma_tab9_2.png")
knitr::include_graphics("prisma_tab9_2.png")

```

\newpage

### Table 10: PNC visit maternal form completion for PRISMA

*Value:* Among women who have passed the late PNC window period, percent with forms completed regardless of visit status. A form is considered complete when a form has been submitted for a participant.

*Goal:* 100% completion for all forms, except MNH08 where lab results are expected to lag.

*Numerator:* By form: visit type = i (variable name: `TYPE_VISIT`) AND have any visit status (variable name: `MAT_VISIT_MNHXX`) AND passed late window for visit type = i

*Denominator:* Any form with visit type = i (variable name: `TYPE_VISIT`) AND have any visit status (variable name: `MAT_VISIT_MNHXX`) AND passed late window for visit type = i. *For PNC52 visits denominator is passed late window for visit type = i AND has not closed out OR closed out with reason for closeout=1-year followup completed).*
```{r}
# Participants are included in the numerator of this table if, for each form, they have visit type = i AND have any visit status AND passed window for visit type = 1. Participants are included Visit status is defined by MAT_VISIT_MNHxx variables in each form.*
birthoutcome <- MatData_Pnc_Visits %>%
  group_by(SITE) %>%
  summarise(
  "total birth outcomes" = paste0(
    "(n=",sum(BIRTH_OUTCOME_YN==1, na.rm = TRUE), ")"
  )
  ) %>% ungroup() %>%
  t() %>%
  as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .before = 1,
    "Total" = MatData_Pnc_Visits %>%
 plyr::summarise(
     "total birth outcomes" = paste0(
    "(n=",sum(BIRTH_OUTCOME_YN==1, na.rm = TRUE),")"
  )) %>%
      t() %>% as.data.frame() %>% unlist()
  )

## PNC0
PNC0 <- Form_Completion_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(FC_PNC0_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_7) & FC_PNC0_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_7) & FC_PNC0_DENOM == 1, na.rm = TRUE)/sum(FC_PNC0_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_7) & FC_PNC0_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_7) & FC_PNC0_DENOM == 1, na.rm = TRUE)/sum(FC_PNC0_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%

  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Form_Completion_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(FC_PNC0_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_7) & FC_PNC0_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_7)& FC_PNC0_DENOM == 1, na.rm = TRUE)/sum(FC_PNC0_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_7) & FC_PNC0_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_7) & FC_PNC0_DENOM == 1, na.rm = TRUE)/sum(FC_PNC0_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
      ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)


## PNC1
PNC1 <- Form_Completion_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(FC_PNC1_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_8) & FC_PNC1_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_8)& FC_PNC1_DENOM == 1, na.rm = TRUE)/sum(FC_PNC1_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_8) & FC_PNC1_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_8) & FC_PNC1_DENOM == 1, na.rm = TRUE)/sum(FC_PNC1_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
      ) %>%

  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Form_Completion_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(FC_PNC1_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_8) & FC_PNC1_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_8)& FC_PNC1_DENOM == 1, na.rm = TRUE)/sum(FC_PNC1_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_8) & FC_PNC1_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_8) & FC_PNC1_DENOM == 1, na.rm = TRUE)/sum(FC_PNC1_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"))

  %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

## PNC4

PNC4 <- Form_Completion_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(FC_PNC4_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_9) & FC_PNC4_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_9)& FC_PNC4_DENOM == 1, na.rm = TRUE)/sum(FC_PNC4_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_9) & FC_PNC4_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_9) & FC_PNC4_DENOM == 1, na.rm = TRUE)/sum(FC_PNC4_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
      ) %>%
  
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Form_Completion_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(FC_PNC4_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_9) & FC_PNC4_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_9)& FC_PNC4_DENOM == 1, na.rm = TRUE)/sum(FC_PNC4_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_9) & FC_PNC4_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_9) & FC_PNC4_DENOM == 1, na.rm = TRUE)/sum(FC_PNC4_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")

      )
  %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

## PNC6
PNC6 <- Form_Completion_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(FC_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH05 Maternal Anthropometrics" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_10)& FC_PNC6_DENOM == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_10)& FC_PNC6_DENOM == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH07 Maternal Specimen Collection" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_10)& FC_PNC6_DENOM == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_10)& FC_PNC6_DENOM == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH25 Maternal Depression" = paste0(
        format(sum(!is.na(M25_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M25_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Form_Completion_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(FC_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH05 Maternal Anthropometrics" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_10)& FC_PNC6_DENOM == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_10)& FC_PNC6_DENOM == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH07 Maternal Specimen Collection" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_10)& FC_PNC6_DENOM == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_10)& FC_PNC6_DENOM == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
    "MNH25 Maternal Depression" = paste0(
        format(sum(!is.na(M25_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M25_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"))
  %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)


## PNC26
PNC26 <- Form_Completion_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(FC_PNC26_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH05 Maternal Anthropometrics" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_11) & FC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_11)& FC_PNC26_DENOM == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_11) & FC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_11)& FC_PNC26_DENOM == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      # "MNH07 Maternal Specimen Collection" = paste0(
      #   format(sum(!is.na(M07_VISIT_COMPLETE_11) & PNC26_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(!is.na(M07_VISIT_COMPLETE_11)& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")"),
      # 
      # "MNH08 Maternal Lab" = paste0(
      #   format(sum(!is.na(M08_VISIT_COMPLETE_11) & PNC26_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(!is.na(M08_VISIT_COMPLETE_11)& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_11) & FC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_11) & FC_PNC26_DENOM == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
      ) %>%


  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Form_Completion_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(FC_PNC26_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH05 Maternal Anthropometrics" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_11) & FC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_11)& FC_PNC26_DENOM == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_11) & FC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_11)& FC_PNC26_DENOM == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      # "MNH07 Maternal Specimen Collection" = paste0(
      #   format(sum(!is.na(M07_VISIT_COMPLETE_11) & PNC26_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(!is.na(M07_VISIT_COMPLETE_11)& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")"),
      # 
      # "MNH08 Maternal Lab" = paste0(
      #   format(sum(!is.na(M08_VISIT_COMPLETE_11) & PNC26_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(!is.na(M08_VISIT_COMPLETE_11)& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_11) & FC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_11) & FC_PNC26_DENOM == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
      ) %>%

        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

## PNC52
PNC52 <- Form_Completion_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(FC_PNC52_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

     "MNH05 Anthropometrics" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_12) & FC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_12)& FC_PNC52_DENOM == 1, na.rm = TRUE)/sum(FC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),


      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_12) & FC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_12)& FC_PNC52_DENOM == 1, na.rm = TRUE)/sum(FC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_12) & FC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_12) & FC_PNC52_DENOM == 1, na.rm = TRUE)/sum(FC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
     ) %>%

  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Form_Completion_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(FC_PNC52_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

    "MNH05 Anthropometrics" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_12) & FC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_12)& FC_PNC52_DENOM == 1, na.rm = TRUE)/sum(FC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_12) & FC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_12)& FC_PNC52_DENOM == 1, na.rm = TRUE)/sum(FC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_12) & FC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_12) & FC_PNC52_DENOM == 1, na.rm = TRUE)/sum(FC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")

      )
  %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)



```

```{r}

form_completion_pnc <- bind_rows(birthoutcome,
                                 PNC0, 
                                 PNC1, 
                                 PNC4, 
                                 PNC6, 
                                 PNC26, 
                                 PNC52
          ) %>%
    `rownames<-`(c("Participants with a birth outcome, n^a^",
                 ## PNC0 (2-4)
                  "Denominator, n",
                  "MNH06 Maternal POC ",
                  "MNH12 Mat Clinical Status ",
                 ## PNC1 (5-7)
                 "Denominator, n ",
                 "MNH06 Maternal POC  ",
                 "MNH12 Mat Clinical Status  ",
                 ## PNC4 (8-10)
                 "Denominator, n  ",
                 "MNH06 Maternal POC   ",
                 "MNH12 Mat Clinical Status   ",
                 ## PNC6 (11-17)
                 "Denominator, n   ",
                 "MNH05 Maternal Anthro    ",
                 "MNH06 Maternal POC    ",
                 "MNH07 Maternal Specimen    ",
                 "MNH08 Maternal Lab    ",
                 "MNH12 Mat Clinical Status    ",
                 "MNH25 Maternal Depression    ",
                 ## PNC26 (18-21)
                 "Denominator, n    ",
                 "MNH05 Maternal Anthro     ",
                 "MNH06 Maternal POC     ",
                 # "MNH07 Maternal Specimen     ",
                 # "MNH08 Maternal Lab     ",
                 "MNH12 Mat Clinical Status     ",
                 ##PNC52 22-25)
                 "Denominator, n     ",
                 "MNH05 Maternal Anthro      ",
                 "MNH06 Maternal POC      ",
                 "MNH12 Mat Clinical Status      "
                 )
               )  %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0"))) %>% 
  mutate_at(vars(everything()), ~ifelse(is.na(.), "0 (0)", .))



table10_1 <- form_completion_pnc[c(1:10),]
table10_2 <- form_completion_pnc[c(1,11:25),]

## PART 1
prisma_tab10_1 <- tb_theme1(table10_1) %>% 
  tab_header(
    title = md("**PRISMA Table 10** *(continued on next page)*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC-0 visit, n(%)<sup>b</sup> [Target window: 3 to 5 days]</span>"),
    rows = 2:4
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC-1 visit, n(%)<sup>c</sup> [Target window: 7 to 14 days]</span>"),
    rows = 5:7
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC-4 visit, n(%)<sup>d</sup> [Target window: 28 to 35 days]</span>"),
    rows = 8:10
  ) %>%

    row_group_order(groups = c(NA,
                               "<span style='font-size: 18px'>PNC-0 visit, n(%)<sup>b</sup> [Target window: 3 to 5 days]</span>",
                               "<span style='font-size: 18px'>PNC-1 visit, n(%)<sup>c</sup> [Target window: 7 to 14 days]</span>",
                               "<span style='font-size: 18px'>PNC-4 visit, n(%)<sup>d</sup> [Target window: 28 to 35 days]</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c("Denominator, n",
                                      "Denominator, n ", 
                                      "Denominator, n  "))
) %>%
    tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> n is any participant with any birth outcome defined by `BIRTH_DSTERM_INFX` in MNH09.</span>")  
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> denominator is n completed any form with any visit status AND visit type=PNC-0 AND passed late window with >5 days postpartum.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> denominator is n completed any form with any visit status AND visit type=PNC-1 AND passed late window with 14 days postpartum.</span>")  
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>d</sup> denominator is n completed any form with any visit status AND visit type=PNC-4 AND passed late window with >35 days postpartum.</span>")  
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note</sup> passed window denominators for all visits are calculated by date and time of birth reported in MNH09. If an date of birth is missing, the participant is removed from this table.</span>")  
)   



## PART 2
prisma_tab10_2 <- tb_theme1(table10_2) %>% 
  tab_header(
    title = md("**PRISMA Table 10** *(continued)*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC-6 visit, n(%)<sup>e</sup> [Target window: 6 to 12wks]</span>"),
    rows = 2:8
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC-26 visit, n(%)<sup>f</sup> [Target window: 26 to 39wks]</span>"),
    rows = 9:12
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC-52 visit, n(%)<sup>g</sup> [Target window: 52 to 64wks]</span>"),
    rows = 13:16
  ) %>%

    row_group_order(groups = c(NA,
                               "<span style='font-size: 18px'>PNC-6 visit, n(%)<sup>e</sup> [Target window: 6 to 12wks]</span>",
                               "<span style='font-size: 18px'>PNC-26 visit, n(%)<sup>f</sup> [Target window: 26 to 39wks]</span>",
                               "<span style='font-size: 18px'>PNC-52 visit, n(%)<sup>g</sup> [Target window: 52 to 64wks]</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c("Denominator, n   ",
                                      "Denominator, n    " , 
                                      "Denominator, n     "))
) %>% 
    tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup>  n is any participant with any birth outcome defined by `BIRTH_DSTERM_INFX` in MNH09.</span>")  
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>e</sup> denominator is n completed any form with any visit status AND visit type=PNC-6 AND passed late window with >12 wks postpartum.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>f</sup> denominator is n completed any form with any visit status AND visit type=PNC-26 AND passed late window with >39 wks postpartum.</span>")  
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>g</sup> denominator is n completed any form with any visit status AND visit type=PNC-52 AND passed late window with >64 wks postpartum.</span>")  
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note</sup> passed window denominators for all visits are calculated by date and time of birth reported in MNH09. If an date of birth is missing, the participant is removed from this table.</span>")  
)  

```

```{r}
prisma_tab10_1 <- prisma_tab10_1 %>% gtsave("prisma_tab10_1.png")
knitr::include_graphics("prisma_tab10_1.png")

```

```{r}
prisma_tab10_2 <- prisma_tab10_2 %>% gtsave("prisma_tab10_2.png")
knitr::include_graphics("prisma_tab10_2.png")
```

\newpage

### Table 11: Protocol compliance for PRISMA depression assessment

*Value:* Among women successfully contacted during the ANC or PNC period who have passed the expected visit window, percent that have MNH25 complete. A visit is considered `complete` if the data reports the visit was conducted in person or by phone (variable name: `MAT_VISIT_MNHXX`).
MNH25 can be completed either during individual visits (e.g., ANC20) or
during combined visits after the gestational age window has passed
(e.g., combined Enrollment and ANC20 visits). The denominators in this
table are based on the latest window for eligible visits. For example,
the denominator for MNH25 completed at ANC32 is the number of
participants who have passed the ANC36 late window to allow for combined
visits.

*Numerator:* MNH25 with visit type = i (variable name: `TYPE_VISIT`) AND
have a complete visit status (variable name: `MAT_VISIT_MNHXX`) AND
passed late window for visit type = i AND (has not delivered OR
delivered with gestational age \> late visit window) AND (has not closed
out OR closed out with closeout date \> visit window)

*Denominator:* Passed late window for visit type = i AND (has not
delivered OR delivered with gestational age \> late visit window) AND
(has not closed out OR closed out with closeout date \> visit window)

```{r}
    
    #* Num: MNH25 with visit status = 1 or 2 AND passed window for visit type = i 
    #* Denom: passed window for visit type = i 
    
prot_compliance_depression <- Prot_Compliance_MNH25 %>% 
      rowwise() %>% 
      group_by(SITE) %>% 
      summarise(
        
      # ANC 20
        "ANC20^a^" = paste0(
          format(sum(M25_ANCLESS20_NUM == 1 & PC_ANCLESS20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M25_ANCLESS20_NUM == 1 & PC_ANCLESS20_DENOM==1, na.rm = TRUE)/sum(PC_ANCLESS20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
          
        "Denominator, n" = paste0(
          format(sum(PC_ANCLESS20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)), 

      ## ANC 32
        "ANC32^b^" = paste0(
          format(sum(M25_ANCOVER31_NUM == 1 & PC_ANCOVER31_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M25_ANCOVER31_NUM == 1 & PC_ANCOVER31_DENOM==1, na.rm = TRUE)/sum(PC_ANCOVER31_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),

        "Denominator, n " = paste0(
          format(sum(PC_ANCOVER31_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)), 
        
     ### PNC 6      
     "PNC6^c^" = paste0(
          format(sum(M25_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1 & PC_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M25_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1 & PC_PNC6_DENOM==1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),

        "Denominator, n  " = paste0(
          format(sum(PC_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2))

      )  %>%
      t() %>% as.data.frame() %>% 
      `colnames<-`(c(.[1,])) %>% 
      slice(-1) %>% 
      add_column(
        .before = 1,
        "Total" = Prot_Compliance_MNH25%>% 
          plyr::summarise(
      # ANC 20
        "ANC20^a^" = paste0(
          format(sum(M25_ANCLESS20_NUM == 1 & PC_ANCLESS20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M25_ANCLESS20_NUM == 1 & PC_ANCLESS20_DENOM==1, na.rm = TRUE)/sum(PC_ANCLESS20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
          
        "Denominator, n" = paste0(
          format(sum(PC_ANCLESS20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)), 

      ## ANC 32
        "ANC32^b^" = paste0(
          format(sum(M25_ANCOVER31_NUM == 1 & PC_ANCOVER31_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M25_ANCOVER31_NUM == 1 & PC_ANCOVER31_DENOM==1, na.rm = TRUE)/sum(PC_ANCOVER31_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),

        "Denominator, n " = paste0(
          format(sum(PC_ANCOVER31_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)), 
        
     ### PNC 6      
     "PNC6^c^" = paste0(
          format(sum(M25_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1 & PC_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M25_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1 & PC_PNC6_DENOM==1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),

        "Denominator, n  " = paste0(
          format(sum(PC_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2))
     
          ) %>% 
          t() %>% 
          as.data.frame() %>% 
          `colnames<-`(c(.[1,])) %>% unlist() 
  )
      
```

```{r}

prisma_table11 <- prot_compliance_depression %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0"))) 

## table 8
prisma_table11 <- tb_theme1(prisma_table11) %>% 
  tab_header(
    title = md("**PRISMA Table 11**")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Depression assessment (MNH25)</span>"),
    rows = 1:6
  ) %>%
  tab_style(
      style = list(
        cell_text(indent = px(40))
        ),
      locations = cells_stub(rows = c("Denominator, n",
                                      "Denominator, n ",
                                      "Denominator, n  "))
) %>% 
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> denominator is n passed ANC-20 late window with >25 weeks gestation AND (has not delivered OR delivered with gestational age >25wks) AND (has not closed out OR closed out with closeout date >25wks).</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> denominator is n passed ANC-32 late window with >33 weeks gestation AND (has not delivered OR delivered with gestational age >33wks) AND (has not closed out OR closed out with closeout date >33wks).</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> denominator is n passed PNC-6 late window with >12 weeks postpartum AND (has not closed out OR closed out with closeout date >12wks postpartum).</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>ANC Note:</sup> passed window denominators for ANC visits are calculated by EDD reported in MNH01 (US_EDD_BRTHDAT). If an EDD is missing, the participant is removed from this table.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>PNC Note:</sup> passed window denominators for PNC visits are calculated by date and time of birth reported in MNH09. If an date of birth is missing, the participant is removed from this table.</span>")
)

```

```{r}
prisma_table11 <- prisma_table11 %>% gtsave("prisma_table11.png")
knitr::include_graphics("prisma_table11.png")
```

\newpage

### Figures 5a-e. Heat maps of form completion for ANC visits in PRISMA

*Value:* Percent of successful visits during the ANC period.

*Numerator:* By form: visit type = i (variable name: `TYPE_VISIT`) AND
have a complete visit status (where variable name: `MAT_VISIT_MNHXX`=1
or 2) AND passed late window for visit type = i

*Denominator:* Passed late window for visit type = i AND (has not
delivered OR delivered with gestational age \> late visit window) AND
(has not closed out OR closed out with closeout date \> visit window)

```{r}

ENROLLMENT_PCT <- Heat_Maps_Anc %>% 
  rowwise() %>% 
  group_by(SITE) %>% 
  summarise(
    "Denominator" = paste0(
      format(sum(HM_ENROLL_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
    ),
    
    "MNH01" = paste0(
      format(round(sum(M01_VISIT_COMPLETE_1 == 1 & HM_ENROLL_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ENROLL_DENOM_LATE==1, na.rm = TRUE)*100,
      2), nsmall = 0, digits = 2)),

    "MNH02" = paste0(
      format(round(sum(ENROLL == 1 & HM_ENROLL_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ENROLL_DENOM_LATE==1, na.rm = TRUE)*100,
      2), nsmall = 0, digits = 2)),

    "MNH03" = paste0(
      format(round(sum(M03_VISIT_COMPLETE_1 == 1 & HM_ENROLL_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ENROLL_DENOM_LATE==1, na.rm = TRUE)*100,
                   2), nsmall = 0, digits = 2)),
    
    "MNH04" = paste0(
      format(round(sum(M04_VISIT_COMPLETE_1 == 1 & HM_ENROLL_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ENROLL_DENOM_LATE==1, na.rm = TRUE)*100,
                   2), nsmall = 0, digits = 2)),
    
    "MNH05" = paste0(
      format(round(sum(M05_VISIT_COMPLETE_1 == 1 & HM_ENROLL_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ENROLL_DENOM_LATE==1, na.rm = TRUE)*100,
                   2), nsmall = 0, digits = 2)),
    
    "MNH06" = paste0(
      format(round(sum(M06_VISIT_COMPLETE_1 == 1 & HM_ENROLL_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ENROLL_DENOM_LATE==1, na.rm = TRUE)*100,
                   2), nsmall = 0, digits = 2)),
    
    "MNH07" = paste0(
      format(round(sum(M07_VISIT_COMPLETE_1 == 1 & HM_ENROLL_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ENROLL_DENOM_LATE==1, na.rm = TRUE)*100, 
                   2), nsmall = 0, digits = 2)),
    
    "MNH08" = paste0(
      format(round(sum(M08_VISIT_COMPLETE_1 == 1 & HM_ENROLL_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ENROLL_DENOM_LATE==1, na.rm = TRUE)*100,
                   2), nsmall = 0, digits = 2))
) %>% 
  pivot_longer(cols = -SITE,
               names_to = "FORM", 
               values_to = "COMPLETE_PCT") %>% 
  filter(FORM != "Denominator") %>% 
  mutate(VISIT = "Enrollment") %>% 
  mutate(COMPLETE_PCT = as.numeric(COMPLETE_PCT)) %>% 
  mutate(PCT_BIN = cut(COMPLETE_PCT, 
                       breaks = c(seq(0, 90, by = 10), Inf),
                       include.lowest = TRUE,
                       labels = c(paste(seq(0, 80, by = 10), seq(9, 90, by = 10), sep = "-"), "90-100")))


ANC20_PCT <- Heat_Maps_Anc %>% 
  filter(US_GA_WKS_ENROLL <= 17) %>% 
  rowwise() %>% 
  group_by(SITE) %>% 
  summarise(
    
    "Denominator" = paste0(
      format(sum(HM_ANC20_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
    ),
    
    "MNH04" = paste0(
      format(round(sum(M04_VISIT_COMPLETE_2 == 1 & HM_ANC20_DENOM_LATE==1, na.rm = TRUE)/sum( HM_ANC20_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2)),
    
    "MNH05" = paste0(
      format(round(sum(M05_VISIT_COMPLETE_2 == 1 & HM_ANC20_DENOM_LATE==1, na.rm = TRUE)/sum( HM_ANC20_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2)),
    
    "MNH06" = paste0(
      format(round(sum(M06_VISIT_COMPLETE_2 == 1 & HM_ANC20_DENOM_LATE==1, na.rm = TRUE)/sum( HM_ANC20_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2)),
    
    "MNH07" = paste0(
      format(round(sum(M07_VISIT_COMPLETE_2 == 1 & HM_ANC20_DENOM_LATE==1, na.rm = TRUE)/sum( HM_ANC20_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2)),
    
    "MNH08" = paste0(
      format(round(sum(M08_VISIT_COMPLETE_2 == 1 & HM_ANC20_DENOM_LATE==1, na.rm = TRUE)/sum( HM_ANC20_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2))
  ) %>%
  pivot_longer(cols = -SITE,
               names_to = "FORM", 
               values_to = "COMPLETE_PCT") %>% 
  filter(FORM != "Denominator") %>% 
  mutate(VISIT = "ANC20") %>% 
  mutate(COMPLETE_PCT = as.numeric(COMPLETE_PCT)) %>% 
  mutate(PCT_BIN = cut(COMPLETE_PCT, 
                       breaks = c(seq(0, 90, by = 10), Inf),
                       include.lowest = TRUE,
                       labels = c(paste(seq(0, 80, by = 10), seq(9, 90, by = 10), sep = "-"), "90-100")))

ANC28_PCT <- Heat_Maps_Anc %>% 
  rowwise() %>% 
  group_by(SITE) %>% 
  summarise(
    "Denominator" = paste0(
      format(sum(HM_ANC28_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
    ),
    
    "MNH04" = paste0(
      format(round(sum(M04_VISIT_COMPLETE_3 == 1 & HM_ANC28_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ANC28_DENOM_LATE==1, na.rm = TRUE)*100, 2), 
             nsmall = 0, digits = 2)),
    
    "MNH05" = paste0(
      format(round(sum(M05_VISIT_COMPLETE_3 == 1 & HM_ANC28_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ANC28_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2)),
    
    "MNH06" = paste0(
      format(round(sum(M06_VISIT_COMPLETE_3 == 1 & HM_ANC28_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ANC28_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2)),
    
    "MNH07" = paste0(
      format(round(sum(M07_VISIT_COMPLETE_3 == 1 & HM_ANC28_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ANC28_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2)),
    
    "MNH08" = paste0(
      format(round(sum(M08_VISIT_COMPLETE_3 == 1 & HM_ANC28_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ANC28_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2))) %>%
  pivot_longer(cols = -SITE,
               names_to = "FORM", 
               values_to = "COMPLETE_PCT") %>% 
  filter(FORM != "Denominator") %>% 
  mutate(VISIT = "ANC28") %>% 
  mutate(COMPLETE_PCT = as.numeric(COMPLETE_PCT)) %>% 
  mutate(PCT_BIN = cut(COMPLETE_PCT, 
                       breaks = c(seq(0, 90, by = 10), Inf),
                       include.lowest = TRUE,
                       labels = c(paste(seq(0, 80, by = 10), seq(9, 90, by = 10), sep = "-"), "90-100")))


ANC32_PCT <- Heat_Maps_Anc %>% 
  rowwise() %>% 
  group_by(SITE) %>% 
  summarise(
    
    "Denominator" = paste0(
      format(sum(HM_ANC32_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
    ),
    
    "MNH01" = paste0(
      format(round(sum(M01_VISIT_COMPLETE_4 == 1 & HM_ANC32_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ANC32_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2)),
    
    "MNH04" = paste0(
      format(round(sum(M04_VISIT_COMPLETE_4 == 1 & HM_ANC32_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ANC32_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2)),
    
    "MNH05" = paste0(
      format(round(sum(M05_VISIT_COMPLETE_4 == 1 & HM_ANC32_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ANC32_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2)),
    
    "MNH06" = paste0(
      format(round(sum(M06_VISIT_COMPLETE_4 == 1 & HM_ANC32_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ANC32_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2)),
    
    "MNH07" = paste0(
      format(round(sum(M07_VISIT_COMPLETE_4 == 1 & HM_ANC32_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ANC32_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2)),
    
    "MNH08" = paste0(
      format(round(sum(M08_VISIT_COMPLETE_4 == 1 & HM_ANC32_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ANC32_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2))
  ) %>%
  pivot_longer(cols = -SITE,
               names_to = "FORM", 
               values_to = "COMPLETE_PCT") %>% 
  filter(FORM != "Denominator") %>% 
  mutate(VISIT = "ANC32") %>% 
  mutate(COMPLETE_PCT = as.numeric(COMPLETE_PCT)) %>% 
  mutate(PCT_BIN = cut(COMPLETE_PCT, 
                       breaks = c(seq(0, 90, by = 10), Inf),
                       include.lowest = TRUE,
                       labels = c(paste(seq(0, 80, by = 10), seq(9, 90, by = 10), sep = "-"), "90-100")))


ANC36_PCT <- Heat_Maps_Anc %>% 
  rowwise() %>% 
  group_by(SITE) %>% 
  summarise(
    
    "Denominator" = paste0(
      format(sum(HM_ANC36_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
    ),
    
    "MNH04" = paste0(
      format(round(sum(M04_VISIT_COMPLETE_5 == 1 & HM_ANC36_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ANC36_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2)),
    
    "MNH05" = paste0(
      format(round(sum(M05_VISIT_COMPLETE_5 == 1 & HM_ANC36_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ANC36_DENOM_LATE==1, na.rm = TRUE)*100, 2), 
             nsmall = 0, digits = 2)),
    
    "MNH06" = paste0(
      format(round(sum(M06_VISIT_COMPLETE_5 == 1 & HM_ANC36_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ANC36_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2)),
    
    "MNH07" = paste0(
      format(round(sum(M07_VISIT_COMPLETE_5 == 1 & HM_ANC36_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ANC36_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2)),
    
    "MNH08" = paste0(
      format(round(sum(M08_VISIT_COMPLETE_5 == 1 & HM_ANC36_DENOM_LATE==1, na.rm = TRUE)/sum(HM_ANC36_DENOM_LATE==1, na.rm = TRUE)*100, 2),
             nsmall = 0, digits = 2))) %>%
  pivot_longer(cols = -SITE,
               names_to = "FORM", 
               values_to = "COMPLETE_PCT") %>% 
  filter(FORM != "Denominator") %>% 
  mutate(VISIT = "ANC36") %>% 
  mutate(COMPLETE_PCT = as.numeric(COMPLETE_PCT)) %>% 
  mutate(PCT_BIN = cut(COMPLETE_PCT, 
                       breaks = c(seq(0, 90, by = 10), Inf),
                       include.lowest = TRUE,
                       labels = c(paste(seq(0, 80, by = 10), seq(9, 90, by = 10), sep = "-"), "90-100")))

heat_map_data_anc <- bind_rows(ENROLLMENT_PCT, ANC20_PCT, ANC28_PCT, ANC32_PCT, ANC36_PCT)

```

```{r}

# Reorder the "Visit" variable with the desired order
custom_palette <- colorRampPalette(c("darkred", "#B22222", "#FF0000", "#FF6347", "#F9A603",
                                     "#FFA500", "#FFD700", "#FFFF00", "#7bd386", "darkgreen"))(10)

UNIQUE_VISITS = as.vector(unique(heat_map_data_anc$VISIT))

out1  <- heat_map_data_anc %>% 
  filter(VISIT == UNIQUE_VISITS[1]) %>% 
  mutate(SITE = factor(SITE, levels = rev(levels(factor(SITE))))) %>%  # Reverse the order of levels
  ggplot(aes(x = FORM, y = SITE, fill = PCT_BIN)) +
  geom_tile(color = "grey40", size = 0.2) +
  scale_fill_manual(values = custom_palette,
                    labels = c("0-9%", "10-19%", "20-29%", "30-39%", "40-49%",
                               "50-59%", "60-69%", "70-79%", "80-89%", "90-100%"),
                    drop = FALSE) +
  labs(fill = str_wrap("Percent Complete", width = 8)) +
  xlab("Expected forms") +
  ylab("Study site") + 
  # ggtitle(paste0("Form completion at ",tolower(UNIQUE_VISITS[1]), " visit (target window: <20wks)"))  +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(size = 8),
        axis.title.x = element_text(colour = "black", size = 10, margin = margin(t = 20, r = 20, b = 0, l = 0)),
        axis.text.y = element_text(size = 8, colour = "black"),
        legend.text = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.margin = margin(grid::unit(0, "cm")),
        legend.key.width = grid::unit(0.5, "cm"),
        plot.title = element_text(colour = "black", hjust = 0,  size = 10, face = "bold"),
        plot.margin = margin(t = 20, r = 10, b = 10, l = 10),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 10), vjust = 0)) + 
  coord_fixed(ratio = 0.35)  # Adjust the ratio to make the tiles shorter

out2  <- heat_map_data_anc %>%
    mutate(SITE = factor(SITE, levels = rev(levels(factor(SITE))))) %>%  # Reverse the order of levels
  filter(VISIT == UNIQUE_VISITS[2]) %>% 
  ggplot(aes(x = FORM, y = SITE, fill = PCT_BIN)) +
  geom_tile(color = "grey40", size = 0.2) +
  scale_fill_manual(values = custom_palette,
                    labels = c("0-9%", "10-19%", "20-29%", "30-39%", "40-49%",
                               "50-59%", "60-69%", "70-79%", "80-89%", "90-100%"),
                    drop = FALSE) +
  labs(fill = str_wrap("Percent Complete", width = 8)) +
  xlab("Expected forms") +
  ylab("Study site") + 
  # ggtitle(paste0("Form completion at ", tolower(UNIQUE_VISITS[2]), " visit (target window: 18 to 25wks)"))  +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(size = 8),
        axis.title.x = element_text(colour = "black", size = 10, margin = margin(t = 20, r = 20, b = 0, l = 0)),
        axis.text.y = element_text(size = 8, colour = "black"),
        legend.text = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.margin = margin(grid::unit(0, "cm")),
        legend.key.width = grid::unit(0.5, "cm"),
        plot.title = element_text(colour = "black", hjust = 0,  size = 10, face = "bold"),
        plot.margin = margin(t = 20, r = 10, b = 10, l = 10),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 10), vjust = 0)) + 
  coord_fixed(ratio = 0.35)  # Adjust the ratio to make the tiles shorter

out3  <- heat_map_data_anc %>% 
  mutate(SITE = factor(SITE, levels = rev(levels(factor(SITE))))) %>%  # Reverse the order of levels
  filter(VISIT == UNIQUE_VISITS[3]) %>% 
  ggplot(aes(x = FORM, y = SITE, fill = PCT_BIN)) +
  geom_tile(color = "grey40", size = 0.2) +
  scale_fill_manual(values = custom_palette,
                    labels = c("0-9%", "10-19%", "20-29%", "30-39%", "40-49%",
                               "50-59%", "60-69%", "70-79%", "80-89%", "90-100%"),
                    drop = FALSE) +
  labs(fill = str_wrap("Percent Complete", width = 8)) +
  xlab("Expected forms") +
  ylab("Study site") +
  # ggtitle(paste0("Form completion at ", tolower(UNIQUE_VISITS[3]), " visit (target window: 26 to 30wks)"))  +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(size = 8),
        axis.title.x = element_text(colour = "black", size = 10, margin = margin(t = 20, r = 20, b = 0, l = 0)),
        axis.text.y = element_text(size = 8, colour = "black"),
        legend.text = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.margin = margin(grid::unit(0, "cm")),
        legend.key.width = grid::unit(0.5, "cm"),
        plot.title = element_text(colour = "black", hjust = 0,  size = 10, face = "bold"),
        plot.margin = margin(t = 20, r = 10, b = 10, l = 10),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 10), vjust = 0)) + 
  coord_fixed(ratio = 0.35)  # Adjust the ratio to make the tiles shorter

out4  <- heat_map_data_anc %>% 
  mutate(SITE = factor(SITE, levels = rev(levels(factor(SITE))))) %>%  # Reverse the order of levels
  filter(VISIT == UNIQUE_VISITS[4]) %>% 
  ggplot(aes(x = FORM, y = SITE, fill = PCT_BIN)) +
  geom_tile(color = "grey40", size = 0.2) +
  scale_fill_manual(values = custom_palette,
                    labels = c("0-9%", "10-19%", "20-29%", "30-39%", "40-49%",
                               "50-59%", "60-69%", "70-79%", "80-89%", "90-100%"),
                    drop = FALSE) +
  labs(fill = str_wrap("Percent Complete", width = 8)) +
  xlab("Expected forms") +
  ylab("Study site") +
  # ggtitle(paste0("Form completion at ", tolower(UNIQUE_VISITS[4]), " visit (target window: 31 to 33wks)"))  +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(size = 8),
        axis.title.x = element_text(colour = "black", size = 10, margin = margin(t = 20, r = 20, b = 0, l = 0)),
        axis.text.y = element_text(size = 8, colour = "black"),
        legend.text = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.margin = margin(grid::unit(0, "cm")),
        legend.key.width = grid::unit(0.5, "cm"),
        plot.title = element_text(colour = "black", hjust = 0,  size = 10, face = "bold"),
        plot.margin = margin(t = 20, r = 10, b = 10, l = 10),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 10), vjust = 0)) + 
  coord_fixed(ratio = 0.35)  # Adjust the ratio to make the tiles shorter

out5  <- heat_map_data_anc %>% 
  mutate(SITE = factor(SITE, levels = rev(levels(factor(SITE))))) %>%  # Reverse the order of levels
  filter(VISIT == UNIQUE_VISITS[5]) %>% 
  ggplot(aes(x = FORM, y = SITE, fill = PCT_BIN)) +
  geom_tile(color = "grey40", size = 0.2) +
  scale_fill_manual(values = custom_palette,
                    labels = c("0-9%", "10-19%", "20-29%", "30-39%", "40-49%",
                               "50-59%", "60-69%", "70-79%", "80-89%", "90-100%"),
                    drop = FALSE) +
  labs(fill = str_wrap("Percent Complete", width = 8)) +
  xlab("Expected forms") +
  ylab("Study site") +
  # ggtitle(paste0("Form completion at ", tolower(UNIQUE_VISITS[5]), " visit (target window 34 to 38wks)"))  +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(size = 8),
        axis.title.x = element_text(colour = "black", size = 10, margin = margin(t = 20, r = 20, b = 0, l = 0)),
        axis.text.y = element_text(size = 8, colour = "black"),
        legend.text = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.margin = margin(grid::unit(0, "cm")),
        legend.key.width = grid::unit(0.5, "cm"),
        plot.title = element_text(colour = "black", hjust = 0,  size = 10, face = "bold"),
        plot.margin = margin(t = 20, r = 10, b = 10, l = 10),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 10), vjust = 0)) + 
  coord_fixed(ratio = 0.35)  # Adjust the ratio to make the tiles shorter


```

#### Figure 5a. Form completion at enrollment visit (target window: \<20 wks)

```{r}
out1 + theme(legend.position = "bottom")
```

\newpage

#### Figure 5b. Form completion at anc20 visit (target window: 19 to 25wks)

```{r, echo=FALSE,out.width="100%",out.height="49%",fig.show='hold', fig.align='center'}
out2 + theme(legend.position = "bottom")
```

\newpage

#### Figure 5c. Form completion at anc28 visit (target window: 26 to 30wks)

```{r, echo=FALSE,out.width="100%",out.height="49%",fig.show='hold', fig.align='center'}
out3 + theme(legend.position = "bottom")
```

\newpage

#### Figure 5d. Form completion at anc32 visit (target window: 31 to 33wks)

```{r, echo=FALSE,out.width="100%",out.height="49%",fig.show='hold', fig.align='center'}
out4 + theme(legend.position = "bottom")

```

\newpage

#### Figure 5e. Form completion at anc36 visit (target window: 34 to 38wks)

```{r, echo=FALSE,out.width="100%",out.height="49%",fig.show='hold', fig.align='center'}
out5 + theme(legend.position = "bottom")

```

\newpage

### Figures 6a-f. Heat maps of form completion for PNC visits in PRISMA

*Value:* Percent of successful visits during the PNC period.

*Numerator:* By form: visit type = i (variable name: `TYPE_VISIT`) AND
have a complete visit status (where variable name: `MAT_VISIT_MNHXX`=1
or 2) AND passed late window for visit type = i

*Denominator:* Passed late window for visit type = i AND (has not closed
out OR closed out with closeout date \> visit window). *For PNC52 visits denominator is passed late window for visit type = i AND has not closed out OR closed out with reason for closeout=1-year followup completed).*

```{r}

## PNC0
PNC0_PCT <- Heat_Maps_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(HM_PNC0_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06" = paste0(
        format(round(sum(M06_VISIT_COMPLETE_7 == 1 & HM_PNC0_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC0_DENOM_LATE==1, na.rm = TRUE)*100, 2),
               nsmall = 0, digits = 2)),

      "MNH12" = paste0(
        format(round(sum(M12_VISIT_COMPLETE_7==1 & HM_PNC0_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC0_DENOM_LATE==1, na.rm = TRUE)*100, 2),
               nsmall = 0, digits = 2))
      ) %>% 
  pivot_longer(cols = -SITE,
               names_to = "FORM", 
               values_to = "COMPLETE_PCT") %>% 
  filter(FORM != "Denominator") %>% 
  mutate(VISIT = "PNC0") %>% 
  mutate(COMPLETE_PCT = as.numeric(COMPLETE_PCT)) %>% 
  mutate(PCT_BIN = cut(COMPLETE_PCT, 
                       breaks = c(seq(0, 90, by = 10), Inf),
                       include.lowest = TRUE,
                       labels = c(paste(seq(0, 80, by = 10), seq(9, 90, by = 10), sep = "-"), "90-100")))





## PNC1
PNC1_PCT <- Heat_Maps_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(HM_PNC1_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06" = paste0(
        format(round(sum(M06_VISIT_COMPLETE_8 == 1 & HM_PNC1_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC1_DENOM_LATE==1, na.rm = TRUE)*100, 2),
               nsmall = 0, digits = 2)),

      "MNH12" = paste0(
        format(round(sum(M12_VISIT_COMPLETE_8 == 1 & HM_PNC1_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC1_DENOM_LATE==1, na.rm = TRUE)*100, 2),
               nsmall = 0, digits = 2))
      ) %>% 
  pivot_longer(cols = -SITE,
               names_to = "FORM", 
               values_to = "COMPLETE_PCT") %>% 
  filter(FORM != "Denominator") %>% 
  mutate(VISIT = "PNC1") %>% 
  mutate(COMPLETE_PCT = as.numeric(COMPLETE_PCT)) %>% 
  mutate(PCT_BIN = cut(COMPLETE_PCT, 
                       breaks = c(seq(0, 90, by = 10), Inf),
                       include.lowest = TRUE,
                       labels = c(paste(seq(0, 80, by = 10), seq(9, 90, by = 10), sep = "-"), "90-100")))



## PNC4
PNC4_PCT <- Heat_Maps_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(HM_PNC4_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06" = paste0(
        format(round(sum(M06_VISIT_COMPLETE_9 == 1 & HM_PNC4_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC4_DENOM_LATE==1, na.rm = TRUE)*100, 2),
               nsmall = 0, digits = 2)),

      "MNH12" = paste0(
        format(round(sum(M12_VISIT_COMPLETE_9 == 1 & HM_PNC4_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC4_DENOM_LATE==1, na.rm = TRUE)*100, 2),
               nsmall = 0, digits = 2))
      ) %>% 
  pivot_longer(cols = -SITE,
               names_to = "FORM", 
               values_to = "COMPLETE_PCT") %>% 
  filter(FORM != "Denominator") %>% 
  mutate(VISIT = "PNC4") %>% 
  mutate(COMPLETE_PCT = as.numeric(COMPLETE_PCT)) %>% 
  mutate(PCT_BIN = cut(COMPLETE_PCT, 
                       breaks = c(seq(0, 90, by = 10), Inf),
                       include.lowest = TRUE,
                       labels = c(paste(seq(0, 80, by = 10), seq(9, 90, by = 10), sep = "-"), "90-100")))


 
## PNC6
PNC6_PCT <- Heat_Maps_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(HM_PNC6_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH05" = paste0(
        format(round(sum(M05_VISIT_COMPLETE_10 == 1 & HM_PNC6_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC6_DENOM_LATE==1, na.rm = TRUE)*100, 2),
               nsmall = 0, digits = 2)),

      "MNH06" = paste0(
        format(round(sum(M06_VISIT_COMPLETE_10 == 1 & HM_PNC6_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC6_DENOM_LATE==1, na.rm = TRUE)*100, 2),
               nsmall = 0, digits = 2)),

      "MNH07" = paste0(
        format(round(sum(M07_VISIT_COMPLETE_10 == 1 & HM_PNC6_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC6_DENOM_LATE==1, na.rm = TRUE)*100, 2),
               nsmall = 0, digits = 2)),

      "MNH08" = paste0(
        format(round(sum(M08_VISIT_COMPLETE_10 == 1 & HM_PNC6_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC6_DENOM_LATE==1, na.rm = TRUE)*100, 2),
               nsmall = 0, digits = 2)),

      "MNH12" = paste0(
        format(round(sum(M12_VISIT_COMPLETE_10 == 1 & HM_PNC6_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC6_DENOM_LATE==1, na.rm = TRUE)*100, 2),
               nsmall = 0, digits = 2))
      ) %>% 
  pivot_longer(cols = -SITE,
               names_to = "FORM", 
               values_to = "COMPLETE_PCT") %>% 
  filter(FORM != "Denominator") %>% 
  mutate(VISIT = "PNC6") %>% 
  mutate(COMPLETE_PCT = as.numeric(COMPLETE_PCT)) %>% 
  mutate(PCT_BIN = cut(COMPLETE_PCT, 
                       breaks = c(seq(0, 90, by = 10), Inf),
                       include.lowest = TRUE,
                       labels = c(paste(seq(0, 80, by = 10), seq(9, 90, by = 10), sep = "-"), "90-100")))



## PNC26
PNC26_PCT <- Heat_Maps_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(HM_PNC26_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH05" = paste0(
        format(round(sum(M05_VISIT_COMPLETE_11 == 1 & HM_PNC26_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC26_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2)),

      "MNH06" = paste0(
        format(round(sum(M06_VISIT_COMPLETE_11 == 1 & HM_PNC26_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC26_DENOM_LATE==1, na.rm = TRUE)*100, 2),
               nsmall = 0, digits = 2)),
# 
#       "MNH07" = paste0(
#         format(round(sum(M07_VISIT_COMPLETE_11 == 1 & HM_PNC26_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC26_DENOM_LATE==1, na.rm = TRUE)*100, 2),
#                nsmall = 0, digits = 2)),
# 
#       "MNH08" = paste0(
#         format(round(sum(M08_VISIT_COMPLETE_11 == 1 & HM_PNC26_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC26_DENOM_LATE==1, na.rm = TRUE)*100, 2),
#                nsmall = 0, digits = 2)),
# 
      "MNH12" = paste0(
        format(round(sum(M12_VISIT_COMPLETE_11 == 1 & HM_PNC26_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC26_DENOM_LATE==1, na.rm = TRUE)*100, 2),
               nsmall = 0, digits = 2))
      ) %>% 
  pivot_longer(cols = -SITE,
               names_to = "FORM", 
               values_to = "COMPLETE_PCT") %>% 
  filter(FORM != "Denominator") %>% 
  mutate(VISIT = "PNC26") %>% 
  mutate(COMPLETE_PCT = as.numeric(COMPLETE_PCT)) %>% 
  mutate(PCT_BIN = cut(COMPLETE_PCT, 
                       breaks = c(seq(0, 90, by = 10), Inf),
                       include.lowest = TRUE,
                       labels = c(paste(seq(0, 80, by = 10), seq(9, 90, by = 10), sep = "-"), "90-100")))




## PNC52
PNC52_PCT <- Heat_Maps_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(HM_PNC52_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

     "MNH05" = paste0(
        format(round(sum(M05_VISIT_COMPLETE_12 == 1 & HM_PNC52_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC52_DENOM_LATE==1, na.rm = TRUE)*100, 2),
               nsmall = 0, digits = 2)),


      "MNH06" = paste0(
        format(round(sum(M06_VISIT_COMPLETE_12 == 1 & HM_PNC52_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC52_DENOM_LATE==1, na.rm = TRUE)*100, 2),
               nsmall = 0, digits = 2)),

      "MNH12" = paste0(
        format(round(sum(M12_VISIT_COMPLETE_12 == 1 & HM_PNC52_DENOM_LATE==1, na.rm = TRUE)/sum(HM_PNC52_DENOM_LATE==1, na.rm = TRUE)*100, 2),
               nsmall = 0, digits = 2))
     ) %>% 
  pivot_longer(cols = -SITE,
               names_to = "FORM", 
               values_to = "COMPLETE_PCT") %>% 
  filter(FORM != "Denominator") %>% 
  mutate(VISIT = "PNC52") %>% 
  mutate(COMPLETE_PCT = as.numeric(COMPLETE_PCT)) %>% 
  mutate(PCT_BIN = cut(COMPLETE_PCT, 
                       breaks = c(seq(0, 90, by = 10), Inf),
                       include.lowest = TRUE,
                       labels = c(paste(seq(0, 80, by = 10), seq(9, 90, by = 10), sep = "-"), "90-100")))


heat_map_data_pnc <- bind_rows(PNC0_PCT, PNC1_PCT, PNC4_PCT, PNC6_PCT, PNC26_PCT, PNC52_PCT)

```

```{r}

# Reorder the "Visit" variable with the desired order
custom_palette <- colorRampPalette(c("darkred", "#B22222", "#FF0000", "#FF6347", "#F9A603",
                                     "#FFA500", "#FFD700", "#FFFF00", "#7bd386", "darkgreen"))(10)

UNIQUE_VISITS = as.vector(unique(heat_map_data_pnc$VISIT))

out1  <- heat_map_data_pnc %>%
  mutate(SITE = factor(SITE, levels = rev(levels(factor(SITE))))) %>%  # Reverse the order of levels
  filter(VISIT == UNIQUE_VISITS[1]) %>% 
  ggplot(aes(x = FORM, y = SITE, fill = PCT_BIN)) +
  geom_tile(color = "grey40", size = 0.2) +
  scale_fill_manual(values = custom_palette,
                    labels = c("0-9%", "10-19%", "20-29%", "30-39%", "40-49%",
                               "50-59%", "60-69%", "70-79%", "80-89%", "90-100%"),
                    drop = FALSE) +
  labs(fill = str_wrap("Percent Complete", width = 8)) +
  xlab("Expected forms") +
  ylab("Study site") +
  # ggtitle(paste0("Form completion at ", tolower(UNIQUE_VISITS[1]), " visit (target window: 3 to 5 days)"))  +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(size = 8),
        axis.title.x = element_text(colour = "black", size = 10, margin = margin(t = 20, r = 20, b = 0, l = 0)),
        axis.text.y = element_text(size = 8, colour = "black"),
        legend.text = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.margin = margin(grid::unit(0, "cm")),
        legend.key.width = grid::unit(0.5, "cm"),
        plot.title = element_text(colour = "black", hjust = 0,  size = 10, face = "bold"),
        plot.margin = margin(t = 20, r = 10, b = 10, l = 10),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 10), vjust = 0)) + 
  coord_fixed(ratio = 0.35)  # Adjust the ratio to make the tiles shorter

out2  <- heat_map_data_pnc %>% 
  mutate(SITE = factor(SITE, levels = rev(levels(factor(SITE))))) %>%  # Reverse the order of levels
  filter(VISIT == UNIQUE_VISITS[2]) %>% 
  ggplot(aes(x = FORM, y = SITE, fill = PCT_BIN)) +
  geom_tile(color = "grey40", size = 0.2) +
  scale_fill_manual(values = custom_palette,
                    labels = c("0-9%", "10-19%", "20-29%", "30-39%", "40-49%",
                               "50-59%", "60-69%", "70-79%", "80-89%", "90-100%"),
                    drop = FALSE) +
  labs(fill = str_wrap("Percent Complete", width = 8)) +
  xlab("Expected forms") +
  ylab("Study site") +
  # ggtitle(paste0("Form completion at ", tolower(UNIQUE_VISITS[2]), " visit (target window: 7 to 14 days)"))  +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(size = 8),
        axis.title.x = element_text(colour = "black", size = 10, margin = margin(t = 20, r = 20, b = 0, l = 0)),
        axis.text.y = element_text(size = 8, colour = "black"),
        legend.text = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.margin = margin(grid::unit(0, "cm")),
        legend.key.width = grid::unit(0.5, "cm"),
        plot.title = element_text(colour = "black", hjust = 0,  size = 10, face = "bold"),
        plot.margin = margin(t = 20, r = 10, b = 10, l = 10),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 10), vjust = 0)) + 
  coord_fixed(ratio = 0.35)  # Adjust the ratio to make the tiles shorter

out3  <- heat_map_data_pnc %>% 
  mutate(SITE = factor(SITE, levels = rev(levels(factor(SITE))))) %>%  # Reverse the order of levels
  filter(VISIT == UNIQUE_VISITS[3]) %>% 
  ggplot(aes(x = FORM, y = SITE, fill = PCT_BIN)) +
  geom_tile(color = "grey40", size = 0.2) +
  scale_fill_manual(values = custom_palette,
                    labels = c("0-9%", "10-19%", "20-29%", "30-39%", "40-49%",
                               "50-59%", "60-69%", "70-79%", "80-89%", "90-100%"),
                    drop = FALSE) +
  labs(fill = str_wrap("Percent Complete", width = 8)) +
  xlab("Expected forms") +
  ylab("Study site") +
  # ggtitle(paste0("Form completion at ", tolower(UNIQUE_VISITS[3]), " visit (target window: 28 to 35 days)"))  +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(size = 8),
        axis.title.x = element_text(colour = "black", size = 10, margin = margin(t = 20, r = 20, b = 0, l = 0)),
        axis.text.y = element_text(size = 8, colour = "black"),
        legend.text = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.margin = margin(grid::unit(0, "cm")),
        legend.key.width = grid::unit(0.5, "cm"),
        plot.title = element_text(colour = "black", hjust = 0,  size = 10, face = "bold"),
        plot.margin = margin(t = 20, r = 10, b = 10, l = 10),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 10), vjust = 0)) + 
  coord_fixed(ratio = 0.35)  # Adjust the ratio to make the tiles shorter

out4  <- heat_map_data_pnc %>% 
  mutate(SITE = factor(SITE, levels = rev(levels(factor(SITE))))) %>%  # Reverse the order of levels
  filter(VISIT == UNIQUE_VISITS[4]) %>% 
  ggplot(aes(x = FORM, y = SITE, fill = PCT_BIN)) +
  geom_tile(color = "grey40", size = 0.2) +
  scale_fill_manual(values = custom_palette,
                    labels = c("0-9%", "10-19%", "20-29%", "30-39%", "40-49%",
                               "50-59%", "60-69%", "70-79%", "80-89%", "90-100%"),
                    drop = FALSE) +
  labs(fill = str_wrap("Percent Complete", width = 8)) +
  xlab("Expected forms") +
  ylab("Study site") +
  # ggtitle(paste0("Form completion at ", tolower(UNIQUE_VISITS[4]), " visit (target window: 6 to 12wks)"))  +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(size = 8),
        axis.title.x = element_text(colour = "black", size = 10, margin = margin(t = 20, r = 20, b = 0, l = 0)),
        axis.text.y = element_text(size = 8, colour = "black"),
        legend.text = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.margin = margin(grid::unit(0, "cm")),
        legend.key.width = grid::unit(0.5, "cm"),
        plot.title = element_text(colour = "black", hjust = 0,  size = 10, face = "bold"),
        plot.margin = margin(t = 20, r = 10, b = 10, l = 10),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 10), vjust = 0)) + 
  coord_fixed(ratio = 0.35)  # Adjust the ratio to make the tiles shorter

out5  <- heat_map_data_pnc %>% 
  mutate(SITE = factor(SITE, levels = rev(levels(factor(SITE))))) %>%  # Reverse the order of levels
  filter(VISIT == UNIQUE_VISITS[5]) %>% 
  ggplot(aes(x = FORM, y = SITE, fill = PCT_BIN)) +
  geom_tile(color = "grey40", size = 0.2) +
  scale_fill_manual(values = custom_palette,
                    labels = c("0-9%", "10-19%", "20-29%", "30-39%", "40-49%",
                               "50-59%", "60-69%", "70-79%", "80-89%", "90-100%"),
                    drop = FALSE) +
  labs(fill = str_wrap("Percent Complete", width = 8)) +
  xlab("Expected forms") +
  ylab("Study site") +
  # ggtitle(paste0("Form completion at ",tolower(UNIQUE_VISITS[5]), " visit (target window: 26 to 39wks)"))  +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(size = 8),
        axis.title.x = element_text(colour = "black", size = 10, margin = margin(t = 20, r = 20, b = 0, l = 0)),
        axis.text.y = element_text(size = 8, colour = "black"),
        legend.text = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.margin = margin(grid::unit(0, "cm")),
        legend.key.width = grid::unit(0.5, "cm"),
        plot.title = element_text(colour = "black", hjust = 0,  size = 10, face = "bold"),
        plot.margin = margin(t = 20, r = 10, b = 10, l = 10),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 10), vjust = 0)) + 
  coord_fixed(ratio = 0.35)  # Adjust the ratio to make the tiles shorter


out6  <- heat_map_data_pnc %>%
  mutate(SITE = factor(SITE, levels = rev(levels(factor(SITE))))) %>%  # Reverse the order of levels
  filter(VISIT == UNIQUE_VISITS[6]) %>%
  ggplot(aes(x = FORM, y = SITE, fill = PCT_BIN)) +
  geom_tile(color = "grey40", size = 0.2) +
  scale_fill_manual(values = custom_palette,
                    labels = c("0-9%", "10-19%", "20-29%", "30-39%", "40-49%",
                               "50-59%", "60-69%", "70-79%", "80-89%", "90-100%"),
                    drop = FALSE) +
  labs(fill = str_wrap("Percent Complete", width = 8)) +
  xlab("Expected forms") +
  ylab("Study site") +
  # ggtitle(paste0("Form completion at ",tolower(UNIQUE_VISITS[6]), " visit (target window: 52 to 64wks)"))  +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(size = 8),
        axis.title.x = element_text(colour = "black", size = 10, margin = margin(t = 20, r = 20, b = 0, l = 0)),
        axis.text.y = element_text(size = 8, colour = "black"),
        legend.text = element_text(size = 8),
        axis.title.y = element_blank(),
        legend.margin = margin(grid::unit(0, "cm")),
        legend.key.width = grid::unit(0.5, "cm"),
        plot.title = element_text(colour = "black", hjust = 0,  size = 10, face = "bold"),
        plot.margin = margin(t = 20, r = 10, b = 10, l = 10),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 10), vjust = 0)) +
  coord_fixed(ratio = 0.35)  # Adjust the ratio to make the tiles shorter

```

#### Figure 6a. Form completion at pnc0 visit (target window: 3 to 5 days)

```{r, echo=FALSE,out.width="100%",out.height="49%",fig.show='hold', fig.align='center'}

# # Extract and format the legend
# legend_gtable <- g_legend(out1)
# 
# # Print just the legend horizontally
# grid.newpage()
# grid.arrange(legend_gtable)

out1 + theme(legend.position = "bottom")
```

\newpage

#### Figure 6b. Form completion at pnc1 visit (target window: 7 to 14 days)

```{r, echo=FALSE,out.width="100%",out.height="49%",fig.show='hold', fig.align='center'}
out2 + theme(legend.position = "bottom")
```

\newpage

#### Figure 6c. Form completion at pnc4 visit (target window: 28 to 35 days)

```{r, echo=FALSE,out.width="100%",out.height="49%",fig.show='hold', fig.align='center'}
out3 + theme(legend.position = "bottom")
```

\newpage

#### Figure 6d. Form completion at pnc6 visit (target window: 6 to 12wks)

```{r, echo=FALSE,out.width="100%",out.height="49%",fig.show='hold', fig.align='center'}
out4 + theme(legend.position = "bottom")

```

\newpage

#### Figure 6e. Form completion at pnc26 visit (target window: 26 to 39wks)

```{r, echo=FALSE,out.width="100%",out.height="49%",fig.show='hold', fig.align='center'}
out5 + theme(legend.position = "bottom")

```

\newpage

#### Figure 6f. Form completion at pnc52 visit (target window: 52 to 64 wks)

```{r, echo=FALSE,out.width="100%",out.height="49%",fig.show='hold', fig.align='center'}
out6 + theme(legend.position = "bottom")
```

\newpage

### Table 12. Summary of PRISMA infant outcomes.

**Denominator:** All livebirths unless otherwise specified. All missing
is excluded.

*For more detailed output, please refer to the infant outcomes report.*

```{r}

## this data is generated in the infant outcomes report code linked here in github: https://github.com/PRiSMA-Study/PRISMA-Public/blob/main/PRISMA-Infant-Constructed-Outcomes/Infant-Constructed-Variables.R


infantoutcomes_output <- tb_theme1(infantoutcomes_summary) %>% 
  tab_header(
    title = md("**PRISMA Table 12**")
  )  %>% 

tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> Denominator is all live births with MNH09 and MNH11 filled out AND have passed the risk period with a visit OR died within the risk period (risk period: age = 28days).</span>")
) %>% 
    tab_footnote(
        footnote = html("<span style='font-size: 18px'><sup>b</sup> Denominator is all livebirths and stillbirths.</span>")
    ) %>% 
    tab_footnote(
        footnote = html("<span style='font-size: 18px'><sup>c</sup> Denominator is all infants with a fetal loss reported in MNH04 or birth outcome in MNH09.</span>")
    ) %>% 
    tab_footnote(
        footnote = html("<span style='font-size: 18px'><sup>d</sup> 
All infants with a TcB measurement taken at <14 weeks of life.</span>")
    ) %>% 
    tab_footnote(
        footnote = html("<span style='font-size: 18px'><sup>e</sup> 
All infants with a jaundice assessment at <14 weeks of life.</span>")
    ) %>% 
    tab_footnote(
      footnote = html("<span style='font-size: 18px'><sup>f</sup> Denominator is all livebirths aged 0-59 days.</span>")
   )


```

```{r, out.width = '100%'}
infantoutcomes_output <- infantoutcomes_output %>% gtsave("infantoutcomes_output.png", expand = 10)
knitr::include_graphics("infantoutcomes_output.png")
```

\newpage

## **2. ReMAPP Study Monitoring Report**

### Table 13: Protocol compliance for ReMAPP fatigue assessment

*Value:* Percent of fatigue assessments (MNH26) completed among women
expected for visits in the ANC and PNC periods, regardless of visit
completion status. A visit is considered `complete` if the data reports
the visit was conducted in person or by phone (variable name:
`MAT_VISIT_MNHXX`). The table below shows protocol compliance
distributions for MNH26 forms following site launch of ReMAPP. These
forms can be filled out either during individual visits (e.g., ANC20) or
during combined visits after the gestational age window has passed
(e.g., combined Enrollment and ANC20 visits).For example, the
denominator for MNH26 completed at ANC32 is the number of participants
who have passed the ANC36 late window to allow for combined visits.

*Numerator:* MNH26 with visit type = i (variable name: `TYPE_VISIT`) AND
have a complete visit status (variable name: `MAT_VISIT_MNHXX`) AND
passed late window for visit type = i AND (has not delivered OR
delivered with gestational age \> late visit window) AND (has not closed
out OR closed out with closeout date \> visit window)

*Denominator:* Passed late window for visit type = i AND (has not
delivered OR delivered with gestational age \> late visit window) AND
(has not closed out OR closed out with closeout date \> visit window)

```{r}
    
    #* Num: MNH26 with visit status = 1 or 2 AND passed window for visit type = i 
    #* Denom: passed window for visit type = i 
    
prot_compliance_fatigue <- Prot_Compliance_MNH26 %>% 
      rowwise() %>% 
      group_by(SITE) %>% 
      summarise(
        
      # ANC 20
        "ANC20^a^" = paste0(
          format(sum(M26_ANCLESS20_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M26_ANCLESS20_NUM == 1, na.rm = TRUE)/sum(PC_ANCLESS20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
          
        "Denominator, n" = paste0(
          format(sum(PC_ANCLESS20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)), 

      ## ANC 32
        "ANC32^b^" = paste0(
          format(sum(M26_ANCOVER31_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M26_ANCOVER31_NUM == 1, na.rm = TRUE)/sum(PC_ANCOVER31_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),

        "Denominator, n " = paste0(
          format(sum(PC_ANCOVER31_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)), 
        
     ### PNC 6      
     "PNC6^c^" = paste0(
          format(sum(M26_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M26_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),

        "Denominator, n  " = paste0(
          format(sum(PC_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2))

      )  %>%
      t() %>% as.data.frame() %>% 
      `colnames<-`(c(.[1,])) %>% 
      slice(-1) %>% 
      add_column(
        .before = 1,
        "Total" = Prot_Compliance_MNH26 %>% 
          plyr::summarise(
            
      # ANC 20
        "ANC20^a^" = paste0(
          format(sum(M26_ANCLESS20_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M26_ANCLESS20_NUM == 1, na.rm = TRUE)/sum(PC_ANCLESS20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
          
        "Denominator, n" = paste0(
          format(sum(PC_ANCLESS20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)), 

      ## ANC 32
        "ANC32^b^" = paste0(
          format(sum(M26_ANCOVER31_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M26_ANCOVER31_NUM == 1, na.rm = TRUE)/sum(PC_ANCOVER31_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),

        "Denominator, n " = paste0(
          format(sum(PC_ANCOVER31_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)), 
        
     ### PNC 6      
     "PNC6^c^" = paste0(
          format(sum(M26_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M26_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),

        "Denominator, n  " = paste0(
          format(sum(PC_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2))
            
          ) %>% 
          t() %>% 
          as.data.frame() %>% 
          `colnames<-`(c(.[1,])) %>% unlist() 
  )
      
    
```

```{r}

remapp_table1 <- prot_compliance_fatigue %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0"))) 

## table 8
remapp_table1 <- tb_theme1(remapp_table1) %>% 
  tab_header(
    title = md("**Table 13**")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Fatigue assessments (MNH26)</span>"),
    rows = 1:6
  ) %>%
  tab_style(
      style = list(
        cell_text(indent = px(40))
        ),
      locations = cells_stub(rows = c("Denominator, n",
                                      "Denominator, n ",
                                      "Denominator, n  "))
) %>% 
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> denominator is n passed ANC20 late window with >25 weeks gestation AND (has not delivered OR delivered with gestational age >25wks) AND (has not closed out OR closed out with closeout date >25wks).</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> denominator is n passed ANC32 late window with >33 weeks gestation AND (has not delivered OR delivered with gestational age >33wks) AND (has not closed out OR closed out with closeout date >33wks).</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> denominator is n passed PNC6 late window with >12 weeks postpartum AND (has not closed out OR closed out with closeout date >12wks postpartum).</span>")
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note:</sup> This table includes all participants who were enrolled following site launch of ReMAPP.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>ANC Note:</sup> passed window denominators for ANC visits are calculated by EDD reported in MNH01 (US_EDD_BRTHDAT). If an EDD is missing, the participant is removed from this table.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>PNC Note:</sup> passed window denominators for PNC visits are calculated by date and time of birth reported in MNH09. If an date of birth is missing, the participant is removed from this table.</span>")
)

```

```{r}
remapp_table1 <- remapp_table1 %>% gtsave("remapp_table1.png")
knitr::include_graphics("remapp_table1.png")
```

\newpage

### Table 14: Participant eligibility for the ReMAPP healthy cohort

*Value:* This table will be updated as lab measurements are updated and
reported. Those who are unknown may move into eligible or ineligible
categories based on updated lab reports. Those who are eligible were
enrolled in PRISMA following the launch of ReMAPP at each site.
Distributions of eligibility criteria are outlined in Table 2 below.

```{r}

options(knitr.kable.NA = '0 (0)')


remapp_table2 <- healthyOutcome %>% 
  filter(ENROLL == 1) %>% 
  group_by(SITE) %>% 
  summarise("Total enrolled in PRISMA since ReMAPP launch" = paste0("(n=", n(), ")"),
            "Eligible for healthy cohort, n(%)" = paste0(sum(HEALTHY_ELIGIBLE == 1, na.rm=TRUE),
                                        " (", format(sum(HEALTHY_ELIGIBLE == 1, na.rm=TRUE)/sum(ENROLL == 1)*100, digits = 2, nsmall=0), ")"),
            "Ineligible for healthy cohort, n(%)" = paste0(sum(HEALTHY_ELIGIBLE == 0, na.rm=TRUE),
                             " (", format(sum(HEALTHY_ELIGIBLE == 0, na.rm=TRUE)/sum(ENROLL == 1)*100, digits = 2, nsmall=0), ")"),
            "Pending, n(%)^a^" = paste0(sum(HEALTHY_ELIGIBLE == 3, na.rm=TRUE),
                                " (", format(sum(HEALTHY_ELIGIBLE == 3, na.rm=TRUE)/sum(ENROLL == 1)*100, digits = 2, nsmall=0), ")")
  ) %>% 
    t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "Total" = healthyOutcome %>% 
  filter(ENROLL == 1) %>% 
  plyr::summarise("Total enrolled in PRISMA since ReMAPP launch" = paste0("(n=", sum(ENROLL==1), ")"), 
            "Eligible , n(%)" = paste0(sum(HEALTHY_ELIGIBLE == 1, na.rm=TRUE),
                                        " (", format(sum(HEALTHY_ELIGIBLE == 1, na.rm=TRUE)/sum(ENROLL==1)*100, digits = 2, nsmall=0), ")"),
            "Ineligible, n(%)" = paste0(sum(HEALTHY_ELIGIBLE == 0, na.rm=TRUE),
                             " (", format(sum(HEALTHY_ELIGIBLE == 0, na.rm=TRUE)/sum(ENROLL == 1)*100, digits = 2, nsmall=0), ")"),
            "Pending, n(%)^a^" = paste0(sum(HEALTHY_ELIGIBLE == 3, na.rm=TRUE),
                                " (", format(sum(HEALTHY_ELIGIBLE == 3, na.rm=TRUE)/sum(ENROLL == 1)*100, digits = 2, nsmall=0), ")")
  ) %>% 
      t() %>% unlist()
  ) 
```

```{r}

remapp_table2 <- remapp_table2 %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0"))) 

## ReMAPP table 2
remapp_table2 <- tb_theme1(remapp_table2) %>% 
  tab_header(
    title = md("**Table 14**")
  ) %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> a participant is considered pending if default values 55 or -5 are reported for any of the criteria.</span>")
)

```

```{r}
remapp_table2 <- remapp_table2 %>% gtsave("remapp_table2.png")
knitr::include_graphics("remapp_table2.png")
```

\newpage

### Figure 7: Eligibility status and missingness by ReMAPP healthy cohort criteria

*Value:* Illustrates the distribution of each healthy cohort criteria
(C1-C19) among women enrolled in PRISMA since ReMAPP launch. Missing
means missing form, note that it includes pending data (test not
performed yet or result pending).

```{r}
plot_criteria <- df_eli_long 

plot_criteria %>%
  ggplot(aes(y = reorder(Variable, desc(Variable)), fill = Value)) + 
  geom_bar(alpha = 0.9, aes(x = (..count..)/sum(..count..)), position = position_fill(reverse = TRUE)) +
  scale_x_continuous(labels=percent) + 
  scale_y_discrete(limits = rev(levels("Variable"))) +
  scale_fill_manual(
    values = c("#43bfc7","#F0833A","lightgrey"), 
    drop = FALSE) + 
  xlab("") + 
  ylab("") +
  facet_grid(~SITE, scales = "free_y", margins = FALSE) + 
  theme_bw() +  
  theme(strip.background=element_rect(fill="white"),
        axis.text = element_text(size = 7),
        axis.text.x = element_text(size = 6, angle = 90),  # Rotate x-axis labels by 180 degrees
        legend.key.size = unit(0.38,"cm"),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),)

```

**Description of eligibility criteria (C1-C19):**

-   C1: Aged 18 to 34 years;
-   C2: Gestational age \<14 weeks
-   C3: Pre-pregnancy or early pregnancy body mass index (BMI) of \>18.5
    and \<30 kg/m2 AND mid-upper arm circumference (MUAC) \> 23cm
-   C4: Height ≥150 cm
-   C5: Singleton pregnancy
-   C6: No previous reported low birth weight delivery
-   C7: No previous reported stillbirth
-   C8: No previous reported unplanned cesarean delivery
-   C9: No reported cigarette smoking, tobacco chewing, or betel nut use
    during pregnancy
-   C10: No reported alcohol consumption during pregnancy
-   C11: No known history or current chronic disease including cancer,
    kidney disease, and cardiac conditions
-   C12: No known history or current HIV
-   C13: Systolic blood pressure \<140 mmHg and diastolic blood pressure
    \<90 mmHg
-   C14: No current malaria infection (per rapid diagnostic test)
-   C15: No current Hepatitis B virus infection (per rapid diagnostic
    test)
-   C16: No current Hepatitis C virus infection (per rapid diagnostic
    test)
-   C17: Not iron deficient (serum ferritin \>15 mcg/L-- adjusted for
    inflammation)
-   C18: No subclinical inflammation (CRP\>=5 mg/L and/or AGP\>=1 g/L)
-   C19: No hemoglobinopathies: SS, SC, SE, EE, CC, SD-Punjab, Sβthal,
    Eβthal, Cβthal, CD-Punjab, ED-Punjab, D-D-Punjab, D-Punjabβthal,
    Thalassemia major, Thalassemia intermedia, glucose-6-phosphate
    dehydrogenase deficiency, or Alpha thalassemia

\newpage

### Table 15: Protocol compliance for ReMAPP hemoglobin measurements by CBC

*Value:* Protocol compliance for CBC hemoglobin measurements at required
ReMAPP study visits, regardless of visit completion status.

```{r}
## denominators: 
  # DenHBV1 = MNH08 completed with visit type = 1 AND visit status = 1/2 OR enrollment overdue
  # DenHBV2 = MNH08 completed with visit type = 2 AND visit status = 1/2 AND GA at enrollment <= 17wks OR ANC20 overdue
  # DenHBV3 = MNH08 completed with visit type = 3 AND visit status = 1/2 OR ANC28 overdue
  # DenHBV5 = MNH08 completed with visit type = 5 AND visit status = 1/2 OR ANC36 overdue
  # DenHBV10 = MNH08 completed with visit type = 10 AND visit status = 1/2 OR PNC6 overdue

remapp_table3 <- MatData_Hb_Visit %>%
  group_by(SITE) %>%
    summarise(
          "Total enrolled since ReMAPP launch" = paste0(
            "(n=", n(),")"
          ),
            "Enrollment" = paste0(sum(HB_COMPLETED_1 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_1 == 1, na.rm = TRUE)/sum(DenHBV1 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
            "ANC20" = paste0(sum(HB_COMPLETED_2 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_2 == 1, na.rm = TRUE)/sum(DenHBV2 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
            "ANC28" = paste0(sum(HB_COMPLETED_3 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_3 == 1, na.rm = TRUE)/sum(DenHBV3 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
  
            "ANC36" = paste0(sum(HB_COMPLETED_5 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_5 == 1, na.rm = TRUE)/sum(DenHBV5 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
  
            "PNC6" = paste0(sum(HB_COMPLETED_10 == 1 & DenHBV10 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_10 == 1 & DenHBV10 == 1, na.rm = TRUE)/sum(DenHBV10 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")")

) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .before = 1,
    "Total" = MatData_Hb_Visit %>%
    plyr::summarise(
          "Total enrolled since ReMAPP launch" = paste0(
            "(n=", sum(ENROLL_DENOM == 1, na.rm=TRUE),")"),
          
            "Enrollment" = paste0(sum(HB_COMPLETED_1 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_1 == 1, na.rm = TRUE)/sum(DenHBV1 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
            "ANC20" = paste0(sum(HB_COMPLETED_2 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_2 == 1, na.rm = TRUE)/sum(DenHBV2 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
            "ANC28" = paste0(sum(HB_COMPLETED_3 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_3 == 1, na.rm = TRUE)/sum(DenHBV3 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
  
            "ANC36" = paste0(sum(HB_COMPLETED_5 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_5 == 1, na.rm = TRUE)/sum(DenHBV5 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
  
            "PNC6" = paste0(sum(HB_COMPLETED_10 == 1& DenHBV10 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_10 == 1 & DenHBV10 == 1, na.rm = TRUE)/sum(DenHBV10 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")")

) %>%
      t() %>% unlist()
  )


```

```{r}

remapp_table3 <- remapp_table3 %>%    
  `rownames<-`(c("Total enrolled in PRISMA since ReMAPP launch",
                  "Enrollment visit (<20wks), n(%)^a^",
                  "ANC-20 visit, n(%)^b^",
                  "ANC-28 visit, n(%)^c^",
                  "ANC-36 visit, n(%)^d^",
                  "PNC-6 visit, n(%)^e^"
                 )) %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0"))) 

## ReMAPP Table 3
remapp_table3 <- tb_theme1(remapp_table3) %>% 
  tab_header(
    title = md("*Table 15**")
  ) %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> denominator is n enrolled during ReMAPP study period.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> denominator is n completed MNH08 with visit type=ANC-20 OR missed late window with >25 weeks gestation.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> denominator is n completed  MNH08 with visit type=ANC-28 OR missed late window with >30 weeks gestation.</span>")
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>d</sup> denominator is n completed  MNH08 with visit type=ANC-36 OR missed late window with >38 weeks gestation.</span>")
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>e</sup> denominator is n completed  MNH08 with visit type=PNC-6 OR missed late window with >12 weeks postpartum</span>")
) 

```

```{r}
remapp_table3 <- remapp_table3 %>% gtsave("remapp_table3.png")
knitr::include_graphics("remapp_table3.png")
```

\newpage

### Figure 8: Plot of PRISMA hemoglobin measurements using any method by gestational age

```{r}
## x axis in days
MatData_Hb_GA_Visit <- MatData_Hb_GA_Visit %>% filter(GA > 0)

ggplot(data = MatData_Hb_GA_Visit,
             aes(x = GA, y = RESULT, group = TEST, color = TEST), ) +
  geom_point(alpha = 0.25)  +
    facet_grid(rows = vars(SITE)) +
    theme_bw() +
    ylim(0,25) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position="bottom",
        panel.grid.minor = element_blank(),
    # Adjust facet label font size
        strip.text = element_text(size = 7) # You can modify the size as needed
        ) +
  scale_x_continuous(breaks = c(0,49,98,147,198,245, 294),
                     label = c("0", "7", "14", "21", "28", "35", "42"), 
                     limits = c(0,294)) +
  xlab("Gestational Age (weeks)") +
  ylab("Hemoglobin (g/dL)") +
  scale_color_brewer(palette="Set1") + 
  labs(color = "Method") 

```
