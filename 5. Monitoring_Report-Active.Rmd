---
title: "<span style='font-size: 18px'> <span style='text-align: center'> PRISMA & ReMAPP Monitoring Report (Issued: 2023-05-30)"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 4
  word_document:
    toc: yes
    toc_depth: '4'
  pdf_document:
    toc: yes
    toc_depth: '4'
    df_print: kable
always_allow_html: true
---
  
```{r updates, include=FALSE}
 # Last Updated: May 20, 2023
      # Updated tables to display visit completion, form completion, and protocol compliance 
      # Split table 5 (Visit completion) into two tables (5a and 5b) to reflect on-time and late windows, respectively

# Previous updates:
    # May 01, 2023: 
      # 1. Combined tables 1a and 2a to include only 1 table that provides a snapshot of prescreening/enrollment in the most recent 1 week. 
      # 2. Renamed the remaining tables to account for changes in tables 1-2
  
```

```{css, echo=FALSE}
.table caption {
  color: black;
  font-weight: bold;
}
```

<center>
##### PRISMA MNH and ReMAPP Monitoring Report {.unlisted .unnumbered}
</center>

&nbsp;

#####  **PRISMA MNH:** Pregnancy Risk and Infant Surveillance and Measurement Alliance Maternal and Newborn Health (PRISMA MNH) Study: A multi-center, prospective cohort study of maternal, newborn, and infant health {.unlisted .unnumbered}

&nbsp;

#####  **ReMAPP:** Redefining Maternal Anemia in Pregnancy and Postpartum (ReMAPP) Study {.unlisted .unnumbered}

<!-- &nbsp; -->

<!-- ##### **Date report issued:** `r Sys.Date()` {.unlisted .unnumbered} -->

&nbsp;

##### **Includes data from synapse last updated:** {.unlisted .unnumbered}
##### Kenya : 2023-05-26 {.unlisted .unnumbered}
##### Pakistan : 2023-05-26 {.unlisted .unnumbered}
##### Ghana : 2023-05-26 {.unlisted .unnumbered}
##### Zambia : 2023-05-26 {.unlisted .unnumbered}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
 
library(knitr)
library(tidyverse)
library(reshape2)
library(lubridate)
library(kableExtra)
library(emo)
library(naniar)
#library(dplyr)
library(RColorBrewer)

UploadDate = "2023-05-26" 

## Set working directory to site-specific folder -- QUERIES folder
setwd(paste0("D:/Users/stacie.loisate/Documents/Monitoring Report/data/cleaned/", UploadDate, sep = ""))

## import all rda files 
rda_files = list.files(pattern="*.RData")
walk(rda_files, ~ load(.x, .GlobalEnv))

```

```{r, results='hide'}
#check last day of screening and enrollment
lastscreen <- MatData_Screen_Enroll %>%
  filter(PRESCREEN == 1) %>%
  select(M00_SCRN_OBSSTDAT_1, M02_SCRN_OBSSTDAT_1, SITE) %>%
  group_by(SITE) %>%
  mutate(last_screen = max((M00_SCRN_OBSSTDAT_1), na.rm = TRUE)) %>% 
  ungroup()

lastenroll <- MatData_Screen_Enroll %>%
  filter(ENROLL == 1) %>% 
  select(M00_SCRN_OBSSTDAT_1, M02_SCRN_OBSSTDAT_1, SITE) %>%
  group_by(SITE) %>%
  mutate(last_enroll = max((M02_SCRN_OBSSTDAT_1), na.rm = TRUE)) %>% 
  ungroup()

 table(lastscreen$last_screen, lastscreen$SITE)
 table(lastenroll$last_enroll, lastenroll$SITE)
## 

##new 
date_last_enrll_pak <- lastenroll %>% filter(SITE == "Pakistan") %>% select(last_enroll) %>%  unique() %>% mutate(last_enroll = last_enroll-7) %>% pull()
date_last_enrll_ke <- lastenroll %>% filter(SITE == "Kenya") %>% select(last_enroll) %>%  unique() %>% mutate(last_enroll = last_enroll-7) %>% pull()
date_last_enrll_ga <- lastenroll %>% filter(SITE == "Ghana") %>% select(last_enroll) %>%  unique() %>% mutate(last_enroll = last_enroll-7) %>% pull()
date_last_enrll_za <- lastenroll %>% filter(SITE == "Zambia") %>% select(last_enroll) %>%  unique() %>% mutate(last_enroll = last_enroll-7) %>% pull()

```
##### **Last Enrollment Date: ** 
##### Kenya : 2023-05-25 {.unlisted .unnumbered}
##### Pakistan : 2023-05-19 {.unlisted .unnumbered}
##### Ghana : 2023-05-24 {.unlisted .unnumbered}
##### Zambia : 2023-05-17 {.unlisted .unnumbered}

```{r Table1}
## Prescreening and enrollment in the most recent one week 
# denominator: a = n all pre-screened 
MatData_Screen_Enroll$date_last_enrll_pak = date_last_enrll_pak
MatData_Screen_Enroll$date_last_enrll_ke = date_last_enrll_ke
MatData_Screen_Enroll$date_last_enrll_ga = date_last_enrll_ga
MatData_Screen_Enroll$date_last_enrll_za = date_last_enrll_za

tb_prescreen_enroll <- MatData_Screen_Enroll %>% 
  filter(
    SITE == "Pakistan" & (M00_SCRN_OBSSTDAT_1 > date_last_enrll_pak) |
    SITE == "Kenya" & (M00_SCRN_OBSSTDAT_1 > date_last_enrll_ke) | 
    SITE == "Ghana" & (M00_SCRN_OBSSTDAT_1 > date_last_enrll_ga) |
    SITE == "Zambia" & (M00_SCRN_OBSSTDAT_1 > date_last_enrll_za) 
  ) %>% 
  group_by(SITE) %>% 
  summarise("Pre-screened for PRISMA, n" = sum(PRESCREEN == 1),
            "Eligible based on pre-screening, n" = paste0(sum(PRESCR_ELIGIBLE == 1, na.rm=TRUE), 
                                        " (", format(sum(PRESCR_ELIGIBLE == 1, na.rm=TRUE)/sum(a == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Screened for PRISMA, n" = sum(SCREEN == 1),
            "Enrolled in PRISMA, n(%)" = paste0(sum(ENROLL == 1, na.rm=TRUE), 
                                        " (", format(sum(ENROLL == 1, na.rm=TRUE)/sum(b == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")")
) %>% 
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "All sites" = MatData_Screen_Enroll %>% 
  filter(
    SITE == "Pakistan" & (M00_SCRN_OBSSTDAT_1 > date_last_enrll_pak) |
    SITE == "Kenya" & (M00_SCRN_OBSSTDAT_1 > date_last_enrll_ke) | 
    SITE == "Ghana" & (M00_SCRN_OBSSTDAT_1 > date_last_enrll_ga) |
    SITE == "Zambia" & (M00_SCRN_OBSSTDAT_1 > date_last_enrll_za) 


  ) %>% 
  plyr::summarise("Pre-screened for PRISMA, n" = sum(PRESCREEN == 1),
            "Eligible based on pre-screening, n" = paste0(sum(PRESCR_ELIGIBLE == 1, na.rm=TRUE), 
                                        " (", format(sum(PRESCR_ELIGIBLE == 1, na.rm=TRUE)/sum(a == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Screened for PRISMA, n" = sum(SCREEN == 1),
            "Enrolled in PRISMA, n(%) ^a^" = paste0(sum(ENROLL == 1, na.rm=TRUE), 
                                        " (", format(sum(ENROLL == 1, na.rm=TRUE)/sum(b == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")")

) %>% 
      t() %>% unlist()
  ) 

# 
```

\newpage
### **1. PRISMA**

&nbsp;
&nbsp;

#### `r emo::ji("pushpin")` Table 1: Pre-screening and Enrollment numbers for PRISMA for the most recent <span style="text-decoration:underline">one week</span> 
*Value: This will provide a snapshot of weekly pre-screening and enrollment progress.* 

<!-- &nbsp; -->

```{r Table1aOut}
bind_rows(tb_prescreen_enroll) %>% 
    `rownames<-`(c("Pre-screened for PRISMA, n",
                  "Eligible based on pre-screening, n(%)  ^a^",
                  "Screened for PRISMA, n",
                  "Enrolled in PRISMA, n(%) ^b^"
                 )
               ) %>%  
  kbl(caption = "") %>%
  kable_paper(bootstrap_options = "striped", 
              full_width = T, html_font = "Cambria", position = "left",
              latex_options = "hold_position") %>% 
  footnote(alphabet = c("Denominator is pre-screened (MNH00 completed)",
                        "Denominator is n screened (MNH02 completed)"))  %>% 
  pack_rows("Pre-screening (MNH00)", 1, 2, label_row_css = "color: steelblue;")  %>% 
  pack_rows("Enrollment (MNH02)", 3, 4, label_row_css = "color: steelblue;") 


```

&nbsp;
&nbsp;

#### `r emo::ji("pushpin")` Table 2: <span style="text-decoration:underline">Cumulative</span>  pre-screening numbers for PRISMA
*Value: look at cumulative pre-screening distributions since the start of relaunch. If ineligible, distributions by exclusion criteria are listed below.*

```{r Table2}
## Cumulative Prescreening criteria 
# denominator: a = n all pre-screened 

tb_prescreen_all <- MatData_Screen_Enroll %>% 
  filter(PRESCREEN == 1) %>% 
  group_by(SITE) %>% 
  summarise("Pre-screened for PRISMA, n (MNH00)" = sum(PRESCREEN == 1),
            
            "Eligible based on pre-screening, n(%)^a^" = paste0(sum(PRESCR_ELIGIBLE == 1, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_ELIGIBLE == 1, na.rm = TRUE)/sum(a == 1)*100, digits = 2, nsmall=0), ")"),
            "No clinical signs of pregnancy" = paste0(sum(PRESCR_PREGSIGN == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_PREGSIGN == 0, na.rm = TRUE)/sum(a == 1)*100, digits = 2, nsmall=0), ")"),
            "Viable pregnancy with GA>=25 weeks" = paste0(sum(PRESCR_GA25 == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_GA25 == 0, na.rm = TRUE)/sum(a == 1)*100, digits = 2, nsmall=0), ")"),
            "Did not meet age requirement" = paste0(sum(PRESCR_AGE == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_AGE == 0, na.rm = TRUE)/sum(a == 1)*100, digits = 2, nsmall=0), ")"),

            "Outside catchment area" = paste0(sum(PRESCR_CATCHAREA == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_CATCHAREA == 0, na.rm = TRUE)/sum(a == 1)*100, digits = 2, nsmall=0), ")"),
            "Other reason^1^" = paste0(sum(PRESCR_OTHER == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_OTHER == 0, na.rm = TRUE)/sum(a == 1)*100, digits = 2, nsmall=0), ")"),
            "Did not consent" = paste0(sum(CONSENT_PRESCREEN== 0, na.rm = TRUE), 
                                        " (", format(sum(CONSENT_PRESCREEN == 0, na.rm = TRUE)/sum(a == 1)*100, digits = 2, nsmall=0), ")")
) %>% 
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "All sites" = MatData_Screen_Enroll %>% 
  plyr::summarise("Pre-screened for PRISMA, n (MNH00)" = sum(PRESCREEN == 1),
            "Eligible based on pre-screening, n(%)^a^" = paste0(sum(PRESCR_ELIGIBLE == 1, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_ELIGIBLE == 1, na.rm = TRUE)/sum(a == 1)*100, digits = 2, nsmall=0), ")"),
            "No clinical signs of pregnancy" = paste0(sum(PRESCR_PREGSIGN == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_PREGSIGN == 0, na.rm = TRUE)/sum(a == 1)*100, digits = 2, nsmall=0), ")"),
            "Viable pregnancy with GA>=25 weeks" = paste0(sum(PRESCR_GA25 == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_GA25 == 0, na.rm = TRUE)/sum(a == 1)*100, digits = 2, nsmall=0), ")"),
            "Did not meet age requirement" = paste0(sum(PRESCR_AGE == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_AGE == 0, na.rm = TRUE)/sum(a == 1)*100, digits = 2, nsmall=0), ")"),
            "Outside catchment area" = paste0(sum(PRESCR_CATCHAREA == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_CATCHAREA == 0, na.rm = TRUE)/sum(a == 1)*100, digits = 2, nsmall=0), ")"),
            "Other reason^1^" = paste0(sum(PRESCR_OTHER == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_OTHER == 0, na.rm = TRUE)/sum(a == 1)*100, digits = 2, nsmall=0), ")"),
            "Did not consent" = paste0(sum(CONSENT_PRESCREEN== 0, na.rm = TRUE), 
                                        " (", format(sum(CONSENT_PRESCREEN == 0, na.rm = TRUE)/sum(a == 1)*100, digits = 2, nsmall=0), ")")
) %>% 
      t() %>% unlist()
  ) 
```

```{r Table2out}
bind_rows(tb_prescreen_all
          ) %>% 
  kbl(caption = "") %>%
  kable_paper(bootstrap_options = "striped", 
              full_width = T, html_font = "Cambria", position = "left",
              latex_options = "hold_position") %>% 
  footnote(alphabet = c("Denominator is pre- screened (MNH00 completed)"),
           number = c("Other reasons for exclusion include: not feasible to collect the minimal required dataset, medical contraindication, comes from outside the study area, refusal to be screened, not interested, deferred, needs to seek spousal consent, or does not have time to proceed with enrollment process"), 
          footnote_order = c( "number", "alphabet"))  %>% 
  pack_rows("Pre-screening", 1, 2, label_row_css = "color: steelblue;")  %>% 
  pack_rows("Reason for exclusion in pre-screening, n(%)^a^", 3, 8, label_row_css = "color: steelblue;") 
```

&nbsp;
&nbsp;


#### `r emo::ji("pushpin")` Table 3: <span style="text-decoration:underline">Cumulative</span> enrollment numbers for PRISMA
*Value: look at cumulative enrollment and study progress distributions since the start of relaunch. If ineligible, distributions by exclusion criteria are listed below. Each column should sum to 100%.*

```{r Table3 gen}
## Cumulative Enrollment 
# denominator: a = n all screened 

tb_enroll <- MatData_Screen_Enroll %>%
  filter(SCREEN == 1) %>% 
  group_by(SITE) %>%
  summarise("Screened for PRISMA (MNH02), n" = sum(SCREEN == 1),
            "Enrolled in PRISMA (MNH02), n(%) ^a^" = paste0(sum(ENROLL == 1, na.rm=TRUE),
                                        " (", format(sum(ENROLL == 1, na.rm=TRUE)/sum(b == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            
              "Gestational Age at Enrollment, mean (SD)" = paste0(format(round(mean(GA_ENROLL_WKS, na.rm = TRUE),2), 
                                                        nsmall=0, digits = 2), " (",format(round(sd(GA_ENROLL_WKS, 
                                                            na.rm = TRUE),2), nsmall=0, digits = 2), ")"), 
              "First trimester (<14 wks), n(%)^a^" = paste0(sum(GA_ENROLL_WKS < 14, na.rm = TRUE)," (",
                          format(round(sum(GA_ENROLL_WKS < 14, na.rm = TRUE)/sum(c == 1)*100, 2), nsmall = 0, digits = 2),
    ")"),
            "Did not meet age requirement" = paste0(sum(AGE == 0, na.rm=TRUE),
                             " (", format(sum(AGE == 0, na.rm=TRUE)/sum(b == 1)*100, digits = 2, nsmall=0), ")"),
            "Viable pregnancy with GA>=20 weeks by US" = paste0(sum(GA20 == 0, na.rm=TRUE),
                                " (", format(sum(GA20 == 0, na.rm=TRUE)/sum(b == 1)*100, digits = 2, nsmall=0), ")"),
            "Outside catchment area" = paste0(sum(CATCHAREA == 0, na.rm=TRUE),
                                   " (", format(sum(CATCHAREA == 0, na.rm=TRUE)/sum(b == 1)*100, digits = 2, nsmall=0), ")"),
            "Did not consent" = paste0(sum(CONSENT == 0, na.rm=TRUE),
                                  " (", format(sum(CONSENT == 0, na.rm=TRUE)/sum(b == 1)*100, digits = 2, nsmall=0), ")")
  ) %>%
    t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .before = 1,
    "All sites" = MatData_Screen_Enroll %>%
  plyr::summarise("Screened for PRISMA (MNH02), n" = sum(SCREEN == 1),
            "Enrolled in PRISMA (MNH02), n(%) ^a^" = paste0(sum(ENROLL == 1, na.rm=TRUE),
                                        " (", format(sum(ENROLL == 1, na.rm=TRUE)/sum(b == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Gestational Age at Enrollment, mean (SD)" = paste0(format(round(mean(GA_ENROLL_WKS, na.rm = TRUE),2), 
                                                        nsmall=0, digits = 2), " (",format(round(sd(GA_ENROLL_WKS, 
                                                            na.rm = TRUE),2), nsmall=0, digits = 2), ")"), 
            "First trimester (<14 wks), n(%)^a^" = paste0(sum(GA_ENROLL_WKS < 14, na.rm = TRUE)," (",
                          format(round(sum(GA_ENROLL_WKS < 14, na.rm = TRUE)/sum(c == 1)*100, 2), nsmall = 0, digits = 2),
    ")"),
            "Viable pregnancy with GA>=20 weeks by US" = paste0(sum(AGE == 0, na.rm=TRUE),
                             " (", format(sum(AGE == 0, na.rm=TRUE)/sum(b == 1)*100, digits = 2, nsmall=0), ")"),
            "GA >= 20 wks by US" = paste0(sum(GA20 == 0, na.rm=TRUE),
                                " (", format(sum(GA20 == 0, na.rm=TRUE)/sum(b == 1)*100, digits = 2, nsmall=0), ")"),
            "Outside catchment area" = paste0(sum(CATCHAREA == 0, na.rm=TRUE),
                                   " (", format(sum(CATCHAREA == 0, na.rm=TRUE)/sum(b == 1)*100, digits = 2, nsmall=0), ")"),
            "Did not consent" = paste0(sum(CONSENT == 0, na.rm=TRUE),
                                  " (", format(sum(CONSENT == 0, na.rm=TRUE)/sum(b == 1)*100, digits = 2, nsmall=0), ")")
      ) %>%
      t() %>% unlist()
  )



```

```{r Table3 Out}
bind_rows(tb_enroll#,
          # tb_status
          ) %>%
    `rownames<-` (c(
                 "Screened for PRISMA (MNH02), n",
                 "Enrolled in PRISMA (MNH02), n(%) ^a^",
                 "Gestational Age at Enrollment, mean (SD)",
                 "First trimester (<14 wks), n(%)^b^",
                 "Did not meet age requirement",
                 "Viable pregnancy with GA>=20 weeks by US", 
                 "Outside catchment area", 
                 "Did not consent"
                 )
                ) %>% 
  kbl(caption = "") %>%
  kable_paper(bootstrap_options = "striped", 
              full_width = T, html_font = "Cambria", position = "left",
              latex_options = "hold_position") %>% 
  footnote(alphabet = c("denominator is n screened (MNH02 completed)", 
                        "denominator is n enrolled")
          )  %>% 
  pack_rows("Enrollment", 1, 4, label_row_css = "color: steelblue;")  %>% 
  pack_rows("Reason not enrolled, n(%)^a^", 5, 8, label_row_css = "color: steelblue;") 
```

\newpage

#### `r emo::ji("pushpin")` Figure 1a: Cumulative Enrollment by Site and Week
*Value: Illustrate cumulative enrollment status by site over time.*

```{r, echo=FALSE, figure.align='center', out.width="100%"}
##new 

enroll_cum <- MatData_Screen_Enroll %>% 
  arrange("", by_group=START_DATE_MOM_WK) %>% 
  filter(ENROLL == 1 & !is.na(START_DATE_MOM_WK), 
         START_DATE_MOM_WK > dmy("21/09/2022")) %>% 
  group_by(SITE, START_DATE_MOM_WK) %>% 
  summarise(n = n()) %>% 
  mutate(cum_n = cumsum(n)) %>% 
  ungroup() 

enroll_cum$START_DATE_MOM_WK <- as.Date(as.POSIXct(enroll_cum$START_DATE_MOM_WK))

enroll_cum %>% 
  ggplot(aes(x = START_DATE_MOM_WK, y = cum_n, color = SITE)) +
  geom_point(shape = 15) +
  geom_line() +
  scale_x_date(date_breaks = "1 week", date_labels = ("%m-%d"), limits = c(dmy("25-09-2022"), UploadDate)) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position="bottom",
        panel.grid.minor = element_blank()) +
  xlab("Enrollment Week") +
  ylab("Site Participant Enrolled") +
  ggtitle("")


```

\newpage

#### `r emo::ji("pushpin")` Figure 1b: Cumulative Enrollment by Week for Each Site
*Value: Compare expected and actual enrollment for each site over time. Calculated by dividing the total target enrollment by 36 months to get the average enrollment per month over the course of three years. We can further divide to get average enrollment per week.*

```{r, figure-side, fig.show='hold', out.width="50%"}

## pakistan
enroll_cum_PA <- MatData_Screen_Enroll %>% 
  arrange("", by_group=START_DATE_MOM_WK) %>% 
  filter(SCREEN == 1 & SITE == "Pakistan" & !is.na(START_DATE_MOM_WK), 
         START_DATE_MOM_WK > dmy("21/09/2022")) %>% 
  group_by(START_DATE_MOM_WK) %>% 
  summarise(enroll_n=sum(ENROLL==1),
            expect_n=mean(EXPECT)) %>% 
  mutate(
  gap = as.numeric(ymd(START_DATE_MOM_WK)-lag(ymd(START_DATE_MOM_WK))),
  expect_n = case_when(
    gap <= 1 ~ expect_n,
    gap > 1 ~ expect_n*gap,
    is.na(gap) ~ expect_n
  )) %>% 
  mutate(expect_cum=cumsum(expect_n),
         enroll_cum=cumsum(enroll_n))%>% 
  ungroup() 

enroll_cum_PA$START_DATE_MOM_WK <- as.Date(as.POSIXct(enroll_cum_PA$START_DATE_MOM_WK))

enroll_cum_PA %>% 
  ggplot(aes(x = START_DATE_MOM_WK)) +
  geom_point(aes(y = expect_cum, color = "Expected"), shape = 15) +
  geom_point(aes(y = enroll_cum, color = "Enrolled"), shape = 15) +
  geom_line(aes(y = expect_cum, color = "Expected")) +
  geom_line(aes(y = enroll_cum, color = "Enrolled")) +
  scale_color_manual("",
                     breaks=c("Expected","Enrolled"),
                     values = c("orange", "royalblue1")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position="bottom",
        panel.grid.minor = element_blank()) +
  scale_x_date(date_breaks = "1 week", date_labels = ("%m-%d"), limits = c(dmy("25-09-2022"), date_last_enrll_pak)) + ## UPDATE EACH RUN
  xlab("Enrollment Week") +
  ylab("Site Participant Expected and Enrolled") +
  ggtitle("Pakistan") 

# kenya
enroll_cum_KE <- MatData_Screen_Enroll %>% 
  arrange("", by_group=START_DATE_MOM_WK) %>% 
  filter(SCREEN == 1 & SITE == "Kenya" & !is.na(START_DATE_MOM_WK), 
         START_DATE_MOM_WK > dmy("20/11/2022")) %>% 
  group_by(START_DATE_MOM_WK) %>% 
  summarise(enroll_n=sum(ENROLL==1),
            expect_n=mean(EXPECT)) %>% 
  mutate(
  gap = as.numeric(ymd(START_DATE_MOM_WK)-lag(ymd(START_DATE_MOM_WK))),
  expect_n = case_when(
    gap <= 1 ~ expect_n,
    gap > 1 ~ expect_n*gap,
    is.na(gap) ~ expect_n
  )) %>% 
  mutate(expect_cum=cumsum(expect_n),
         enroll_cum=cumsum(enroll_n))%>% 
  ungroup() 

enroll_cum_KE$START_DATE_MOM_WK <- as.Date(as.POSIXct(enroll_cum_KE$START_DATE_MOM_WK))

enroll_cum_KE %>% 
  ggplot(aes(x = START_DATE_MOM_WK)) +
  geom_point(aes(y = expect_cum, color = "Expected"), shape = 15) +
  geom_point(aes(y = enroll_cum, color = "Enrolled"), shape = 15) +
  geom_line(aes(y = expect_cum, color = "Expected")) +
  geom_line(aes(y = enroll_cum, color = "Enrolled")) +
  scale_color_manual("",
                     breaks=c("Expected","Enrolled"),
                     values = c("orange", "royalblue1")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position="bottom",
        panel.grid.minor = element_blank()) +
  scale_x_date(date_breaks = "1 week", date_labels = ("%m-%d"), limits = c(dmy("20-11-2022"), date_last_enrll_ke)) +    
  xlab("Enrollment Week") +
  ylab("Site Participant Expected and Enrolled") +
  ggtitle("Kenya") 

## Ghana
enroll_cum_GA <- MatData_Screen_Enroll %>%
  arrange("", by_group=START_DATE_MOM_WK) %>%
  filter(SCREEN == 1 & SITE == "Ghana" & !is.na(START_DATE_MOM_WK),
         START_DATE_MOM_WK > dmy("01/01/2023")) %>%
  group_by(START_DATE_MOM_WK) %>%
  summarise(enroll_n=sum(ENROLL==1),
            expect_n=mean(EXPECT)) %>%
  mutate(
  gap = as.numeric(ymd(START_DATE_MOM_WK)-lag(ymd(START_DATE_MOM_WK))),
  expect_n = case_when(
    gap <= 1 ~ expect_n,
    gap > 1 ~ expect_n*gap,
    is.na(gap) ~ expect_n
  )) %>%
  mutate(expect_cum=cumsum(expect_n),
         enroll_cum=cumsum(enroll_n)) %>%
  ungroup()

enroll_cum_GA$START_DATE_MOM_WK <- as.Date(as.POSIXct(enroll_cum_GA$START_DATE_MOM_WK))

enroll_cum_GA %>%
  ggplot(aes(x = START_DATE_MOM_WK)) +
  geom_point(aes(y = expect_cum, color = "Expected"), shape = 15) +
  geom_point(aes(y = enroll_cum, color = "Enrolled"), shape = 15) +
  geom_line(aes(y = expect_cum, color = "Expected")) +
  geom_line(aes(y = enroll_cum, color = "Enrolled")) +
  scale_color_manual("",
                     breaks=c("Expected","Enrolled"),
                     values = c("orange", "royalblue1")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position="bottom",
        panel.grid.minor = element_blank()) +
  scale_x_date(date_breaks = "1 week", date_labels = ("%m-%d"), limits = c(dmy("26-12-2022"), date_last_enrll_ga)) +  
  xlab("Enrollment Week") +
  ylab("Site Participant Expected and Enrolled") +
  ggtitle("Ghana")

# Zambia
enroll_cum_ZA <- MatData_Screen_Enroll %>% 
  arrange("", by_group=START_DATE_MOM_WK) %>% 
  filter(SCREEN == 1 & SITE == "Zambia" & !is.na(START_DATE_MOM_WK), 
         START_DATE_MOM_WK > dmy("15/12/2022")) %>% 
  group_by(START_DATE_MOM_WK) %>% 
  summarise(enroll_n=sum(ENROLL==1),
            expect_n=mean(EXPECT)) %>% 
  mutate(
  gap = as.numeric(ymd(START_DATE_MOM_WK)-lag(ymd(START_DATE_MOM_WK))),
  expect_n = case_when(
    gap <= 1 ~ expect_n,
    gap > 1 ~ expect_n*gap,
    is.na(gap) ~ expect_n
  )) %>% 
  mutate(expect_cum=cumsum(expect_n),
         enroll_cum=cumsum(enroll_n))%>% 
  ungroup() 

enroll_cum_ZA$START_DATE_MOM_WK <- as.Date(as.POSIXct(enroll_cum_ZA$START_DATE_MOM_WK))

enroll_cum_ZA %>% 
  ggplot(aes(x = START_DATE_MOM_WK)) +
  geom_point(aes(y = expect_cum, color = "Expected"), shape = 15) +
  geom_point(aes(y = enroll_cum, color = "Enrolled"), shape = 15) +
  geom_line(aes(y = expect_cum, color = "Expected")) +
  geom_line(aes(y = enroll_cum, color = "Enrolled")) +
  scale_color_manual("",
                     breaks=c("Expected","Enrolled"),
                     values = c("orange", "royalblue1")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position="bottom",
        panel.grid.minor = element_blank()) +
  scale_x_date(date_breaks = "1 week", date_labels = ("%m-%d"), limits = c(dmy("15-12-2022"), date_last_enrll_za)) + 
  xlab("Enrollment Week") +
  ylab("Site Participant Expected and Enrolled") +
  ggtitle("Zambia") 


```

\newpage

#### `r emo::ji("pushpin")` Table 4: Study Status for PRISMA MNH Study 
*Value: look at current status of enrolled women. Each column should sum to 100%.*

```{r Table3}
## study status 
# denominator: c = n all enrolled


tb_status <- MatData_Screen_Enroll %>% 
  filter(ENROLL == 1) %>% 
  group_by(SITE) %>% 
  summarise(
    " " = paste0("(n=", sum(c==1), ")"),
    "Ongoing participants" = paste0(sum(is.na(M23_CLOSE_DSDECOD)), 
                                        " (", format(sum(is.na(M23_CLOSE_DSDECOD))/sum(c==1)*100, digits = 2, nsmall=0), ")"),
    "Completed 1-year follow-up after live birth or stillbirth" = paste0(sum(M23_CLOSE_DSDECOD == 1, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 1, na.rm=TRUE)/sum(c == 1)*100, digits = 2, nsmall=0), ")"),
    "Completed 42-day follow-up after spontaneous abortion (miscarriage) or induced abortion" = paste0(sum(M23_CLOSE_DSDECOD == 2, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 2, na.rm=TRUE)/sum(c == 1)*100, digits = 2, nsmall=0), ")"),
    "Mother died before completion" = paste0(sum(M23_CLOSE_DSDECOD == 3, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 3, na.rm=TRUE)/sum(c == 1)*100, digits = 2, nsmall=0), ")"),
    "Withdrew study" = paste0(sum(M23_CLOSE_DSDECOD == 4, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 4, na.rm=TRUE)/sum(c == 1)*100, digits = 2, nsmall=0), ")"),
    "Terminated from study" = paste0(sum(M23_CLOSE_DSDECOD == 5, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 5, na.rm=TRUE)/sum(c == 1)*100, digits = 2, nsmall=0), ")"),
    "Lost to follow-up" = paste0(sum(M23_CLOSE_DSDECOD == 6, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 6, na.rm=TRUE)/sum(c == 1)*100, digits = 2, nsmall=0), ")")
  ) %>% 
    t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "All sites" = MatData_Screen_Enroll %>% 
  # left_join(statusOutcome %>% 
  #             select(SCRNID, MOMID, PREGID, ENROLL), by = c("SCRNID", "MOMID", "PREGID")) %>%
      mutate(M23_CLOSE_DSDECOD = NA) %>% #remove this after we have data
      filter(ENROLL == 1) %>% 
  plyr::summarise(
    " " = paste0("(n=", sum(c == 1), ")"),
    "Ongoing participants" = paste0(sum(is.na(M23_CLOSE_DSDECOD)), 
                                        " (", format(sum(is.na(M23_CLOSE_DSDECOD))/sum(c==1)*100, digits = 2, nsmall=0), ")"),
    
    "Completed 1-year follow-up after live birth or stillbirth" = paste0(sum(M23_CLOSE_DSDECOD == 1, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 1, na.rm=TRUE)/sum(c == 1)*100, digits = 2, nsmall=0), ")"),
    "Completed 42-day follow-up after spontaneous abortion (miscarriage) or induced abortion" = paste0(sum(M23_CLOSE_DSDECOD == 2, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 2, na.rm=TRUE)/sum(c == 1)*100, digits = 2, nsmall=0), ")"),
    "Mother died before completion" = paste0(sum(M23_CLOSE_DSDECOD == 3, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 3, na.rm=TRUE)/sum(c == 1)*100, digits = 2, nsmall=0), ")"),
    "Withdrew study" = paste0(sum(M23_CLOSE_DSDECOD == 4, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 4, na.rm=TRUE)/sum(c == 1)*100, digits = 2, nsmall=0), ")"),
    "Terminated from study" = paste0(sum(M23_CLOSE_DSDECOD == 5, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 5, na.rm=TRUE)/sum(c == 1)*100, digits = 2, nsmall=0), ")"),
    "Lost to follow-up" = paste0(sum(M23_CLOSE_DSDECOD == 6, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 6, na.rm=TRUE)/sum(c == 1)*100, digits = 2, nsmall=0), ")")
      ) %>% 
      t() %>% unlist()
  ) 
```

```{r Table3Out}
tb_status %>% 
  kbl(caption = "") %>%
  kable_paper(bootstrap_options = "striped", 
              full_width = T, html_font = "Cambria", position = "left",
              latex_options = "hold_position") %>% 
  row_spec(0, extra_css = "border-bottom: 0px white;") %>% 
  row_spec(0:1, extra_css = "padding: 0px") %>% 
  footnote(alphabet = c("denominator is n enrolled"
          ) ) %>% 
  pack_rows("Study status, n (%)^a^", 2, 8, label_row_css = "color: steelblue;") 
```

\newpage

#### `r emo::ji("pushpin")` Table 5a: PRISMA Visit Completion (On-Time Windows)
*Value: Are forms completed for each visit? A visit is considered `complete` if the data reports the visit was conducted in person or by phone (variable name: `MAT_VISIT_MNHXX`).*
<br>
<br>

*Numerator:* Any form with visit type = i (variable name: `TYPE_VISIT`) AND have a complete visit status (variable name: `MAT_VISIT_MNHXX`) AND passed on-time window for visit type = i 
<br>
*Denominator:* Passed on-time window for visit type = i
```{r Table 5a }
#* Num: Any form with visit type = i AND visit status = 1 or 2 & Passed window for visit type = i
#* Denom: Passed window for visit type = i

VISIT_COMPLETE_ANC <- Visit_Complete_Anc %>% 
          rowwise() %>% 
          group_by(SITE) %>% 
          summarise(

      "Enrollment" = paste0(
        format(sum(VC_ENROLL_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ENROLL_NUM == 1, na.rm = TRUE)/sum(ENROLL_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "Denominator,n" = paste0(
        format(sum(ENROLL_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 20" = paste0(
        format(sum(VC_ANC20_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC20_NUM == 1, na.rm = TRUE)/sum(ANC20_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "Denominator,n " = paste0(
        format(sum(ANC20_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
      
      "ANC = 28" = paste0(
        format(sum(VC_ANC28_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC28_NUM == 1, na.rm = TRUE)/sum(ANC28_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
            
      "Denominator,n  " = paste0(
        format(sum(ANC28_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
      
      "ANC = 32" = paste0(
        format(sum(VC_ANC32_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC32_NUM == 1, na.rm = TRUE)/sum(ANC32_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
            
      "Denominator,n   " = paste0(
        format(sum(ANC32_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 36" = paste0(
        format(sum(VC_ANC36_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC36_NUM == 1, na.rm = TRUE)/sum(ANC36_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
            
      "Denominator,n    " = paste0(
        format(sum(ANC36_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        )
      ) %>%
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "All sites" = Visit_Complete_Anc %>% 
        plyr::summarise(

      "Enrollment" = paste0(
        format(sum(VC_ENROLL_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ENROLL_NUM == 1, na.rm = TRUE)/sum(ENROLL_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
            
      "Denominator,n" = paste0(
        format(sum(ENROLL_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
      
      "ANC = 20" = paste0(
        format(sum(VC_ANC20_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC20_NUM == 1, na.rm = TRUE)/sum(ANC20_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
            
      "Denominator,n " = paste0(
        format(sum(ANC20_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 28" = paste0(
        format(sum(VC_ANC28_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC28_NUM == 1, na.rm = TRUE)/sum(ANC28_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
            
      "Denominator,n  " = paste0(
        format(sum(ANC28_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 32" = paste0(
        format(sum(VC_ANC32_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC32_NUM == 1, na.rm = TRUE)/sum(ANC32_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
            
      "Denominator,n   " = paste0(
        format(sum(ANC32_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 36" = paste0(
        format(sum(VC_ANC36_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC36_NUM == 1, na.rm = TRUE)/sum(ANC36_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
            
      "Denominator,n    " = paste0(
        format(sum(ANC36_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        )
      
      ) %>% 
        t() %>% 
        as.data.frame() %>% 
      `colnames<-`(c(.[1,])) %>% unlist() 
)


## PNC 
VISIT_COMPLETE_PNC <- Visit_Complete_Pnc %>% 
          rowwise() %>% 
          group_by(SITE) %>% 
          summarise(

      "PNC = 0" = paste0(
        format(sum(VC_PNC0_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC0_NUM == 1, na.rm = TRUE)/sum(PNC0_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
                  
      "Denominator,n" = paste0(
        format(sum(PNC0_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 1" = paste0(
        format(sum(VC_PNC1_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC1_NUM == 1, na.rm = TRUE)/sum(PNC1_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
                        
      "Denominator,n " = paste0(
        format(sum(PNC1_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 4" = paste0(
        format(sum(VC_PNC4_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC4_NUM == 1, na.rm = TRUE)/sum(PNC4_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
                        
      "Denominator,n  " = paste0(
        format(sum(PNC4_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
      
      "PNC = 6" = paste0(
        format(sum(VC_PNC6_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC6_NUM == 1, na.rm = TRUE)/sum(PNC6_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
                        
      "Denominator,n   " = paste0(
        format(sum(PNC6_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
      
      "PNC = 26" = paste0(
        format(sum(VC_PNC26_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC26_NUM == 1, na.rm = TRUE)/sum(PNC26_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
                        
      "Denominator,n    " = paste0(
        format(sum(PNC26_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
      
      "PNC = 52" = paste0(
        format(sum(VC_PNC26_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC26_NUM == 1, na.rm = TRUE)/sum(PNC52_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
                        
      "Denominator,n     " = paste0(
        format(sum(PNC52_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        )
      ) %>%
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "All sites" = Visit_Complete_Pnc %>% 
        plyr::summarise(
          
      "PNC = 0" = paste0(
        format(sum(VC_PNC0_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC0_NUM == 1, na.rm = TRUE)/sum(PNC0_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
                  
      "Denominator,n" = paste0(
        format(sum(PNC0_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 1" = paste0(
        format(sum(VC_PNC1_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC1_NUM == 1, na.rm = TRUE)/sum(PNC1_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
                        
      "Denominator,n " = paste0(
        format(sum(PNC1_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 4" = paste0(
        format(sum(VC_PNC4_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC4_NUM == 1, na.rm = TRUE)/sum(PNC4_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
                        
      "Denominator,n  " = paste0(
        format(sum(PNC4_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
      
      "PNC = 6" = paste0(
        format(sum(VC_PNC6_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC6_NUM == 1, na.rm = TRUE)/sum(PNC6_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
                        
      "Denominator,n   " = paste0(
        format(sum(PNC6_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 26" = paste0(
        format(sum(VC_PNC26_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC26_NUM == 1, na.rm = TRUE)/sum(PNC26_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
                        
      "Denominator,n    " = paste0(
        format(sum(PNC26_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
      
      "PNC = 52" = paste0(
        format(sum(VC_PNC26_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC26_NUM == 1, na.rm = TRUE)/sum(PNC52_PASS==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
                        
      "Denominator,n     " = paste0(
        format(sum(PNC52_PASS==1, na.rm = TRUE), nsmall = 0, digits = 2)
        )
      ) %>% 
        t() %>% 
        as.data.frame() %>% 
      `colnames<-`(c(.[1,])) %>% unlist() 
)

## since no PNC data in zambia or ghana - replace with "no data" 
#VISIT_COMPLETE_PNC <- VISIT_COMPLETE_PNC %>%  add_column(Ghana = "No PNC Data", .after = "All sites")
VISIT_COMPLETE_PNC <- VISIT_COMPLETE_PNC %>%  add_column(Zambia = "No PNC Data", .after = "Pakistan")

```

```{r PRISMA TABLE 5a OUT}

bind_rows(VISIT_COMPLETE_ANC, 
          VISIT_COMPLETE_PNC, 
          ) %>% 
  `rownames<-` (c(## anc (1-10)
                 "Enrollment (Target window: <20wks)",
                 "Denominator, n",
                 "ANC = 20 (Target window: 18 to 22wks)",
                 "Denominator, n ",
                 "ANC = 28 (Target window: 26 to 30wks)",
                 "Denominator, n  ",
                 "ANC = 32 (Target window: 31 to 33wks)",
                 "Denominator, n   ",
                 "ANC = 36 (Target window: 34 to 38wks)",
                 "Denominator, n    ",
                 ## pnc (11-22)
                 "PNC = 0 (Target window: 3 to 5 days)",
                 "Denominator, n     ",
                 "PNC = 1 (Target window: 7 to 14 days)",
                 "Denominator, n      ",
                 "PNC = 4 (Target window: 28 to 35 days)",
                 "Denominator, n       ",
                 "PNC = 6 (Target window: 6 to 7wks)",
                 "Denominator, n        ",
                 "PNC = 26 (Target window: 26 to 28wks)",
                 "Denominator, n         ",
                 "PNC = 52 (Target window: 52 to 54wks)",
                 "Denominator, n          "
                 )
                ) %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  kbl(caption = "") %>%
    footnote(alphabet = c("denominator is n passed window for visit type=i"),
             general = "Passed window denominators for all visits are calculated by EDD reported in MNH01 (US_EDD_BRTHDAT). If an EDD is missing, the particpant is removed from this table.", 
             footnote_order = c("alphabet", "general")) %>% 
  kable_paper(bootstrap_options = "striped", 
              full_width = T, html_font = "Cambria", position = "left",
              latex_options = c("repeat_header", "HOLD_position")) %>% 
  row_spec(0, extra_css = "border-bottom: 0px white;") %>% 
  row_spec(c(1,3,5,7,9,11,13,15,17,19,21), extra_css = "border-bottom: 0px white;") %>% 
  #row_spec(c(2, 4, 6,8,10, 12, 14,16,18,20,22), italic = TRUE) %>% 
  add_indent(c(2, 4, 6,8,10, 12, 14,16,18,20,22), level_of_indent = 2)  %>% 
  pack_rows("ANC Visits", 1, 10, label_row_css = "color: steelblue;") %>% 
  pack_rows("PNC Visits", 11, 22, label_row_css = "color: steelblue;") 

```


#### `r emo::ji("pushpin")` Table 5b: PRISMA Visit Completion (Late Windows) 
*Value: Are forms completed for each visit? A visit is considered `complete` if the data reports the visit was conducted in person or by phone (variable name: `MAT_VISIT_MNHXX`). If there is no late window for a visit, the on-time windows are used.*
<br>
<br>

*Numerator:* Any form with visit type = i (variable name: `TYPE_VISIT`) AND have a complete visit status (variable name: `MAT_VISIT_MNHXX`) AND passed late window for visit type = i
<br>
*Denominator:* Passed late window for visit type = i
```{r Table 5b }
#* Num: Any form with visit type = i AND visit status = 1 or 2 & Passed window for visit type = i
#* Denom: Passed window for visit type = i

VISIT_COMPLETE_ANC <- Visit_Complete_Anc %>%
          rowwise() %>%
          group_by(SITE) %>%
          summarise(

      "Enrollment" = paste0(
        format(sum(VC_ENROLL_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ENROLL_NUM_LATE == 1, na.rm = TRUE)/sum(ENROLL_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n" = paste0(
        format(sum(ENROLL_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 20" = paste0(
        format(sum(VC_ANC20_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC20_NUM_LATE == 1, na.rm = TRUE)/sum(ANC20_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n " = paste0(
        format(sum(ANC20_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 28" = paste0(
        format(sum(VC_ANC28_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC28_NUM_LATE == 1, na.rm = TRUE)/sum(ANC28_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n  " = paste0(
        format(sum(ANC28_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 32" = paste0(
        format(sum(VC_ANC32_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC32_NUM_LATE == 1, na.rm = TRUE)/sum(ANC32_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n   " = paste0(
        format(sum(ANC32_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 36" = paste0(
        format(sum(VC_ANC36_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC36_NUM_LATE == 1, na.rm = TRUE)/sum(ANC36_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n    " = paste0(
        format(sum(ANC36_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        )
      ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "All sites" = Visit_Complete_Anc %>%
        plyr::summarise(

      "Enrollment" = paste0(
        format(sum(VC_ENROLL_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ENROLL_NUM_LATE == 1, na.rm = TRUE)/sum(ENROLL_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n" = paste0(
        format(sum(ENROLL_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 20" = paste0(
        format(sum(VC_ANC20_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC20_NUM_LATE == 1, na.rm = TRUE)/sum(ANC20_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n " = paste0(
        format(sum(ANC20_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 28" = paste0(
        format(sum(VC_ANC28_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC28_NUM_LATE == 1, na.rm = TRUE)/sum(ANC28_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n  " = paste0(
        format(sum(ANC28_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 32" = paste0(
        format(sum(VC_ANC32_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC32_NUM_LATE == 1, na.rm = TRUE)/sum(ANC32_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n   " = paste0(
        format(sum(ANC32_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 36" = paste0(
        format(sum(VC_ANC36_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC36_NUM_LATE == 1, na.rm = TRUE)/sum(ANC36_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n    " = paste0(
        format(sum(ANC36_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        )

      ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)


## PNC
VISIT_COMPLETE_PNC <- Visit_Complete_Pnc %>%
          rowwise() %>%
          group_by(SITE) %>%
          summarise(

      "PNC = 0" = paste0(
        format(sum(VC_PNC0_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC0_NUM_LATE == 1, na.rm = TRUE)/sum(PNC0_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n" = paste0(
        format(sum(PNC0_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 1" = paste0(
        format(sum(VC_PNC1_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC1_NUM_LATE == 1, na.rm = TRUE)/sum(PNC1_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n " = paste0(
        format(sum(PNC1_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 4" = paste0(
        format(sum(VC_PNC4_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC4_NUM_LATE == 1, na.rm = TRUE)/sum(PNC4_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n  " = paste0(
        format(sum(PNC4_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 6" = paste0(
        format(sum(VC_PNC6_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC6_NUM_LATE == 1, na.rm = TRUE)/sum(PNC6_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n   " = paste0(
        format(sum(PNC6_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 26" = paste0(
        format(sum(VC_PNC26_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC26_NUM_LATE == 1, na.rm = TRUE)/sum(PNC26_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n    " = paste0(
        format(sum(PNC26_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 52" = paste0(
        format(sum(VC_PNC26_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC26_NUM_LATE == 1, na.rm = TRUE)/sum(PNC52_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n     " = paste0(
        format(sum(PNC52_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        )
      ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "All sites" = Visit_Complete_Pnc %>%
        plyr::summarise(

      "PNC = 0" = paste0(
        format(sum(VC_PNC0_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC0_NUM_LATE == 1, na.rm = TRUE)/sum(PNC0_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n" = paste0(
        format(sum(PNC0_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 1" = paste0(
        format(sum(VC_PNC1_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC1_NUM_LATE == 1, na.rm = TRUE)/sum(PNC1_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n " = paste0(
        format(sum(PNC1_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 4" = paste0(
        format(sum(VC_PNC4_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC4_NUM_LATE == 1, na.rm = TRUE)/sum(PNC4_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n  " = paste0(
        format(sum(PNC4_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 6" = paste0(
        format(sum(VC_PNC6_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC6_NUM_LATE == 1, na.rm = TRUE)/sum(PNC6_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n   " = paste0(
        format(sum(PNC6_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 26" = paste0(
        format(sum(VC_PNC26_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC26_NUM_LATE == 1, na.rm = TRUE)/sum(PNC26_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n    " = paste0(
        format(sum(PNC26_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 52" = paste0(
        format(sum(VC_PNC26_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC26_NUM_LATE == 1, na.rm = TRUE)/sum(PNC52_PASS_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n     " = paste0(
        format(sum(PNC52_PASS_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        )
      ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

## since no PNC data in zambia or ghana - replace with "no data"
# VISIT_COMPLETE_PNC <- VISIT_COMPLETE_PNC %>%  add_column(Ghana = "No PNC Data", .after = "All sites")
VISIT_COMPLETE_PNC <- VISIT_COMPLETE_PNC %>%  add_column(Zambia = "No PNC Data", .after = "Pakistan")

```

```{r PRISMA TABLE 5b OUT}

bind_rows(VISIT_COMPLETE_ANC,
          VISIT_COMPLETE_PNC,
          ) %>%
  `rownames<-` (c(## anc (1-10)
                 "Enrollment (Late window: None)", ## NONE - SKIP WINDOW
                 "Denominator, n",
                 "ANC = 20 (Late window: 23 to 25wks)",
                 "Denominator, n ",
                 "ANC = 28 (Late window: None)", ## NONE - SKIP WINDOW
                 "Denominator, n  ",
                 "ANC = 32 (Late window: 34 to delivery)", ## ask about this delivery end date
                 "Denominator, n   ",
                 "ANC = 36 (Late window: 38 to delivery)", ## ask about this delivery end date
                 "Denominator, n    ",
                 ## pnc (11-22)
                 "PNC = 0 (Late window: None)", ## NONE - SKIP WINDOW
                 "Denominator, n     ",
                 "PNC = 1 (Late window: None)", ## NONE - SKIP WINDOW
                 "Denominator, n      ",
                 "PNC = 4 (Late window: None)", ## NONE - SKIP WINDOW
                 "Denominator, n       ",
                 "PNC = 6 (Late window: 8 to 12wks)",
                 "Denominator, n        ",
                 "PNC = 26 (Late window: 29 to 39wks)",
                 "Denominator, n         ",
                 "PNC = 52 (Late window: 55 to 64wks)",
                 "Denominator, n          "
                 )
                ) %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  kbl(caption = "") %>%
    footnote(alphabet = c("denominator is n passed window for visit type=i"),
             general = "Passed window denominators for all visits are calculated by EDD reported in MNH01 (US_EDD_BRTHDAT). If an EDD is missing, the particpant is removed from this table.",
             footnote_order = c("alphabet", "general")) %>%
  kable_paper(bootstrap_options = "striped",
              full_width = T, html_font = "Cambria", position = "left",
              latex_options = c("repeat_header", "HOLD_position")) %>%
  row_spec(0, extra_css = "border-bottom: 0px white;") %>%
  row_spec(c(1,3,5,7,9,11,13,15,17,19,21), extra_css = "border-bottom: 0px white;") %>%
  #row_spec(c(2, 4, 6,8,10, 12, 14,16,18,20,22), italic = TRUE) %>%
  add_indent(c(2, 4, 6,8,10, 12, 14,16,18,20,22), level_of_indent = 2)  %>%
  pack_rows("ANC Visits", 1, 10, label_row_css = "color: steelblue;") %>%
  pack_rows("PNC Visits", 11, 22, label_row_css = "color: steelblue;")

```


\newpage

#### `r emo::ji("pushpin")` Table 6: ANC Protocol Compliance
*Value: Among women successfully contacted during the ANC period, are all expected forms for the visit complete? A visit is considered `complete` if the data reports the visit was conducted in person or by phone (variable name: `MAT_VISIT_MNHXX`).*
<br>
<br>

*Numerator:* By form: visit type = i (variable name: `TYPE_VISIT`) AND have a complete visit status (variable name: `MAT_VISIT_MNHXX`) AND passed window for visit type = i 
<br>
*Denominator:* Any form with visit type = i (variable name: `TYPE_VISIT`) AND have have a complete visit status (variable name: `MAT_VISIT_MNHXX`) AND passed window for visit type = i 

```{r ga_tb PC}
## ANC visits - ultrasound form  
# denominator: c = n all screened 

ga_tb <- MatData_Anc_Visits %>% 
  group_by(SITE) %>% 
  summarise(
  "total enrolled" = paste0(
    "(n=",sum(c==1), ")"
  )
  ) %>% ungroup() %>% 
  #mutate(`Gestational Age at Enrollment, mean  SD` = ifelse(SITE == "Ghana", NA, `Gestational Age at Enrollment, mean  SD`)) %>% 
  t() %>% 
  as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "All sites" = MatData_Anc_Visits %>%
 # mutate(GA_ENROLL_WKS = ifelse(SITE == "Ghana", NA, GA_ENROLL_WKS)) %>% 
 plyr::summarise(
     "total enrolled" = paste0(
    "(n=",sum(c==1),")"
  )
  ) %>% 
      t() %>% as.data.frame() %>% unlist()
  ) 


```

```{r ENROLLMENT PC}

#* Num (hard code in monitoring report rmd): For each form: visit type = i AND visit status = 1 or 2 AND passed window for visit type = i 
#* Denom: Any form with visit type = i AND visit status = 1 or 2 AND passed window for visit type = i 

ENROLLMENT <- Prot_Compliance_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
      "Denominator" = paste0(
        format(sum(PC_ENROLL_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
      
      "MNH01 Ultrasound" = paste0(
        format(sum(M01_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M01_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH02 Enrollment Status" = paste0(
        format(sum(M02_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M02_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      "MNH03 Sociodemographic" = paste0(
        format(sum(M03_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M03_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(M05_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "All sites" = Prot_Compliance_Anc %>% 
        plyr::summarise(
          
      "Denominator" = paste0(
        format(sum(PC_ENROLL_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH01 Ultrasound" = paste0(
        format(sum(M01_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M01_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH02 Enrollment Status" = paste0(
        format(sum(M02_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M02_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH03 Sociodemographic" = paste0(
        format(sum(M03_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M03_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(M05_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_1 == 1 & ENROLL_PASS == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>% 
        t() %>% 
        as.data.frame() %>% 
      `colnames<-`(c(.[1,])) %>% unlist() 
)


```

```{r ANC20 PC}
#* Num (hard code in monitoring report rmd): For each form: visit type = i AND visit status = 1 or 2 AND passed window for visit type = i 
#* Denom: Any form with visit type = i AND visit status = 1 or 2 AND passed window for visit type = i 

ANC20 <- Prot_Compliance_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(

    "Denominator" = paste0(
        format(sum(PC_ANC20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
        
    "MNH01 Ultrasound (optional)" = paste0(
        format(sum(M01_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M01_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
    
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(M05_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
       "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH25 Maternal Depression" = paste0(
        format(sum(M25_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M25_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

       "MNH26 Maternal Fatigue" = paste0(
        format(sum(!is.na(M26_VISIT_COMPLETE_2)  & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M26_VISIT_COMPLETE_2)  & ANC20_PASS == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
    t() %>% 
    as.data.frame() %>%    
        `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
    add_column(
      .before = 1,
      "All sites" = Prot_Compliance_Anc %>% 
        plyr::summarise(
          
      "Denominator" = paste0(
        format(sum(PC_ANC20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
          
      "MNH01 Ultrasound (optional)" = paste0(
        format(sum(M01_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M01_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
    
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(M05_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH25 Maternal Depression" = paste0(
        format(sum(M25_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M25_VISIT_COMPLETE_2 == 1 & ANC20_PASS == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

       "MNH26 Maternal Fatigue" = paste0(
        format(sum(!is.na(M26_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M26_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
        
        t() %>% as.data.frame() %>% unlist() 
)

```

```{r ANC 28 PC}
#* Num (hard code in monitoring report rmd): For each form: visit type = i AND visit status = 1 or 2 AND passed window for visit type = i 
#* Denom: Any form with visit type = i AND visit status = 1 or 2 AND passed window for visit type = i 

ANC28 <- Prot_Compliance_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
      
      "Denominator" = paste0(
        format(sum(PC_ANC28_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
        
       "MNH01 Ultrasound (optional)" = paste0(
        format(sum(M01_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M01_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(M05_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% `colnames<-`(c(.[1,]))  %>% as.data.frame() %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "All sites" = Prot_Compliance_Anc %>% 
        plyr::summarise(
          
      "Denominator" = paste0(
        format(sum(PC_ANC28_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

       "MNH01 Ultrasound (optional)" = paste0(
        format(sum(M01_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M01_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(M05_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_3 == 1 & ANC28_PASS == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>% 
        t() %>% `colnames<-`(c(.[1,])) %>% 
        as.data.frame() %>% unlist() 
)

```

```{r ANC 32 PC}
#* Num (hard code in monitoring report rmd): For each form: visit type = i AND visit status = 1 or 2 AND passed window for visit type = i 
#* Denom: Any form with visit type = i AND visit status = 1 or 2 AND passed window for visit type = i 

ANC32 <- Prot_Compliance_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
    
  "Denominator" = paste0(
        format(sum(PC_ANC32_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
        
   "MNH01 Ultrasound" = paste0(
        format(sum(M01_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M01_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(M05_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH25 Maternal Lab" = paste0(
        format(sum(M25_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M25_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"), 
   
      "MNH26 Maternal Fatigue" = paste0(
        format(sum(!is.na(M26_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M26_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%

  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,]))  %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "All sites" = Prot_Compliance_Anc %>% 
        plyr::summarise(
          
  "Denominator" = paste0(
        format(sum(PC_ANC32_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
        
    "MNH01 Ultrasound" = paste0(
        format(sum(M01_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M01_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(M05_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      "MNH25 Maternal Lab" = paste0(
        format(sum(M25_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M25_VISIT_COMPLETE_4 == 1 & ANC32_PASS == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH26 Maternal Fatigue" = paste0(
        format(sum(!is.na(M26_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M26_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%

        t() %>% 
        as.data.frame() %>% 
      `colnames<-`(c(.[1,])) %>%  unlist() 
)

```

```{r ANC36 PC}
#* Num (hard code in monitoring report rmd): For each form: visit type = i AND visit status = 1 or 2 AND passed window for visit type = i 
#* Denom: Any form with visit type = i AND visit status = 1 or 2 AND passed window for visit type = i 

ANC36 <- Prot_Compliance_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
                
       "Denominator" = paste0(
        format(sum(PC_ANC36_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
  
       "MNH01 Ultrasound (optional)" = paste0(
        format(sum(M01_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M01_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),


      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(M05_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% `colnames<-`(c(.[1,]))  %>% as.data.frame() %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "All sites" = Prot_Compliance_Anc %>% 
        plyr::summarise(
          
       "Denominator" = paste0(
        format(sum(PC_ANC36_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
          
       "MNH01 Ultrasound (optional)" = paste0(
        format(sum(M01_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M01_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(M05_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_5 == 1 & ANC36_PASS == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
        t() %>% `colnames<-`(c(.[1,])) %>% 
        as.data.frame() %>% unlist() 
)

```

```{r PRISMA TABLE 6 OUT}

bind_rows(ga_tb, 
          ENROLLMENT, 
          ANC20,
          ANC28, 
          ANC32, 
          ANC36
          ) %>% 
  `rownames<-`(c(" ",
                 ## ANCLESS20 (2-10)
                 "Denominator, n",
                 "MNH01 Ultrasound", 
                 "MNH02 Enrollment Status", 
                 "MNH03 Sociodemographic", 
                 "MNH04 ANC Clinical Status",
                 "MNH05 Maternal Anthropometry",
                 "MNH06 Maternal POC",
                 "MNH07 Maternal Specimen",
                 "MNH08 Maternal Lab",
                 ## ANC20 (11-19)
                 "Denominator, n ",                 
                 "MNH01 Ultrasound (optional) ",
                 "MNH04 ANC Clinical Status ",
                 "MNH05 Maternal Anthropometry ",
                 "MNH06 Maternal POC ",
                 "MNH07 Maternal Specimen ",
                 "MNH08 Maternal Lab ",
                 "MNH25 Maternal Depression ",
                 "MNH26 Maternal Fatigue ",
                 ## ANC28 (20-26)
                 "Denominator, n  ",                 
                 "MNH01 Ultrasound (optional)  ",
                 "MNH04 ANC Clinical Status  ",
                 "MNH05 Maternal Anthropometry  ",
                 "MNH06 Maternal POC  ",
                 "MNH07 Maternal Specimen  ",
                 "MNH08 Maternal Lab  ",
                 ## ANC32 (27-35)
                 "Denominator, n   ",                 
                 "MNH01 Ultrasound   ",
                 "MNH04 ANC Clinical Status   ",
                 "MNH05 Maternal Anthropometry   ",
                 "MNH06 Maternal POC   ",
                 "MNH07 Maternal Specimen   ",
                 "MNH08 Maternal Lab   ",
                 "MNH25 Maternal Depression   ",
                 "MNH26 Maternal Fatigue   ",
                 ##ANC36 (36-42)
                 "Denominator, n    ",                 
                 "MNH01 Ultrasound (optional)    ",
                 "MNH04 ANC Clinical Status    ",
                 "MNH05 Maternal Anthropometry    ",
                 "MNH06 Maternal POC    ",
                 "MNH07 Maternal Specimen    ",
                 "MNH08 Maternal Lab    "
                 )
               )  %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  kbl(caption = "", longtable = T) %>%
    footnote(alphabet = c("denominator is n enrolled", 
                      "denominator is n completed any form with visit status=complete AND visit type=Enrollment AND passed on-time window with >19 weeks gestation",
                      "denominator is n completed any form with visit status=complete AND visit type=ANC20 AND passed on-time window with >22 weeks gestation",
                      "denominator is n completed any form with visit status=complete ANDvisit type=ANC28  AND passed on-time window with >30 weeks gestation",
                      "denominator is n completed any form with visit status=complete AND visit type=ANC32  AND passed on-time window with>33 weeks gestation",
                      "denominator is n completed any form with visit status=complete AND visit type=ANC36  AND passed on-time window with >38 weeks gestation"),
             general = "Passed window denominators for all visits are calculated by EDD reported in MNH01 (US_EDD_BRTHDAT). If an EDD is missing, the particpant is removed from this table.", 
             footnote_order = c("alphabet", "general")) %>% 
  kable_paper(bootstrap_options = "striped", 
              full_width = T, html_font = "Cambria", position = "left",
              latex_options = c("repeat_header", "HOLD_position")) %>% 
              #latex_options = "hold_position") %>% 
  row_spec(0, extra_css = "border-bottom: 0px white;") %>% 
  row_spec(0:1, extra_css = "padding: 0.1px") %>% 
  row_spec(c(2,11,20,27,36), bold = TRUE) %>% 
  #pack_rows("MNH01 Ultrasound", 2, 5, label_row_css = "color: steelblue;") %>%
  pack_rows(paste0("Enrollment, n(%)^b^ \nTarget window: <20wks"),2, 10, 
            label_row_css = "color: steelblue;") %>% 
  pack_rows("ANC = 20, n(%)^c^ \nTarget window: 18 to 22wks", 11, 19, 
            label_row_css = "color: steelblue;") %>% 
  pack_rows("ANC = 28, n(%)^d^ \nTarget window: 26 to 30wks", 20, 26,
            label_row_css = "color: steelblue;") %>% 
  pack_rows("ANC = 32, n(%)^e^ \nTarget window: 31 to 33wks", 27, 35,
            label_row_css = "color: steelblue;") %>% 
  pack_rows("ANC = 36, n(%)^f^ \nTarget window: 34 to 38wks", 36, 42,
            label_row_css = "color: steelblue;") 

```

\newpage

#### `r emo::ji("pushpin")` Table 7: ANC Form Completion
*Value: Are forms completed regardless of visit status?*
<br>
<br>

*Numerator:* By form: visit type = i (variable name: `TYPE_VISIT`) AND have any visit status (variable name: `MAT_VISIT_MNHXX`) AND passed window for visit type = i 
<br>
*Denominator:* Any form with visit type = i (variable name: `TYPE_VISIT`) AND have any visit status (variable name: `MAT_VISIT_MNHXX`) AND passed window for visit type = i 

```{r ga_tb FC}
## ANC visits - ultrasound form  
# denominator: c = n all screened 
# Participants are included in the numerator of this table if, for each form, they have visit type = i AND have any visit status AND passed window for visit type = 1. Participants are included Visit status is defined by MAT_VISIT_MNHxx variables in each form.*
ga_tb <- MatData_Anc_Visits %>% 
  group_by(SITE) %>% 
  summarise(
  "total enrolled" = paste0(
    "(n=",sum(c==1), ")"
  )
  ) %>% ungroup() %>% 
  t() %>% 
  as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "All sites" = MatData_Anc_Visits %>%
 plyr::summarise(
     "total enrolled" = paste0(
    "(n=",sum(c==1),")"
  )) %>% 
      t() %>% as.data.frame() %>% unlist()
  ) 


```

```{r ENROLLMENT FC}

#* Num (hard code in monitoring report rmd): for each form: visit type = i AND have any visit status AND passed window for visit type = i 
#* Denom: Any form with visit type = i AND have any visit status AND passed window for visit type = i

ENROLLMENT <- Form_Completion_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
      "Denominator" = paste0(
        format(sum(FC_ENROLL_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH01 Ultrasound" = paste0(
        format(sum(!is.na(M01_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M01_VISIT_COMPLETE_1)& ENROLL_PASS == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH02 Enrollment Status" = paste0(
        format(sum(!is.na(M02_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M02_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      "MNH03 Sociodemographic" = paste0(
        format(sum(!is.na(M03_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M03_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "All sites" = Form_Completion_Anc %>% 
        plyr::summarise(
        
      "Denominator" = paste0(
        format(sum(FC_ENROLL_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),  
      
      "MNH01 Ultrasound" = paste0(
        format(sum(!is.na(M01_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M01_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH02 Enrollment Status" = paste0(
        format(sum(!is.na(M02_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M02_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH03 Sociodemographic" = paste0(
        format(sum(!is.na(M03_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M03_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_1) & ENROLL_PASS == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>% 
        t() %>% 
        as.data.frame() %>% 
      `colnames<-`(c(.[1,])) %>% unlist() 
)


```

```{r ANC20 FC}
#* Num (hard code in monitoring report rmd): for each form: visit type = i AND have any visit status AND passed window for visit type = i 
#* Denom: Any form with visit type = i AND have any visit status AND passed window for visit type = i

ANC20 <- Form_Completion_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
      
    "Denominator" = paste0(
        format(sum(FC_ANC20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 
      
    "MNH01 Ultrasound (optional)" = paste0(
        format(sum(!is.na(M01_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M01_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
    
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
       "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH25 Maternal Depression" = paste0(
        format(sum(!is.na(M25_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M25_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

       "MNH26 Maternal Fatigue" = paste0(
        format(sum(!is.na(M26_VISIT_COMPLETE_2)  & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M26_VISIT_COMPLETE_2)  & ANC20_PASS == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
    t() %>% 
    as.data.frame() %>%    
        `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
    add_column(
      .before = 1,
      "All sites" = Form_Completion_Anc %>% 
        plyr::summarise(
                
    "Denominator" = paste0(
        format(sum(FC_ANC20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 
    
      "MNH01 Ultrasound (optional)" = paste0(
        format(sum(!is.na(M01_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M01_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
    
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH25 Maternal Depression" = paste0(
        format(sum(!is.na(M25_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M25_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

       "MNH26 Maternal Fatigue" = paste0(
        format(sum(!is.na(M26_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M26_VISIT_COMPLETE_2) & ANC20_PASS == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
        
        t() %>% as.data.frame() %>% unlist() 
)

```

```{r ANC 28 FC}
#* Num (hard code in monitoring report rmd): for each form: visit type = i AND have any visit status AND passed window for visit type = i 
#* Denom: Any form with visit type = i AND have any visit status AND passed window for visit type = i

ANC28 <- Form_Completion_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
            
    "Denominator" = paste0(
        format(sum(FC_ANC28_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 
    
       "MNH01 Ultrasound (optional)" = paste0(
        format(sum(!is.na(M01_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M01_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% `colnames<-`(c(.[1,]))  %>% as.data.frame() %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "All sites" = Form_Completion_Anc %>% 
        plyr::summarise(
                      
    "Denominator" = paste0(
        format(sum(FC_ANC28_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 

       "MNH01 Ultrasound (optional)" = paste0(
        format(sum(!is.na(M01_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M01_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_3) & ANC28_PASS == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>% 
        t() %>% `colnames<-`(c(.[1,])) %>% 
        as.data.frame() %>% unlist() 
)

```

```{r ANC 32 FC}
#* Num (hard code in monitoring report rmd): for each form: visit type = i AND have any visit status AND passed window for visit type = i 
#* Denom: Any form with visit type = i AND have any visit status AND passed window for visit type = i

ANC32 <- Form_Completion_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
                  
    "Denominator" = paste0(
        format(sum(FC_ANC32_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 
      
   "MNH01 Ultrasound" = paste0(
        format(sum(!is.na(M01_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M01_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH25 Maternal Lab" = paste0(
        format(sum(!is.na(M25_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M25_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"), 
   
      "MNH26 Maternal Fatigue" = paste0(
        format(sum(!is.na(M26_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M26_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%

  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,]))  %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "All sites" = Form_Completion_Anc %>% 
        plyr::summarise(
                            
    "Denominator" = paste0(
        format(sum(FC_ANC32_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 

    "MNH01 Ultrasound" = paste0(
        format(sum(!is.na(M01_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M01_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      "MNH25 Maternal Lab" = paste0(
        format(sum(!is.na(M25_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M25_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH26 Maternal Fatigue" = paste0(
        format(sum(!is.na(M26_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M26_VISIT_COMPLETE_4) & ANC32_PASS == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%

        t() %>% 
        as.data.frame() %>% 
      `colnames<-`(c(.[1,])) %>%  unlist() 
)

```

```{r ANC36 FC}
#* Num (hard code in monitoring report rmd): for each form: visit type = i AND have any visit status AND passed window for visit type = i 
#* Denom: Any form with visit type = i AND have any visit status AND passed window for visit type = i

ANC36 <- Form_Completion_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
                        
    "Denominator" = paste0(
        format(sum(FC_ANC36_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 
      
       "MNH01 Ultrasound (optional)" = paste0(
        format(sum(!is.na(M01_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M01_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),


      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% `colnames<-`(c(.[1,]))  %>% as.data.frame() %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "All sites" = Form_Completion_Anc %>% 
        plyr::summarise(
                            
    "Denominator" = paste0(
        format(sum(FC_ANC36_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 
          
       "MNH01 Ultrasound (optional)" = paste0(
        format(sum(!is.na(M01_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M01_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthropometry" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_5) & ANC36_PASS == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
        t() %>% `colnames<-`(c(.[1,])) %>% 
        as.data.frame() %>% unlist() 
)

```

```{r PRISMA TABLE 7 OUT}
bind_rows(ga_tb, 
          ENROLLMENT, 
          ANC20,
          ANC28, 
          ANC32, 
          ANC36
          ) %>% 
  `rownames<-`(c(" ",
                 ## ANCLESS20 (2-10)
                 "Denominator, n",
                 "MNH01 Ultrasound", 
                 "MNH02 Enrollment Status", 
                 "MNH03 Sociodemographic", 
                 "MNH04 ANC Clinical Status",
                 "MNH05 Maternal Anthropometry",
                 "MNH06 Maternal POC",
                 "MNH07 Maternal Specimen",
                 "MNH08 Maternal Lab",
                 ## ANC20 (11-19)
                 "Denominator, n ",
                 "MNH01 Ultrasound (optional) ",
                 "MNH04 ANC Clinical Status ",
                 "MNH05 Maternal Anthropometry ",
                 "MNH06 Maternal POC ",
                 "MNH07 Maternal Specimen ",
                 "MNH08 Maternal Lab ",
                 "MNH25 Maternal Depression ",
                 "MNH26 Maternal Fatigue ",
                 ## ANC28 (20-26)
                 "Denominator, n  ",
                 "MNH01 Ultrasound (optional)  ",
                 "MNH04 ANC Clinical Status  ",
                 "MNH05 Maternal Anthropometry  ",
                 "MNH06 Maternal POC  ",
                 "MNH07 Maternal Specimen  ",
                 "MNH08 Maternal Lab  ",
                 ## ANC32 (27-35)
                 "Denominator, n   ",
                 "MNH01 Ultrasound   ",
                 "MNH04 ANC Clinical Status   ",
                 "MNH05 Maternal Anthropometry   ",
                 "MNH06 Maternal POC   ",
                 "MNH07 Maternal Specimen   ",
                 "MNH08 Maternal Lab   ",
                 "MNH25 Maternal Depression   ",
                 "MNH26 Maternal Fatigue   ",
                 ##ANC36 (36-42)
                 "Denominator, n    ",
                 "MNH01 Ultrasound (optional)    ",
                 "MNH04 ANC Clinical Status    ",
                 "MNH05 Maternal Anthropometry    ",
                 "MNH06 Maternal POC    ",
                 "MNH07 Maternal Specimen    ",
                 "MNH08 Maternal Lab    "
                 )
               )  %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  kbl(caption = "", longtable = T) %>%
    footnote(alphabet = c("denominator is n enrolled", 
                      "denominator is n completed any form with any visit status AND visit type=Enrollment AND passed on-time window with >19 weeks gestation",
                      "denominator is n completed any form with any visit status AND visit type=ANC20 AND passed on-time window with >22 weeks gestation",
                      "denominator is n completed any form with any visit status AND visit type=ANC28 AND passed on-time window with >30 weeks gestation",
                      "denominator is n completed any form with any visit status AND visit type=ANC32 AND passed on-time window with>33 weeks gestation",
                      "denominator is n completed any form with any visit status AND visit type=ANC36 AND passed on-time window with >38 weeks gestation"),
             general = "Passed window denominators for all visits are calculated by EDD reported in MNH01 (US_EDD_BRTHDAT). If an EDD is missing, the particpant is removed from this table.", 
             footnote_order = c("alphabet", "general")) %>% 
  kable_paper(bootstrap_options = "striped", 
              full_width = T, html_font = "Cambria", position = "left",
              latex_options = c("repeat_header", "HOLD_position")) %>% 
              #latex_options = "hold_position") %>% 
  row_spec(0, extra_css = "border-bottom: 0px white;") %>% 
  row_spec(0:1, extra_css = "padding: 0.1px") %>% 
  row_spec(c(2,11,20,27,36), bold = TRUE) %>% 
  #pack_rows("MNH01 Ultrasound", 2, 5, label_row_css = "color: steelblue;") %>%
  pack_rows(paste0("Enrollment, n(%)^b^ \nTarget window: <20wks"),2, 10, 
            label_row_css = "color: steelblue;") %>% 
  pack_rows("ANC = 20, n(%)^c^ \nTarget window: 18 to 22wks", 11, 19, 
            label_row_css = "color: steelblue;") %>% 
  pack_rows("ANC = 28, n(%)^d^ \nTarget window: 26 to 30wks", 20, 26,
            label_row_css = "color: steelblue;") %>% 
  pack_rows("ANC = 32, n(%)^e^ \nTarget window: 31 to 33wks", 27, 35,
            label_row_css = "color: steelblue;") %>% 
  pack_rows("ANC = 36, n(%)^f^ \nTarget window: 34 to 38wks", 36, 42,
            label_row_css = "color: steelblue;") 

```


\newpage

### **2. ReMAPP** 

#### `r emo::ji("pushpin")` Table 1: ReMAPP healthy cohort eligibility
*Value: This table will be updated as lab measurements are updated and reported. Those who are unknown may move into eligible or ineligible categories based on updated lab reports. Those who are eligible were enrolled in PRISMA following the launch of ReMAPP at each site.*

```{r}
options(knitr.kable.NA = '0 (0)')

healthy_enroll <- healthyOutcome %>% 
  filter(ENROLL == 1) %>% 
  group_by(SITE) %>% 
  summarise(" " = paste0("(n=", n(), ")"), 
            "Total enrolled in PRISMA since ReMAPP launch" = sum(HEALTHY_ELIGIBLE == 1, na.rm=TRUE),
            "Eligible , n(%)" = paste0(sum(HEALTHY_ELIGIBLE == 1, na.rm=TRUE),
                                        " (", format(sum(HEALTHY_ELIGIBLE == 1, na.rm=TRUE)/sum(ENROLL == 1)*100, digits = 2, nsmall=0), ")"),
            "Ineligible, n(%)" = paste0(sum(HEALTHY_ELIGIBLE == 0, na.rm=TRUE),
                             " (", format(sum(HEALTHY_ELIGIBLE == 0, na.rm=TRUE)/sum(ENROLL == 1)*100, digits = 2, nsmall=0), ")"),
            "Pending, n(%)" = paste0(sum(HEALTHY_ELIGIBLE == 3, na.rm=TRUE),
                                " (", format(sum(HEALTHY_ELIGIBLE == 3, na.rm=TRUE)/sum(ENROLL == 1)*100, digits = 2, nsmall=0), ")")
  ) %>% 
    t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "All sites" = healthyOutcome %>% 
  filter(ENROLL == 1) %>% 
  plyr::summarise(" " = paste0("(n=", sum(ENROLL==1), ")"), 
            "Total enrolled in ReMAPP" = sum(HEALTHY_ELIGIBLE == 1, na.rm=TRUE),
            "Eligible , n(%)" = paste0(sum(HEALTHY_ELIGIBLE == 1, na.rm=TRUE),
                                        " (", format(sum(HEALTHY_ELIGIBLE == 1, na.rm=TRUE)/sum(ENROLL==1)*100, digits = 2, nsmall=0), ")"),
            "Ineligible, n(%)" = paste0(sum(HEALTHY_ELIGIBLE == 0, na.rm=TRUE),
                             " (", format(sum(HEALTHY_ELIGIBLE == 0, na.rm=TRUE)/sum(ENROLL == 1)*100, digits = 2, nsmall=0), ")"),
            "Pending, n(%)" = paste0(sum(HEALTHY_ELIGIBLE == 3, na.rm=TRUE),
                                " (", format(sum(HEALTHY_ELIGIBLE == 3, na.rm=TRUE)/sum(ENROLL == 1)*100, digits = 2, nsmall=0), ")")
  ) %>% 
      t() %>% unlist()
  ) 
```


```{r}
bind_rows(healthy_enroll) %>% 
  kbl(caption = "") %>%
  kable_paper(bootstrap_options = "striped", 
              full_width = T, html_font = "Cambria", position = "left",
              latex_options = "hold_position") %>% 
  row_spec(0, extra_css = "border-bottom: 0px white;") %>% 
  row_spec(0:1, extra_css = "padding: 0px") %>% 
  footnote(alphabet = c("denominator is n enrolled in PRISMA")) 
```

&nbsp;
&nbsp;

#### `r emo::ji("pushpin")` Table 2: Proportion of women eligible for ReMAPP healthy cohort by eligibility criteria. 
*Value: This table will show the eligible number and percentage of all ReMAPP enrolled women for each criteria at baseline*

```{r}
criteria_cols = c('CRIT_AGE', 'CRIT_GA',
                  'CRIT_BMI', 'CRIT_MUAC',
                  'CRIT_HEIGHT', 'CRIT_SINGLEPREG',
                  'CRIT_BP', 'CRIT_PREV_MISCARR',
                  'CRIT_PREV_PRETERM_LBW', 'CRIT_PREV_NEODEATH',
                  'CRIT_COMPLICATION', 'CRIT_SMOKE',
                  'CRIT_DRINK', 'CRIT_CHRONIC', 
                  'CRIT_HIV', 'CRIT_MALARIA',
                  'CRIT_HEPATITISB','CRIT_HEPATITISC',
                  'CRIT_HEMOGLOBINOPATHIES', 'CRIT_IRON',
                  'CRIT_INFLAM'
 )
criteria_names <- c('Aged 18 to 34 years',
                    'Gestational age <14 weeks at enrollment',
                    'BMI at baseline of >18.5 and <30 kg/m2',
                    'Mid-upper arm circumference \n(MUAC) > 23cm',
                    'Height >153 cm',
                    'Singleton pregnancy',
                    'Systolic blood pressure <140 mmHg and \ndiastolic blood pressure <90 mmHg',
                    '<= 1 miscarriage in two consecutive \npregnancies',
                    'No previous preterm or low birth \nweight delivery',
                    'No previous fetal death',
                    'No history of pregnancy complications',
                    'Non-cigarette smoking, tobacco chewing, \nor betel nut use',
                    'No reported alcohol consumption during \npregnancy',
                    'No known history or current chronic \ndisease including cancer, kidney disease, and cardiac conditions',
                    'No known history or current HIV',
                    'No current malaria infection (per RDT)\n at baseline',
                    'No Hepatitis B virus infection',
                    'No Hepatitis C virus infection',
                    'No hemoglobinopathies',
                    'Not iron deficient (serum ferritin >15 mcg/L \nadjusted for inflammation)',
                    'No subclinical inflammation \n(CRP > 5 mg/L and/or AGP > 1 g/L)'
                    )
healthy_tb <- map_dfc(c("Ghana", "Pakistan","Kenya"), function(site){ 
    healthyOutcome %>%
    filter(ENROLL == 1) %>% 
    filter(SITE == {{site}}) %>% 
    select(starts_with("CRIT_")) %>%
    pivot_longer(everything()) %>%
    group_by(name, value) %>%
    summarize(n = n(), .groups = "drop_last") %>%
    mutate(p = paste0(n, " (", format(round(n/sum(n, na.rm = TRUE)*100), digits = 2, nsmall=0), ")")) %>%
    select(-n) %>%
    pivot_wider(names_from = value, values_from = p, values_fill = "0 (0)") %>%
    ungroup() %>% arrange(match(name, criteria_cols)) %>%
    select(-name) %>%
    mutate(criteria = criteria_names, .before  = 1) %>% 
    select(`1`) %>% 
  `colnames<-`(c(site))
}) %>% 
  as.data.frame() %>% 
  `rownames<-`(criteria_names) %>% 
  add_column(
    .before = 1,
    "All sites" = 
    healthyOutcome %>%
    filter(ENROLL == 1) %>% 
    select(starts_with("CRIT_")) %>%
    pivot_longer(everything()) %>%
    group_by(name, value) %>%
    summarize(n = n(), .groups = "drop_last") %>%
    mutate(p = paste0(n, " (", format(round(n/sum(n)*100), digits = 2, nsmall=0), ")")) %>%
    select(-n) %>%
    pivot_wider(names_from = value, values_from = p, values_fill = "0 (0)") %>%
    ungroup() %>% arrange(match(name, criteria_cols)) %>%
    select(-name) %>%
    mutate(criteria = criteria_names, .before  = 1) %>% 
    select(`1`) %>% 
    unlist()
    )
healthy_tb$Pakistan[13] = "NA"

enroll_tb <- healthyOutcome %>% 
  group_by(SITE) %>% 
  filter(ENROLL ==1 ) %>% 
  summarise(" " = paste0("(n=", sum(ENROLL == 1), ")")#,
            ) %>% 
  t() %>% as.data.frame() %>% 
    `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "All sites" = healthyOutcome %>% 
  filter(ENROLL ==1 ) %>% 
  summarise(" " = paste0("(n=", sum(ENROLL == 1), ")")
            ) %>% 
  t() %>% as.data.frame() %>% unlist()
  ) 

```

```{r}
enroll_tb %>% 
  bind_rows(healthy_tb) %>% 
  kbl(caption = "", longtable = T) %>%
  kable_paper(bootstrap_options = c("striped", "hover"), 
              full_width = T, html_font = "Cambria", position = "left",
              latex_option = "hold position") %>% 
  row_spec(0, extra_css = "border-bottom: 0px white;") %>% 
  row_spec(0:1, extra_css = "padding: 0px") %>% 
  pack_rows("Eligible for ReMAPP Aim 1 enrollment, n(%)^a^", 2, 15, label_row_css = "color: steelblue;") %>%
  pack_rows("Lab Values, n(%)^a^", 16, 22, label_row_css = "color: steelblue;") %>% 
  column_spec(1, width = "22em") %>% 
    footnote(alphabet = c("denominator is enrolled in PRISMA")) 
```

\newpage

#### `r emo::ji("pushpin")` Table 3: CBC Hemoglobin measurements for participants in ReMAPP per visit 
*Value: Were all the required CBC hemoglobin measurements taken as directed by the protocol?* 

```{r REMAPP Table 3}
## denominators: 
  # DenHBV1 = MNH08 completed with visit type = 1 AND visit status = 1/2 OR enrollment overdue
  # DenHBV2 = MNH08 completed with visit type = 2 AND visit status = 1/2 AND GA at enrollment <= 17wks OR ANC20 overdue
  # DenHBV3 = MNH08 completed with visit type = 3 AND visit status = 1/2 OR ANC28 overdue
  # DenHBV5 = MNH08 completed with visit type = 5 AND visit status = 1/2 OR ANC36 overdue


remapp_table3 <- MatData_Hb_Visit %>%
  group_by(SITE) %>%
    summarise(
          "total enrolled" = paste0(
            "(n=", n(),")"
          ),
            "Enrollment" = paste0(sum(HB_COMPLETED_1 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_1 == 1, na.rm = TRUE)/sum(DenHBV1 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
            "ANC20" = paste0(sum(HB_COMPLETED_2 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_2 == 1, na.rm = TRUE)/sum(DenHBV2 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
            "ANC28" = paste0(sum(HB_COMPLETED_3 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_3 == 1, na.rm = TRUE)/sum(DenHBV3 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
  
            "ANC36" = paste0(sum(HB_COMPLETED_5 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_5 == 1, na.rm = TRUE)/sum(DenHBV5 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")")
  
            # "PNC6" = paste0(sum(HB_COMPLETED_10 == 1),
            #                             " (", format(sum(HB_COMPLETED_10 == 1)/sum(d == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")")
  
) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .before = 1,
    "All sites" = MatData_Hb_Visit %>%
    plyr::summarise(
          "total enrolled" = paste0(
            "(n=", sum(c==1),")"),
          
            "Enrollment" = paste0(sum(HB_COMPLETED_1 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_1 == 1, na.rm = TRUE)/sum(DenHBV1 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
            "ANC20" = paste0(sum(HB_COMPLETED_2 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_2 == 1, na.rm = TRUE)/sum(DenHBV2 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
            "ANC28" = paste0(sum(HB_COMPLETED_3 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_3 == 1, na.rm = TRUE)/sum(DenHBV3 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
  
            "ANC36" = paste0(sum(HB_COMPLETED_5 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_5 == 1, na.rm = TRUE)/sum(DenHBV5 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")")
  
            # "PNC6" = paste0(sum(HB_COMPLETED_10 == 1),
            #                             " (", format(sum(HB_COMPLETED_10 == 1)/sum(d == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")")
  
) %>%
      t() %>% unlist()
  )

```

```{r REMAPP Table 3 Out}
remapp_table3 %>% 
    `rownames<-`(c(" ",
                  "ANC < 20, n(%)^a^",
                  "ANC = 20, n(%)^b^",
                  "ANC = 28, n(%)^c^",
                  "ANC = 36, n(%)^d^")) %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  kbl(caption = "") %>%
  kable_paper(bootstrap_options = "striped", 
              full_width = T, html_font = "Cambria", position = "left",
              latex_options = "hold_position") %>% 
  row_spec(0, extra_css = "border-bottom: 0px white;") %>% 
  row_spec(0:1, extra_css = "padding: 0px") %>% 
  footnote(alphabet = c("denominator is n enrolled", 
                      "denominator is n completed MNH-08 with visit type=ANC20 OR missed on-time window with >22 weeks gestation",
                      "denominator is n completed  MNH-08 with visit type=ANC28  OR missed on-time window with >30 weeks gestation",
                      "denominator is n completed  MNH-08 with visit type=ANC36  OR missed on-time window with >38 weeks gestation"
                       )) 
  # pack_rows("ANC < 20, n(%)^a^", 2, 2, label_row_css = "color: steelblue;") %>% 
  # pack_rows("ANC = 20, n(%)^b^", 3, 3, label_row_css = "color: steelblue;") %>% 
  # pack_rows("ANC = 28, n(%)^c^", 4, 4, label_row_css = "color: steelblue;") %>% 
  # pack_rows("ANC = 32, n(%)^d^", 5, 5, label_row_css = "color: steelblue;") %>% 
  # pack_rows("ANC = 36, n(%)^e^", 6, 6, label_row_css = "color: steelblue;") 

```

&nbsp;
&nbsp;

#### `r emo::ji("pushpin")` Table 4: Hemoglobin descriptive statistics for participants in ReMAPP cohort

```{r REMAPP Table 4}

MatData_Hb_Visit <- MatData_Hb_Visit %>% 
  mutate(M08_CBC_HB_LBORRES_1 = replace(M08_CBC_HB_LBORRES_1, M08_CBC_HB_LBORRES_1 == -7, NA),
         M08_CBC_HB_LBORRES_2 = replace(M08_CBC_HB_LBORRES_2, M08_CBC_HB_LBORRES_2 == -7, NA),
         M08_CBC_HB_LBORRES_3 = replace(M08_CBC_HB_LBORRES_3, M08_CBC_HB_LBORRES_3 == -7, NA),
         M08_CBC_HB_LBORRES_4 = replace(M08_CBC_HB_LBORRES_4, M08_CBC_HB_LBORRES_4 == -7, NA),
         M08_CBC_HB_LBORRES_5 = replace(M08_CBC_HB_LBORRES_5, M08_CBC_HB_LBORRES_5 == -7, NA))

remapp_table4 <- MatData_Hb_Visit %>%
  group_by(SITE) %>%
    summarise(
     "total enrolled" = paste0(
            "(n=", n(),")" ),
     
      " " = paste0("Mean (SD),<br>[min-max]"),

      "Enrollment" = paste0(
        format(round(mean(M08_CBC_HB_LBORRES_1, na.rm = TRUE),2), nsmall=0, digits = 2),
        " (",
        format(round(sd(M08_CBC_HB_LBORRES_1, na.rm = TRUE),2), nsmall=0, digits = 2),
        "), <br> [",
        format(round(min(M08_CBC_HB_LBORRES_1, na.rm = TRUE),2), nsmall=0, digits = 2),
        " - ",
        format(round(max(M08_CBC_HB_LBORRES_1, na.rm = TRUE),2), nsmall=0, digits = 2),
        "]"),
      "ANC20" = paste0(
        format(round(mean(M08_CBC_HB_LBORRES_2, na.rm = TRUE),2), nsmall=0, digits = 2),
        " (",
        format(round(sd(M08_CBC_HB_LBORRES_2, na.rm = TRUE),2), nsmall=0, digits = 2),
        "), <br> [",
        format(round(min(M08_CBC_HB_LBORRES_2, na.rm = TRUE),2), nsmall=0, digits = 2),
        " - ",
        format(round(max(M08_CBC_HB_LBORRES_2, na.rm = TRUE),2), nsmall=0, digits = 2),
        "]"), 
  
      "ANC28" = paste0(
        format(round(mean(M08_CBC_HB_LBORRES_3, na.rm = TRUE),2), nsmall=0, digits = 2),
        " (",
        format(round(sd(M08_CBC_HB_LBORRES_3, na.rm = TRUE),2), nsmall=0, digits = 2),
        "), <br> [",
        format(round(min(M08_CBC_HB_LBORRES_3, na.rm = TRUE),2), nsmall=0, digits = 2),
        " - ",
        format(round(max(M08_CBC_HB_LBORRES_3, na.rm = TRUE),2), nsmall=0, digits = 2),
        "]"), 
  
      "ANC36" = paste0(
        format(round(mean(M08_CBC_HB_LBORRES_5, na.rm = TRUE),2), nsmall=0, digits = 2),
        " (",
        format(round(sd(M08_CBC_HB_LBORRES_5, na.rm = TRUE),2), nsmall=0, digits = 2),
        "), <br> [",
        format(round(min(M08_CBC_HB_LBORRES_5, na.rm = TRUE),2), nsmall=0, digits = 2),
        " - ",
        format(round(max(M08_CBC_HB_LBORRES_5, na.rm = TRUE),2), nsmall=0, digits = 2),
        "]")
  
            # "PNC6" = paste0(sum(HB_COMPLETED_10 == 1),
            #                             " (", format(sum(HB_COMPLETED_10 == 1)/sum(d == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")")
  
) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .before = 1,
    "All sites" = MatData_Hb_Visit %>%
    plyr::summarise(
          "total enrolled" = paste0(
            "(n=", sum(c==1),")"),
          
      " " = paste0("Mean (SD),<br>[min-max]"),
      
      "Enrollment" = paste0(
        format(round(mean(M08_CBC_HB_LBORRES_1, na.rm = TRUE),2), nsmall=0, digits = 2),
        " (",
        format(round(sd(M08_CBC_HB_LBORRES_1, na.rm = TRUE),2), nsmall=0, digits = 2),
        "),<br>[",
        format(round(min(M08_CBC_HB_LBORRES_1, na.rm = TRUE),2), nsmall=0, digits = 2),
        " - ",
        format(round(max(M08_CBC_HB_LBORRES_1, na.rm = TRUE),2), nsmall=0, digits = 2),
        "]"),
      "ANC20" = paste0(
        format(round(mean(M08_CBC_HB_LBORRES_2, na.rm = TRUE),2), nsmall=0, digits = 2),
        " (",
        format(round(sd(M08_CBC_HB_LBORRES_2, na.rm = TRUE),2), nsmall=0, digits = 2),
        "),<br>[",
        format(round(min(M08_CBC_HB_LBORRES_2, na.rm = TRUE),2), nsmall=0, digits = 2),
        " - ",
        format(round(max(M08_CBC_HB_LBORRES_2, na.rm = TRUE),2), nsmall=0, digits = 2),
        "]"), 
  
      "ANC28" = paste0(
        format(round(mean(M08_CBC_HB_LBORRES_3, na.rm = TRUE),2), nsmall=0, digits = 2),
        " (",
        format(round(sd(M08_CBC_HB_LBORRES_3, na.rm = TRUE),2), nsmall=0, digits = 2),
        "),<br>[",
        format(round(min(M08_CBC_HB_LBORRES_3, na.rm = TRUE),2), nsmall=0, digits = 2),
        " - ",
        format(round(max(M08_CBC_HB_LBORRES_3, na.rm = TRUE),2), nsmall=0, digits = 2),
        "]"), 
  
      "ANC36" = paste0(
        format(round(mean(M08_CBC_HB_LBORRES_5, na.rm = TRUE),2), nsmall=0, digits = 2),
        " (",
        format(round(sd(M08_CBC_HB_LBORRES_5, na.rm = TRUE),2), nsmall=0, digits = 2),
        "),<br>[",
        format(round(min(M08_CBC_HB_LBORRES_5, na.rm = TRUE),2), nsmall=0, digits = 2),
        " - ",
        format(round(max(M08_CBC_HB_LBORRES_5, na.rm = TRUE),2), nsmall=0, digits = 2),
        "]") 
            # "PNC6" = paste0(sum(HB_COMPLETED_10 == 1),
            #                             " (", format(sum(HB_COMPLETED_10 == 1)/sum(d == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")")
  
) %>%
      t() %>% unlist()
  )


```

```{r REMAPP Table 4 Out}

remapp_table4 %>% 
    `rownames<-`(c(" ", "  ",
                  "ANC < 20^a^",
                  "ANC = 20^b^",
                  "ANC = 28^c^",
                  "ANC = 36^d^")) %>% 
 #mutate_all(funs(str_replace(., "<br />\n", ""))) %>% 
  mutate_all(funs(str_replace(., "NaN" , "No Data"))) %>% 
  mutate_all(funs(str_replace(., "Inf" , ""))) %>%  
  mutate_all(funs(str_replace(., "-Inf" , ""))) %>%  
  kbl(caption = "", escape = FALSE) %>%
  kable_paper(bootstrap_options = "striped", 
              full_width = T, html_font = "Cambria", position = "left",
              latex_options = "hold_position") %>% 
  row_spec(0, extra_css = "border-bottom: 0px white;") %>% 
  row_spec(0:1, extra_css = "padding: 0px") %>% 
  footnote(alphabet = c("denominator is n enrolled", 
                      "denominator is n completed MNH-08 with visit type=ANC20 OR missed on-time window with >22 weeks gestation",
                      "denominator is n completed  MNH-08 with visit type=ANC28  OR missed on-time window with >30 weeks gestation",
                      "denominator is n completed  MNH-08 with visit type=ANC36  OR missed on-time window with >38 weeks gestation"
                       )) 
  #row_spec(2, bold = T) 

#add_header_above(c(" " = 1, "Group 1" = 2, "Group 2" = 2, "Group 3" = 2))

```


\newpage

#### `r emo::ji("pushpin")` Figure 1: Hemoglobin measures by gestational age for participants enrolled in PRISMA MNH 

```{r, Remapp Figure 1, fig.show='hold', out.width="80%"}
## x axis in weeks 
#MatData_HB_GA_Visit_Kenya <- MatData_HB_GA_Visit %>% filter(SITE == "Kenya")
# ggplot(data = MatData_Hb_GA_Visit, 
#              aes(x = GA_WKS, y = RESULT, group = TEST, color = TEST), ) + 
#   geom_point(alpha = 0.75)  + 
#     facet_grid(rows = vars(SITE)) + 
#     theme_bw() +
#     ylim(0,20) + 
#     theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
#         legend.position="bottom",
#         legend.title = element_blank(),
#         panel.grid.minor = element_blank()) +
#   scale_x_continuous(n.breaks = 10) + 
#   xlab("Gestational Age (weeks)") +
#   ylab("Hemoglobin (g/dL)") + 
#   scale_color_brewer(palette="Set1")  
  
## x axis in days
MatData_Hb_GA_Visit <- MatData_Hb_GA_Visit %>% filter(GA > 0)

ggplot(data = MatData_Hb_GA_Visit,
             aes(x = GA, y = RESULT, group = TEST, color = TEST), ) +
  geom_point(alpha = 0.25)  +
    facet_grid(rows = vars(SITE)) +
    theme_bw() +
    ylim(0,20) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position="bottom",
        legend.title = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_x_continuous(breaks = c(0,49,98,147,198,245),
                     label = c("0", "7", "14", "21", "28", "35")) +
  xlab("Gestational Age (weeks)") +
  ylab("Hemoglobin (g/dL)") +
  scale_color_brewer(palette="Set1")

```

<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
<!-- </br> -->
\newpage

#### `r emo::ji("pushpin")` Figure 2: ANC hemoglobin values (CBC) by trimester for participants

```{r, Remapp Figure 2 Kenya, fig.show='hold', out.width="70%"}


## ReMAPP figure 3
trimester_names <- c(`1` = "First Trimester",
                     `2` = "Second Trimester",
                     `3` = "Third Trimester")

## Kenya
MatData_HB_GA_Visit_Kenya <- MatData_Hb_GA_Visit %>% filter(SITE == "Kenya", TEST == "CBC", !is.na(TRIMESTER))

ggplot() + 
  geom_histogram(data = MatData_HB_GA_Visit_Kenya, binwidth = 0.1, aes(RESULT))  + 
    facet_grid(rows = vars(TRIMESTER), labeller=as_labeller(trimester_names)) + 
    theme_bw() +
    #ylim(0,30) +
    xlim(2.5,15.5) + 
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position="bottom",
        panel.grid.minor = element_blank()) +
  xlab("Hemoglobin (g/dL)") +
  ylab("Frequency") + 
  scale_color_brewer(palette="Set1") + 
  ggtitle("Kenya") 



```

```{r, Remapp Figure 2 Pakistan, fig.show='hold', out.width="70%"}


## ReMAPP figure 3
trimester_names <- c(`1` = "First Trimester",
                     `2` = "Second Trimester",
                     `3` = "Third Trimester")

## Pakistan
MatData_HB_GA_Visit_Pakistan <- MatData_Hb_GA_Visit %>% filter(SITE == "Pakistan", 
                                                               TEST == "CBC", 
                                                               !is.na(TRIMESTER),
                                                               RESULT < 75)

ggplot() + 
  geom_histogram(data = MatData_HB_GA_Visit_Pakistan, binwidth = 0.1, aes(RESULT))  + 
    facet_grid(rows = vars(TRIMESTER), labeller=as_labeller(trimester_names)) + 
    theme_bw() +
    #ylim(0,30) + 
    xlim(2.5,15.5) + 
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position="bottom",
        panel.grid.minor = element_blank()) +
  xlab("Hemoglobin (g/dL)") +
  ylab("Frequency") + 
  scale_color_brewer(palette="Set1") + 
  ggtitle("Pakistan") 


```

```{r, Remapp Figure 2 Ghana, fig.show='hold', out.width="70%"}


## ReMAPP figure 3
trimester_names <- c(`1` = "First Trimester",
                     `2` = "Second Trimester",
                     `3` = "Third Trimester")
## Ghana
MatData_HB_GA_Visit_Ghana <- MatData_Hb_GA_Visit %>% filter(SITE == "Ghana", 
                                                               TEST == "CBC", 
                                                               !is.na(TRIMESTER),
                                                               RESULT < 75)


ggplot() + 
  geom_histogram(data = MatData_HB_GA_Visit_Ghana, binwidth = 0.1, aes(RESULT))  + 
    facet_grid(rows = vars(TRIMESTER), labeller=as_labeller(trimester_names)) + 
    theme_bw() +
    #ylim(0,30) + 
    xlim(2.5,15.5) + 
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position="bottom",
        panel.grid.minor = element_blank()) +
  xlab("Hemoglobin (g/dL)") +
  ylab("Frequency") + 
  scale_color_brewer(palette="Set1") + 
  ggtitle("Ghana") 


```

