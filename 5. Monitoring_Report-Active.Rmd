---
title: "<span style='font-size: 18px'> <span style='text-align: center'> PRISMA & ReMAPP Monitoring Report (Issued: 2023-11-28)"
output:
  pdf_document:
    toc: no
    toc_depth: 4
    latex_engine: xelatex
    keep_tex: true
include-in-header:
- \usepackage{ booktabs,longtable}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, out.width = "100%") 
knitr::opts_chunk$set(out.width = "100%", fig.align = "center")

library(tidyverse) 
library(knitr) 
library(reshape2) 
library(lubridate) 
library(kableExtra) 
library(emo) 
library(naniar) 
library(RColorBrewer) 
library(scales) 
library(gt) 
library(webshot2) 
library(ggpubr) 

UploadDate = "2023-11-24" 

setwd(paste0("D:/Users/stacie.loisate/Box/Monitoring-Report-Active/data/"))

## import all rda files 
rda_files = list.files(pattern="*.RData")
walk(rda_files, ~ load(.x, .GlobalEnv))

#table format
tb_theme1 <- function(matrix){
  tb <- matrix %>% 
    gt(
      rownames_to_stub = TRUE
    ) %>% 
    opt_align_table_header(align = "left") %>% 
    tab_spanner(
      label = "Sites",
      columns = c(-Total)
    ) %>% 
    opt_stylize(style = 6, color = 'blue') %>% 
    tab_style(
      style = list(
        cell_fill(color = "skyblue4"),
        cell_text(weight = "bold"),
        cell_text(v_align = "middle"),
        cell_text(color = "white", size = px(18))
      ),
      locations = list(
        cells_title()
      )
    ) %>% 
    tab_style(
      style = list(
        cell_fill(color = "cadetblue1"),
        cell_text(color = "black", size = px(18)),
        cell_text(v_align = "middle") 
      ),
      locations = list(
        cells_stubhead(),
        cells_column_spanners(),
        cells_column_labels() 
      )
    ) %>% 
    tab_style(
      style = list(
        cell_fill(color = "aliceblue"),
        cell_text(v_align = "middle", size = px(18))
      ),
      locations = list(
        cells_stub()
      ) 
    ) %>% 
    tab_style(
      style = list(
        cell_text(align = "center", size = px(18)) 
      ),
      locations = list(
        cells_column_labels(columns = everything())
      )
    ) %>% 
    tab_style(
      style = list(
        cell_text(align = "center", size = px(18)) 
      ),
      locations = list(
        cells_body(columns = everything())
      ) 
    ) %>%
    fmt_markdown(columns = everything()) %>%
    tab_options(table.width = pct(100)) %>%
    cols_width(1 ~ px(280))
} 

setwd(paste0("D:/Users/stacie.loisate/Box/Monitoring-Report-Active/tables/"))
```
**PRISMA MNH:** Pregnancy Risk and Infant Surveillance and Measurement Alliance Maternal and Newborn Health (PRISMA MNH) Study: A multi-center, prospective cohort study of maternal, newborn, and infant health

&nbsp;
&nbsp;

**ReMAPP:** Redefining Maternal Anemia in Pregnancy and Postpartum (ReMAPP) Study

&nbsp;
&nbsp;

**Includes data from synapse last updated:** 2023-11-24

#### **Last Enrollment Date: **
  + Kenya: 2023-11-24
  + Pakistan: 2023-11-17
  + Ghana : 2023-10-31
  + Zambia : 2023-11-20
  + India CMC : 2023-11-10
 
```{r, results='hide' }
#check last day of screening and enrollment
lastscreen <- MatData_Screen_Enroll %>%
  filter(PRESCREEN == 1) %>%
  select(M00_SCRN_OBSSTDAT, M02_SCRN_OBSSTDAT, SITE) %>%
  group_by(SITE) %>%
  mutate(last_screen = max((M00_SCRN_OBSSTDAT), na.rm = TRUE)) %>% 
  ungroup()

lastenroll <- MatData_Screen_Enroll %>%
  filter(ENROLL == 1) %>% 
  select(M00_SCRN_OBSSTDAT, M02_SCRN_OBSSTDAT, SITE) %>%
  group_by(SITE) %>%
  mutate(last_enroll = max((M02_SCRN_OBSSTDAT), na.rm = TRUE)) %>% 
  ungroup()

 # table(lastscreen$last_screen, lastscreen$SITE)
 table(lastenroll$last_enroll, lastenroll$SITE)
## 

##new 
date_last_enrll_pak <- lastenroll %>% filter(SITE == "Pakistan") %>% select(last_enroll) %>%  unique() %>% mutate(last_enroll = last_enroll-7) %>% pull()
date_last_enrll_ke <- lastenroll %>% filter(SITE == "Kenya") %>% select(last_enroll) %>%  unique() %>% mutate(last_enroll = last_enroll-7) %>% pull()
date_last_enrll_ga <- lastenroll %>% filter(SITE == "Ghana") %>% select(last_enroll) %>%  unique() %>% mutate(last_enroll = last_enroll-7) %>% pull()
date_last_enrll_za <- lastenroll %>% filter(SITE == "Zambia") %>% select(last_enroll) %>%  unique() %>% mutate(last_enroll = last_enroll-7) %>% pull()
date_last_enrll_cmc <- lastenroll %>% filter(SITE == "India-CMC") %>% select(last_enroll) %>%  unique() %>% mutate(last_enroll = last_enroll-7) %>% pull()


```

\tableofcontents

\newpage

## **1. PRISMA**

&nbsp;
&nbsp;

### Table 1: Pre-screening and Enrollment numbers for PRISMA for the most recent one week
*Value:* This will provide a snapshot of weekly pre-screening and enrollment progress.

```{r}
## Prescreening and enrollment in the most recent one week 
# denominator: a = n all pre-screened 
MatData_Screen_Enroll$date_last_enrll_pak = date_last_enrll_pak
MatData_Screen_Enroll$date_last_enrll_ke = date_last_enrll_ke
MatData_Screen_Enroll$date_last_enrll_ga = date_last_enrll_ga
MatData_Screen_Enroll$date_last_enrll_za = date_last_enrll_za
MatData_Screen_Enroll$date_last_enrll_cmc = date_last_enrll_cmc

tb_prescreen_enroll <- MatData_Screen_Enroll %>% 
  filter(
    SITE == "Pakistan" & (M00_SCRN_OBSSTDAT > date_last_enrll_pak) |
    SITE == "Kenya" & (M00_SCRN_OBSSTDAT > date_last_enrll_ke) | 
   SITE == "Ghana" & (M00_SCRN_OBSSTDAT > date_last_enrll_ga) |
    SITE == "Zambia" & (M00_SCRN_OBSSTDAT > date_last_enrll_za) | 
    SITE == "India-CMC" & (M00_SCRN_OBSSTDAT > date_last_enrll_cmc)  
  ) %>% 
  group_by(SITE) %>% 
  summarise("Pre-screened for PRISMA, n" = sum(PRESCREEN == 1, na.rm=TRUE),
            "Eligible based on pre-screening, n(%) <sup>a</sup>" = paste0(sum(PRESCR_ELIGIBLE == 1, na.rm=TRUE), 
                                        " (", format(sum(PRESCR_ELIGIBLE == 1, na.rm=TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Screened for PRISMA, n" = sum(SCREEN == 1),
            "Enrolled in PRISMA, n(%) <sup>b</sup>" = paste0(sum(ENROLL == 1, na.rm=TRUE), 
                                        " (", format(sum(ENROLL == 1, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")")
) %>% 
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "Total" = MatData_Screen_Enroll %>% 
  filter(
    SITE == "Pakistan" & (M00_SCRN_OBSSTDAT > date_last_enrll_pak) |
    SITE == "Kenya" & (M00_SCRN_OBSSTDAT > date_last_enrll_ke) | 
    SITE == "Ghana" & (M00_SCRN_OBSSTDAT > date_last_enrll_ga) |
    SITE == "Zambia" & (M00_SCRN_OBSSTDAT > date_last_enrll_za) |
    SITE == "India-CMC" & (M00_SCRN_OBSSTDAT > date_last_enrll_cmc) 


  ) %>% 
  plyr::summarise("Pre-screened for PRISMA, n" = sum(PRESCREEN == 1, na.rm=TRUE),
            "Eligible based on pre-screening, n(%) <sup>a</sup>" = paste0(sum(PRESCR_ELIGIBLE == 1, na.rm=TRUE), 
                                        " (", format(sum(PRESCR_ELIGIBLE == 1, na.rm=TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Screened for PRISMA, n" = sum(SCREEN == 1, na.rm=TRUE),
            "Enrolled in PRISMA, n(%) <sup>b</sup>" = paste0(sum(ENROLL == 1, na.rm=TRUE), 
                                        " (", format(sum(ENROLL == 1, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")")

) %>% 
      t() %>% unlist()
  ) 

# 
```

```{r}
#generate table by input data.frame and customize as needed. 
#example: tb_theme1(dataframe)
prisma_tab1 <- tb_theme1(tb_prescreen_enroll) %>% 
  tab_header(
    title = md("**PRISMA Table 1**")
    # subtitle = md("*Value: This will provide a snapshot of weekly pre-screening and enrollment progress.*")
  ) %>%
  # tab_row_group(
  #   label = "Pre-screened for PRISMA, n",
  #   rows = 1:1
  # ) %>% 
  # tab_row_group(
  #   label = "Eligible based on pre-screening, n(%)  ^a^",
  #   rows = 2:2
  # ) %>% 
  # tab_row_group(
  #   label = "Screened for PRISMA, n",
  #   rows = 3:3
  # ) %>%  
  # tab_row_group(
  #   label = "Enrolled in PRISMA, n(%) ^b^",
  #   rows = 4:4
  # )  %>% 
  # row_group_order(groups = c("Pre-screened for PRISMA, n",
  #                 "Eligible based on pre-screening, n(%)  ^a^",
  #                 "Screened for PRISMA, n",
  #                 "Enrolled in PRISMA, n(%) ^b^")) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> Denominator is pre-screened (MNH00 completed).</span>")
) %>%   
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Denominator is n screened (MNH02 completed).</span>")
)
    # tab_footnote(
    # footnote = html("<span style='font-size: 18px'><sup>b</sup> Denominator is n screened (MNH02 completed).</span>"),
    # locations = cells_stub(rows = c(
    #   "Enrolled in PRISMA, n(%)<sup>b</sup>"
    # ))) %>% 
  # opt_footnote_marks(marks = "letters")
```

```{r, out.width = '100%'}
prisma_tab1 <- prisma_tab1 %>% gtsave("prisma_tab1.png", expand = 10)
knitr::include_graphics("prisma_tab1.png")
```

\newpage

### Table 2: Cumulative pre-screening numbers for PRISMA
*Value:* Distribution of cumulative pre-screening distributions since the start of relaunch. If ineligible, distributions by exclusion criteria are listed below.

```{r}
## Cumulative Prescreening criteria 
# denominator: a = n all pre-screened 

tb_prescreen_all <- MatData_Screen_Enroll %>% 
  filter(PRESCREEN == 1) %>% 
  group_by(SITE) %>% 
  summarise("Pre-screened for PRISMA, n (MNH00)" = sum(PRESCREEN == 1, na.rm=TRUE),
            
            "Eligible based on pre-screening, n(%)^a^" = paste0(sum(PRESCR_ELIGIBLE == 1, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_ELIGIBLE == 1, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "No clinical signs of pregnancy" = paste0(sum(PRESCR_PREGSIGN == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_PREGSIGN == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Viable pregnancy with GA>=25 weeks" = paste0(sum(PRESCR_GA25 == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_GA25 == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Did not meet age requirement" = paste0(sum(PRESCR_AGE == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_AGE == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),

            "Outside catchment area" = paste0(sum(PRESCR_CATCHAREA == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_CATCHAREA == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Other reason^b^" = paste0(sum(PRESCR_OTHER == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_OTHER == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Did not consent" = paste0(sum(CONSENT_PRESCREEN== 0, na.rm = TRUE), 
                                        " (", format(sum(CONSENT_PRESCREEN == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")")
) %>% 
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "Total" = MatData_Screen_Enroll %>% 
  plyr::summarise("Pre-screened for PRISMA, n (MNH00)" = sum(PRESCREEN == 1, na.rm=TRUE),
            "Eligible based on pre-screening, n(%)^a^" = paste0(sum(PRESCR_ELIGIBLE == 1, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_ELIGIBLE == 1, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1,na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "No clinical signs of pregnancy" = paste0(sum(PRESCR_PREGSIGN == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_PREGSIGN == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Viable pregnancy with GA>=25 weeks" = paste0(sum(PRESCR_GA25 == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_GA25 == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Did not meet age requirement" = paste0(sum(PRESCR_AGE == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_AGE == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Outside catchment area" = paste0(sum(PRESCR_CATCHAREA == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_CATCHAREA == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Other reason^b^" = paste0(sum(PRESCR_OTHER == 0, na.rm = TRUE), 
                                        " (", format(sum(PRESCR_OTHER == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Did not consent" = paste0(sum(CONSENT_PRESCREEN== 0, na.rm = TRUE), 
                                        " (", format(sum(CONSENT_PRESCREEN == 0, na.rm = TRUE)/sum(PRESCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")")
) %>% 
      t() %>% unlist()
  ) 
```

```{r}
prisma_tab2 <- tb_theme1(tb_prescreen_all) %>% 
  tab_header(
    title = md("**PRISMA Table 2**")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Pre-screening</span>"),
    rows = 1:2
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Reason for exclusion in pre-screening, n(%) <sup>a</sup></span>"),
    rows = 3:8
  ) %>%
  row_group_order(groups = c("<span style='font-size: 18px'>Pre-screening</span>",
                  "<span style='font-size: 18px'>Reason for exclusion in pre-screening, n(%) <sup>a</sup></span>")) %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> Denominator is pre- screened (MNH00 completed).</span>")
) %>%   
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Other reasons for exclusion include: not feasible to collect the minimal required dataset, medical contraindication, comes from outside the catchment area, refusal to be screened, not interested, deferred, needs to seek spousal consent, or does not have time to proceed with enrollment process.</span>")
)
    
```

```{r, out.width = '100%'}
prisma_tab2 <- prisma_tab2 %>% gtsave("prisma_tab2.png", expand = 10)
knitr::include_graphics("prisma_tab2.png")
```




\newpage

### Table 3: Cumulative enrollment numbers for PRISMA
*Value:* Distribution of cumulative enrollment and study progress distributions since the start of relaunch. If ineligible, distributions by exclusion criteria are listed below. Each column should sum to 100%.

```{r}

tb_enroll <- MatData_Screen_Enroll %>%
  group_by(SITE) %>%
  summarise("Screened for PRISMA (MNH02), n" = sum(SCREEN == 1, na.rm=TRUE),
            "Prescreen eligible (MNH00) with no Screening (MNH02), n^a^" = sum(PRESCR_ELIGIBLE ==1 & SCREEN == 0, na.rm = TRUE),
            "Enrolled in PRISMA (MNH02), n(%)^b^" = paste0(sum(ENROLL == 1, na.rm=TRUE),
                                        " (", format(sum(ENROLL == 1, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            
              "Gestational Age at Enrollment, mean (SD)" = paste0(format(round(mean(BOE_GA_WKS_ENROLL, na.rm = TRUE),2), 
                                                        nsmall=0, digits = 2), " (",format(round(sd(BOE_GA_WKS_ENROLL, 
                                                            na.rm = TRUE),2), nsmall=0, digits = 2), ")"), 
              "First trimester (<14 wks), n(%)^c^" = paste0(sum(BOE_GA_WKS_ENROLL < 14, na.rm = TRUE)," (",
                          format(round(sum(BOE_GA_WKS_ENROLL < 14, na.rm = TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
    ")"),
            "Did not meet age requirement" = paste0(sum(AGE == 0, na.rm=TRUE),
                             " (", format(sum(AGE == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Viable pregnancy with GA>=20 weeks by US" = paste0(sum(GA20 == 0, na.rm=TRUE),
                                " (", format(sum(GA20 == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Outside catchment area" = paste0(sum(CATCHAREA == 0, na.rm=TRUE),
                                   " (", format(sum(CATCHAREA == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
          "Doesn't plan to remain in catchment area" = paste0(sum(CATCHREMAIN == 0, na.rm=TRUE),
                                   " (", format(sum(CATCHREMAIN == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),

            "Did not consent" = paste0(sum(CONSENT == 0, na.rm=TRUE),
                                  " (", format(sum(CONSENT == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")")
  ) %>%
    t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .before = 1,
    "Total" = MatData_Screen_Enroll %>%
  plyr::summarise("Screened for PRISMA (MNH02), n" = sum(SCREEN == 1, na.rm = TRUE),
                  "Prescreen eligible (MNH00) with no Screening (MNH02), n^a^" = sum(PRESCR_ELIGIBLE ==1 & SCREEN == 0, na.rm = TRUE),
            "Enrolled in PRISMA (MNH02), n(%)^b^" = paste0(sum(ENROLL == 1, na.rm=TRUE),
                                        " (", format(sum(ENROLL == 1, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Gestational Age at Enrollment, mean (SD)" = paste0(format(round(mean(BOE_GA_WKS_ENROLL, na.rm = TRUE),2), 
                                                        nsmall=0, digits = 2), " (",format(round(sd(BOE_GA_WKS_ENROLL, 
                                                            na.rm = TRUE),2), nsmall=0, digits = 2), ")"), 
            "First trimester (<14 wks), n(%)^c^" = paste0(sum(BOE_GA_WKS_ENROLL < 14, na.rm = TRUE)," (",
                          format(round(sum(BOE_GA_WKS_ENROLL < 14, na.rm = TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
    ")"),
            "Viable pregnancy with GA>=20 weeks by US" = paste0(sum(AGE == 0, na.rm=TRUE),
                             " (", format(sum(AGE == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "GA >= 20 wks by US" = paste0(sum(GA20 == 0, na.rm=TRUE),
                                " (", format(sum(GA20 == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
            "Outside catchment area" = paste0(sum(CATCHAREA == 0, na.rm=TRUE),
                                   " (", format(sum(CATCHAREA == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    
            "Doesn't plan to remain in catchment area" = paste0(sum(CATCHREMAIN == 0, na.rm=TRUE),
                                   " (", format(sum(CATCHREMAIN == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),

            "Did not consent" = paste0(sum(CONSENT == 0, na.rm=TRUE),
                                  " (", format(sum(CONSENT == 0, na.rm=TRUE)/sum(SCREEN_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")")
      ) %>%
      t() %>% unlist()
  )


## remove any NAs that may break the table codes: 
tb_enroll <- tb_enroll %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0")))
             

```

```{r}

prisma_tab3 <- tb_theme1(tb_enroll) %>% 
  tab_header(
    title = md("**PRISMA Table 3**")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Enrollment</span>"),
    rows = 1:5
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Reason not enrolled, n(%) <sup>b</sup></span>"),
    rows = 6:10
  ) %>%
  row_group_order(groups = c("<span style='font-size: 18px'>Enrollment</span>",
                  "<span style='font-size: 18px'>Reason not enrolled, n(%) <sup>b</sup></span>")) %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> n is number participants who met the eligibility criteria in MNH00 but do not have a screening form (MNH02).</span>")
) %>%   
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> denominator is n screened (MNH02 completed).</span>")
) %>% 
    tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> denominator is n enrolled.</span>")
)
    
```

```{r, out.width = '100%'}
prisma_tab3 <- prisma_tab3 %>% gtsave("prisma_tab3.png", expand = 10)
knitr::include_graphics("prisma_tab3.png")
```

\newpage

### Figure 1a: Cumulative Enrollment by Site and Week
*Value:* Illustrate cumulative enrollment status by site over time.

```{r, echo=FALSE}

enroll_cum <- MatData_Screen_Enroll %>% 
  arrange("", by_group=START_DATE_MOM_WK) %>% 
  filter(ENROLL == 1 & !is.na(START_DATE_MOM_WK), 
         START_DATE_MOM_WK > dmy("21/09/2022")) %>% 
  group_by(SITE, START_DATE_MOM_WK) %>% 
  summarise(n = n()) %>% 
  mutate(cum_n = cumsum(n)) %>% 
  ungroup() 

enroll_cum$START_DATE_MOM_WK <- as.Date(as.POSIXct(enroll_cum$START_DATE_MOM_WK))

enroll_cum %>% 
  ggplot(aes(x = START_DATE_MOM_WK, y = cum_n, color = SITE)) +
  geom_point(shape = 15) +
  geom_line() +
  scale_x_date(date_breaks = "2 weeks", date_labels = ("%m-%d"), limits = c(dmy("25-09-2022"), UploadDate)) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position="bottom",
        panel.grid.minor = element_blank()) +
  xlab("Enrollment Week") +
  ylab("Site Participant Enrolled") +
  ggtitle("")


```

\newpage

###  Figure 1b: Cumulative Enrollment by Week for Each Site
*Value:* Compare expected and actual enrollment for each site over time. Calculated by dividing the total target enrollment by 36 months to get the average enrollment per month over the course of three years. We can further divide to get average enrollment per week.

```{r, echo=FALSE,out.width="49%",out.height="49%",fig.show='hold', fig.align='left'}

## pakistan
enroll_cum_PA <- MatData_Screen_Enroll %>% 
  arrange("", by_group=START_DATE_MOM_WK) %>% 
  filter(SCREEN == 1 & SITE == "Pakistan" & !is.na(START_DATE_MOM_WK), 
         START_DATE_MOM_WK > dmy("21/09/2022")) %>% 
  group_by(START_DATE_MOM_WK) %>% 
  summarise(enroll_n=sum(ENROLL==1),
            expect_n=mean(EXPECT)) %>% 
  mutate(
  gap = as.numeric(ymd(START_DATE_MOM_WK)-lag(ymd(START_DATE_MOM_WK))),
  expect_n = case_when(
    gap <= 1 ~ expect_n,
    gap > 1 ~ expect_n*gap,
    is.na(gap) ~ expect_n
  )) %>% 
  mutate(expect_cum=cumsum(expect_n),
         enroll_cum=cumsum(enroll_n))%>% 
  ungroup() 

enroll_cum_PA$START_DATE_MOM_WK <- as.Date(as.POSIXct(enroll_cum_PA$START_DATE_MOM_WK))

enroll_cum_PA %>% 
  ggplot(aes(x = START_DATE_MOM_WK)) +
  geom_point(aes(y = expect_cum, color = "Expected"), shape = 15) +
  geom_point(aes(y = enroll_cum, color = "Enrolled"), shape = 15) +
  geom_line(aes(y = expect_cum, color = "Expected")) +
  geom_line(aes(y = enroll_cum, color = "Enrolled")) +
  scale_color_manual("",
                     breaks=c("Expected","Enrolled"),
                     values = c("orange", "royalblue1")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position="bottom",
        panel.grid.minor = element_blank()) +
  scale_x_date(date_breaks = "2 weeks", date_labels = ("%m-%d"), limits = c(dmy("25-09-2022"), UploadDate)) + ## UPDATE EACH RUN
  xlab("Enrollment Week") +
  ylab("Site Participant Expected and Enrolled") +
  ggtitle("Pakistan") 

# kenya
enroll_cum_KE <- MatData_Screen_Enroll %>% 
  arrange("", by_group=START_DATE_MOM_WK) %>% 
  filter(SCREEN == 1 & SITE == "Kenya" & !is.na(START_DATE_MOM_WK), 
         START_DATE_MOM_WK > dmy("20/11/2022")) %>% 
  group_by(START_DATE_MOM_WK) %>% 
  summarise(enroll_n=sum(ENROLL==1),
            expect_n=mean(EXPECT)) %>% 
  mutate(
  gap = as.numeric(ymd(START_DATE_MOM_WK)-lag(ymd(START_DATE_MOM_WK))),
  expect_n = case_when(
    gap <= 1 ~ expect_n,
    gap > 1 ~ expect_n*gap,
    is.na(gap) ~ expect_n
  )) %>% 
  mutate(expect_cum=cumsum(expect_n),
         enroll_cum=cumsum(enroll_n))%>% 
  ungroup() 

enroll_cum_KE$START_DATE_MOM_WK <- as.Date(as.POSIXct(enroll_cum_KE$START_DATE_MOM_WK))

 enroll_cum_KE %>% 
  ggplot(aes(x = START_DATE_MOM_WK)) +
  geom_point(aes(y = expect_cum, color = "Expected"), shape = 15) +
  geom_point(aes(y = enroll_cum, color = "Enrolled"), shape = 15) +
  geom_line(aes(y = expect_cum, color = "Expected")) +
  geom_line(aes(y = enroll_cum, color = "Enrolled")) +
  scale_color_manual("",
                     breaks=c("Expected","Enrolled"),
                     values = c("orange", "royalblue1")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position="bottom",
        panel.grid.minor = element_blank()) +
  scale_x_date(date_breaks = "2 weeks", date_labels = ("%m-%d"), limits = c(dmy("20-11-2022"), UploadDate)) +    
  xlab("Enrollment Week") +
  ylab("Site Participant Expected and Enrolled") +
  ggtitle("Kenya") 

## Ghana
enroll_cum_GA <- MatData_Screen_Enroll %>%
  arrange("", by_group=START_DATE_MOM_WK) %>%
  filter(SCREEN == 1 & SITE == "Ghana" & !is.na(START_DATE_MOM_WK),
         START_DATE_MOM_WK > dmy("01/01/2023")) %>%
  group_by(START_DATE_MOM_WK) %>%
  summarise(enroll_n=sum(ENROLL==1),
            expect_n=mean(EXPECT)) %>%
  mutate(
  gap = as.numeric(ymd(START_DATE_MOM_WK)-lag(ymd(START_DATE_MOM_WK))),
  expect_n = case_when(
    gap <= 1 ~ expect_n,
    gap > 1 ~ expect_n*gap,
    is.na(gap) ~ expect_n
  )) %>%
  mutate(expect_cum=cumsum(expect_n),
         enroll_cum=cumsum(enroll_n)) %>%
  ungroup()

enroll_cum_GA$START_DATE_MOM_WK <- as.Date(as.POSIXct(enroll_cum_GA$START_DATE_MOM_WK))

enroll_cum_GA %>%
  ggplot(aes(x = START_DATE_MOM_WK)) +
  geom_point(aes(y = expect_cum, color = "Expected"), shape = 15) +
  geom_point(aes(y = enroll_cum, color = "Enrolled"), shape = 15) +
  geom_line(aes(y = expect_cum, color = "Expected")) +
  geom_line(aes(y = enroll_cum, color = "Enrolled")) +
  scale_color_manual("",
                     breaks=c("Expected","Enrolled"),
                     values = c("orange", "royalblue1")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position="bottom",
        panel.grid.minor = element_blank()) +
  scale_x_date(date_breaks = "2 weeks", date_labels = ("%m-%d"), limits = c(dmy("26-12-2022"), UploadDate)) +  
  xlab("Enrollment Week") +
  ylab("Site Participant Expected and Enrolled") +
  ggtitle("Ghana")

# Zambia
enroll_cum_ZA <- MatData_Screen_Enroll %>% 
  arrange("", by_group=START_DATE_MOM_WK) %>% 
  filter(SCREEN == 1 & SITE == "Zambia" & !is.na(START_DATE_MOM_WK), 
         START_DATE_MOM_WK > dmy("15/12/2022")) %>% 
  group_by(START_DATE_MOM_WK) %>% 
  summarise(enroll_n=sum(ENROLL==1),
            expect_n=mean(EXPECT)) %>% 
  mutate(
  gap = as.numeric(ymd(START_DATE_MOM_WK)-lag(ymd(START_DATE_MOM_WK))),
  expect_n = case_when(
    gap <= 1 ~ expect_n,
    gap > 1 ~ expect_n*gap,
    is.na(gap) ~ expect_n
  )) %>% 
  mutate(expect_cum=cumsum(expect_n),
         enroll_cum=cumsum(enroll_n))%>% 
  ungroup() 

enroll_cum_ZA$START_DATE_MOM_WK <- as.Date(as.POSIXct(enroll_cum_ZA$START_DATE_MOM_WK))

enroll_cum_ZA %>% 
  ggplot(aes(x = START_DATE_MOM_WK)) +
  geom_point(aes(y = expect_cum, color = "Expected"), shape = 15) +
  geom_point(aes(y = enroll_cum, color = "Enrolled"), shape = 15) +
  geom_line(aes(y = expect_cum, color = "Expected")) +
  geom_line(aes(y = enroll_cum, color = "Enrolled")) +
  scale_color_manual("",
                     breaks=c("Expected","Enrolled"),
                     values = c("orange", "royalblue1")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position="bottom",
        panel.grid.minor = element_blank()) +
  scale_x_date(date_breaks = "2 weeks", date_labels = ("%m-%d"), limits = c(dmy("15-12-2022"), UploadDate)) + 
  xlab("Enrollment Week") +
  ylab("Site Participant Expected and Enrolled") +
  ggtitle("Zambia") 


# India CMC
enroll_cum_CMC <- MatData_Screen_Enroll %>% 
  arrange("", by_group=START_DATE_MOM_WK) %>% 
  filter(SCREEN == 1 & SITE == "India-CMC" & !is.na(START_DATE_MOM_WK), 
         START_DATE_MOM_WK > dmy("18/07/2023")) %>% 
  group_by(START_DATE_MOM_WK) %>% 
  summarise(enroll_n=sum(ENROLL==1),
            expect_n=mean(EXPECT)) %>% 
  mutate(
  gap = as.numeric(ymd(START_DATE_MOM_WK)-lag(ymd(START_DATE_MOM_WK))),
  expect_n = case_when(
    gap <= 1 ~ expect_n,
    gap > 1 ~ expect_n*gap,
    is.na(gap) ~ expect_n
  )) %>% 
  mutate(expect_cum=cumsum(expect_n),
         enroll_cum=cumsum(enroll_n))%>% 
  ungroup() 

enroll_cum_CMC$START_DATE_MOM_WK <- as.Date(as.POSIXct(enroll_cum_CMC$START_DATE_MOM_WK))

enroll_cum_CMC %>% 
  ggplot(aes(x = START_DATE_MOM_WK)) +
  geom_point(aes(y = expect_cum, color = "Expected"), shape = 15) +
  geom_point(aes(y = enroll_cum, color = "Enrolled"), shape = 15) +
  geom_line(aes(y = expect_cum, color = "Expected")) +
  geom_line(aes(y = enroll_cum, color = "Enrolled")) +
  scale_color_manual("",
                     breaks=c("Expected","Enrolled"),
                     values = c("orange", "royalblue1")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position="bottom",
        panel.grid.minor = element_blank()) +
  scale_x_date(date_breaks = "2 weeks", date_labels = ("%m-%d"), limits = c(dmy("18-07-2023"), UploadDate)) + 
  xlab("Enrollment Week") +
  ylab("Site Participant Expected and Enrolled") +
  ggtitle("India-CMC")

```

\newpage

### Table 4: Study Status for PRISMA MNH Study 
*Value:* Distribution of current status among enrolled women. Each column should sum to 100%.

```{r}

tb_status <- MatData_Screen_Enroll %>% 
  filter(ENROLL == 1) %>% 
  group_by(SITE) %>% 
  summarise(
    "N" = paste0("(n=", sum(ENROLL==1, na.rm = TRUE), ")"),
    "Ongoing participants" = paste0(sum(is.na(M23_CLOSE_DSDECOD)), 
                                        " (", format(sum(is.na(M23_CLOSE_DSDECOD))/sum(ENROLL_DENOM==1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Completed 1-year follow-up after live birth or stillbirth" = paste0(sum(M23_CLOSE_DSDECOD == 1, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 1, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Completed 42-day follow-up after spontaneous abortion (miscarriage) or induced abortion" = paste0(sum(M23_CLOSE_DSDECOD == 2, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 2, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Mother died before completion" = paste0(sum(M23_CLOSE_DSDECOD == 3, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 3, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Withdrew study" = paste0(sum(M23_CLOSE_DSDECOD == 4, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 4, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Terminated from study" = paste0(sum(M23_CLOSE_DSDECOD == 5, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 5, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Lost to follow-up" = paste0(sum(M23_CLOSE_DSDECOD == 6, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 6, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")")
  ) %>% 
    t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "Total" = MatData_Screen_Enroll %>% 
      filter(ENROLL == 1) %>% 
  plyr::summarise(
    "N" = paste0("(n=", sum(ENROLL == 1, na.rm = TRUE), ")"),
    "Ongoing participants" = paste0(sum(is.na(M23_CLOSE_DSDECOD)), 
                                        " (", format(sum(is.na(M23_CLOSE_DSDECOD))/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    
    "Completed 1-year follow-up after live birth or stillbirth" = paste0(sum(M23_CLOSE_DSDECOD == 1, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 1, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Completed 42-day follow-up after spontaneous abortion (miscarriage) or induced abortion" = paste0(sum(M23_CLOSE_DSDECOD == 2, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 2, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Mother died before completion" = paste0(sum(M23_CLOSE_DSDECOD == 3, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 3, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Withdrew study" = paste0(sum(M23_CLOSE_DSDECOD == 4, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 4, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Terminated from study" = paste0(sum(M23_CLOSE_DSDECOD == 5, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 5, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")"),
    "Lost to follow-up" = paste0(sum(M23_CLOSE_DSDECOD == 6, na.rm=TRUE), 
                                        " (", format(sum(M23_CLOSE_DSDECOD == 6, na.rm=TRUE)/sum(ENROLL_DENOM == 1, na.rm=TRUE)*100, digits = 2, nsmall=0), ")")
      ) %>% 
      t() %>% unlist()
  ) 
```

```{r}

prisma_tab4 <- tb_theme1(tb_status) %>% 
  tab_header(
    title = md("**PRISMA Table 4**")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Study status, n (%)<sup>a</sup></span>"),
    rows = 2:8
  ) %>%
    row_group_order(groups = c(NA,
                  "<span style='font-size: 18px'>Study status, n (%)<sup>a</sup></span>")) %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> denominator is n enrolled.</span>")
) 
    
```

```{r}
prisma_tab4 <- prisma_tab4 %>% gtsave("prisma_tab4.png", expand = 10)
knitr::include_graphics("prisma_tab4.png")
```

\newpage

### Table 5: PRISMA Visit Completion (Late Windows) 
*Value:* Among women successfully contacted, are forms completed for each visit? If there is no late window for a visit, the on-time windows are used. 

*Goal:* 90% completion (100% completion for enrollment)

*Numerator:* Any form with visit type = i (variable name: `TYPE_VISIT`) AND have a complete visit status (where variable name: `MAT_VISIT_MNHXX`=1 or 2) AND passed late window for visit type = i

*Denominator:* Passed late window for visit type = i  AND (has not delivered OR delivered with gestational age > late visit window) AND (has not closed out OR closed out with closeout date > visit window)

```{r}
#* Num: Any form with visit type = i AND visit status = 1 or 2 & Passed window for visit type = i
#* Denom: Passed window for visit type = i

VISIT_COMPLETE_ANC <- Visit_Complete_Anc %>%
          rowwise() %>%
          group_by(SITE) %>%
          summarise(

      "Enrollment" = paste0(
        format(sum(VC_ENROLL_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ENROLL_NUM_LATE == 1, na.rm = TRUE)/sum(VC_ENROLL_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n" = paste0(
        format(sum(VC_ENROLL_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 20" = paste0(
        format(sum(VC_ANC20_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC20_NUM_LATE == 1, na.rm = TRUE)/sum(VC_ANC20_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n " = paste0(
        format(sum(VC_ANC20_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 28" = paste0(
        format(sum(VC_ANC28_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC28_NUM_LATE == 1, na.rm = TRUE)/sum(VC_ANC28_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n  " = paste0(
        format(sum(VC_ANC28_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 32" = paste0(
        format(sum(VC_ANC32_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC32_NUM_LATE == 1, na.rm = TRUE)/sum(VC_ANC32_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n   " = paste0(
        format(sum(VC_ANC32_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 36" = paste0(
        format(sum(VC_ANC36_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC36_NUM_LATE == 1, na.rm = TRUE)/sum(VC_ANC36_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n    " = paste0(
        format(sum(VC_ANC36_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        )
      ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Visit_Complete_Anc %>%
        plyr::summarise(

      "Enrollment" = paste0(
        format(sum(VC_ENROLL_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ENROLL_NUM_LATE == 1, na.rm = TRUE)/sum(VC_ENROLL_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n" = paste0(
        format(sum(VC_ENROLL_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 20" = paste0(
        format(sum(VC_ANC20_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC20_NUM_LATE == 1, na.rm = TRUE)/sum(VC_ANC20_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n " = paste0(
        format(sum(VC_ANC20_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 28" = paste0(
        format(sum(VC_ANC28_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC28_NUM_LATE == 1, na.rm = TRUE)/sum(VC_ANC28_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n  " = paste0(
        format(sum(VC_ANC28_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 32" = paste0(
        format(sum(VC_ANC32_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC32_NUM_LATE == 1, na.rm = TRUE)/sum(VC_ANC32_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n   " = paste0(
        format(sum(VC_ANC32_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "ANC = 36" = paste0(
        format(sum(VC_ANC36_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_ANC36_NUM_LATE == 1, na.rm = TRUE)/sum(VC_ANC36_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n    " = paste0(
        format(sum(VC_ANC36_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        )

      ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)


## PNC
VISIT_COMPLETE_PNC <- Visit_Complete_Pnc %>%
          rowwise() %>%
          group_by(SITE) %>%
          summarise(

      "PNC = 0" = paste0(
        format(sum(VC_PNC0_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC0_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC0_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n" = paste0(
        format(sum(VC_PNC0_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 1" = paste0(
        format(sum(VC_PNC1_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC1_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC1_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n " = paste0(
        format(sum(VC_PNC1_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 4" = paste0(
        format(sum(VC_PNC4_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC4_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC4_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n  " = paste0(
        format(sum(VC_PNC4_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 6" = paste0(
        format(sum(VC_PNC6_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC6_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC6_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n   " = paste0(
        format(sum(VC_PNC6_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 26" = paste0(
        format(sum(VC_PNC26_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC26_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC26_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n    " = paste0(
        format(sum(VC_PNC26_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 52" = paste0(
        format(sum(VC_PNC52_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC52_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC52_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n     " = paste0(
        format(sum(VC_PNC52_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        )
      ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Visit_Complete_Pnc %>%
        plyr::summarise(

      "PNC = 0" = paste0(
        format(sum(VC_PNC0_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC0_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC0_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n" = paste0(
        format(sum(VC_PNC0_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 1" = paste0(
        format(sum(VC_PNC1_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC1_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC1_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n " = paste0(
        format(sum(VC_PNC1_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 4" = paste0(
        format(sum(VC_PNC4_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC4_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC4_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n  " = paste0(
        format(sum(VC_PNC4_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 6" = paste0(
        format(sum(VC_PNC6_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC6_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC6_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n   " = paste0(
        format(sum(VC_PNC6_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 26" = paste0(
        format(sum(VC_PNC26_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC26_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC26_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n    " = paste0(
        format(sum(VC_PNC26_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "PNC = 52" = paste0(
        format(sum(VC_PNC52_NUM_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(VC_PNC52_NUM_LATE == 1, na.rm = TRUE)/sum(VC_PNC52_DENOM_LATE==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "Denominator,n     " = paste0(
        format(sum(VC_PNC52_DENOM_LATE==1, na.rm = TRUE), nsmall = 0, digits = 2)
        )
      ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

```

```{r}

table5 <- bind_rows(VISIT_COMPLETE_ANC,
          VISIT_COMPLETE_PNC) %>% 
    `rownames<-` (c(## anc (1-10)
                 "Enrollment (Late window: None)", ## NONE - SKIP WINDOW
                 "Denominator, n",
                 "ANC=20 (Late window: 23 to 25wks)",
                 "Denominator, n ",
                 "ANC=28 (Late window: None)", ## NONE - SKIP WINDOW
                 "Denominator, n  ",
                 "ANC=32 (Late window: 31 to 33)", ## use on time windows
                 "Denominator, n   ",
                 "ANC=36 (Late window: 38 to delivery)", ## use on time windows
                 "Denominator, n    ",
                 ## pnc (11-22)
                 "PNC=0 (Late window: None)", ## NONE - SKIP WINDOW
                 "Denominator, n     ",
                 "PNC=1 (Late window: None)", ## NONE - SKIP WINDOW
                 "Denominator, n      ",
                 "PNC=4 (Late window: None)", ## NONE - SKIP WINDOW
                 "Denominator, n       ",
                 "PNC=6 (Late window: 8 to 12wks)",
                 "Denominator, n        ",
                 "PNC=26 (Late window: 29 to 39wks)",
                 "Denominator, n^a^         ",
                 "PNC=52 (Late window: 55 to 64wks)",
                 "Denominator, n^a^          "
                 )
                ) %>% 
    mutate_all(funs(str_replace(., "NaN", "0"))) %>%
    mutate_all(funs(str_replace(., "NA", "0"))) 

table5_anc <- table5[c(1:10),]
table5_pnc <- table5[c(11:22),]

prisma_tab5_1 <- tb_theme1(table5_anc) %>% 
  tab_header(
    title = md("**PRISMA Table 5**"), 
    subtitle = md("*Continued on next page*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>ANC Visits</span>"),
    rows = 1:10
  ) %>%
    row_group_order(groups = c("<span style='font-size: 18px'>ANC Visits</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(indent = px(0))
        ),
      locations = cells_stub(rows = c('Enrollment (Late window: None)',
                 "ANC=20 (Late window: 23 to 25wks)",
                 "ANC=28 (Late window: None)", ## NONE - SKIP WINDOW
                 "ANC=32 (Late window: 31 to 33)", ## use on time windows
                 "ANC=36 (Late window: 38 to delivery)")) ## use on time windows
) %>% 
  tab_style(
      style = list(
        cell_text(indent = px(40))
        ),
      locations = cells_stub(rows = c('Denominator, n',
                 "Denominator, n ",
                 "Denominator, n  ",
                 "Denominator, n   ",
                 "Denominator, n    "))
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> excludes participants with a reported miscarriage `(FETAL_LOSS_DSDECOD==1 [MNH04])` who are only expected to have PNC0-6.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note</sup> passed late window denominators for all visits are calculated by EDD reported in MNH01 (US_EDD_BRTHDAT). If an EDD is missing, the participant is removed from this table..</span>")
) 

 
prisma_tab5_2 <- tb_theme1(table5_pnc) %>% 
  tab_header(
    title = md("**PRISMA Table 5**"),
    subtitle = md("*Continued*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC Visits</span>"),
    rows = 1:12
  ) %>%
    row_group_order(groups = c("<span style='font-size: 18px'>PNC Visits</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(indent = px(0))
        ),
      locations = cells_stub(rows = c(
                 "PNC=0 (Late window: None)", ## NONE - SKIP WINDOW
                 "PNC=1 (Late window: None)", ## NONE - SKIP WINDOW
                 "PNC=4 (Late window: None)", ## NONE - SKIP WINDOW
                 "PNC=6 (Late window: 8 to 12wks)",
                 "PNC=26 (Late window: 29 to 39wks)",
                 "PNC=52 (Late window: 55 to 64wks)"))
) %>% 
  tab_style(
      style = list(
        cell_text(indent = px(40))
        ),
      locations = cells_stub(rows = c(
                 "Denominator, n     ",
                 "Denominator, n      ",
                 "Denominator, n       ",
                 "Denominator, n        ",
                 "Denominator, n^a^         ",
                 "Denominator, n^a^          "))
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> excludes participants with a reported miscarriage `(FETAL_LOSS_DSDECOD==1 [MNH04])` who are only expected to have PNC0-6.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note</sup> passed late window denominators for all visits are calculated by EDD reported in MNH01 (US_EDD_BRTHDAT). If an EDD is missing, the participant is removed from this table..</span>")
) 


```

```{r}
prisma_tab5_1 <- prisma_tab5_1 %>% gtsave("prisma_tab5_1.png")
knitr::include_graphics("prisma_tab5_1.png")

```

```{r}
prisma_tab5_2 <- prisma_tab5_2 %>% gtsave("prisma_tab5_2.png")
knitr::include_graphics("prisma_tab5_2.png")

```

\newpage

### Table 6: ANC Protocol Compliance
*Value:* Among women successfully contacted during the ANC period, are all expected forms for the visit complete? 

*Goal:* 100% completion for all forms, except MNH08 where lab results are expected to lag.

*Numerator:* By form: visit type = i (variable name: `TYPE_VISIT`) AND have a complete visit status (where variable name: `MAT_VISIT_MNHXX`=1 or 2) AND passed late window for visit type = i 

*Denominator:* Any form with visit type = i (variable name: `TYPE_VISIT`) AND have a complete visit status (where variable name: `MAT_VISIT_MNHXX`=1 or 2) AND passed late window for visit type = i 

```{r}

ga_tb <- MatData_Anc_Visits %>% 
  group_by(SITE) %>% 
  summarise(
  "total enrolled" = paste0(
    "(n=",sum(ENROLL_DENOM==1, na.rm = TRUE), ")"
  )
  ) %>% ungroup() %>% 
  t() %>% 
  as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "Total" = MatData_Anc_Visits %>%
 plyr::summarise(
     "total enrolled" = paste0(
    "(n=",sum(ENROLL_DENOM==1, na.rm = TRUE),")"
  )
  ) %>% 
      t() %>% as.data.frame() %>% unlist()
  ) 


ENROLLMENT <- Prot_Compliance_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
      "Denominator" = paste0(
        format(sum(PC_ENROLL_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
      
      "MNH01 Ultrasound" = paste0(
        format(sum(M01_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M01_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH02 Enrollment Status" = paste0(
        format(sum(ENROLL == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(ENROLL == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      "MNH03 Sociodemographic" = paste0(
        format(sum(M03_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M03_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Anc %>% 
        plyr::summarise(
          
      "Denominator" = paste0(
        format(sum(PC_ENROLL_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH01 Ultrasound" = paste0(
        format(sum(M01_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M01_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH02 Enrollment Status" = paste0(
        format(sum(ENROLL == 1& ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(ENROLL == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH03 Sociodemographic" = paste0(
        format(sum(M03_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M03_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_1 == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>% 
        t() %>% 
        as.data.frame() %>% 
      `colnames<-`(c(.[1,])) %>% unlist() 
)

ANC20 <- Prot_Compliance_Anc %>% 
    filter(BOE_GA_WKS_ENROLL <= 17) %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(

    "Denominator" = paste0(
        format(sum(PC_ANC20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
        
    # "MNH01 Ultrasound (optional)" = paste0(
    #     format(sum(M01_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
    #     " (",
    #     format(round(sum(M01_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
    #     ")"),
    
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
       "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
    ) %>%
    t() %>% 
    as.data.frame() %>%    
        `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
    add_column(
      .before = 1,
      "Total" = Prot_Compliance_Anc %>%
      filter(BOE_GA_WKS_ENROLL <= 17) %>% 
        plyr::summarise(
          
      "Denominator" = paste0(
        format(sum(PC_ANC20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
          
      # "MNH01 Ultrasound (optional)" = paste0(
      #   format(sum(M01_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(M01_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")"),
    
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_2 == 1 & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
      ) %>%
        
        t() %>% as.data.frame() %>% unlist() 
)

ANC28 <- Prot_Compliance_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
      
      "Denominator" = paste0(
        format(sum(PC_ANC28_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
        
       # "MNH01 Ultrasound (optional)" = paste0(
       #  format(sum(M01_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(M01_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% `colnames<-`(c(.[1,]))  %>% as.data.frame() %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Anc %>% 
        plyr::summarise(
          
      "Denominator" = paste0(
        format(sum(PC_ANC28_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

       # "MNH01 Ultrasound (optional)" = paste0(
       #  format(sum(M01_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(M01_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_3 == 1 & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>% 
        t() %>% `colnames<-`(c(.[1,])) %>% 
        as.data.frame() %>% unlist() 
)

ANC32 <- Prot_Compliance_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
    
  "Denominator" = paste0(
        format(sum(PC_ANC32_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
        
   "MNH01 Ultrasound" = paste0(
        format(sum(M01_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M01_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
  ) %>%

  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,]))  %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Anc %>% 
        plyr::summarise(
          
  "Denominator" = paste0(
        format(sum(PC_ANC32_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
        
    "MNH01 Ultrasound" = paste0(
        format(sum(M01_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M01_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_4 == 1 & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
  
  ) %>%

        t() %>% 
        as.data.frame() %>% 
      `colnames<-`(c(.[1,])) %>%  unlist() 
)

ANC36 <- Prot_Compliance_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
                
       "Denominator" = paste0(
        format(sum(PC_ANC36_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
  
       # "MNH01 Ultrasound (optional)" = paste0(
       #  format(sum(M01_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(M01_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")"),


      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% `colnames<-`(c(.[1,]))  %>% as.data.frame() %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Anc %>% 
        plyr::summarise(
          
       "Denominator" = paste0(
        format(sum(PC_ANC36_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),
          
       # "MNH01 Ultrasound (optional)" = paste0(
       #  format(sum(M01_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(M01_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(M04_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M04_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(M05_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(M07_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_5 == 1 & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(PC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
        t() %>% `colnames<-`(c(.[1,])) %>% 
        as.data.frame() %>% unlist() 
)

```

```{r}

prot_compliance_anc <- bind_rows(ga_tb, 
          ENROLLMENT, 
          ANC20,
          ANC28, 
          ANC32, 
          ANC36
          ) %>% 
  `rownames<-`(c("N",
                 ## ANCLESS20 (2-10) 2-10
                 "Denominator, n^a^",
                 "MNH01 Ultrasound", 
                 "MNH02 Enrollment Status", 
                 "MNH03 Sociodemographic", 
                 "MNH04 ANC Clinical Status",
                 "MNH05 Maternal Anthro",
                 "MNH06 Maternal POC",
                 "MNH07 Maternal Specimen",
                 "MNH08 Maternal Lab",
                 ## ANC20 (11-16) 11-17
                 "Denominator, n^b^ ",                 
                # "MNH01 Ultrasound (optional) ",
                 "MNH04 ANC Clinical Status ",
                 "MNH05 Maternal Anthro ",
                 "MNH06 Maternal POC ",
                 "MNH07 Maternal Specimen ",
                 "MNH08 Maternal Lab ",
                 ## ANC28 (17-22) 18-24
                 "Denominator, n^c^  ",                 
                # "MNH01 Ultrasound (optional)  ",
                 "MNH04 ANC Clinical Status  ",
                 "MNH05 Maternal Anthro  ",
                 "MNH06 Maternal POC  ",
                 "MNH07 Maternal Specimen  ",
                 "MNH08 Maternal Lab  ",
                 ## ANC32 (23-29) 25-31
                 "Denominator, n^d^   ",                 
                 "MNH01 Ultrasound   ",
                 "MNH04 ANC Clinical Status   ",
                 "MNH05 Maternal Anthro   ",
                 "MNH06 Maternal POC   ",
                 "MNH07 Maternal Specimen   ",
                 "MNH08 Maternal Lab   ",
                 ##ANC36 (30-35) 32-38
                 "Denominator, n^e^    ",                 
               #  "MNH01 Ultrasound (optional)    ",
                 "MNH04 ANC Clinical Status    ",
                 "MNH05 Maternal Anthro    ",
                 "MNH06 Maternal POC    ",
                 "MNH07 Maternal Specimen    ",
                 "MNH08 Maternal Lab    "
                 )
               )  %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0"))) 


table6_1 <- prot_compliance_anc[c(1:16),]
table6_2 <- prot_compliance_anc[c(1,17:35),]

## PART 1
prisma_tab6_1 <- tb_theme1(table6_1) %>% 
  tab_header(
    title = md("**PRISMA Table 6** *(continued on next page)*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Enrollment, n(%)<sup>a</sup> [Target window: <20wks]</span>"),
    rows = 2:10
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>ANC = 20, n(%)<sup>b</sup> [Target window: 23 to 25wks]</span>"),
    rows = 11:16
  ) %>%
    row_group_order(groups = c(NA,
                               "<span style='font-size: 18px'>Enrollment, n(%)<sup>a</sup> [Target window: <20wks]</span>",
                               "<span style='font-size: 18px'>ANC = 20, n(%)<sup>b</sup> [Target window: 23 to 25wks]</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c("Denominator, n^a^",
                                      "Denominator, n^b^ "))
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> denominator is n completed any form with visit status=complete AND visit type=Enrollment AND passed late window with >19 weeks gestation.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> denominator is n completed any form with visit status=complete AND visit type=ANC20 AND passed late window with >22 weeks gestation.</span>")
) 

## PART 2
prisma_tab6_2 <- tb_theme1(table6_2) %>% 
  tab_header(
    title = md("**PRISMA Table 6** *(continued)*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>ANC = 28, n(%)<sup>c</sup> [Target window: 26 to 30wks]</span>"),
    rows = 2:7
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>ANC = 32, n(%)<sup>d</sup> [Target window: 31 to 33wks]</span>"),
    rows = 8:14
  ) %>%
 tab_row_group(
    label = html("<span style='font-size: 18px'>ANC = 36, n(%)<sup>e</sup> [Target window: 34 to 38wks]</span>"),
    rows = 15:20
  ) %>%
    row_group_order(groups = c(NA,
                               "<span style='font-size: 18px'>ANC = 28, n(%)<sup>c</sup> [Target window: 26 to 30wks]</span>",
                               "<span style='font-size: 18px'>ANC = 32, n(%)<sup>d</sup> [Target window: 31 to 33wks]</span>", 
                               "<span style='font-size: 18px'>ANC = 36, n(%)<sup>e</sup> [Target window: 34 to 38wks]</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c("Denominator, n^c^  ",
                                      "Denominator, n^d^   ",
                                      "Denominator, n^e^    "))
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> denominator is n completed any form with visit status=complete ANDvisit type=ANC28  AND passed late window with >30 weeks gestation.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>d</sup> denominator is n completed any form with visit status=complete AND visit type=ANC32  AND passed late window with>33 weeks gestation.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>e</sup> denominator is n completed any form with visit status=complete AND visit type=ANC36  AND passed late window with >38 weeks gestation.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note:</sup> Passed window denominators for all visits are calculated by EDD reported in MNH01 (US_EDD_BRTHDAT). If an EDD is missing, the participant is removed from this table.</span>")
) 

```

```{r}
prisma_tab6_1 <- prisma_tab6_1 %>% gtsave("prisma_tab6_1.png")
knitr::include_graphics("prisma_tab6_1.png")
```

```{r}
prisma_tab6_2 <- prisma_tab6_2 %>% gtsave("prisma_tab6_2.png")
knitr::include_graphics("prisma_tab6_2.png")
```

\newpage

### Table 7: ANC Form Completion
*Value:* Among women successfully contacted during the ANC period, are forms completed regardless of visit status?

*Goal:* 100% completion for all forms, except MNH08 where lab results are expected to lag.

*Numerator:* By form: visit type = i (variable name: `TYPE_VISIT`) AND have any visit status (variable name: `MAT_VISIT_MNHXX`) AND passed late window for visit type = i 

*Denominator:* Any form with visit type = i (variable name: `TYPE_VISIT`) AND have any visit status (variable name: `MAT_VISIT_MNHXX`) AND passed late window for visit type = i 

```{r}
# Participants are included in the numerator of this table if, for each form, they have visit type = i AND have any visit status AND passed window for visit type = 1. Participants  are included Visit status is defined by MAT_VISIT_MNHxx variables in each form.*
ga_tb <- MatData_Anc_Visits %>% 
  group_by(SITE) %>% 
  summarise(
  "total enrolled" = paste0(
    "(n=",sum(ENROLL==1, na.rm=TRUE), ")"
  )
  ) %>% ungroup() %>% 
  t() %>% 
  as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "Total" = MatData_Anc_Visits %>%
 plyr::summarise(
     "total enrolled" = paste0(
    "(n=",sum(ENROLL==1, na.rm=TRUE),")"
  )) %>% 
      t() %>% as.data.frame() %>% unlist()
  ) 



## ENROLLMENT
ENROLLMENT <- Form_Completion_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
      "Denominator" = paste0(
        format(sum(FC_ENROLL_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH01 Ultrasound" = paste0(
        format(sum(!is.na(M01_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M01_VISIT_COMPLETE_1)& ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH02 Enrollment Status" = paste0(
        format(sum(ENROLL == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(ENROLL == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      "MNH03 Sociodemographic" = paste0(
        format(sum(!is.na(M03_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M03_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "Total" = Form_Completion_Anc %>% 
        plyr::summarise(
        
      "Denominator" = paste0(
        format(sum(FC_ENROLL_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),  
      
      "MNH01 Ultrasound" = paste0(
        format(sum(!is.na(M01_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M01_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH02 Enrollment Status" = paste0(
        format(sum(ENROLL == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(ENROLL == 1 & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH03 Sociodemographic" = paste0(
        format(sum(!is.na(M03_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M03_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_1) & ENROLL_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ENROLL_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>% 
        t() %>% 
        as.data.frame() %>% 
      `colnames<-`(c(.[1,])) %>% unlist() 
)

## ANC20
ANC20 <- Form_Completion_Anc %>% 
    filter(BOE_GA_WKS_ENROLL <= 17) %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
      
    "Denominator" = paste0(
        format(sum(FC_ANC20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 
      
    # "MNH01 Ultrasound (optional)" = paste0(
    #     format(sum(!is.na(M01_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
    #     " (",
    #     format(round(sum(!is.na(M01_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
    #     ")"),
    
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
       "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH25 Maternal Depression" = paste0(
        format(sum(!is.na(M25_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M25_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")

       # "MNH26 Maternal Fatigue" = paste0(
       #  format(sum(!is.na(M26_VISIT_COMPLETE_2)  & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(!is.na(M26_VISIT_COMPLETE_2)  & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")")
    
    ) %>%
    t() %>% 
    as.data.frame() %>%    
        `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
    add_column(
      .before = 1,
      "Total" = Form_Completion_Anc %>% 
      filter(BOE_GA_WKS_ENROLL <= 17) %>% 
        plyr::summarise(
                
    "Denominator" = paste0(
        format(sum(FC_ANC20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 
    
      # "MNH01 Ultrasound (optional)" = paste0(
      #   format(sum(!is.na(M01_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(!is.na(M01_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")"),
    
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH25 Maternal Depression" = paste0(
        format(sum(!is.na(M25_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M25_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")

       # "MNH26 Maternal Fatigue" = paste0(
       #  format(sum(!is.na(M26_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(!is.na(M26_VISIT_COMPLETE_2) & ANC20_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")")
    ) %>%
        
        t() %>% as.data.frame() %>% unlist() 
)

## ANC28
ANC28 <- Form_Completion_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
            
    "Denominator" = paste0(
        format(sum(FC_ANC28_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 
    
       # "MNH01 Ultrasound (optional)" = paste0(
       #  format(sum(!is.na(M01_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(!is.na(M01_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% `colnames<-`(c(.[1,]))  %>% as.data.frame() %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "Total" = Form_Completion_Anc %>% 
        plyr::summarise(
                      
    "Denominator" = paste0(
        format(sum(FC_ANC28_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 

       # "MNH01 Ultrasound (optional)" = paste0(
       #  format(sum(!is.na(M01_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(!is.na(M01_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_3) & ANC28_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC28_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>% 
        t() %>% `colnames<-`(c(.[1,])) %>% 
        as.data.frame() %>% unlist() 
)

## ANC32
ANC32 <- Form_Completion_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
                  
    "Denominator" = paste0(
        format(sum(FC_ANC32_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 
      
   "MNH01 Ultrasound" = paste0(
        format(sum(!is.na(M01_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M01_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH25 Maternal Lab" = paste0(
        format(sum(!is.na(M25_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M25_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
      
      # "MNH26 Maternal Fatigue" = paste0(
      #   format(sum(!is.na(M26_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(!is.na(M26_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")")
   ) %>%

  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,]))  %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "Total" = Form_Completion_Anc %>% 
        plyr::summarise(
                            
    "Denominator" = paste0(
        format(sum(FC_ANC32_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 

    "MNH01 Ultrasound" = paste0(
        format(sum(!is.na(M01_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M01_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      # 
       "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      "MNH25 Maternal Lab" = paste0(
        format(sum(!is.na(M25_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M25_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
      
      # "MNH26 Maternal Fatigue" = paste0(
      #   format(sum(!is.na(M26_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      #   " (",
      #   format(round(sum(!is.na(M26_VISIT_COMPLETE_4) & ANC32_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC32_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      #   ")")
    ) %>%

        t() %>% 
        as.data.frame() %>% 
      `colnames<-`(c(.[1,])) %>%  unlist() 
)

## ANC36
ANC36 <- Form_Completion_Anc %>% 
    rowwise() %>% 
    group_by(SITE) %>% 
    summarise(
                        
    "Denominator" = paste0(
        format(sum(FC_ANC36_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 
      
       # "MNH01 Ultrasound (optional)" = paste0(
       #  format(sum(!is.na(M01_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(!is.na(M01_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")"),


      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% `colnames<-`(c(.[1,]))  %>% as.data.frame() %>% 
  slice(-1) %>% 
      add_column(
      .before = 1,
      "Total" = Form_Completion_Anc %>% 
        plyr::summarise(
                            
    "Denominator" = paste0(
        format(sum(FC_ANC36_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ), 
          
       # "MNH01 Ultrasound (optional)" = paste0(
       #  format(sum(!is.na(M01_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       #  " (",
       #  format(round(sum(!is.na(M01_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
       #  ")"),
       # 
      "MNH04 ANC Clinical Status" = paste0(
        format(sum(!is.na(M04_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M04_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH05 Maternal Anthro" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      
      "MNH07 Maternal Specimen" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
     
       "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_5) & ANC36_PASS_LATE == 1, na.rm = TRUE)/sum(FC_ANC36_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
        t() %>% `colnames<-`(c(.[1,])) %>% 
        as.data.frame() %>% unlist() 
)


```

```{r}

form_completion_anc <- bind_rows(ga_tb, 
          ENROLLMENT, 
          ANC20,
          ANC28, 
          ANC32, 
          ANC36
          ) %>% 
  `rownames<-`(c("N",
                 ## ANCLESS20 (2-10)
                 "Denominator, n",
                 "MNH01 Ultrasound", 
                 "MNH02 Enrollment Status", 
                 "MNH03 Sociodemographic", 
                 "MNH04 ANC Clinical Status",
                 "MNH05 Maternal Anthro",
                 "MNH06 Maternal POC",
                 "MNH07 Maternal Specimen",
                 "MNH08 Maternal Lab",
                 ## ANC20 (11-17)
                 "Denominator, n ",
                # "MNH01 Ultrasound (optional) ",
                 "MNH04 ANC Clinical Status ",
                 "MNH05 Maternal Anthro ",
                 "MNH06 Maternal POC ",
                 "MNH07 Maternal Specimen ",
                 "MNH08 Maternal Lab ",
                 "MNH25 Maternal Depression ",
                 #"MNH26 Maternal Fatigue^1^ ",
                 ## ANC28 (18-23)
                 "Denominator, n  ",
                # "MNH01 Ultrasound (optional)  ",
                 "MNH04 ANC Clinical Status  ",
                 "MNH05 Maternal Anthro  ",
                 "MNH06 Maternal POC  ",
                 "MNH07 Maternal Specimen  ",
                 "MNH08 Maternal Lab  ",
                 ## ANC32 (24-31)
                 "Denominator, n   ",
                 "MNH01 Ultrasound   ",
                 "MNH04 ANC Clinical Status   ",
                 "MNH05 Maternal Anthro   ",
                 "MNH06 Maternal POC   ",
                 "MNH07 Maternal Specimen   ",
                 "MNH08 Maternal Lab   ",
                 "MNH25 Maternal Depression   ",
                 #"MNH26 Maternal Fatigue^1^   ",
                 ##ANC36 (32-37)
                 "Denominator, n    ",
                # "MNH01 Ultrasound (optional)    ",
                 "MNH04 ANC Clinical Status    ",
                 "MNH05 Maternal Anthro    ",
                 "MNH06 Maternal POC    ",
                 "MNH07 Maternal Specimen    ",
                 "MNH08 Maternal Lab    "
                 )
               )  %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0"))) 


table7_1 <- form_completion_anc[c(1:17),]
table7_2 <- form_completion_anc[c(1,18:37),]

## PART 1
prisma_tab7_1 <- tb_theme1(table7_1) %>% 
  tab_header(
    title = md("**PRISMA Table 7** *(continued on next page)*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Enrollment, n(%)<sup>a</sup> [Target window: <20wks]</span>"),
    rows = 2:10
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>ANC = 20, n(%)<sup>b</sup> [Target window: 23 to 25wks]</span>"),
    rows = 11:17
  ) %>%
    row_group_order(groups = c(NA,
                               "<span style='font-size: 18px'>Enrollment, n(%)<sup>a</sup> [Target window: <20wks]</span>",
                               "<span style='font-size: 18px'>ANC = 20, n(%)<sup>b</sup> [Target window: 23 to 25wks]</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c("Denominator, n",
                                      "Denominator, n "))
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> denominator is n completed any form with any visit status AND visit type=Enrollment AND passed late window with >19 weeks gestation.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> passed window denominators for all visits are calculated by EDD reported in MNH01 (US_EDD_BRTHDAT). If an EDD is missing, the particpant is removed from this table.</span>")
) 

## PART 2
prisma_tab7_2 <- tb_theme1(table7_2) %>% 
  tab_header(
    title = md("**PRISMA Table 7** *(continued)*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>ANC = 28, n(%)<sup>c</sup> [Target window: 26 to 30wks]</span>"),
    rows = 2:7
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>ANC = 32, n(%)<sup>d</sup> [Target window: 31 to 33wks]</span>"),
    rows = 8:15
  ) %>%
 tab_row_group(
    label = html("<span style='font-size: 18px'>ANC = 36, n(%)<sup>e</sup> [Target window: 34 to 38wks]</span>"),
    rows = 16:21
  ) %>%
    row_group_order(groups = c(NA,
                               "<span style='font-size: 18px'>ANC = 28, n(%)<sup>c</sup> [Target window: 26 to 30wks]</span>",
                               "<span style='font-size: 18px'>ANC = 32, n(%)<sup>d</sup> [Target window: 31 to 33wks]</span>", 
                               "<span style='font-size: 18px'>ANC = 36, n(%)<sup>e</sup> [Target window: 34 to 38wks]</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c("Denominator, n  ",
                                      "Denominator, n   ",
                                      "Denominator, n    "))
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> denominator is n completed any form with any visit status AND visit type=ANC28 AND passed late window with >30 weeks gestation.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>d</sup> denominator is n completed any form with any visit status AND visit type=ANC32 AND passed late window with>33 weeks gestation.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>e</sup> denominator is n completed any form with any visit status AND visit type=ANC36 AND passed late window with >38 weeks gestation.</span>")
) 

```

```{r}
prisma_tab7_1 <- prisma_tab7_1 %>% gtsave("prisma_tab7_1.png")
knitr::include_graphics("prisma_tab7_1.png")

```

```{r}
prisma_tab7_2 <- prisma_tab7_2 %>% gtsave("prisma_tab7_2.png")
knitr::include_graphics("prisma_tab7_2.png")

```

\newpage

### Table 8: IPC Visit Completion & Protocol Compliance
*Value:* Among women successfully contacted during the IPC period, are all expected forms for the visit complete? A visit is considered `complete` if the data reports the visit was conducted in person or by phone (variable name: `MAT_VISIT_MNHXX`).

```{r}

# row 1: among people with a passed window how many have an mnh09 OR mnh10 OR mnh11
# row 2: among people WITH either an 09/10/11 how many have mnh09 complete 
# row 3: among people WITH either an 09/10/11 how many have mnh10 complete 
# row 4: among people WITH either an 09/10/11 how many have mnh11 complete 

IPC_Total <- MatData_Ipc_Visits_Mat %>%
  group_by(SITE) %>%
  summarise(
    
  ## VISIT COMPLETION: 
      # NUM: have MNH09 or MNH10 or MNH11 with a complete visit status (variable name: `MAT_VISIT_MNHXX`).   
      # DENOM: denominator is n completed MNH09 or MNH10 or MNH11 with a complete visit status (variable name: `MAT_VISIT_MNHXX`) OR passed on-time window with >42 weeks gestation.

    "IPC" = paste0(
      format(sum(ANY_TYPE_VISIT_COMPLETE_6 == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANY_TYPE_VISIT_COMPLETE_6 == 1, na.rm = TRUE)/sum(IPC_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "total passed ipc period" = paste0(
      format(sum(IPC_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2))
    
    
  ) %>%
  
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>% 
      add_column(
      .before = 1,
      "Total" = MatData_Ipc_Visits_Mat %>%
        plyr::summarise(
          
  ## VISIT COMPLETION: 
      # NUM: have MNH09 or MNH10 or MNH11 with a complete visit status (variable name: `MAT_VISIT_MNHXX`).   
      # DENOM: denominator is n completed MNH09 or MNH10 or MNH11 with a complete visit status (variable name: `MAT_VISIT_MNHXX`) OR passed on-time window with >42 weeks gestation.

    "IPC" = paste0(
      format(sum(ANY_TYPE_VISIT_COMPLETE_6 == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANY_TYPE_VISIT_COMPLETE_6 == 1, na.rm = TRUE)/sum(IPC_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "total passed ipc period" = paste0(
      format(sum(IPC_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2))
  ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

IPC_Prot_Comp_Mat <- MatData_Ipc_Visits_Compliance_Mat %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(
    
  ## PROTOCOL COMPLIANCE: 
    # NUM: have a complete visit status (variable name: `MAT_VISIT_MNHXX`).
    # DENOM: n completed MNH09 or MNH10 or MNH11 with visit status=complete.
    
    "MNH09" = paste0(
      format(sum(M09_VISIT_COMPLETE_6==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(M09_VISIT_COMPLETE_6==1, na.rm = TRUE)/sum(ANY_TYPE_VISIT_COMPLETE_6==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "MNH10" = paste0(
      format(sum(M10_VISIT_COMPLETE_6==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(M10_VISIT_COMPLETE_6==1, na.rm = TRUE)/sum(ANY_TYPE_VISIT_COMPLETE_6==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")
  ) %>%
  
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>% 
      add_column(
      .before = 1,
      "Total" = MatData_Ipc_Visits_Compliance_Mat %>%
        plyr::summarise(

  ## PROTOCOL COMPLIANCE: 
    # NUM: have a complete visit status (variable name: `MAT_VISIT_MNHXX`).
    # DENOM: n completed MNH09 or MNH10 or MNH11 with visit status=complete.
    
    "MNH09" = paste0(
      format(sum(M09_VISIT_COMPLETE_6==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(M09_VISIT_COMPLETE_6==1, na.rm = TRUE)/sum(ANY_TYPE_VISIT_COMPLETE_6==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "MNH10" = paste0(
      format(sum(M10_VISIT_COMPLETE_6==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(M10_VISIT_COMPLETE_6==1, na.rm = TRUE)/sum(ANY_TYPE_VISIT_COMPLETE_6==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")
  ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

IPC_Prot_Comp_Inf <- MatData_Ipc_Visits_Compliance_Inf %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(
    
  ## PROTOCOL COMPLIANCE: 
    # NUM: have a complete visit status (variable name: `MAT_VISIT_MNHXX`).
    # DENOM: n completed MNH09 or MNH10 or MNH11 with visit status=complete.

    "MNH11" = paste0(
      format(sum(M11_VISIT_COMPLETE_6==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(M11_VISIT_COMPLETE_6==1, na.rm = TRUE)/sum(ANY_TYPE_VISIT_COMPLETE_6==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")
  ) %>%
  
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>% 
      add_column(
      .before = 1,
      "Total" = MatData_Ipc_Visits_Compliance_Inf %>%
        plyr::summarise(

  ## PROTOCOL COMPLIANCE: 
    # NUM: have a complete visit status (variable name: `MAT_VISIT_MNHXX`).
    # DENOM: n completed MNH09 or MNH10 or MNH11 with visit status=complete.
    
    "MNH11" = paste0(
      format(sum(M11_VISIT_COMPLETE_6==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(M11_VISIT_COMPLETE_6==1, na.rm = TRUE)/sum(ANY_TYPE_VISIT_COMPLETE_6==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")
  ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)



```

```{r}

table8 <- bind_rows(IPC_Total, 
                    IPC_Prot_Comp_Mat,
                    IPC_Prot_Comp_Inf) %>% 
  `rownames<-`(c("IPC (Target window: Delivery to 72 hours)",
                 "Denominator, n",
                 "MNH09 Labor & Delivery", 
                 "MNH10 Maternal Post-Delivery Outcome", 
                 "MNH11 Newborn Birth Outcome")
               )  %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0"))) 

## table 8
prisma_tab8 <- tb_theme1(table8) %>% 
  tab_header(
    title = md("**PRISMA Table 8**")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>IPC Visit Completion<sup>a,b</sup></span>"),
    rows = 1:2
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Maternal IPC Protocol Compliance<sup>c,d</sup></span>"),
    rows = 3:4
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Infant IPC Protocol Compliance<sup>e,f</sup></span>"),
    rows = 5:5
  ) %>%
    row_group_order(groups = c("<span style='font-size: 18px'>IPC Visit Completion<sup>a,b</sup></span>",
                               "<span style='font-size: 18px'>Maternal IPC Protocol Compliance<sup>c,d</sup></span>",
                               "<span style='font-size: 18px'>Infant IPC Protocol Compliance<sup>e,f</sup></span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> numerator: n mom with MNH09 or MNH10 or MNH11 with a complete visit status (variable name: `MAT_VISIT_MNHXX`).</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> denominator: n mom completed MNH09 or MNH10 or MNH11 with a complete visit status (variable name: `MAT_VISIT_MNHXX`) OR passed late window with >42 weeks gestation AND (has not closed out OR closed out with closeout date >42wks).</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> numerator: n mom with a complete visit status (variable name: `MAT_VISIT_MNHXX`).</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>d</sup> denominator: n mom completed MNH09 or MNH10 or MNH11 with visit status=complete.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>e</sup> numerator: n infant with a complete visit status (variable name: `MAT_VISIT_MNHXX`).</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>f</sup> denominator: n mom-infant pair completed MNH09 or MNH10 or MNH11 with visit status=complete.</span>")
) 

```

```{r}
prisma_tab8 <- prisma_tab8 %>% gtsave("prisma_tab8.png")
knitr::include_graphics("prisma_tab8.png")
```

\newpage

### Table 9: PNC Protocol Compliance (Maternal Forms)
*Value:* Among women successfully contacted during the PNC period, are all expected forms for the visit complete? 

*Goal:* 100% completion for all forms, except MNH08 where lab results are expected to lag.

*Numerator:* By form: visit type = i (variable name: `TYPE_VISIT`) AND have a complete visit status (variable name: ``MAT_VISIT_MNHXX`=1 or 2) AND passed late window for visit type = i

*Denominator:* Any form with visit type = i (variable name: `TYPE_VISIT`) AND have a complete visit status (variable name: `MAT_VISIT_MNHXX`=1 or 2) AND passed late window for visit type = i

```{r}

# Participants are included in the numerator of this table if, for each form, they have visit type = i AND have any visit status AND passed window for visit type = 1. Participants are included Visit status is defined by MAT_VISIT_MNHxx variables in each form.*
birthoutcome <- MatData_Pnc_Visits %>%
  group_by(SITE) %>%
  summarise(
  "total birth outcomes" = paste0(
    "(n=",sum(BIRTH_OUTCOME_YN==1, na.rm = TRUE), ")"
  )
  ) %>% ungroup() %>%
  t() %>%
  as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .before = 1,
    "Total" = MatData_Pnc_Visits %>%
 plyr::summarise(
     "total birth outcomes" = paste0(
    "(n=",sum(BIRTH_OUTCOME_YN==1, na.rm = TRUE),")"
  )) %>%
      t() %>% as.data.frame() %>% unlist()
  )

## PNC0
PNC0 <- Prot_Compliance_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(PC_PNC0_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_7 == 1 & PNC0_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_7 == 1 & PNC0_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC0_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_7==1 & PC_PNC0_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_7==1 & PNC0_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC0_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%

  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(PC_PNC0_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_7==1 & PC_PNC0_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_7==1& PNC0_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC0_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_7==1 & PC_PNC0_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_7==1 & PNC0_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC0_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)



## PNC1
PNC1 <- Prot_Compliance_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(PC_PNC1_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_8 == 1 & PC_PNC1_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_8 == 1& PNC1_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC1_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_8 == 1 & PC_PNC1_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_8 == 1 & PNC1_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC1_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(PC_PNC1_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_8 == 1 & PC_PNC1_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_8 == 1& PNC1_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC1_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_8 == 1 & PC_PNC1_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_8 == 1 & PNC1_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC1_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"))
  %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

## PNC4
PNC4 <- Prot_Compliance_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(PC_PNC4_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_9 == 1 & PC_PNC4_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_9 == 1& PNC4_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC4_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_9 == 1 & PC_PNC4_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_9 == 1 & PNC4_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC4_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%

  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(PC_PNC4_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_9 == 1 & PC_PNC4_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_9 == 1& PNC4_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC4_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_9 == 1 & PC_PNC4_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_9 == 1 & PNC4_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC4_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")

      )
  %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

## PNC6
PNC6 <- Prot_Compliance_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(PC_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH05 Maternal Anthropometrics" = paste0(
        format(sum(M05_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_10 == 1& PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_10 == 1& PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH07 Maternal Specimen Collection" = paste0(
        format(sum(M07_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_10 == 1& PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_10 == 1& PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      "MNH25 Maternal Depression" = paste0(
        format(sum(M25_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M25_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(PC_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH05 Maternal Anthropometrics" = paste0(
        format(sum(M05_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_10 == 1& PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_10 == 1& PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH07 Maternal Specimen Collection" = paste0(
        format(sum(M07_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_10 == 1& PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_10 == 1& PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

    "MNH25 Maternal Depression" = paste0(
        format(sum(M25_VISIT_COMPLETE_10 == 1 & PC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M25_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"))
  %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

## PNC26
PNC26 <- Prot_Compliance_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(PC_PNC26_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH05 Maternal Anthropometrics" = paste0(
        format(sum(M05_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_11 == 1& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_11 == 1& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH07 Maternal Specimen Collection" = paste0(
        format(sum(M07_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_11 == 1& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_11 == 1& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_11 == 1 & PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(PC_PNC26_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH05 Maternal Anthropometrics" = paste0(
        format(sum(M05_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_11 == 1& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_11 == 1& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH07 Maternal Specimen Collection" = paste0(
        format(sum(M07_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M07_VISIT_COMPLETE_11 == 1& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH08 Maternal Lab" = paste0(
        format(sum(M08_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M08_VISIT_COMPLETE_11 == 1& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_11 == 1 & PC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_11 == 1 & PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)


## PNC52
PNC52 <- Prot_Compliance_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(PC_PNC52_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

     "MNH05 Anthropometrics" = paste0(
        format(sum(M05_VISIT_COMPLETE_12 == 1 & PC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_12 == 1& PNC52_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),


      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_12 == 1 & PC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_12 == 1& PNC52_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_12 == 1 & PC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_12 == 1 & PNC52_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Prot_Compliance_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(PC_PNC52_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

    "MNH05 Anthropometrics" = paste0(
        format(sum(M05_VISIT_COMPLETE_12 == 1 & PC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M05_VISIT_COMPLETE_12 == 1& PNC52_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(M06_VISIT_COMPLETE_12 == 1 & PC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M06_VISIT_COMPLETE_12 == 1& PNC52_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(M12_VISIT_COMPLETE_12 == 1 & PC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(M12_VISIT_COMPLETE_12 == 1 & PNC52_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
            )
  %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)


```

```{r}

prot_compliance_pnc <- bind_rows(birthoutcome,
                                 PNC0,
                                 PNC1, 
                                 PNC4, 
                                 PNC6, 
                                 PNC26, 
                                 PNC52
          ) %>%
    `rownames<-`(c("Participants with a birth outcome, n^a^",
                 ## PNC0 (2-4)
                  "Denominator, n",
                  "MNH06 Maternal POC ",
                  "MNH12 Mat Clinical ",
                 ## PNC1 (5-7)
                 "Denominator, n ",
                 "MNH06 Maternal POC  ",
                 "MNH12 Mat Clinical  ",
                 ## PNC4 (8-10)
                 "Denominator, n  ",
                 "MNH06 Maternal POC   ",
                 "MNH12 Mat Clinical   ",
                 ## PNC6 (11-17)
                 "Denominator, n   ",
                 "MNH05 Maternal Anthro    ",
                 "MNH06 Maternal POC    ",
                 "MNH07 Maternal Specimen    ",
                 "MNH08 Maternal Lab    ",
                 "MNH12 Mat Clinical    ",
                 "MNH25 Maternal Depression    ",
                 ## PNC26 (18-23)
                 "Denominator, n    ",
                 "MNH05 Maternal Anthro     ",
                 "MNH06 Maternal POC     ",
                 "MNH07 Maternal Specimen     ",
                 "MNH08 Maternal Lab     ",
                 "MNH12 Mat Clinical     ",
                 ##PNC52 24-27)
                 "Denominator, n     ",
                 "MNH05 Maternal Anthro      ",
                 "MNH06 Maternal POC      ",
                 "MNH12 Mat Clinical      "
                 )
               )  %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0"))) 


table9_1 <- prot_compliance_pnc[c(1:10),]
table9_2 <- prot_compliance_pnc[c(1,11:27),]


## PART 1
prisma_tab9_1 <- tb_theme1(table9_1) %>% 
  tab_header(
    title = md("**PRISMA Table 9** *(continued on next page)*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC = 0, n(%)<sup>b</sup> [Target window: 3 to 5 days]</span>"),
    rows = 2:4
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC = 1, n(%)<sup>c</sup> [Target window: 7 to 14 days]</span>"),
    rows = 5:7
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC = 4, n(%)<sup>d</sup> [Target window: 28 to 35 days]</span>"),
    rows = 8:10
  ) %>%

    row_group_order(groups = c(NA,
                               "<span style='font-size: 18px'>PNC = 0, n(%)<sup>b</sup> [Target window: 3 to 5 days]</span>",
                               "<span style='font-size: 18px'>PNC = 1, n(%)<sup>c</sup> [Target window: 7 to 14 days]</span>",
                               "<span style='font-size: 18px'>PNC = 4, n(%)<sup>d</sup> [Target window: 28 to 35 days]</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c("Denominator, n",
                                      "Denominator, n ", 
                                      "Denominator, n  "))
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> n is any participant with any birth outcome defined by `BIRTH_DSTERM_INFX` in MNH09.</span>")  
) %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> denominator is n completed any form with visit status=complete AND visit type=PNC0 AND passed late window with >5 days postpartum.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> denominator is n completed any form with visit status=complete AND visit type=PNC1 AND passed late window with 14 days postpartum.</span>")  
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>d</sup> denominator is n completed any form with visit status=complete AND visit type=PNC4 AND passed late window with >35 days postpartum.</span>")  
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note</sup> passed window denominators for all visits are calculated by date and time of birth reported in MNH09. If an date of birth is missing, the particpant is removed from this table.</span>")  
)   



## PART 2
prisma_tab9_2 <- tb_theme1(table9_2) %>% 
  tab_header(
    title = md("**PRISMA Table 9** *(continued)*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC = 6, n(%)<sup>e</sup> [Target window: 8 to 12 wks]</span>"),
    rows = 2:8
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC = 26, n(%)<sup>f</sup> [Target window: 29 to 39 wks]</span>"),
    rows = 9:14
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC = 52, n(%)<sup>g</sup> [Target window: 55 to 54 wks]</span>"),
    rows = 15:18
  ) %>%

    row_group_order(groups = c(NA,
                               "<span style='font-size: 18px'>PNC = 6, n(%)<sup>e</sup> [Target window: 8 to 12 wks]</span>",
                               "<span style='font-size: 18px'>PNC = 26, n(%)<sup>f</sup> [Target window: 29 to 39 wks]</span>",
                               "<span style='font-size: 18px'>PNC = 52, n(%)<sup>g</sup> [Target window: 55 to 54 wks]</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c("Denominator, n   ",
                                      "Denominator, n    " , 
                                      "Denominator, n     "))
) %>% 
    tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> n is any participant with any birth outcome defined by `BIRTH_DSTERM_INFX` in MNH09.</span>")  
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>e</sup> denominator is n completed any form with visit status=complete AND visit type=PNC6 AND passed late window with >7 wks postpartum.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>f</sup> denominator is n completed any form with visit status=complete AND visit type=PNC26 AND passed late window with >28 wks postpartum.</span>")  
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>g</sup> denominator is n completed any form wit visit status=complete AND visit type=PNC52 AND passed late window with >54 wks postpartum.</span>")  
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note</sup> passed window denominators for all visits are calculated by date and time of birth reported in MNH09. If an date of birth is missing, the particpant is removed from this table.</span>")  
)  




```

```{r}
prisma_tab9_1 <- prisma_tab9_1 %>% gtsave("prisma_tab9_1.png")
knitr::include_graphics("prisma_tab9_1.png")

```

```{r}
prisma_tab9_2 <- prisma_tab9_2 %>% gtsave("prisma_tab9_2.png")
knitr::include_graphics("prisma_tab9_2.png")

```

\newpage

### Table 10: PNC Form Completion (Maternal Forms)
*Value:* Among women successfully contacted during the PNC period, are forms completed regardless of visit status?

*Goal:* 100% completion for all forms, except MNH08 where lab results are expected to lag.

*Numerator:* By form: visit type = i (variable name: `TYPE_VISIT`) AND have any visit status (variable name: `MAT_VISIT_MNHXX`) AND passed late window for visit type = i

*Denominator:* Any form with visit type = i (variable name: `TYPE_VISIT`) AND have any visit status (variable name: `MAT_VISIT_MNHXX`) AND passed late window for visit type = i
```{r}
# Participants are included in the numerator of this table if, for each form, they have visit type = i AND have any visit status AND passed window for visit type = 1. Participants are included Visit status is defined by MAT_VISIT_MNHxx variables in each form.*
birthoutcome <- MatData_Pnc_Visits %>%
  group_by(SITE) %>%
  summarise(
  "total birth outcomes" = paste0(
    "(n=",sum(BIRTH_OUTCOME_YN==1, na.rm = TRUE), ")"
  )
  ) %>% ungroup() %>%
  t() %>%
  as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .before = 1,
    "Total" = MatData_Pnc_Visits %>%
 plyr::summarise(
     "total birth outcomes" = paste0(
    "(n=",sum(BIRTH_OUTCOME_YN==1, na.rm = TRUE),")"
  )) %>%
      t() %>% as.data.frame() %>% unlist()
  )

## PNC0
PNC0 <- Form_Completion_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(FC_PNC0_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_7) & FC_PNC0_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_7)& PNC0_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC0_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_7) & FC_PNC0_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_7) & PNC0_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC0_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%

  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Form_Completion_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(FC_PNC0_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_7) & FC_PNC0_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_7)& PNC0_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC0_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_7) & FC_PNC0_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_7) & PNC0_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC0_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
      ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)


## PNC1
PNC1 <- Form_Completion_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(FC_PNC1_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_8) & FC_PNC1_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_8)& PNC1_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC1_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_8) & FC_PNC1_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_8) & PNC1_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC1_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
      ) %>%

  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Form_Completion_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(FC_PNC1_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_8) & FC_PNC1_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_8)& PNC1_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC1_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_8) & FC_PNC1_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_8) & PNC1_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC1_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"))

  %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

## PNC4

PNC4 <- Form_Completion_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(FC_PNC4_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_9) & FC_PNC4_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_9)& PNC4_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC4_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_9) & FC_PNC4_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_9) & PNC4_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC4_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
      ) %>%
  
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Form_Completion_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(FC_PNC4_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_9) & FC_PNC4_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_9)& PNC4_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC4_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_9) & FC_PNC4_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_9) & PNC4_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC4_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")

      )
  %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

## PNC6
PNC6 <- Form_Completion_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(FC_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH05 Maternal Anthropometrics" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_10)& PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_10)& PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH07 Maternal Specimen Collection" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_10)& PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_10)& PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_10) & PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH25 Maternal Depression" = paste0(
        format(sum(!is.na(M25_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M25_VISIT_COMPLETE_10) & PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Form_Completion_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(FC_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH05 Maternal Anthropometrics" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_10)& PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_10)& PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH07 Maternal Specimen Collection" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_10)& PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_10)& PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_10) & PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
    "MNH25 Maternal Depression" = paste0(
        format(sum(!is.na(M25_VISIT_COMPLETE_10) & FC_PNC6_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M25_VISIT_COMPLETE_10) & PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"))
  %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)


## PNC26
PNC26 <- Form_Completion_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(FC_PNC26_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH05 Maternal Anthropometrics" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_11) & FC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_11)& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_11) & FC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_11)& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH07 Maternal Specimen Collection" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_11) & FC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_11)& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_11) & FC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_11)& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_11) & FC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_11) & PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
      ) %>%


  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Form_Completion_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(FC_PNC26_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

      "MNH05 Maternal Anthropometrics" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_11) & FC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_11)& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_11) & FC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_11)& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH07 Maternal Specimen Collection" = paste0(
        format(sum(!is.na(M07_VISIT_COMPLETE_11) & FC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M07_VISIT_COMPLETE_11)& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH08 Maternal Lab" = paste0(
        format(sum(!is.na(M08_VISIT_COMPLETE_11) & FC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M08_VISIT_COMPLETE_11)& PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_11) & FC_PNC26_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_11) & PNC26_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC26_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
      ) %>%

        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)

## PNC52
PNC52 <- Form_Completion_Pnc %>%
    rowwise() %>%
    group_by(SITE) %>%
    summarise(
      "Denominator" = paste0(
        format(sum(FC_PNC52_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

     "MNH05 Anthropometrics" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_12) & FC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_12)& PNC52_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),


      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_12) & FC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_12)& PNC52_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_12) & FC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_12) & PNC52_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")
     ) %>%

  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
      add_column(
      .before = 1,
      "Total" = Form_Completion_Pnc %>%
        plyr::summarise(

      "Denominator" = paste0(
        format(sum(FC_PNC52_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)
        ),

    "MNH05 Anthropometrics" = paste0(
        format(sum(!is.na(M05_VISIT_COMPLETE_12) & FC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M05_VISIT_COMPLETE_12)& PNC52_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH06 Maternal POC" = paste0(
        format(sum(!is.na(M06_VISIT_COMPLETE_12) & FC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M06_VISIT_COMPLETE_12)& PNC52_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

      "MNH12 Maternal PNC Clinical Status" = paste0(
        format(sum(!is.na(M12_VISIT_COMPLETE_12) & FC_PNC52_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
        " (",
        format(round(sum(!is.na(M12_VISIT_COMPLETE_12) & PNC52_PASS_LATE == 1, na.rm = TRUE)/sum(FC_PNC52_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")")

      )
  %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
)



```

```{r}

form_completion_pnc <- bind_rows(birthoutcome,
                                 PNC0, 
                                 PNC1, 
                                 PNC4, 
                                 PNC6, 
                                 PNC26, 
                                 PNC52
          ) %>%
    `rownames<-`(c("Participants with a birth outcome,, n^a^",
                 ## PNC0 (2-4)
                  "Denominator, n",
                  "MNH06 Maternal POC ",
                  "MNH12 Mat Clinical ",
                 ## PNC1 (5-7)
                 "Denominator, n ",
                 "MNH06 Maternal POC  ",
                 "MNH12 Mat Clinical  ",
                 ## PNC4 (8-10)
                 "Denominator, n  ",
                 "MNH06 Maternal POC   ",
                 "MNH12 Mat Clinical   ",
                 ## PNC6 (11-17)
                 "Denominator, n   ",
                 "MNH05 Maternal Anthro    ",
                 "MNH06 Maternal POC    ",
                 "MNH07 Maternal Specimen    ",
                 "MNH08 Maternal Lab    ",
                 "MNH12 Mat Clinical    ",
                 "MNH25 Maternal Depression    ",
                 ## PNC26 (18-23)
                 "Denominator, n    ",
                 "MNH05 Maternal Anthro     ",
                 "MNH06 Maternal POC     ",
                 "MNH07 Maternal Specimen     ",
                 "MNH08 Maternal Lab     ",
                 "MNH12 Mat Clinical     ",
                 ##PNC52 24-27)
                 "Denominator, n     ",
                 "MNH05 Maternal Anthro      ",
                 "MNH06 Maternal POC      ",
                 "MNH12 Mat Clinical      "
                 )
               )  %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0"))) 


table10_1 <- form_completion_pnc[c(1:10),]
table10_2 <- form_completion_pnc[c(1,11:27),]

## PART 1
prisma_tab10_1 <- tb_theme1(table10_1) %>% 
  tab_header(
    title = md("**PRISMA Table 10** *(continued on next page)*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC = 0, n(%)<sup>b</sup> [Target window: 3 to 5 days]</span>"),
    rows = 2:4
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC = 1, n(%)<sup>c</sup> [Target window: 7 to 14 days]</span>"),
    rows = 5:7
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC = 4, n(%)<sup>d</sup> [Target window: 28 to 35 days]</span>"),
    rows = 8:10
  ) %>%

    row_group_order(groups = c(NA,
                               "<span style='font-size: 18px'>PNC = 0, n(%)<sup>b</sup> [Target window: 3 to 5 days]</span>",
                               "<span style='font-size: 18px'>PNC = 1, n(%)<sup>c</sup> [Target window: 7 to 14 days]</span>",
                               "<span style='font-size: 18px'>PNC = 4, n(%)<sup>d</sup> [Target window: 28 to 35 days]</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c("Denominator, n",
                                      "Denominator, n ", 
                                      "Denominator, n  "))
) %>%
    tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> n is any participant with any birth outcome defined by `BIRTH_DSTERM_INFX` in MNH09.</span>")  
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> denominator is n completed any form with any visit status AND visit type=PNC0 AND passed late window with >5 days postpartum.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> denominator is n completed any form with any visit status AND visit type=PNC1 AND passed late window with 14 days postpartum.</span>")  
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>d</sup> denominator is n completed any form with any visit status AND visit type=PNC4 AND passed late window with >35 days postpartum.</span>")  
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note</sup> passed window denominators for all visits are calculated by date and time of birth reported in MNH09. If an date of birth is missing, the participant is removed from this table.</span>")  
)   



## PART 2
prisma_tab10_2 <- tb_theme1(table10_2) %>% 
  tab_header(
    title = md("**PRISMA Table 10** *(continued)*")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC = 6, n(%)<sup>e</sup> [Target window: 8 to 12 wks]</span>"),
    rows = 2:8
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC = 26, n(%)<sup>f</sup> [Target window: 29 to 39 wks]</span>"),
    rows = 9:14
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PNC = 52, n(%)<sup>g</sup> [Target window: 55 to 54 wks]</span>"),
    rows = 15:18
  ) %>%

    row_group_order(groups = c(NA,
                               "<span style='font-size: 18px'>PNC = 6, n(%)<sup>e</sup> [Target window: 8 to 12 wks]</span>",
                               "<span style='font-size: 18px'>PNC = 26, n(%)<sup>f</sup> [Target window: 29 to 39 wks]</span>",
                               "<span style='font-size: 18px'>PNC = 52, n(%)<sup>g</sup> [Target window: 55 to 54 wks]</span>")) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c("Denominator, n   ",
                                      "Denominator, n    " , 
                                      "Denominator, n     "))
) %>% 
    tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup>  n is any participant with any birth outcome defined by `BIRTH_DSTERM_INFX` in MNH09.</span>")  
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>e</sup> denominator is n completed any form with any visit status AND visit type=PNC6 AND passed late window with >7 wks postpartum.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>f</sup> denominator is n completed any form with any visit status AND visit type=PNC26 AND passed late window with >28 wks postpartum.</span>")  
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>g</sup> denominator is n completed any form with any visit status AND visit type=PNC52 AND passed late window with >54 wks postpartum.</span>")  
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note</sup> passed window denominators for all visits are calculated by date and time of birth reported in MNH09. If an date of birth is missing, the participant is removed from this table.</span>")  
)  

```

```{r}
prisma_tab10_1 <- prisma_tab10_1 %>% gtsave("prisma_tab10_1.png")
knitr::include_graphics("prisma_tab10_1.png")

```

```{r}
prisma_tab10_2 <- prisma_tab10_2 %>% gtsave("prisma_tab10_2.png")
knitr::include_graphics("prisma_tab10_2.png")
```

\newpage

### Table 11: MNH25 Protocol Compliance
*Value:* Among women successfully contacted during the ANC or PNC period, are all expected MNH25 Maternal Depression forms for the visit complete? A visit is considered `complete` if the data reports the visit was conducted in person or by phone (variable name: `MAT_VISIT_MNHXX`). MNH25 can be completed either during individual visits (e.g., ANC20) or during combined visits after the gestational age window has passed (e.g., combined Enrollment and ANC20 visits). The denominators in this table are based on the latest window for eligible visits. For example, the denominator for MNH25 completed at ANC32 is the number of participants who have passed the ANC36 late window to allow for combined visits.

*Numerator:* MNH25 with visit type = i (variable name: `TYPE_VISIT`) AND have a complete visit status (variable name: `MAT_VISIT_MNHXX`) AND passed late window for visit type = i AND (has not delivered OR delivered with gestational age > late visit window) AND (has not closed out OR closed out with closeout date > visit window)

*Denominator:* Passed late window for visit type = i AND (has not delivered OR delivered with gestational age > late visit window) AND (has not closed out OR closed out with closeout date > visit window)
```{r}
    
    #* Num: MNH25 with visit status = 1 or 2 AND passed window for visit type = i 
    #* Denom: passed window for visit type = i 
    
prot_compliance_depression <- Prot_Compliance_MNH25 %>% 
      rowwise() %>% 
      group_by(SITE) %>% 
      summarise(
        
      # ANC 20
        "MNH25 at ANC20^a^" = paste0(
          format(sum(M25_ANCLESS20_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M25_ANCLESS20_NUM == 1, na.rm = TRUE)/sum(PC_ANCLESS20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
          
        "Denominator, n" = paste0(
          format(sum(PC_ANCLESS20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)), 

      ## ANC 32
        "MNH25 at ANC32^b^" = paste0(
          format(sum(M25_ANCOVER31_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M25_ANCOVER31_NUM == 1, na.rm = TRUE)/sum(PC_ANCOVER31_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),

        "Denominator, n " = paste0(
          format(sum(PC_ANCOVER31_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)), 
        
     ### PNC 6      
     "MNH25 at PNC6^c^" = paste0(
          format(sum(M25_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M25_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),

        "Denominator, n  " = paste0(
          format(sum(PC_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2))

      )  %>%
      t() %>% as.data.frame() %>% 
      `colnames<-`(c(.[1,])) %>% 
      slice(-1) %>% 
      add_column(
        .before = 1,
        "Total" = Prot_Compliance_MNH25%>% 
          plyr::summarise(
      # ANC 20
        "MNH25 at ANC20^a^" = paste0(
          format(sum(M25_ANCLESS20_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M25_ANCLESS20_NUM == 1, na.rm = TRUE)/sum(PC_ANCLESS20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
          
        "Denominator, n" = paste0(
          format(sum(PC_ANCLESS20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)), 

      ## ANC 32
        "MNH25 at ANC32^b^" = paste0(
          format(sum(M25_ANCOVER31_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M25_ANCOVER31_NUM == 1, na.rm = TRUE)/sum(PC_ANCOVER31_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),

        "Denominator, n " = paste0(
          format(sum(PC_ANCOVER31_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)), 
        
     ### PNC 6      
     "MNH25 at PNC6^c^" = paste0(
          format(sum(M25_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M25_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),

        "Denominator, n  " = paste0(
          format(sum(PC_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2))
            
          ) %>% 
          t() %>% 
          as.data.frame() %>% 
          `colnames<-`(c(.[1,])) %>% unlist() 
  )
      
```

```{r}

prisma_table11 <- prot_compliance_depression %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0"))) 

## table 8
prisma_table11 <- tb_theme1(prisma_table11) %>% 
  tab_header(
    title = md("**ReMAPP Table 1a**")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>MNH25 Maternal Depression</span>"),
    rows = 1:6
  ) %>%
  tab_style(
      style = list(
        cell_text(indent = px(40))
        ),
      locations = cells_stub(rows = c("Denominator, n",
                                      "Denominator, n ",
                                      "Denominator, n  "))
) %>% 
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> denominator is n passed ANC20 late window with >25 weeks gestation AND (has not delivered OR delivered with gestational age >25wks) AND (has not closed out OR closed out with closeout date >25wks).</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> denominator is n passed ANC36 late window with >42 weeks gestation AND (has not delivered OR delivered with gestational age >32wks) AND (has not closed out OR closed out with closeout date >32wks).</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> denominator is n passed PNC6 late window with >12 weeks postpartum AND (has not closed out OR closed out with closeout date >12wks postpartum).</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>ANC Note:</sup> passed window denominators for ANC visits are calculated by EDD reported in MNH01 (US_EDD_BRTHDAT). If an EDD is missing, the participant is removed from this table.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>PNC Note:</sup> passed window denominators for PNC visits are calculated by date and time of birth reported in MNH09. If an date of birth is missing, the participant is removed from this table.</span>")
)

```

```{r}
prisma_table11 <- prisma_table11 %>% gtsave("prisma_table11.png")
knitr::include_graphics("prisma_table11.png")
```

\newpage

## **2. ReMAPP**

### Table 1: MNH26 Protocol Compliance
*Value:* Among women successfully contacted during the ANC or PNC period, are all expected MNH26 Maternal Fatigue forms for the visit complete? A visit is considered `complete` if the data reports the visit was conducted in person or by phone (variable name: `MAT_VISIT_MNHXX`). The table below shows protocol compliance distributions for MNH26 forms following site launch of ReMAPP. These forms can be filled out either during individual visits (e.g., ANC20) or during combined visits after the gestational age window has passed (e.g., combined Enrollment and ANC20 visits).For example, the denominator for MNH25 completed at ANC32 is the number of participants who have passed the ANC36 late window to allow for combined visits.

*Numerator:* MNH26 with visit type = i (variable name: `TYPE_VISIT`) AND have a complete visit status (variable name: `MAT_VISIT_MNHXX`) AND passed late window for visit type = i AND (has not delivered OR delivered with gestational age > late visit window) AND (has not closed out OR closed out with closeout date > visit window)

*Denominator:* Passed late window for visit type = i AND (has not delivered OR delivered with gestational age > late visit window) AND (has not closed out OR closed out with closeout date > visit window)

```{r}
    
    #* Num: MNH26 with visit status = 1 or 2 AND passed window for visit type = i 
    #* Denom: passed window for visit type = i 
    
prot_compliance_fatigue <- Prot_Compliance_MNH26 %>% 
      rowwise() %>% 
      group_by(SITE) %>% 
      summarise(
        
      # ANC 20
        "MNH26 at ANC20^a^" = paste0(
          format(sum(M26_ANCLESS20_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M26_ANCLESS20_NUM == 1, na.rm = TRUE)/sum(PC_ANCLESS20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
          
        "Denominator, n" = paste0(
          format(sum(PC_ANCLESS20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)), 

      ## ANC 32
        "MNH26 at ANC32^b^" = paste0(
          format(sum(M26_ANCOVER31_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M26_ANCOVER31_NUM == 1, na.rm = TRUE)/sum(PC_ANCOVER31_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),

        "Denominator, n " = paste0(
          format(sum(PC_ANCOVER31_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)), 
        
     ### PNC 6      
     "MNH26 at PNC6^c^" = paste0(
          format(sum(M26_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M26_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),

        "Denominator, n  " = paste0(
          format(sum(PC_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2))

      )  %>%
      t() %>% as.data.frame() %>% 
      `colnames<-`(c(.[1,])) %>% 
      slice(-1) %>% 
      add_column(
        .before = 1,
        "Total" = Prot_Compliance_MNH26 %>% 
          plyr::summarise(
            
      # ANC 20
        "MNH26 at ANC20^a^" = paste0(
          format(sum(M26_ANCLESS20_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M26_ANCLESS20_NUM == 1, na.rm = TRUE)/sum(PC_ANCLESS20_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
          
        "Denominator, n" = paste0(
          format(sum(PC_ANCLESS20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)), 

      ## ANC 32
        "MNH26 at ANC32^b^" = paste0(
          format(sum(M26_ANCOVER31_NUM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M26_ANCOVER31_NUM == 1, na.rm = TRUE)/sum(PC_ANCOVER31_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),

        "Denominator, n " = paste0(
          format(sum(PC_ANCOVER31_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)), 
        
     ### PNC 6      
     "MNH26 at PNC6^c^" = paste0(
          format(sum(M26_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
          " (",
          format(round(sum(M26_VISIT_COMPLETE_10 == 1 & PNC6_PASS_LATE == 1, na.rm = TRUE)/sum(PC_PNC6_DENOM==1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),

        "Denominator, n  " = paste0(
          format(sum(PC_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2))
            
          ) %>% 
          t() %>% 
          as.data.frame() %>% 
          `colnames<-`(c(.[1,])) %>% unlist() 
  )
      
    
```

```{r}

remapp_table1 <- prot_compliance_fatigue %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0"))) 

## table 8
remapp_table1 <- tb_theme1(remapp_table1) %>% 
  tab_header(
    title = md("**ReMAPP Table 1b**")
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>MNH26 Maternal Fatigue</span>"),
    rows = 1:6
  ) %>%
  tab_style(
      style = list(
        cell_text(indent = px(40))
        ),
      locations = cells_stub(rows = c("Denominator, n",
                                      "Denominator, n ",
                                      "Denominator, n  "))
) %>% 
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_row_groups()
) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> denominator is n passed ANC20 late window with >25 weeks gestation AND (has not delivered OR delivered with gestational age >25wks) AND (has not closed out OR closed out with closeout date >25wks).</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> denominator is n passed ANC36 late window with >42 weeks gestation AND (has not delivered OR delivered with gestational age >32wks) AND (has not closed out OR closed out with closeout date >32wks).</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> denominator is n passed PNC6 late window with >12 weeks postpartum AND (has not closed out OR closed out with closeout date >12wks postpartum).</span>")
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note:</sup> This table includes all participants who were enrolled following site launch of ReMAPP.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>ANC Note:</sup> passed window denominators for ANC visits are calculated by EDD reported in MNH01 (US_EDD_BRTHDAT). If an EDD is missing, the participant is removed from this table.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>PNC Note:</sup> passed window denominators for PNC visits are calculated by date and time of birth reported in MNH09. If an date of birth is missing, the participant is removed from this table.</span>")
)

```

```{r}
remapp_table1 <- remapp_table1 %>% gtsave("remapp_table1.png")
knitr::include_graphics("remapp_table1.png")
```

\newpage

### Table 2: ReMAPP healthy cohort eligibility
*Value:* This table will be updated as lab measurements are updated and reported. Those who are unknown may move into eligible or ineligible categories based on updated lab reports. Those who are eligible were enrolled in PRISMA following the launch of ReMAPP at each site. Distributions of eligibility criteria are outlined in Table 2 below.

```{r}

options(knitr.kable.NA = '0 (0)')


remapp_table2 <- healthyOutcome %>% 
  filter(ENROLL == 1) %>% 
  group_by(SITE) %>% 
  summarise("Total enrolled in PRISMA since ReMAPP launch" = paste0("(n=", n(), ")"),
            "Eligible for healthy cohort, n(%)" = paste0(sum(HEALTHY_ELIGIBLE == 1, na.rm=TRUE),
                                        " (", format(sum(HEALTHY_ELIGIBLE == 1, na.rm=TRUE)/sum(ENROLL == 1)*100, digits = 2, nsmall=0), ")"),
            "Ineligible for healthy cohort, n(%)" = paste0(sum(HEALTHY_ELIGIBLE == 0, na.rm=TRUE),
                             " (", format(sum(HEALTHY_ELIGIBLE == 0, na.rm=TRUE)/sum(ENROLL == 1)*100, digits = 2, nsmall=0), ")"),
            "Pending, n(%)" = paste0(sum(HEALTHY_ELIGIBLE == 3, na.rm=TRUE),
                                " (", format(sum(HEALTHY_ELIGIBLE == 3, na.rm=TRUE)/sum(ENROLL == 1)*100, digits = 2, nsmall=0), ")")
  ) %>% 
    t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .before = 1,
    "Total" = healthyOutcome %>% 
  filter(ENROLL == 1) %>% 
  plyr::summarise("Total enrolled in PRISMA since ReMAPP launch" = paste0("(n=", sum(ENROLL==1), ")"), 
            "Eligible , n(%)" = paste0(sum(HEALTHY_ELIGIBLE == 1, na.rm=TRUE),
                                        " (", format(sum(HEALTHY_ELIGIBLE == 1, na.rm=TRUE)/sum(ENROLL==1)*100, digits = 2, nsmall=0), ")"),
            "Ineligible, n(%)" = paste0(sum(HEALTHY_ELIGIBLE == 0, na.rm=TRUE),
                             " (", format(sum(HEALTHY_ELIGIBLE == 0, na.rm=TRUE)/sum(ENROLL == 1)*100, digits = 2, nsmall=0), ")"),
            "Pending, n(%)" = paste0(sum(HEALTHY_ELIGIBLE == 3, na.rm=TRUE),
                                " (", format(sum(HEALTHY_ELIGIBLE == 3, na.rm=TRUE)/sum(ENROLL == 1)*100, digits = 2, nsmall=0), ")")
  ) %>% 
      t() %>% unlist()
  ) 
```

```{r}

remapp_table2 <- remapp_table2 %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0"))) 

## ReMAPP table 2
remapp_table2 <- tb_theme1(remapp_table2) %>% 
  tab_header(
    title = md("**ReMAPP Table 2**")
  ) %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> denominator is n enrolled in PRISMA.</span>")
)

```

```{r}
remapp_table2 <- remapp_table2 %>% gtsave("remapp_table2.png")
knitr::include_graphics("remapp_table2.png")
```

\newpage

### Figure 1: ReMAPP healthy cohort eligibility and missingness by criteria by site.
*Value:* This figure will show the distribution of each healthy cohort criteria among women enrolled in ReMAPP. Missing means missing form, missing diagnosed or measured data, note that it includes pending data (test not performed yet or result pending).

```{r}
plot_criteria <- df_eli_long 

plot_criteria %>%
  ggplot(aes(y = reorder(Variable, desc(Variable)), fill = Value)) + 
  geom_bar(alpha = 0.9, aes(x = (..count..)/sum(..count..)), position = position_fill(reverse = TRUE)) +
  scale_x_continuous(labels=percent) + 
  scale_y_discrete(limits = rev(levels("Variable"))) +
  scale_fill_manual(
    values = c("#43bfc7","#F0833A","lightgrey"), 
    drop = FALSE) + 
  xlab("") + 
  ylab("") +
  facet_grid(~SITE, scales = "free_y", margins = FALSE) + 
  theme_bw() +  
  theme(strip.background=element_rect(fill="white"),
        axis.text = element_text(size = 7),
        axis.text.x = element_text(size = 6),
        legend.key.size = unit(0.38,"cm"),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),)

```
* Missing means missing form, missing diagnosed or measured data, note that it includes pending data (test not performed yet or result pending).

**Explanation of variable C1-C19:**

* C1 -- CRIT_AGE: Aged 18 to 34 years;
* C2 -- CRIT_GA: Gestational age <14 weeks 
* C3 -- CRIT_BMI_MUAC: Pre-pregnancy or early pregnancy body mass index (BMI) of >18.5 and <30 kg/m2 AND mid-upper arm circumference (MUAC) > 23cm 
* C4 -- CRIT_HEIGHT: Height ≥150 cm 
* C5 -- CRIT_SINGLEPREG: Singleton pregnancy 
* C6 -- CRIT_IRON: Not iron deficient (serum ferritin >15 mcg/L– adjusted for inflammation) 
* C7 -- CRIT_INFLAM: No subclinical inflammation (CRP≤5 and/or AGP≤1) 
* C8 -- CRIT_BP: Systolic blood pressure <140 mmHg and diastolic blood pressure <90 mmHg 
* C9 -- CRIT_LBW: No previous reported low birth weight delivery
* C10 -- CRIT_STILLBIRTH: No previous reported stillbirth
* C11 -- CRIT_UNPL_CESARIAN: No previous reported unplanned cesarean delivery
* C12 -- CRIT_HEMOGLOBINOPATHIES: No hemoglobinopathies: SS, SC, SE, EE, CC, SD-Punjab, Sβthal, Eβthal, Cβthal, CD-Punjab, ED-Punjab, D-D-Punjab, D-Punjabβthal, Thalassemia major, Thalassemia intermedia, glucose-6-phosphate dehydrogenase deficiency, or Alpha thalassemia
* C13 -- CRIT_SMOKE: No reported cigarette smoking, tobacco chewing, or betel nut use during pregnancy
* C14 -- CRIT_DRINK: No reported alcohol consumption during pregnancy
* C15 -- CRIT_CHRONIC: No known history or current chronic disease including cancer, kidney disease, and cardiac conditions
* C16 -- CRIT_HIV: No known history or current HIV
* C17 -- CRIT_MALARIA: No current malaria infection (per rapid diagnostic test)
* C18 -- CRIT_HEPATITISB: No current Hepatitis B virus infection (per rapid diagnostic test)
* C19 -- CRIT_HEPATITISC: No current Hepatitis C virus infection (per rapid diagnostic test)

\newpage


### Table 3: CBC Hemoglobin measurements for participants in ReMAPP per visit. 
*Value:* Were all the required CBC hemoglobin measurements taken as directed by the protocol?

```{r}
## denominators: 
  # DenHBV1 = MNH08 completed with visit type = 1 AND visit status = 1/2 OR enrollment overdue
  # DenHBV2 = MNH08 completed with visit type = 2 AND visit status = 1/2 AND GA at enrollment <= 17wks OR ANC20 overdue
  # DenHBV3 = MNH08 completed with visit type = 3 AND visit status = 1/2 OR ANC28 overdue
  # DenHBV5 = MNH08 completed with visit type = 5 AND visit status = 1/2 OR ANC36 overdue
  # DenHBV10 = MNH08 completed with visit type = 10 AND visit status = 1/2 OR PNC6 overdue

remapp_table3 <- MatData_Hb_Visit %>%
  group_by(SITE) %>%
    summarise(
          "Total enrolled since ReMAPP launch" = paste0(
            "(n=", n(),")"
          ),
            "Enrollment" = paste0(sum(HB_COMPLETED_1 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_1 == 1, na.rm = TRUE)/sum(DenHBV1 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
            "ANC20" = paste0(sum(HB_COMPLETED_2 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_2 == 1, na.rm = TRUE)/sum(DenHBV2 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
            "ANC28" = paste0(sum(HB_COMPLETED_3 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_3 == 1, na.rm = TRUE)/sum(DenHBV3 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
  
            "ANC36" = paste0(sum(HB_COMPLETED_5 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_5 == 1, na.rm = TRUE)/sum(DenHBV5 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
  
            "PNC6" = paste0(sum(HB_COMPLETED_10 == 1),
                                        " (", format(sum(HB_COMPLETED_10 == 1, na.rm = TRUE)/sum(DenHBV10 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")")
  
) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .before = 1,
    "Total" = MatData_Hb_Visit %>%
    plyr::summarise(
          "Total enrolled since ReMAPP launch" = paste0(
            "(n=", sum(ENROLL_DENOM == 1, na.rm=TRUE),")"),
          
            "Enrollment" = paste0(sum(HB_COMPLETED_1 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_1 == 1, na.rm = TRUE)/sum(DenHBV1 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
            "ANC20" = paste0(sum(HB_COMPLETED_2 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_2 == 1, na.rm = TRUE)/sum(DenHBV2 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
            "ANC28" = paste0(sum(HB_COMPLETED_3 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_3 == 1, na.rm = TRUE)/sum(DenHBV3 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
  
            "ANC36" = paste0(sum(HB_COMPLETED_5 == 1, na.rm = TRUE),
                                        " (", format(sum(HB_COMPLETED_5 == 1, na.rm = TRUE)/sum(DenHBV5 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")"),
  
            "PNC6" = paste0(sum(HB_COMPLETED_10 == 1),
                                        " (", format(sum(HB_COMPLETED_10 == 1, na.rm = TRUE)/sum(DenHBV10 == 1, na.rm = TRUE)*100, digits = 2, nsmall=0), ")")
  
) %>%
      t() %>% unlist()
  )

```

```{r}

remapp_table3 <- remapp_table3 %>%    
  `rownames<-`(c("Total enrolled since ReMAPP launch",
                  "ANC < 20, n(%)^a^",
                  "ANC = 20, n(%)^b^",
                  "ANC = 28, n(%)^c^",
                  "ANC = 36, n(%)^d^",
                  "PNC = 6, n(%)^e^"
                 )) %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  mutate_all(funs(str_replace(., "NA", "0"))) 

## ReMAPP Table 3
remapp_table3 <- tb_theme1(remapp_table3) %>% 
  tab_header(
    title = md("**ReMAPP Table 3**")
  ) %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> denominator is n enrolled during ReMAPP study period.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> denominator is n completed MNH08 with visit type=ANC20 OR missed late window with >22 weeks gestation.</span>")
) %>% 
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> denominator is n completed  MNH08 with visit type=ANC28 OR missed late window with >30 weeks gestation.</span>")
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>d</sup> denominator is n completed  MNH08 with visit type=ANC36 OR missed late window with >38 weeks gestation.</span>")
) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>e</sup> denominator is n completed  MNH08 with visit type=PNC6 OR missed late window with >12 weeks postpartum</span>")
) 

```

```{r}
remapp_table3 <- remapp_table3 %>% gtsave("remapp_table3.png")
knitr::include_graphics("remapp_table3.png")
```

\newpage

### Figure 2: Hemoglobin measures by gestational age for participants enrolled in PRISMA MNH 

```{r}

## x axis in days
MatData_Hb_GA_Visit <- MatData_Hb_GA_Visit %>% filter(GA > 0)

ggplot(data = MatData_Hb_GA_Visit,
             aes(x = GA, y = RESULT, group = TEST, color = TEST), ) +
  geom_point(alpha = 0.25)  +
    facet_grid(rows = vars(SITE)) +
    theme_bw() +
    ylim(0,20) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position="bottom",
        legend.title = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_x_continuous(breaks = c(0,49,98,147,198,245, 294),
                     label = c("0", "7", "14", "21", "28", "35", "42"), 
                     limits = c(0,294)) +
  xlab("Gestational Age (weeks)") +
  ylab("Hemoglobin (g/dL)") +
  scale_color_brewer(palette="Set1")

```

